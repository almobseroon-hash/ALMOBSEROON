<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام عرض المنتجات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- إضافة مكتبة Leaflet للخرائط -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* نافذة الشعار البسيطة */
.splash-logo {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgb(255, 255, 255);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.logo-container {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.logo-image {
    max-width: 500px;
    max-height: 500px;
    animation: fadeIn 1s ease-in-out;
    margin-bottom: 20px;
}

.company-name-splash {
    color: #074199e3;
    font-size: 30px;
    font-weight: bold;
    text-align: center;
    margin: 0;
    animation: fadeIn 1s ease-in-out 0.5s both;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* إخفاء الشعار بعد 3 ثواني */
.splash-logo.hide {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

/* المحتوى الرئيسي (مخفي في البداية) */
.main-content {
    display: none;
}

.main-content.show {
    display: block;
    animation: fadeInContent 0.5s ease;
}

@keyframes fadeInContent {
    from { opacity: 0; }
    to { opacity: 1; }
}

        /* المحتوى الرئيسي (مخفي في البداية) */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
            animation: fadeInContent 0.5s ease;
        }

        @keyframes fadeInContent {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* تنسيقات شريط التنقل */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background-color: #3498db;
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .company-name {
            font-size: 20px;
            font-weight: bold;
            color: #ffffff;
        }

        /* تنسيقات المنتجات */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }


.filter-tabs {
    position: sticky;
    top: 90px; /* top لـ page-title + ارتفاع page-title */
    z-index: 999;
    background: #ced1d3af;
    padding: 10px 0;
    margin-bottom: 0;
}

        .filter-tab {
            padding: 12px 24px;
            border-radius: 30px;
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tab.active {
            background-color: #3498db;
            color: white;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .product-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-info {
            padding: 20px;
        }

        .product-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        /* جميع الأنماط السابقة تبقى كما هي */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #ced1d3af;
            color: #333;
            line-height: 1.6;
        }

        /* شريط التنقل العلوي */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3498db, #8e44ad);
            border-radius: 50%;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .company-name {
            font-size: 18px;
            font-weight: 700;
            color: #e3f2fd;
         
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-login {
            background-color: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn-login:hover {
            background-color: white;
            color: #2c3e50;
            transform: translateY(-2px);
        }

        .btn-signup {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-signup:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        /* نافذة تسجيل المستخدم */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(255, 255, 255);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 15px 0;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-modal:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px;
        }

        .form-group {
            flex: 1 0 100%;
            margin: 0 5px 15px;
        }

        @media (min-width: 480px) {
            .form-group {
                flex: 1 0 calc(50% - 10px);
            }
        }

        .form-group.full-width {
            flex: 1 0 100%;
        }

        .form-group.hidden {
            display: none;
        }
            .form-body.hidden {
            display: none;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .photo-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border: 2px dashed #bdc3c7;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s;
        }

        .photo-circle:hover {
            border-color: #3498db;
            background-color: #e8f4fd;
        }

        .photo-circle i {
            font-size: 32px;
            color: #7f8c8d;
        }

        .photo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload span {
            transition: all 0.3s ease;
        }

        .btn-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .map-container {
            height: 200px;
            background-color: #f0f0f0;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 6px;
        }

        .map-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        @media (min-width: 480px) {
            .map-controls {
                flex-direction: row;
            }
        }

        .map-controls .btn {
            flex: 1;
            padding: 10px 12px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
        }

        .btn-submit {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
        }

        /* محتوى الصفحة الرئيسية */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }

      .page-title {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 15px;
        }

        .page-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #3498db, #8e44ad);
            border-radius: 2px;
        }

        /* عناوين الفلترة */
        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-bottom: 25px;
        }

        .filter-tab {
            background: white;
            padding: 10px 14px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            flex: 0 0 auto; /* منع التمدد */
            max-width: 140px;
            min-width: 0; /* السماح بالتقلص */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .filter-tab {
                padding: 8px 12px;
                font-size: 13px;
                max-width: 120px;
                gap: 5px;
            }
            .filter-tab i {
                font-size: 12px;
            }
        }

        .filter-tab:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .filter-tab.active {
            transform: translateY(-5px);
        }

        .filter-tab.new {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .filter-tab.sale {
            background: linear-gradient(135deg, #d304b0, #d304b0);
            color: white;
        }

        .filter-tab.popular {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .filter-tab.all {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
          .filter-tab.filter {
            background: linear-gradient(135deg, #bcbabd, #a7a4a8);
            color: white;
        }

        /* تحديث شبكة المنتجات لتصبح عمودين على الهواتف */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
             border-radius: 10px;
            row-gap: 10px; /* إضافة خاصية row-gap لتقليل المسافة بين الصفوف */
        }

        @media (min-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                row-gap: 10px; /* إضافة خاصية row-gap لتقليل المسافة بين الصفوف */
                 border-radius: 10px;
            }
        }

        @media (min-width: 1024px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                row-gap: 10px; /* إضافة خاصية row-gap لتقليل المسافة بين الصفوف */
                 border-radius: 10px;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                gap: 8px;
                row-gap: 10px; /* تقليل المسافة أكثر للشاشات الصغيرة */
                 border-radius: 10px;
            }
        }

        .product-card {
            background: white;
           border-radius: 10px;
            border: 2px solid #c4bfbf;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(255, 254, 254, 0.08);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto; /* تغيير من 80% إلى auto لتحسين المسافات */
            margin-bottom: 0; /* إزالة الهوامش السفلية الإضافية */
            row-gap: 0px;
        }

        /* تقليل الهوامش الداخلية في معلومات المنتج */
        .product-info {
            padding: 10px 12px; /* تقليل padding من 12px إلى 10px */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* تقليل المسافات بين العناصر داخل المنتج */
        .product-name {
            font-weight: 700;
            margin-bottom: 2px; /* تقليل من 8px إلى 6px */
            font-size: 20px; /* تقليل قليلاً من 24px */
            font-style: oblique;
            color: #2c3e50;
            line-height: 1.3;
            height: 36px; /* تقليل من 40px إلى 36px */
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }

        /* تقليل المسافة في حاوية التفاصيل */
        .product-details-container {
            padding: 6px 5px; /* تقليل من 20px إلى 12px */
            border-radius: 8px;
            background: #fafafa;
            margin-bottom: 4px; /* تقليل من 20px إلى 8px */
            align-items: center;
            row-gap: 1PX;
            height: 60px;
        }

        /* تقليل المسافة بين الصفوف في التفاصيل */
        .product-details-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px; /* تقليل من 8px إلى 6px */
            align-items: right;
        }

        /* تقليل المسافة في أزرار الإجراءات */
        .product-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px; /* تقليل من auto إلى 8px */
            padding-top: 8px;
            border-top: 1px solid #eee;
        
        }

        /* تعديل حجم الصورة الرئيسية لتحسين المسافات */
        .product-image {
            height: 300px; /* تقليل من 250px إلى 220px */
            width: 90%;
            margin: 0 auto;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 8px; /* تقليل من 10px إلى 8px */
            margin-bottom: 8px; /* إضافة margin-bottom */
        }

        /* تقليل حجم الصور المصغرة */
        .product-thumbnails {
            display: flex;
            justify-content: center;
            gap: 4px; /* تقليل من 5px إلى 4px */
            padding: 6px; /* تقليل من 8px إلى 6px */
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
            margin-bottom: 8px; /* إضافة margin-bottom */
        }

        @media (max-width: 480px) {
            .product-image {
                height: 150px; /* تقليل أكثر للشاشات الصغيرة */
            }
            
            .product-name {
                font-size: 18px; /* تقليل أكثر للشاشات الصغيرة */
                height: 50px; /* تقليل أكثر للشاشات الصغيرة */
                white-space: normal; /* أو pre-wrap */
                word-wrap: break-word; /* لكسر الكلمات الطويلة */
                 overflow-wrap: break-word; /* البديل الحديث */
                word-break: break-word; /* لكسر النص عند الحاجة */
             }
            
            .products-grid {
                gap: 6px;
                row-gap: 10px;
                border-radius: 10px;
            }
        }

        .product-image:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #3498db, #8e44ad);
        }

        .product-image i {
            font-size: 50px;
            color: #7f8c8d;
            transition: transform 0.5s;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease-in-out;
        }

        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
        }

        .product-badge.new {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .product-badge.sale {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .product-badge.popular {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        /* زر العرض في منتصف الجزء السفلي من الصورة */
        .view-details-btn {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px 50px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 10px;
            z-index: 3;
            width: 50px;
            text-align: center;
        }

        .view-details-btn:hover {
            background: rgba(41, 128, 185, 0.9);
            padding-top: 10px;
        }

        /* إضافة قسم الصور المصغرة */
        .product-thumbnails {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 8px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            overflow: hidden;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        @media (max-width: 480px) {
            .thumbnail {
                width: 35px;
                height: 35px;
            }
        }

        .thumbnail:hover {
            transform: scale(1.05);
            border-color: #3498db;
        }

        .thumbnail.active {
            border-color: #3498db;
        }

        .thumbnail i {
            font-size: 16px;
            color: #7f8c8d;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* تحديث تنسيق تفاصيل المنتج */
        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .product-location {
            color: #0920f1;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .product-type {
            color: #4b0dda;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            flex: 1;
            justify-content: flex-end;
        }

        .product-status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 10px;
        }

        .product-quantity {
            color: #e74c3c;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            flex: 1;
        }

        .product-condition {
            color: #9b59b6;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            flex: 1;
            justify-content: flex-end;
        }

        .product-price {
            color: #e74c3c;
            font-weight: 600;
            font-size: 18px;
            font-style: bold;
            display: flex;
            align-items: left;
            row-gap: 0px;
            padding-right: 20px; /* للغة الإنجليزية */
            justify-content: center;
        }

        .product-rating {
            color: #f39c12;
            font-size: 12px;
        }

        .product-actions {
            display: flex;
            gap: 4px;
            margin-top: auto;
             margin-bottom: 5px;
            justify-content: center;
        }

        .whatsapp-btn {
            background: #25D366;
            color: rgb(7, 0, 0);
            border: none;
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 16px;
            max-width: 50%;
        }

        .whatsapp-btn:hover {
            background: #10e6cd;
        }

        .whatsapp-btn .phone-number {
            font-size: 14px;
            margin-left: 5px;
        }

        .call-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .call-btn:hover {
            background: #d3dad4;
        }

    

        /* نافذة تفاصيل المنتج - التعديلات هنا */
        .product-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(243, 237, 237, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 15px 0;
        }

        .product-detail-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            animation: modalAppear 0.3s ease-out;
            margin: 20px 10px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .product-detail-header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-detail-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .close-detail-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-detail-modal:hover {
            transform: scale(1.1);
        }

        .product-detail-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
              background: linear-gradient(135deg, #ecf0f1, #f8f8f8);
        }

        .product-detail-images {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid #ada9a9;
        }

        .product-detail-main-image {
            height: 200px;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            width: 80%;
            margin: 0 auto;
        }

        .product-detail-main-image i {
            font-size: 80px;
            color: #7f8c8d;
        }

        .product-detail-main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease-in-out;
        }

        .product-detail-thumbnails {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .product-detail-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            overflow: hidden;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .product-detail-thumbnail.active {
            border-color: #3498db;
        }

        .product-detail-thumbnail:hover {
            transform: scale(1.05);
            border-color: #3498db;
        }

        .product-detail-thumbnail i {
            font-size: 20px;
            color: #7f8c8d;
        }

        .product-detail-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-detail-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            row-gap: 0px;
        }

        .product-detail-name {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .product-detail-descriptionLable {
            color: #f30a0a9d;
            font-size: 20px;
            font-weight: 700;
        }

        .product-detail-description {
            color: #020202;
            line-height: 1.5;
               min-height: 120px;
    resize: vertical;
    white-space: pre-line;
  
        }

        .product-detail-priceLable {
            font-size: 24px;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .product-detail-price {
            font-size: 24px;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .product-detail-rating {
            color: #f39c12;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .product-detail-attributes {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .product-detail-attribute:last-child {
            border-bottom: none;
        }

        .attribute-label {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .attribute-value {
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .product-detail-actions .whatsapp-btn,
        .product-detail-actions .call-btn,
        .product-detail-actions .favorite-icon {
            flex: 1;
        }
    .favorite-icon {
            background: #e9eef5;
            color: #f10909;
            padding: 8px;
            border-radius: 5px;
            border-color: #333;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            font-size: 18px;
        }

        .favorite-icon.active {
            color: #e74c3c;
            background: #ffeaea;
        }

        .favorite-icon:hover {
            color: #ffffff;
            background: #f82525;
        }
        
     .share-btn{
    background:#f80fec;
    color:#fff;
    border:none;
    padding:10px 12px;
    cursor:pointer;
    font-size:16px;
}
.share-btn:hover{
    background:#2980b9;
}
        /* تخصيص الخريطة للغة العربية */
        .leaflet-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       
        }

        .location-name {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        /* تحسين التمرير */
        .modal-body::-webkit-scrollbar,
        .product-detail-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track,
        .product-detail-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb,
        .product-detail-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover,
        .product-detail-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* تأثيرات الشرائح */
        .product-image-slide {
            transition: opacity 0.5s ease-in-out;
        }

        .product-image-slide.fade-out {
            opacity: 0;
        }

        .product-image-slide.fade-in {
            opacity: 1;
        }

        /* تحسينات للشاشات الصغيرة جداً */
        @media (max-width: 360px) {
            .navbar {
                padding: 10px;
            }
            
            .logo {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .company-name {
                font-size: 18px;
                color: #e3f2fd;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .filter-tab {
                min-width: 100%;
            }
            
            .product-actions {
                flex-direction: column;
                justify-content: center;
                
            }
            
            .whatsapp-btn {
                padding: 6px 8px;
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                border-radius: 10px;
            }
            
            .product-image {
                height: 100px; /* تعديل الارتفاع للشاشات الصغيرة */
                width: 90%; /* زيادة العرض قليلاً للشاشات الصغيرة */
                border-radius: 10px;
            }
            
            .product-image i {
                font-size: 40px;
                border-radius: 10px;
            }
            
            .product-info {
                padding: 10px;
            }
            
            .product-name {
                font-size: 20px;
                height: 36px;
                  white-space: normal; /* أو pre-wrap */
                word-wrap: break-word; /* لكسر الكلمات الطويلة */
                overflow-wrap: break-word; /* البديل الحديث */
                 word-break: break-word; /* لكسر النص عند الحاجة */
            }
            
            .view-details-btn {
                width: 80px;
                font-size: 12px;
                padding: 6px 15px;
            }
        }

        /* تفاصيل المنتج تحت الاسم مباشرة */
.product-details-containerVeiw {
  padding: 10px;
  border: 1px solid #ada9a9;
  border-radius: 4px;
  background: #ffffff;
  margin-bottom: 0px;
  row-gap: 1PX;
  min-height: 200px;
  height: 100%;

        }
.phone-icon-blue {
    color: #ff0022; /* أزرق فاتح */
}
        .product-details-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px;
        }

        .product-details-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 18px;
            font-style: bold;
        }

        .product-details-item i {
            color: #3498db;
        }

        .product-details-item.location {
            color: #0920f1;
        }

        .product-details-item.type {
            color: #166116;
        }

        .product-details-item.quantity {
            color: #e74c3c;
        }

        .product-details-item.condition {
            color: #9b59b6;
        }
        /* أنماط الملف الشخصي للمستخدم */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-phone {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-logout {

 background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        width: 100%;
        padding: 12px;
        font-Size: 16px;
        font-Weight: 600;
        margin-Top: 10px;
        border: none;
        border-Radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 480px) {
            .user-profile {
                gap: 5px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
            }
            
            .user-phone {
                font-size: 12px;
            }
            
            .btn-logout {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* أنماط زر إضافة المنتج */
        .add-product-section {
            margin-left: 15px;
        }

        .btn-add-product {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-add-product:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.4);
        }

        /* نافذة إضافة المنتج */
        .product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 15px 0;
        }

        .product-modal-content {
            background-color: white;
            width: 95%;
            max-width: 470px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            animation: modalAppear 0.3s ease-out;
            margin: 20px 10px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .product-modal-header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-modal-header h2 {
            font-size: 18px;
           
        }

        .close-product-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-product-modal:hover {
            transform: scale(1.1);
        }

        .product-modal-body {
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* تعديلات للصور في نموذج المنتج */
        .product-images-upload {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .product-image-upload {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #bdc3c7;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .product-image-upload:hover {
            border-color: #3498db;
            background-color: #e8f4fd;
        }

        .product-image-upload i {
            font-size: 24px;
            color: #7f8c8d;
        }

        .product-image-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-image-upload .remove-image {
            position: absolute;
            top: 2px;
            left: 2px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .product-image-upload:hover .remove-image {
            display: block;
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 480px) {
            .add-product-section {
                margin-left: 8px;
            }
            
            .btn-add-product {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .product-image-upload {
                width: 70px;
                height: 70px;
            }
        }

        /* زر الفلترة للمفضلة */
        .filter-tab.favorite {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            max-width: 20%;
            max-height: 20%;
        }

      


        .section-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header i {
            color: #3498db;
            font-size: 16px;
        }

        .section-header span {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .product-map-container {
            padding: 12px;
            border: 1px solid #ada9a9;
        }

        #product-detail-map {
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .map-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-map-control {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            justify-content: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-map-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-map-control#get-directions {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-map-control#get-directions:hover {
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        /* نافذة الخريطة الكاملة */
        .full-map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .full-map-content {
            background-color: white;
            width: 95%;
            max-width: 800px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.3s ease-out;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .full-map-header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .full-map-header h3 {
            font-size: 18px;
            margin: 0;
        }

        .close-full-map {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-full-map:hover {
            transform: scale(1.1);
        }

        .full-map-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #full-size-map {
            height: 400px;
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .map-info {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .map-info p {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .map-info i {
            color: #e74c3c;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .product-detail-map-section {
                margin-top: 12px;
            }
            
            #product-detail-map {
                height: 180px;
            }
            
            .map-controls {
                flex-direction: column;
            }
            
            .full-map-content {
                width: 98%;
                max-height: 80vh;
                margin: 10px;
            }
            
            #full-size-map {
                height: 300px;
            }
            
            .map-info {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            #product-detail-map {
                height: 150px;
            }
            
            .section-header {
                padding: 8px 12px;
            }
            
            .section-header span {
                font-size: 14px;
            }
            
            .product-map-container {
                padding: 10px;
              border: 1px solid #ada9a9;
            }
            
            .btn-map-control {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            #full-size-map {
                height: 250px;
            }
            
            .full-map-header {
                padding: 12px;
            }
            
            .full-map-header h3 {
                font-size: 16px;
            }
        }

        /* في قسم الأنماط CSS - أضف هذه الأنماط مع الأنماط الأخرى */
        /* أنماط خريطة المنتج */
        .product-map-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            margin-top: 10px;
        }

        .product-map-section .section-header {
            background: none;
            padding: 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .product-map-section .section-header i {
            color: #3498db;
            font-size: 16px;
        }

        .product-map-section .section-header span {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        #product-map {
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .product-map-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .product-map-controls .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .modal {
            display: none; /* مخفي بشكل افتراضي */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* خلفية شبه شفافة */
            z-index: 1000;
        }

        .modal-content {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 
                0 0 0 1px rgba(255, 255, 255, 0.1);
    overflow: hidden;
    transform: translateY(0);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modal-content:hover {
    transform: translateY(-5px);
}
.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
    position: relative;
}

.modal-header:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
}

.modal-header h2 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-footer {
    text-align: center;
    padding-top: 20px;
    border-top: 1px solid #eee;
    
    /* إضافة هذه الخصائص للتثبيت */
    position: sticky;
    bottom: 0;
    background-color: white; /* لون الخلفية حسب التصميم */
    z-index: 10;
}
        .close-btn {
            background-color: #ffffff; /* لون أحمر */
            color: rgb(250, 0, 0);
            border-color: #ff0000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            height: 18%;
            font-size: 24px;
            font-style: bold;
            padding: 10px 20px;
            cursor: pointer;
        }

        .close-btn:hover {
              background-color: #131212; /* لون أحمر */
            color: rgb(255, 255, 255);
        }

        /* إضافة إلى قسم الأنماط CSS */
        #custom-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* نافذة تسجيل الدخول المصغرة */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            animation: modalAppear 0.3s ease-out;
        }

        .login-modal-header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-modal-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .close-login-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-login-modal:hover {
            transform: scale(1.1);
        }
.login-modal.active {
    display: flex;
}
        .login-modal-body {
            padding: 20px;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .login-form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s, box-shadow 0.3s;
        }

        .login-form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-login-submit {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            height: 40px;
            align-self: center;
        }

        .btn-login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
        }

  .btn-login-secondary {
     display: block;
            text-align: left;
            margin-top: 6px;
            color: #4a90e2;
            font-size: 16px;
            text-decoration: none;
}

        .btn-forgot-password {
            display: block;
            text-align: left;
            margin-top: 6px;
            color: #4a90e2;
            font-size: 16px;
            text-decoration: none;
        }
/* أنماط لحقول كلمة المرور مع زر الإظهار */
.password-input-wrapper {
    position: relative;
    width: 100%;
}

.password-input-wrapper input {
    padding-right: 40px !important;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: #7f8c8d;
    font-size: 16px;
    padding: 5px;
    z-index: 2;
}

.toggle-password:hover {
    color: #3498db;
}

/* أنماط خاصة للنوافذ المختلفة */
.modal-body .password-input-wrapper {
    margin-bottom: 15px;
}

.login-form-group .password-input-wrapper {
    margin-bottom: 20px;
}
        .close-login-btn {
               display: block;
            text-align: left;
            margin-top: 6px;
            color: #4a90e2;
            font-size: 16px;
            text-decoration: none;
        }


        .login-form-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #666;
        }

        .login-form-footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }

        .login-form-footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 480px) {
            .login-modal-content {
                width: 95%;
                margin: 10px;
            }
        }
        /* أنماط لزر الحذف */
.btn-delete {
    background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
    color: white !important;
}

.btn-delete:hover {
    background: linear-gradient(135deg, #c0392b, #a93226) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3) !important;
}

/* أنماط لرقم الهاتف القابل للنقر */
.user-phone {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 5px 10px;
    border-radius: 5px;
}

.user-phone:hover {
    background-color: rgba(255, 255, 255, 0.1);
    text-decoration: underline;
}

/* أنماط لحقل رقم الهاتف للقراءة فقط */
input[readonly] {
    background-color: #f5f5f5;
    cursor: not-allowed;
    opacity: 0.8;
}
/* تحسينات نافذة التسجيل للشاشات الصغيرة */
@media (max-width: 768px) {
    .modal-content {
        width: 98% !important;
        margin: 10px auto !important;
        max-height: 90vh !important;
    }
    
    .modal-body {
        padding: 10px !important;
        max-height: calc(90vh - 120px) !important;
    }
    
    .form-row {
        margin: 0 -3px !important;
    }
    
    .form-group {
        margin: 0 3px 10px !important;
        flex: 1 0 100% !important;
    }
    
    .modal-header {
        padding: 12px !important;
    }
    
    .modal-header h2 {
        font-size: 16px !important;
    }
    
   .close-modal {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}
    
    .photo-circle {
        width: 80px !important;
        height: 80px !important;
    }
    
    .photo-circle i {
        font-size: 24px !important;
    }
    
    .photo-upload span {
        font-size: 14px !important;
    }
    
    .form-control {
        padding: 8px 10px !important;
        font-size: 14px !important;
    }
    
    label {
        font-size: 13px !important;
    }
    
    .map-container {
        height: 150px !important;
        margin-bottom: 8px !important;
    }
    
    .map-controls {
        flex-direction: column !important;
        gap: 5px !important;
    }
    
    .map-controls .btn {
        width: 100% !important;
        padding: 8px !important;
        font-size: 13px !important;
    }
    
    .btn-submit {
        padding: 10px !important;
        font-size: 15px !important;
    }
}

/* تحسينات إضافية للهواتف الصغيرة جداً */
@media (max-width: 480px) {
    .modal-content {
        width: 99% !important;
        margin: 5px auto !important;
        border-radius: 8px !important;
    }
    
    .modal-body {
        padding: 8px !important;
        max-height: calc(85vh - 110px) !important;
    }
    
    .form-group {
        margin-bottom: 8px !important;
    }
    
    .photo-circle {
        width: 70px !important;
        height: 70px !important;
    }
    
    .modal-header {
        padding: 10px !important;
    }
    
    .modal-header h2 {
        font-size: 15px !important;
    }
    
    .close-modal {
        font-size: 18px !important;
        padding: 0 !important;
    }
    
    .form-control {
        padding: 7px 8px !important;
        font-size: 13px !important;
    }
    
    .map-container {
        height: 120px !important;
    }
    
    .btn-submit {
        padding: 9px !important;
        font-size: 14px !important;
        margin-top: 5px !important;
    }
}

/* تحسينات للدورات الأفقية (landscape) */
@media (max-width: 768px) and (orientation: landscape) {
    .modal-content {
        max-height: 85vh !important;
    }
    
    .modal-body {
        max-height: calc(85vh - 100px) !important;
        overflow-y: auto !important;
    }
    
    .form-group {
        margin-bottom: 6px !important;
    }
    
    .form-control {
        padding: 6px 8px !important;
    }
}

/* تحسين التمرير للنوافذ على الجوال */
.modal-body {
    -webkit-overflow-scrolling: touch !important;
    overflow-y: auto !important;
}

/* إصلاح مشكلة position للنافذة على الجوال */
.modal {
    align-items: flex-start !important;
    padding-top: 20px !important;
    padding-bottom: 20px !important;
    overflow-y: auto !important;
}

/* منع التكبير التلقائي على حقول الإدخال في iOS */
@media (max-width: 768px) {
    input[type="text"],
    input[type="tel"],
    input[type="password"],
    select,
    textarea {
        font-size: 16px !important; /* منع التكبير في iOS */
    }
    
    .form-control:focus {
        font-size: 16px !important;
    }
}
/* إضافة أنماط لرقم المنتج */
.product-number {
    color: #7f8c8d;
    font-size: 14px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border-right: 3px solid #3498db;
}

.product-number i {
    color: #3498db;
}

.product-number span {
    font-weight: 600;
    color: #2c3e50;
}
/* تحسين عرض القوائم المنسدلة على الجوال */
@media (max-width: 768px) {
    select.form-control {
        padding-right: 25px !important;
        background-position: right 8px center !important;
    }
}
/* أنماط نافذة إدارة المنتجات */
.product-management-section {
    margin-top: 20px;
    border-top: 2px solid #3498db;
    padding-top: 15px;
}

.product-management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.product-management-header h3 {
    color: #2c3e50;
    font-size: 18px;
    margin: 0;
}

.btn-manage-products {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-manage-products:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
}

/* نافذة إدارة المنتجات */
.products-management-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 15px;
}

.products-management-content {
    background-color: white;
    width: 95%;
    max-width: 800px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    animation: modalAppear 0.3s ease-out;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.products-management-header {
    background: linear-gradient(135deg, #2c3e50, #bdcbf0);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.products-management-header h2 {
    font-size: 18px;
    margin: 0;
}

.close-products-management {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}

.close-products-management:hover {
    transform: scale(1.1);
}

.products-management-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

/* جدول المنتجات */
.products-table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 8px;
    border: 1px solid #eee;
}

.products-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
}

.products-table th {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 12px 15px;
    text-align: right;
    font-weight: 600;
    font-size: 14px;
}

.products-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    text-align: right;
    font-size: 14px;
}

.products-table tr:hover {
    background-color: #f8f9fa;
}

.products-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* أزرار الإجراءات في الجدول */
.btn-action {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-edit {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
}

.btn-edit:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-2px);
}

.btn-delete {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.btn-delete:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
}

/* نافذة إضافة/تعديل الطلب */
.order-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1100;
    justify-content: center;
    align-items: center;
    padding: 15px;
}

.order-modal-content {
    background-color: white;
    width: 95%;
    max-width: 500px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    animation: modalAppear 0.3s ease-out;
}

.order-modal-header {
    background: linear-gradient(135deg, #2c3e50, #4a69bd);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-modal-header h2 {
    font-size: 18px;
    margin: 0;
}

.close-order-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}

.close-order-modal:hover {
    transform: scale(1.1);
}

.order-modal-body {
    padding: 20px;
    max-height: 80vh;
    overflow-y: auto;
}

/* الحسابات التلقائية */
.calculation-results {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #e9ecef;
}

.calculation-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #dee2e6;
}

.calculation-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.calculation-label {
    font-weight: 600;
    color: #2c3e50;
}

.calculation-value {
    font-weight: 700;
    color: #e74c3c;
}

.calculation-value.total {
    font-size: 18px;
    color: #27ae60;
}

/* إحصائيات المنتجات */
.products-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(30px, 100px));
    gap: 5px;
    margin-bottom: 10px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    border: 1px solid #eee;
}

.stat-value {
    font-size: 18px;
    font-weight: 100;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #7f8c8d;
}

.stat-card.total {
    border-top: 4px solid #3498db;
}

.stat-card.active {
    border-top: 4px solid #2ecc71;
}

.stat-card.inactive {
    border-top: 4px solid #e74c3c;
}

.stat-card.expired {
    border-top: 4px solid #f39c12;
}

/* حالة الإدارة - للمسؤول فقط */
.admin-only {
    display: none;
}

.user-is-admin .admin-only {
    display: block;
}
/* أنماط نافذة إدارة الطلبات */
.order-management-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 15px;
}

.order-management-content {
    background-color: white;
    width: 95%;
    max-width: 1200px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    animation: modalAppear 0.3s ease-out;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.order-management-header {
    background: linear-gradient(135deg, #2c3e50, #4a69bd);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-management-header h2 {
    font-size: 18px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-order-management {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}

.close-order-management:hover {
    transform: scale(1.1);
}

.order-management-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

/* إحصائيات الطلبات */
.orders-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

/* جدول الطلبات */
.orders-table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 8px;
    border: 1px solid #eee;
    max-height: 400px;
    overflow-y: auto;
}

.orders-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.orders-table th {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 12px 15px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.orders-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    text-align: center;
    font-size: 14px;
}

.orders-table tr:hover {
    background-color: #f8f9fa;
}

.orders-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* أزرار إدارة الطلبات */
.btn-manage-orders {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-manage-orders:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
}

.btn-add-order {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-add-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .order-management-content {
        width: 98%;
        margin: 5px;
    }
    
    .orders-table th,
    .orders-table td {
        padding: 8px 10px;
        font-size: 12px;
    }
    
    .orders-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.status-badge.active {
    background-color: #2ecc71;
}

.status-badge.inactive {
    background-color: #e74c3c;
}

.status-badge.expired {
    background-color: #f39c12;
}

.status-badge.cancelled {
    background-color: #95a5a6;
}
/* الصف الأفقي لجميع الحقول */
.form-row-horizontal {
    display: flex;
    flex-direction: row;
    gap: 8px;
    justify-content: center;
    margin-bottom: 15px;
    align-items: center;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 10px 5px;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #070707;
    font-size: 16px;
}

.form-field-inline {
    display: flex;
    flex-direction: column;
    min-width: 100px;
    max-width: 120px;
    flex-shrink: 0;
    font-size: 16px;
    margin-right: 12px;
    
}

.field-label {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    text-align: center;
    white-space: nowrap;
    padding: 0 5px;
}

.form-control-inline {
    width: 100%;
    padding: 6px 8px;
    font-size: 13px;
    height: 36px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    text-align: center;
}

.form-control-inline:read-only,
.form-control-inline[readonly] {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

.form-control-inline:focus {
    border-color: #000000;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    outline: none;
}

/* تحديد عرض كل حقل حسب محتواه */
#orderNo {
    min-width: 140px;
    background-color: azure;
    border-color: #000000;
     font-size: 14px;
}

#orderDate, #expiryDate {
    min-width: 100px;
     background-color: azure;
    border-color: #000000;
     font-size: 16px;
}

#orderQuantity {
    min-width: 80px;
     background-color: rgb(255, 255, 255);
    border-color: #000000;
     font-size: 16px;
}

#unitPrice, #totalPrice, #taxAmount {
    min-width: 80px;
     background-color: azure;
    border-color: #000000;
    font-size: 16px;
}
#grandTotal {
    min-width: 80px;
     background-color: rgb(233, 218, 7);
    border-color: #f00303;
    font-size: 20px;
    font-style: oblique;
}
#orderStatus {
    min-width: 100px;
     background-color: azure;
    border-color: #000000;
     font-size: 16px;
}

/* شريط التمرير الأفقي */
.form-row-horizontal::-webkit-scrollbar {
    height: 6px;
    min-width: 120px;
}

.form-row-horizontal::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.form-row-horizontal::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.form-row-horizontal::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* للشاشات الكبيرة جداً - عدم وجود تمرير */
@media (min-width: 1600px) {
    .form-row-horizontal {
        flex-wrap: wrap;
        overflow-x: visible;
        justify-content: center;
        gap: 15px;
    }
    
    .form-field-inline {
        min-width: 140px;
        max-width: 160px;
    }
}

/* للشاشات المتوسطة */
@media (max-width: 1400px) {
    .form-field-inline {
        min-width: 110px;
        max-width: 130px;
    }
    
    .form-control-inline {
        padding: 5px 6px;
        font-size: 12px;
        height: 34px;
    }
}

/* للشاشات الصغيرة - بقاء التمرير الأفقي */
@media (max-width: 768px) {
    .form-row-horizontal {
        gap: 6px;
        padding: 8px 3px;
    }
    
    .form-field-inline {
        min-width: 100px;
        max-width: 120px;
    }
    .field-text {
        font-size:18px;
        color: #000000;
    }
    .field-label {
         font-size: 18px;
    color: #000000;
  }
  .orderNo {
    min-width: 140px;
    background-color: azure;
    border-color: #000000;
     font-size: 12px;
    }
    
    .form-control-inline {
        padding: 4px 5px;
        font-size: 11px;
        height: 32px;
    }

}
/* أنماط زر طلب التنشيط */
.btn-activate {
    background: linear-gradient(135deg, #25D366, #128C7E) !important;
    color: white !important;
    padding: 6px 12px !important;
    border: none !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.btn-activate:hover {
    background: linear-gradient(135deg, #128C7E, #075E54) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3) !important;
}

.btn-activate:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
}

.btn-activate i {
    font-size: 14px !important;
}
.form-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
  font-size: 16px;
}

.form-field-inline {
  display: flex;
  flex-direction: column;
  flex: 1 1 calc(33.333% - 10px); /* ثلاثة أعمدة للشاشات الصغيرة */
  min-width: 0;
}

/* للشاشات الكبيرة */
@media (min-width: 769px) {
  .form-field-inline {
    flex: 1 1 calc(11.111% - 10px); /* 9 حقول = 100/9 ≈ 11.111% */
    /* أو استخدم flex: 1 لجعلها تأخذ مساحة متساوية */
  }
}

/* للشاشات الصغيرة جداً */
@media (max-width: 480px) {
  .form-field-inline {
    flex: 1 1 calc(50% - 10px); /* عمودين */

}
}
/* أنماط قسم اختيار الطلب */
.order-selection-section {
    border: 2px solid #3498db;
    position: relative;
}

.order-selection-section:before {
    content: 'خطوة 1: اختر طلب مفعل';
    position: absolute;
    top: -10px;
    right: 10px;
    background: #3498db;
    color: white;
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.form-body.hidden {
    display: none;
}

.form-body.visible {
    display: block;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .order-selection-section .form-row {
        flex-direction: column;
    }
    
    .order-selection-section .form-group {
        width: 100%;
    }
}
/* أنماط زر طلباتي في الشريط العلوي */
.my-orders-section {
    margin-left: 10px;
}

.btn-my-orders {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-my-orders:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(155, 89, 182, 0.4);
}

/* نافذة طلباتي الأساسية */
.my-orders-modal {
    display: none; /* هذا مهم - النافذة مخفية افتراضياً */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 15px;
}

.my-orders-content {
    background-color: white;
    width: 95%;
    max-width: 900px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    animation: modalAppear 0.3s ease-out;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.my-orders-header {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.my-orders-header h2 {
    font-size: 18px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-my-orders {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}

.close-my-orders:hover {
    transform: scale(1.1);
}

.my-orders-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

.my-orders-footer {
    padding: 15px;
    text-align: center;
    border-top: 1px solid #eee;
}

/* أنماط شريط أزرار المستخدم */
.navbar-buttons {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-right: auto;
    margin-left: 20px;
}

/* زر طلباتي في الشريط العلوي */
.my-orders-section-nav {
    display: flex;
    align-items: center;
}

.btn-my-orders-nav {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-my-orders-nav:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(155, 89, 182, 0.4);
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .navbar-buttons {
        gap: 8px;
        margin-left: 10px;
    }
    
    .btn-my-orders-nav {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    .btn-my-orders-nav i {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .navbar-buttons {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
    }
}

/* إحصائيات الطلبات */
.orders-stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.orders-stats-container .stat-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #eee;
    transition: all 0.3s ease;
}

.orders-stats-container .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
}

.orders-stats-container .stat-card.total {
    border-top: 4px solid #3498db;
}

.orders-stats-container .stat-card.active {
    border-top: 4px solid #2ecc71;
}

.orders-stats-container .stat-card.inactive {
    border-top: 4px solid #f39c12;
}

.orders-stats-container .stat-card.expired {
    border-top: 4px solid #e74c3c;
}

.orders-stats-container .stat-card.cancelled {
    border-top: 4px solid #95a5a6;
}

.orders-stats-container .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.orders-stats-container .stat-label {
    font-size: 14px;
    color: #7f8c8d;
}

/* زر إضافة طلب جديد */
.add-order-btn-container {
    text-align: center;
    margin: 25px 0;
}

.add-order-btn-container .btn-add-order {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
}

.add-order-btn-container .btn-add-order:hover {
    background: linear-gradient(135deg, #27ae60, #219653);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.4);
}

/* قائمة الطلبات */
.orders-list-container {
    margin-top: 20px;
}

.orders-list-container h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
}

.orders-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
}

/* تصميم بطاقة الطلب */
.order-card {
    background: white;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 15px;
    transition: all 0.3s ease;
}

.order-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.order-number {
    font-weight: 700;
    color: #2c3e50;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.order-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    min-width: 80px;
    text-align: center;
}

.status-active {
    background-color: #2ecc71;
}

.status-inactive {
    background-color: #f39c12;
}

.status-expired {
    background-color: #e74c3c;
}

.status-cancelled {
    background-color: #95a5a6;
}

.order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.order-detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 600;
    margin-bottom: 3px;
}

.detail-value {
    font-size: 14px;
    color: #2c3e50;
    font-weight: 500;
}

.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    justify-content: flex-end;
}

.btn-edit-order, .btn-share-order {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-edit-order {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.btn-edit-order:hover {
    background: linear-gradient(135deg, #2980b9, #2471a3);
    transform: translateY(-2px);
}

.btn-share-order {
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: white;
}

.btn-share-order:hover {
    background: linear-gradient(135deg, #128C7E, #075E54);
    transform: translateY(-2px);
}

/* زر الإغلاق */
.close-btn {
    background-color: #ffffff;
    color: rgb(250, 0, 0);
    border: 1px solid #ff0000;
    padding: 10px 30px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background-color: #ff0000;
    color: white;
}

/* رسائل */
.no-orders-message {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-orders-message i {
    font-size: 50px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.no-orders-message h3 {
    margin: 10px 0;
    color: #2c3e50;
}

.no-orders-message p {
    color: #999;
}

.loading-orders {
    text-align: center;
    padding: 30px;
    color: #666;
}

.loading-orders .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #9b59b6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .orders-stats-container {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .orders-list {
        max-height: 300px;
    }
    
    .order-details {
        grid-template-columns: 1fr;
    }
    
    .order-actions {
        flex-direction: column;
    }
    
    .btn-edit-order, .btn-share-order {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .orders-stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .orders-stats-container .stat-card {
        padding: 10px;
    }
    
    .orders-stats-container .stat-value {
        font-size: 20px;
    }
    
    .orders-stats-container .stat-label {
        font-size: 12px;
    }
    
    .my-orders-content {
        width: 98%;
        margin: 5px;
    }
    
    .btn-my-orders {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    .btn-my-orders i {
        font-size: 12px;
    }
}
/* تحسينات نافذة طلباتي للشاشات الصغيرة */
@media (max-width: 768px) {
    .my-orders-content {
        width: 98% !important;
        max-height: 95vh !important;
        margin: 10px !important;
    }
    
    .my-orders-header {
        padding: 12px 15px !important;
        flex-direction: column !important;
        gap: 10px !important;
    }
    
    .my-orders-header h2 {
        font-size: 16px !important;
        text-align: center !important;
    }
    
    .close-my-orders {
        position: absolute !important;
        top: 10px !important;
        left: 15px !important;
        font-size: 20px !important;
    }
    
    .my-orders-body {
        padding: 15px !important;
        max-height: calc(95vh - 150px) !important;
        overflow-y: auto !important;
    }
    
    .orders-stats-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
        margin-bottom: 15px !important;
    }
    
    .orders-stats-container .stat-card {
        padding: 12px !important;
    }
    
    .orders-stats-container .stat-value {
        font-size: 20px !important;
    }
    
    .orders-stats-container .stat-label {
        font-size: 12px !important;
    }
    
    .orders-list-container h3 {
        font-size: 16px !important;
        padding: 8px 0 !important;
    }
    
    .order-card {
        padding: 12px !important;
    }
    
    .order-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
    }
    
    .order-number {
        font-size: 14px !important;
    }
    
    .order-status {
        align-self: flex-start !important;
        font-size: 11px !important;
        padding: 4px 8px !important;
    }
    
    .order-details {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
    }
    
    .order-actions {
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    .btn-edit-order, 
    .btn-share-order {
        width: 100% !important;
        justify-content: center !important;
        padding: 10px !important;
    }
    
    .my-orders-footer {
        padding: 12px !important;
    }
    
    .close-btn {
        width: 100% !important;
        padding: 12px !important;
        font-size: 16px !important;
    }
}

@media (max-width: 480px) {
    .my-orders-content {
        width: 99% !important;
        margin: 5px !important;
        border-radius: 8px !important;
    }
    
    .orders-stats-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
    }
    
    .orders-stats-container .stat-card {
        padding: 10px !important;
    }
    
    .orders-stats-container .stat-value {
        font-size: 16px !important;
    }
    
    .orders-stats-container .stat-label {
        font-size: 11px !important;
    }
    
    .order-card {
        margin-bottom: 10px !important;
    }
    
    .detail-label {
        font-size: 11px !important;
    }
    
    .detail-value {
        font-size: 13px !important;
    }
}

/* دعم التوجيه الأفقي للهواتف */
@media (max-width: 768px) and (orientation: landscape) {
    .my-orders-content {
        max-height: 85vh !important;
        width: 95% !important;
    }
    
    .my-orders-body {
        max-height: calc(85vh - 120px) !important;
    }
    
    .orders-stats-container {
        grid-template-columns: repeat(3, 1fr) !important;
    }
    
    .orders-list {
        max-height: 250px !important;
    }
}

/* تحسين التمرير على الجوال */
.my-orders-body {
    -webkit-overflow-scrolling: touch !important;
    scroll-behavior: smooth !important;
}

/* إخفاء شريط التمرير في بعض المتصفحات */
.my-orders-body::-webkit-scrollbar {
    width: 5px !important;
}

.my-orders-body::-webkit-scrollbar-track {
    background: #f1f1f1 !important;
    border-radius: 10px !important;
}

.my-orders-body::-webkit-scrollbar-thumb {
    background: #c1c1c1 !important;
    border-radius: 10px !important;
}

/* تحسين قابلية النقر على الجوال */
.order-card, 
.btn-edit-order, 
.btn-share-order, 
.close-btn {
    -webkit-tap-highlight-color: transparent !important;
    touch-action: manipulation !important;
}

/* منع تكبير النص في iOS */
@media (max-width: 768px) {
    .my-orders-content * {
        -webkit-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
    }
    
    input, select, textarea, button {
        font-size: 16px !important; /* منع التكبير في iOS */
    }
}
/* أضف هذا في قسم الأنماط CSS */
.orders-management-section {
    margin-left: 10px;
    display: flex;
    align-items: center;
}

.btn-manage-orders {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-manage-orders:hover {
    background: linear-gradient(135deg, #2980b9, #2471a3);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .orders-management-section {
        margin-left: 8px;
    }
    
    .btn-manage-orders {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    .btn-manage-orders i {
        font-size: 12px;
    }
}
@media (max-width: 768px) {
    .counters-section {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .counter-card {
        padding: 12px;
    }
    
    .counter-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .counter-value {
        font-size: 20px;
    }
    
    .counter-label {
        font-size: 12px;
        color: red;
    }
    
    #userPhoneDisplay {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .counters-section {
        grid-template-columns: 1fr;
    }
}
/* أنماط شروط التسجيل */
/* أنماط شروط التسجيل */
.terms-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #e9ecef;
}

.terms-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #3498db;
}

.terms-checkbox label {
    font-size: 14px;
    color: #333;
    cursor: pointer;
    margin: 0;
}

.terms-link {
    color: #3498db;
    text-decoration: underline;
    cursor: pointer;
    font-weight: bold;
    padding: 2px 5px;
}

.terms-link:hover {
    color: #2980b9;
    background: #f1f9ff;
    border-radius: 3px;
}

.terms-content {
    display: none;
    margin-top: 10px;
    padding: 0;
    border: 2px solid #3498db;
    border-radius: 8px;
    background-color: #fff;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.terms-header {
    background: #3498db;
    color: white;
    padding: 15px;
    text-align: center;
    border-radius: 6px 6px 0 0;
}

.terms-header h3 {
    margin: 0;
    font-size: 18px;
}

.terms-body {
    padding: 20px;
    max-height: 300px;
    overflow-y: auto;
}

.terms-body p {
    margin-bottom: 12px;
    line-height: 1.6;
    font-size: 14px;
    color: #555;
    padding-right: 10px;
    border-bottom: 1px dashed #eee;
    padding-bottom: 8px;
}

.terms-body p:last-child {
    border-bottom: none;
}

.terms-body strong {
    color: #2c3e50;
}

.terms-footer {
    padding: 15px;
    background: #f8f9fa;
    text-align: center;
    border-radius: 0 0 6px 6px;
    border-top: 1px solid #e9ecef;
     justify-items: center;
}

#closeTermsBtn {
    padding: 8px 25px;
    background: #3498db;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

#closeTermsBtn:hover {
    background: #2980b9;
}
.product-dates {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.product-date {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #555;
}

.product-date i {
    width: 16px;
    text-align: center;
    color: #3498db;
}

.product-date.expired i {
    color: #e74c3c;
}

.date-title {
    font-weight: bold;
    color: #333;
    min-width: 90px;
}

.date-value {
    color: #666;
    flex-grow: 1;
}

/* إضافة أنماط للتأكيد على التاريخ انتهى */
.product-date.expired .date-value {
    color: #e74c3c;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
 /* نافذة التعديل المستقلة */
 /* أنماط نافذة التعديل المستقلة */
.edit-product-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 999999;
    animation: fadeIn 0.3s ease;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.edit-product-modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(3px);
}

.edit-product-modal-content {
    background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    width: 95%;
    max-width: 900px;
    max-height: 95vh;
    border-radius: 20px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
    border: 2px solid #3498db;
    transform: translateY(0);
    transition: transform 0.3s;
}

.edit-product-modal-content:hover {
    transform: translateY(-5px);
}

.edit-product-modal-header {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    padding: 25px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid #2573a7;
    position: relative;
    overflow: hidden;
}

.edit-product-modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
}

.edit-product-modal-header h3 {
    margin: 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.edit-product-modal-header h3 i {
    font-size: 28px;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
}

#editProductNo {
    font-size: 16px;
    background: rgba(255,255,255,0.15);
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    margin-right: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.edit-product-modal-close {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    font-size: 24px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 1;
    backdrop-filter: blur(5px);
}

.edit-product-modal-close:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255,255,255,0.5);
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.edit-product-modal-body {
    padding: 0;
    flex: 1;
    overflow-y: auto;
    background: #f5f7fa;
}

.edit-product-modal-footer {
    padding: 20px 30px;
    background: linear-gradient(to right, #f8f9fa, #eef2f7);
    border-top: 2px solid #e1e8f0;
    display: flex;
    justify-content: space-between;
    gap: 20px;
    box-shadow: 0 -3px 15px rgba(0,0,0,0.05);
}

.edit-modal-btn {
    padding: 14px 35px;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 17px;
    min-width: 180px;
    letter-spacing: 0.3px;
    position: relative;
    overflow: hidden;
}

.edit-modal-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.7s;
}

.edit-modal-btn:hover::before {
    left: 100%;
}

.edit-modal-btn-save {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
    border: 1px solid rgba(255,255,255,0.2);
}

.edit-modal-btn-save:hover {
    background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
}

.edit-modal-btn-save:active {
    transform: translateY(-1px) scale(0.98);
}

.edit-modal-btn-close {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
    border: 1px solid rgba(255,255,255,0.2);
}

.edit-modal-btn-close:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
}

.edit-modal-btn i {
    font-size: 18px;
    transition: transform 0.3s;
}

.edit-modal-btn:hover i {
    transform: scale(1.2);
}

@keyframes fadeIn {
    from { 
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to { 
        opacity: 1;
        backdrop-filter: blur(3px);
    }
}

@keyframes slideUp {
    from { 
        transform: translateY(80px) scale(0.95); 
        opacity: 0; 
    }
    to { 
        transform: translateY(0) scale(1); 
        opacity: 1; 
    }
}

/* نماذج داخل النافذة */
.standalone-form-container {
    padding: 30px;
}

.standalone-form-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    border: 1px solid #e8f4fd;
    transition: transform 0.3s, box-shadow 0.3s;
}

.standalone-form-section:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eef5fc;
}

.section-header i {
    font-size: 22px;
    color: #3498db;
    background: #e8f4fd;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.section-header h4 {
    margin: 0;
    color: #2c3e50;
    font-size: 20px;
    font-weight: 700;
}

.standalone-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.standalone-form-group {
    margin-bottom: 20px;
}

.standalone-form-group label {
    display: block;
    margin-bottom: 8px;
    color: #2c3e50;
    font-weight: 600;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.standalone-form-group label i {
    color: #3498db;
    font-size: 16px;
}

.standalone-form-control {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e1e8f0;
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s;
    background: white;
    color: #2c3e50;
}

.standalone-form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
    outline: none;
    transform: translateY(-1px);
}

.standalone-form-control:disabled {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

/* حقل التواريخ مع تنسيق عربي */
.date-input-group {
    position: relative;
}

.date-input-group .standalone-form-control {
    padding-left: 45px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233498db'%3E%3Cpath d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM5 8V6h14v2H5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 15px center;
    background-size: 20px;
    font-weight: 600;
    color: #2c3e50;
}

.date-input-group::after {
    content: '📅';
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}

/* معاينة الصور */
.standalone-images-section {
    margin-top: 10px;
}

.images-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.image-preview-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid #e1e8f0;
    transition: all 0.3s;
    height: 150px;
    background: #f8f9fa;
}

.image-preview-item:hover {
    transform: translateY(-5px) scale(1.03);
    border-color: #3498db;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s;
}

.image-preview-item:hover img {
    transform: scale(1.1);
}

.image-preview-item .image-number {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(52, 152, 219, 0.9);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

.no-images-message {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

.no-images-message i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #adb5bd;
    display: block;
}

/* حقل الوصف */
.standalone-textarea {
    min-height: 120px;
    resize: vertical;
    line-height: 1.6;
}

/* قسم المعلومات */
.product-info-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #e8f4fd;
    color: #2c3e50;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin: 5px;
    border: 1px solid #b3d7ff;
}

.product-info-badge i {
    color: #3498db;
}

/* زر تحميل الصور */
.upload-images-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    transition: all 0.3s;
    margin-top: 15px;
}

.upload-images-btn:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(155, 89, 182, 0.3);
}

/* شريط التمرير */
.edit-product-modal-body::-webkit-scrollbar {
    width: 10px;
}

.edit-product-modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
    margin: 10px 0;
}

.edit-product-modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #3498db, #2980b9);
    border-radius: 5px;
    border: 2px solid #f1f1f1;
}

.edit-product-modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #2980b9, #2573a7);
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .edit-product-modal-content {
        width: 98%;
        max-height: 98vh;
        border-radius: 15px;
        margin: 10px;
    }
    
    .edit-product-modal-header {
        padding: 20px;
    }
    
    .edit-product-modal-header h3 {
        font-size: 20px;
        flex-wrap: wrap;
    }
    
    .edit-product-modal-body {
        padding: 15px;
    }
    
    .standalone-form-container {
        padding: 20px;
    }
    
    .standalone-form-section {
        padding: 20px;
    }
    
    .standalone-form-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .edit-modal-btn {
        min-width: 140px;
        padding: 12px 20px;
        font-size: 15px;
    }
    
    .edit-product-modal-footer {
        flex-direction: column;
        gap: 15px;
    }
    
    .images-preview-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* رسالة التحميل */
#editFormLoading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    text-align: center;
}

.loading-spinner {
    width: 70px;
    height: 70px;
    border: 5px solid #e8f4fd;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 25px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #3498db;
    font-size: 18px;
    font-weight: 600;
    margin-top: 15px;
    background: linear-gradient(90deg, #3498db, #2ecc71, #3498db);
    background-size: 200% auto;
    -webkit-text-fill-color: transparent;
    animation: shimmer 2s linear infinite;
}

@keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
}
/* تعديل عام لجميع النوافذ للشاشات الصغيرة */
@media (max-width: 768px) {
    /* جعل النافذة تأخذ كامل الشاشة */
    .modal,
    .product-detail-modal,
    .product-modal,
    .products-management-modal,
    .order-management-modal,
    .my-orders-modal,
    .login-modal,
    .order-modal,
    .full-map-modal {
        padding: 0 !important;
        align-items: flex-start !important;
        background-color: rgba(0, 0, 0, 0.9) !important;
    }

    /* جعل محتوى النافذة يأخذ كامل الشاشة */
    .modal-content,
    .product-detail-content,
    .product-modal-content,
    .products-management-content,
    .order-management-content,
    .my-orders-content,
    .login-modal-content,
    .order-modal-content,
    .full-map-content {
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        display: flex !important;
        flex-direction: column !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1001 !important;
    }

    /* جعل الهيدر ثابت في الأعلى */
    .modal-header,
    .product-detail-header,
    .product-modal-header,
    .products-management-header,
    .order-management-header,
    .my-orders-header,
    .login-modal-header,
    .order-modal-header,
    .full-map-header {
        padding: 15px !important;
        flex-shrink: 0 !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 1002 !important;
        background: linear-gradient(135deg, #2c3e50, #4a69bd) !important;
    }

    /* جعل الجسم يأخذ المساحة المتبقية */
    .modal-body,
    .product-detail-body,
    .product-modal-body,
    .products-management-body,
    .order-management-body,
    .my-orders-body,
    .login-modal-body,
    .order-modal-body,
    .full-map-body {
        flex: 1 !important;
        padding: 15px !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        max-height: none !important;
    }

    /* تحسين عرض الأزرار في الهيدر */
    .modal-header h2,
    .product-detail-header h2,
    .product-modal-header h2,
    .products-management-header h2,
    .order-management-header h2,
    .my-orders-header h2,
    .login-modal-header h2,
    .order-modal-header h2,
    .full-map-header h3 {
        font-size: 18px !important;
        margin: 0 !important;
        flex: 1 !important;
        text-align: center !important;
    }

    /* تحسين أزرار الإغلاق */
    .close-modal,
    .close-detail-modal,
    .close-product-modal,
    .close-products-management,
    .close-order-management,
    .close-my-orders,
    .close-login-modal,
    .close-order-modal,
    .close-full-map {
        background: rgba(255, 255, 255, 0.2) !important;
        border: none !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: white !important;
        font-size: 24px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        backdrop-filter: blur(10px) !important;
        position: relative !important;
        z-index: 1003 !important;
        flex-shrink: 0 !important;
        margin: 0 !important;
    }

    .close-modal:hover,
    .close-detail-modal:hover,
    .close-product-modal:hover,
    .close-products-management:hover,
    .close-order-management:hover,
    .close-my-orders:hover,
    .close-login-modal:hover,
    .close-order-modal:hover,
    .close-full-map:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        transform: rotate(90deg) !important;
    }

    /* تحسين حقول الإدخال */
    .form-control,
    .login-form-control,
    .form-control-inline {
        font-size: 16px !important; /* لمنع التكبير في iOS */
        padding: 12px 15px !important;
        height: 48px !important;
    }

    /* تحسين الأزرار الرئيسية */
    .btn-submit,
    .btn-login-submit,
    .btn-logout,
    .btn-primary,
    .btn-secondary,
    .btn-map-control,
    .btn-add-order,
    .close-btn {
        height: 50px !important;
        min-height: 50px !important;
        font-size: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 10px 0 !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
    }

    /* تحسين الخرائط */
    .map-container,
    #map,
    #product-detail-map,
    #product-map,
    #full-size-map {
        height: 200px !important;
        min-height: 200px !important;
        flex-shrink: 0 !important;
    }

    /* تحسين الجداول للشاشات الصغيرة */
    .products-table-container,
    .orders-table-container {
        max-height: 300px !important;
        overflow-x: auto !important;
        overflow-y: auto !important;
        border: 1px solid #ddd !important;
        border-radius: 8px !important;
        margin: 10px 0 !important;
    }

    .products-table,
    .orders-table {
        min-width: 600px !important;
    }

    /* تحسين الصور */
    .photo-circle {
        width: 100px !important;
        height: 100px !important;
        margin: 10px auto !important;
    }

    .product-detail-main-image {
        height: 220px !important;
        min-height: 220px !important;
    }

    .product-detail-thumbnails {
        flex-wrap: wrap !important;
        justify-content: center !important;
        padding: 10px !important;
    }

    .product-detail-thumbnail {
        width: 60px !important;
        height: 60px !important;
        margin: 5px !important;
    }
}

/* تحسينات إضافية للشاشات الصغيرة جدًا */
@media (max-width: 480px) {
    /* تصغير الهيدر قليلاً */
    .modal-header,
    .product-detail-header,
    .product-modal-header,
    .products-management-header,
    .order-management-header,
    .my-orders-header,
    .login-modal-header,
    .order-modal-header,
    .full-map-header {
        padding: 12px 15px !important;
    }

    .modal-header h2,
    .product-detail-header h2,
    .product-modal-header h2,
    .products-management-header h2,
    .order-management-header h2,
    .my-orders-header h2,
    .login-modal-header h2,
    .order-modal-header h2,
    .full-map-header h3 {
        font-size: 16px !important;
    }

    /* تصغير أزرار الإغلاق */
    .close-modal,
    .close-detail-modal,
    .close-product-modal,
    .close-products-management,
    .close-order-management,
    .close-my-orders,
    .close-login-modal,
    .close-order-modal,
    .close-full-map {
        width: 36px !important;
        height: 36px !important;
        font-size: 20px !important;
    }

    /* تقليل padding الداخلي */
    .modal-body,
    .product-detail-body,
    .product-modal-body,
    .products-management-body,
    .order-management-body,
    .my-orders-body,
    .login-modal-body,
    .order-modal-body,
    .full-map-body {
        padding: 12px !important;
    }

    /* تصغير الخرائط */
    .map-container,
    #map,
    #product-detail-map,
    #product-map,
    #full-size-map {
        height: 180px !important;
        min-height: 180px !important;
    }

    /* تصغير الصور */
    .photo-circle {
        width: 80px !important;
        height: 80px !important;
    }

    .product-detail-main-image {
        height: 180px !important;
        min-height: 180px !important;
    }

    .product-detail-thumbnail {
        width: 50px !important;
        height: 50px !important;
    }

    /* تحسين الحقول في صف واحد */
    .form-row-horizontal {
        padding: 8px 5px !important;
        gap: 5px !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
    }

    .form-field-inline {
        min-width: 100px !important;
        max-width: 120px !important;
    }

    .form-control-inline {
        font-size: 14px !important;
        padding: 6px 8px !important;
        height: 40px !important;
    }

    .field-label {
        font-size: 12px !important;
    }
}

/* تحسينات خاصة للوضع الأفقي (Landscape) */
@media (max-width: 768px) and (orientation: landscape) {
    /* تقليل ارتفاع الهيدر في الوضع الأفقي */
    .modal-header,
    .product-detail-header,
    .product-modal-header,
    .products-management-header,
    .order-management-header,
    .my-orders-header,
    .login-modal-header,
    .order-modal-header,
    .full-map-header {
        padding: 10px 15px !important;
        min-height: 50px !important;
    }

    .modal-header h2,
    .product-detail-header h2,
    .product-modal-header h2,
    .products-management-header h2,
    .order-management-header h2,
    .my-orders-header h2,
    .login-modal-header h2,
    .order-modal-header h2,
    .full-map-header h3 {
        font-size: 16px !important;
    }

    /* زيادة ارتفاع الخرائط في الوضع الأفقي */
    .map-container,
    #map,
    #product-detail-map,
    #product-map,
    #full-size-map {
        height: 150px !important;
        min-height: 150px !important;
    }

    /* تصغير الصور في الوضع الأفقي */
    .product-detail-main-image {
        height: 150px !important;
        min-height: 150px !important;
    }

    .photo-circle {
        width: 70px !important;
        height: 70px !important;
    }
}

/* منع التكبير التلقائي في حقول الإدخال على iOS */
@media (max-width: 768px) {
    input[type="text"],
    input[type="tel"],
    input[type="password"],
    input[type="email"],
    input[type="number"],
    select,
    textarea {
        font-size: 16px !important;
        max-height: none !important;
        transform-origin: right top !important;
    }

    /* تحسين مظهر شريط التمرير */
    .modal-body::-webkit-scrollbar,
    .product-detail-body::-webkit-scrollbar,
    .products-management-body::-webkit-scrollbar,
    .my-orders-body::-webkit-scrollbar {
        width: 6px !important;
    }

    .modal-body::-webkit-scrollbar-track,
    .product-detail-body::-webkit-scrollbar-track,
    .products-management-body::-webkit-scrollbar-track,
    .my-orders-body::-webkit-scrollbar-track {
        background: #f1f1f1 !important;
        border-radius: 10px !important;
    }

    .modal-body::-webkit-scrollbar-thumb,
    .product-detail-body::-webkit-scrollbar-thumb,
    .products-management-body::-webkit-scrollbar-thumb,
    .my-orders-body::-webkit-scrollbar-thumb {
        background: #c1c1c1 !important;
        border-radius: 10px !important;
    }
}

/* تحسينات للأجهزة التي تدعم Hover */
@media (hover: hover) and (pointer: fine) {
    .close-modal:hover,
    .close-detail-modal:hover,
    .close-product-modal:hover,
    .close-products-management:hover,
    .close-order-management:hover,
    .close-my-orders:hover,
    .close-login-modal:hover,
    .close-order-modal:hover,
    .close-full-map:hover {
        transform: rotate(90deg) scale(1.1) !important;
    }
}

/* تحسينات للنوافذ الكبيرة على الشاشات الصغيرة */
@media (max-width: 768px) {
    /* نافذة إدارة المنتجات */
    .products-management-body {
        display: flex !important;
        flex-direction: column !important;
    }

    .products-stats {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
        margin-bottom: 15px !important;
    }

    /* نافذة طلباتي */
    .orders-stats-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
    }

    /* نافذة الخريطة الكاملة */
    .full-map-body {
        display: flex !important;
        flex-direction: column !important;
    }

    .map-info {
        flex-direction: column !important;
        gap: 10px !important;
        text-align: center !important;
        padding: 10px !important;
    }
}
/* أنماط نافذة الفلترة */
.filter-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.filter-modal-content {
    background-color: white;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease-out;
}

.filter-modal-header {
    position: sticky;
    top: 0;
    z-index: 10;              /* فوق المحتوى */
    background: linear-gradient(135deg, #3498db, #2980b9); /* خلفية */
    color: white;
    padding: 20px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center
}

.filter-modal-header h2 {
    margin: 0;
    font-size: 22px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-filter-modal {
    background: none;
    border: none;
    color: white;
    font-size: 30px;
    cursor: pointer;
    line-height: 1;
    transition: transform 0.3s;
}

.close-filter-modal:hover {
    transform: scale(1.2);
}

.filter-modal-body {
    padding: 20px;
}

.filter-modal-footer {
    position: sticky;
    bottom: 0;
    background: #f8f9fa;    /* نفس لون الخلفية */
    padding: 15px 20px;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    z-index: 2;            /* فوق المحتوى */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.03); /* اختياري: ظل خفيف */
}

/* أنماط حقول الفلترة */
.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    flex: 1;
    min-width: 250px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.form-group label i {
    margin-left: 5px;
    color: #3498db;
}

.price-range {
    display: flex;
    align-items: center;
    gap: 10px;
}

.price-range input {
    flex: 1;
}

.price-separator {
    color: #7f8c8d;
    font-weight: 600;
}

/* زر الفلترة في الشريط */
.filter-tab.filter {
    background: linear-gradient(135deg, #bcbabd, #a7a4a8);
    color: white;
}

.filter-tab.filter:hover {
    background: linear-gradient(135deg, #bcbabd, #a7a4a8);
}

.filter-tab.filter.active {
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
}

/* أنماط الأزرار */
.btn {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #27ae60, #219653);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
}

/* تأثيرات الحركة */
@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* أنميشن للنافذة المنبثقة */
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

@keyframes modalSlideOut {
    from {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
    to {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
}

/* تأثيرات hover للأزرار */
.confirm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
    background: linear-gradient(135deg, #27ae60, #219653) !important;
}

.continue-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    background: linear-gradient(135deg, #2980b9, #2573a7) !important;
}

.modal-close-btn:hover {
    background: #f8f9fa !important;
    color: #e74c3c !important;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 10000;
}
  /* تحسينات للشاشات الصغيرة */
    @media (max-width: 480px) {
        #confirmResetModal .modal-content {
            width: 95% !important;
            padding: 15px !important;
            margin: 10px !important;
        }
        
        #confirmResetModal .modal-icon div {
            width: 45px !important;
            height: 45px !important;
        }
        
        #confirmResetModal .modal-icon i {
            font-size: 20px !important;
        }
        
        #confirmResetModal h3 {
            font-size: 17px !important;
            margin-bottom: 6px !important;
        }
        
        #confirmResetModal p {
            font-size: 13px !important;
            margin-bottom: 15px !important;
        }
        
        #confirmResetModal button {
            font-size: 14px !important;
            padding: 10px 14px !important;
            min-height: 42px !important;
        }
        
        #confirmResetModal .modal-close-btn {
            top: 8px !important;
            right: 8px !important;
            width: 28px !important;
            height: 28px !important;
        }
    }
    
    @media (max-width: 360px) {
        #confirmResetModal .modal-content {
            padding: 12px !important;
        }
        
        #confirmResetModal h3 {
            font-size: 16px !important;
        }
        
        #confirmResetModal button {
            font-size: 13px !important;
            padding: 8px 12px !important;
        }
    }
    
    /* تحسينات للشاشات الكبيرة */
    @media (min-width: 768px) {
        #confirmResetModal .modal-content {
            width: 90% !important;
            max-width: 400px !important;
        }
    }
    
    /* تحسينات لللمس على الهواتف */
    @media (hover: none) and (pointer: coarse) {
        #confirmResetModal button {
            min-height: 44px !important;
        }
        
        #confirmResetModal .modal-close-btn {
            min-height: 44px !important;
            min-width: 44px !important;
        }
    }
#activate-unactive-btn {
    transition: all 0.3s ease;
    padding: 4px 8px;
    border-radius: 15px;
    background: rgba(52, 152, 219, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
}

#activate-unactive-btn:hover {
    background: rgba(52, 152, 219, 0.2);
}

#activate-unactive-btn:active {
    transform: scale(0.95);
}
/* أنماط للمبلغ الإجمالي في نافذة الطلبات */
#total-amount-container {
    animation: slideDown 0.5s ease-out;
    transition: all 0.3s ease;
}

#total-amount-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* رسالة تأكيد حذف المنتج */
.confirm-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.confirm-box {
  background: #fff;
  width: 360px;
  border-radius: 14px;
  padding: 22px;
  text-align: center;
  animation: scaleIn 0.2s ease;
}

.confirm-box h3 {
  margin-bottom: 10px;
  color: #333;
}

.confirm-box p {
  color: #555;
  font-size: 14px;
  line-height: 1.6;
}

.confirm-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.confirm-actions .btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

.confirm-actions .confirm {
  background: #e53935;
  color: #fff;
}

.confirm-actions .cancel {
  background: #e0e0e0;
}

@keyframes scaleIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* الشريط المتحرك */
.scrolling-text-container {
    width: 100%;
    overflow: hidden; /* مهم جداً */
   
}

.scrolling-text {
    display: inline-block;
    white-space: nowrap;
    padding-left: 100%;
    animation: scrollText 12s linear infinite;
    font-size: 1.5rem;
    color: blue;
    font-weight: 500;
}

/* حركة النص */
@keyframes scrollText {
    0% {
        transform: translateX(0);
    }
    100% {
        transform: translateX(-100%);
    }
}

/* تحسين للجوال */
@media (max-width: 768px) {
    .scrolling-text {
        font-size: 1rem;
        animation-duration: 15s; /* أبطأ للجوال */
    }
}


/* حاوية الأزرار */
.management-buttons {
    display: flex;
    width: fit-content;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap; /* يسمح للزرين بالالتفاف على الشاشات الصغيرة */
}

/* تصميم الأزرار */
.management-buttons .btn {
    flex: 1; /* توزيع المساحة بالتساوي */
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    width: fit-content;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
}

/* ألوان مميزة لكل زر */
.management-buttons .btn-users {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    width: fit-content;
}
.management-buttons .btn-users:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(39,174,96,0.3);
    width: fit-content;
}

.management-buttons .btn-products {
    background: linear-gradient(135deg, #e67e22, #d35400);
    color: white;
}
.management-buttons .btn-products:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(230,126,34,0.3);
}

/* تصميم متجاوب للشاشات الصغيرة */
@media (max-width: 600px) {
    .management-buttons {
        flex-direction: column; /* تجعل الأزرار في عمود على الشاشات الصغيرة */
    }
}
/* تنسيق رسالة الحساب المعلق */
#suspendedAccountModal .modal-content {
    animation: fadeIn 0.3s ease-out;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#suspendedAccountModal .modal-content h3 {
    color: #e74c3c;
    font-size: 24px;
    margin-bottom: 10px;
}

#suspendedAccountModal .modal-content p {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
}

#closeSuspendedModal {
    background: linear-gradient(135deg, #3498db, #2980b9);
    padding: 12px 30px;
    font-size: 16px;
    transition: all 0.3s ease;
}

#closeSuspendedModal:hover {
    background: linear-gradient(135deg, #2980b9, #1c5a7a);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
    </style>
</head>
<body>
        <!-- نافذة الشعار البسيطة -->
   <div class="splash-logo" id="splashLogo">
    <div class="logo-container">
         
        <!-- رابط الصورة - يمكنك تغييره -->
        <img src="https://i.ibb.co/spw7ZsPy/telescope-1.gif" 
             alt="شعار الشركة" 
             class="logo-image"
             id="companyLogo">
             <h1 class="company-name-splash">المبصرون</h1>
        <h3 class="company-name-splash">ALMOBSEROON</h3>
    </div>
</div>

    <!-- المحتوى الرئيسي -->
    <div class="main-content" id="mainContent">
    <!-- شريط التنقل العلوي -->
    <nav class="navbar">
        <div class="logo-section">
            <div class="company-name">المبصرون-ALMOBSEROON</div>
        </div>
    <div class="my-orders-section-nav" id="myOrdersSectionNav" style="display: none;">
        <button class="btn btn-my-orders-nav" id="myOrdersBtnNav" style="display: flex;">
            <i class="fas fa-shopping-basket"></i>
           طلباتي
        </button>
    </div>
    <!-- أضف هذا القسم لزر إدارة الطلبات -->
    <div class="orders-management-section" id="ordersManagementSection" style="display: none;">
 <button class="btn btn-manage-orders" id="manageOrdersBtn" style="display: flex;">
    <i class="fas fa-shopping-cart"></i>
    إدارة
</button>
    </div>
  <div class="auth-buttons">
    <!-- الحالة الافتراضية (قبل التسجيل) -->
    <button class="btn btn-login" id="loginBtn">تسجيل الدخول</button>
    <button class="btn btn-signup" id="openSignup">تسجيل جديد</button>
    
    <!-- الحالة بعد التسجيل (مخفي بشكل افتراضي) -->
<div class="user-profile" id="userProfile" style="display: none;">
    <div class="profile-content">
        <div class="user-avatar">
            <img id="userAvatar" src="" alt="صورة المستخدم">
        </div>
        <div class="phone-wrapper">
            <span class="user-phone" id="userPhone"></span>
        </div>
    </div>
</div>
    </nav>

   <!-- محتوى الصفحة الرئيسية -->
    <div class="container">
        <h1 class="page-title">منتجاتنا المميزة</h1>
 <!-- الشريط المتحرك -->
<div class="scrolling-text-container">
    <div class="scrolling-text">
        اضف منتجك المتميز في عالمنا المتميز وبسعر 0.525 مع الضريبة
    </div>
</div>
        <!-- عناوين الفلترة -->
        <div class="filter-tabs">
            <div class="filter-tab all active" data-filter="all">
                <i class="fas fa-th-large"></i>
                الكل 
            </div>
            <div class="filter-tab new" data-filter="new">
                <i class="fas fa-certificate"></i>
             جديد
            </div>
            <div class="filter-tab sale" data-filter="sale">
                <i class="fas fa-tag"></i>
             مستعملة
            </div>
            <div class="filter-tab popular" data-filter="popular">
                <i class="fas fa-fire"></i>
             خردة
            </div>
            <!-- زر الفلترة الجديد للمفضلة -->
            <div class="filter-tab favorite" data-filter="favorite">
                <i class="fas fa-heart"></i>
                المفضلة
            </div>
                     <!-- زر الفلترة الجديد -->
    <div class="filter-tab filter" data-filter="filter">
        <i class="fas fa-filter"></i>
        فلترة
    </div>
        </div>
        <div class="products-grid" id="productsGrid">
            <!-- سيتم إضافة المنتجات ديناميكياً من Google Sheets -->
        </div>
        
    </div>
  
     <!-- نافذة تسجيل المستخدم -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تسجيل مستخدم جديد</h2>
                <button class="close-modal" id="closeSignup">&times;</button>
            </div>
            <div class="modal-body">
                
                <form id="signupForm">
                    <!-- دائرة إضافة الصورة -->
                    <div class="photo-upload">
                        <div class="photo-circle" id="photoUpload">
                            <i class="fas fa-user-plus"></i>
                            <img id="previewImage" style="display: none;">
                        </div>
                        <span>إضافة صورة الملف الشخصي</span>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                    </div>

                    <!-- حقول النموذج في صفوف -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullname">الاسم الكامل</label>
                            <input type="text" id="fullname" class="form-control" required>
                        </div>
                   
                        <div class="form-group">
                            <label for="signupPhone">رقم الهاتف</label>
                            <input type="tel" id="signupPhone" class="form-control" required>
                        </div>
                 </div>
                    <div class="form-row">
                        <div class="form-group">
    <label for="signupPassword">كلمة المرور</label>
    <div class="password-input-wrapper">
        <input type="password" id="signupPassword" class="form-control" required>
        <button type="button" class="toggle-password" data-target="signupPassword">
            <i class="far fa-eye"></i>
        </button>
    </div>
     </div>
                        <div class="form-group">
                            <label for="state">المحافظة</label>
                            <select id="state" class="form-control" required>
                                <option value="">اختر المنطقة</option>
                                <option value="مسقط">مسقط</option>
                                <option value="الداخلية">الداخلية</option>
                                <option value="جنوب الباطنة">جنوب الباطنة</option>
                                <option value="شمال الباطنة">شمال الباطنة</option>
                                <option value="الظاهرة">الظاهرة</option>
                                <option value="البريمي">البريمي</option>
                                <option value="شمال الشرقية">شمال الشرقية</option>
                                <option value="جنوب الشرقية">جنوب الشرقية</option>
                                <option value="الوسطى">الوسطى</option>
                                <option value="ظفار">ظفار</option>
                            </select>
                        </div>

</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationAddress">اسم الموقع</label>
                            <input type="text" id="locationAddress" class="form-control" placeholder="أدخل اسم موقعك" required>
                            <div class="location-name" id="locationCoordinates"></div>
                        </div>

             
                    </div>

                    <!-- الحقول المخفية -->
                    <div class="form-group hidden">
                        <label for="date">تاريخ التحديث</label>
                        <input type="date" id="date" class="form-control">
                    </div>
                     <div class="form-group hidden">
                        <label for="TotalQuantity"> الاجمالي</label>
                        <input type="TotalQuantity" id="Total-Quantity" class="form-control">
                    </div>
                     <div class="form-group hidden">
                        <label for="ActiveNo"> النشط</label>
                        <input type="ActiveNo" id="Active-No" class="form-control">
                    </div>
                     <div class="form-group hidden">
                        <label for="UnActiveNo"> الغير نشط</label>
                        <input type="UnActiveNo" id="UnActive-No" class="form-control">
                    </div>
                     <div class="form-group hidden">
                        <label for="ExpiredNo"> المنتهي</label>
                        <input type="ExpiredNo" id="Expired-No" class="form-control">
                    </div>
                        <div class="form-group hidden">
                        <label for="DeleteNo"> الملغي</label>
                        <input type="DeleteNo" id="Delete-No" class="form-control">
                    </div>   
                           <div class="form-group hidden">
                      <label for="AddNo"> إضافة</label>
                        <input type="AddNo" id="Add-No" class="form-control">
                    </div>          
                    <div class="form-group hidden">
                        <label for="userstate">حالة المستخدم</label>
                        <input type="text" id="userstate" class="form-control" value="User">
                    </div>

                    <!-- خريطة مصغرة -->
                    <div class="form-group full-width">
                        <label>تحديد الموقع على الخريطة</label>
                        <div class="map-controls">
                             <button type="button" class="btn btn-secondary" id="searchLocation">بحث عن موقع</button>
                            <button type="button" class="btn btn-primary" id="currentLocation">الموقع الحالي</button>
                        </div>
                        <div class="map-container">
                            <div id="map"></div>
                        </div>
                                   <div class="form-group">
                            <label for="storeLat">رابط الموقع (Store Lat)</label>
                            <input type="text" id="storeLat" class="form-control" placeholder="رابط الموقع في الخريطة" readonly>
                        </div>
                    </div>


<!-- جزء شروط التسجيل -->
<div class="form-group full-width">
    <div class="terms-checkbox">
        <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
        <label for="agreeTerms">
            أوافق على 
            <span class="terms-link" id="showTermsLink">شروط التسجيل والاستخدام</span>
        </label>
    </div>
    <div id="termsContent" class="terms-content" style="display: none;">
        <div class="terms-header">
            <h3>شروط التسجيل والاستخدام</h3>
        </div>
         <h5>
            <p><strong> 1:</strong> يجب أن تكون جميع المعلومات المقدمة صحيحة ودقيقة وكاملة.</p>
            <p><strong> 2:</strong> المستخدم مسؤول عن الحفاظ على سرية بيانات حسابه.</p>
            <p><strong> 3:</strong> يحق للإدارة تعليق أو إلغاء الحساب في حال مخالفة الشروط.</p>
            <p><strong> 4:</strong> المنتجات المضافة يجب أن تكون حقيقية وموجودة وقانونية.</p>
            <p><strong> 5:</strong> يحق للإدارة تعديل الشروط دون إشعار مسبق.</p>
            <p><strong> 6:</strong> المستخدم يوافق على تلقي رسائل إشعار من النظام.</p>
            <p><strong> 7:</strong> يلتزم المستخدم بعدم استخدام النظام لأغراض غير قانونية.</p>
            <p><strong> 8:</strong> لا يمكن استرداد الاموال عند شراء رصيد لعرض المنتجات.</p>
            <p><strong> 9:</strong> يجب معاينة البضاعة على الواقع قبل دفع المبالغ للبائع.</p>
            <p><strong> 10:</strong> يحق لإدارة النظام تعليق حساب اي مستخدم عند ارتكاب مخالفات.</p>
            <p><strong> 11:</strong> جميع الحقوق محفوظة للإدارة.</p>
      </h5>
        <div class="terms-footer">
            <button type="button" class="btn btn-primary" id="closeTermsBtn" >موافق</button>
        </div>
    </div>
</div>
                    <!-- الحقول المخفية للتواريخ -->
                    <div class="form-group hidden">
                        <label for="creationDate">تاريخ الإضافة</label>
                        <input type="datetime-local" id="creationDate" class="form-control" readonly>
                    </div>

                    <div class="form-group hidden">
                        <label for="updateDate">تاريخ التعديل</label>
                        <input type="datetime-local" id="updateDate" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group hidden">
                        <label for="photoUrl">رابط الصورة</label>
                        <input type="text" id="photoUrl" class="form-control" readonly>
                    </div>
                    
                    <button type="submit" class="btn btn-submit">تسجيل الحساب</button>
                      
            <button class="btn btn-logout" id="logoutBtn">تسجيل الخروج</button>
                </form>
          </div>
            <div class="modal-footer">
                <button class="close-btn" id="closeRegister">X</button>
            </div>
        </div>
    </div>
 </div>


   <!-- في نافذة تفاصيل المنتج - أضف قسم الخريطة بعد قسم الوصف -->
<div class="product-detail-modal" id="productDetailModal">
    <div class="product-detail-content">
        <div class="product-detail-header">
            <h2>تفاصيل المنتج</h2>
              
            <button class="close-detail-modal" id="closeDetailModal">&times;</button>
        </div>
        <div class="product-detail-body">
            <!-- نقل رقم المنتج هنا - فوق الصورة مباشرة -->
    <div class="product-number-line" style="text-align: center;">
        <span style="font-weight: 600;">رقم المنتج:</span>
        <strong id="detail-product-number" style="
            color: #f30505;
            font-size: 18px;
            margin-right: 10px;
        ">-</strong>
    </div>
               <div class="product-detail-images">
           
                    <img src="" alt="صورة المنتج" id="detail-main-image">
              
                 
                <div class="product-detail-thumbnails" id="detail-thumbnails">
                    <!-- سيتم إضافة الصور المصغرة ديناميكياً -->
                </div>
                   </div>   
                   <div class="product-detail-info">
                    <span style="color:red;font-size: 20px; font-weight:bold;">السعر:
                    <span id="detail-product-price"  style="color: red; font-weight:bold; font-size: 20px;">$599.99</span>
                </div>   
            <div class="product-detail-info">
         
            
                <div class="product-name" id="detail-product-name">هاتف ذكي متطور</div>
                
                <!-- التفاصيل أسفل اسم المنتج مباشرة -->
                <div class="product-details-containerVeiw">
                    <div class="product-details-row">
                        <div class="product-details-item type">
                            <i class="fas fa-mobile-alt"></i>
                            <span id="detail-product-type">إلكترونيات</span>
                            </div>
                        </div>
                        <div class="product-details-row">
                       <div class="product-details-item warranty">
                            <i class="fas fa-shield-alt"></i>
                            <span id="detail-product-warranty">سنتان</span>
                        </div>
                    </div>
                      <div class="product-details-row">
                               <div class="product-details-item quantity">
                            <i class="fas fa-box"></i>
                            الكمية: <span id="detail-product-quantity">15</span>
                        </div>
                          </div>
                      <div class="product-details-row">
                        <div class="product-details-item color">
                            <i class="fas fa-palette"></i>
                            اللون: <span id="detail-product-color">أسود</span>
                        </div>
                         </div>
                      <div class="product-details-row">
                         <div class="product-details-item condition">
                            <i class="fas fa-star"></i>
                          الحالة:  <span id="detail-product-condition">جديد</span>
                        </div>
                    </div>
                    <div class="product-details-row">
                        <div class="product-details-item location">
                            <i class="fas fa-map-marker-alt"></i>
                            المنطقة: <span id="detail-product-location">بغداد</span>
                        </div>
                         </div>
                          <div class="product-details-row">
                        <div class="product-details-item locationstate">
                            <i class="fas fa-map-marker-alt"></i>
                            الموقع: <span id="detail-product-locationstate">الكرادة - شارع الصناعة</span>
                    </div>
                </div>
             </div>
                
                <!-- وصف المنتج-->
                <span class="product-detail-descriptionLable"> الوصف:</span>
                <div class="product-details-containerVeiw">
                    <p class="product-detail-description" id="detail-product-description">
                        هذا الهاتف الذكي المتطور يتميز بشاشة عالية الدقة، كاميرا متطورة، وبطارية طويلة الأمد. مثالي للاستخدام اليومي والألعاب.
                    </p>
                </div>
                 </div>
                <!-- قسم الخريطة المصغرة المضافة -->
                <div class="product-detail-map-section">
             
                        <i class="fas fa-map-marked-alt"></i>
                        <span>موقع المنتج</span>
                    </div>
                    <div class="product-map-container">
                        <div id="product-detail-map"></div>
                        <div class="map-controls">
                            <button class="btn-map-control" id="open-full-map">
                                <i class="fas fa-expand"></i>
                                عرض كامل
                            </button>
                            <button class="btn-map-control" id="get-directions">
                                <i class="fas fa-directions"></i>
                                اتجاهات
                            </button>
                            <button class="btn-map-control" id="copy-product-location-link">
                                <i class="fas fa-link"></i>
                                نسخ الرابط
                            </button>
                        </div>
                    </div>
            
                
                <div class="product-actions">
                    <button class="whatsapp-btn">
                        <i class="fab fa-whatsapp"></i>
                        <span class="phone-number" id="detail-whatsapp-number">07701234567</span>
                    </button>
                    <button class="call-btn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="favorite-icon">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="share-btn" title="مشاركة المنتج">
    <i class="fas fa-share-alt"></i>
</button>
            </div>
            <div class="modal-footer">
                <button class="close-btn" id="closeShowPord">X</button>
            </div>
        </div>
    </div>
</div>
  </div>
<!-- نافذة الخريطة الكاملة -->
<div class="full-map-modal" id="fullMapModal">
    <div class="full-map-content">
        <div class="full-map-header">
            <h3>موقع المنتج على الخريطة</h3>
            <button class="close-full-map" id="closeFullMap">&times;</button>
        </div>
        <div class="full-map-body">
            <div id="full-size-map"></div>
            <div class="map-info">
                <p><i class="fas fa-map-marker-alt"></i> <span id="full-map-location"></span></p>
                <button class="btn btn-primary" id="copy-location-link">
                    <i class="fas fa-link"></i>
                    نسخ رابط الموقع
                </button>
            </div>
        </div>
    </div>
</div>
<!-- نافذة طلباتي -->

<div class="my-orders-modal" id="myOrdersModal">
    <div class="my-orders-content">
        <div class="my-orders-body">
               <div class="my-orders-header">
                <h2><i class="fas fa-shopping-basket"></i> طلباتي</h2>
            <button class="close-my-orders" id="closeMyOrders">&times;</button>
        </div>
        
        <!-- قسم رقم الهاتف -->
     <div class="user-phone-section" style="
    text-align: center;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa, #f6f9fc);
    margin-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
">
    <div style="display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-phone-alt" style="color: #3498db;"></i>
        <span id="userPhoneDisplay" style="
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        ">رقم الهاتف: جاري التحميل...</span>
    
    
    <!-- زر الإضافة الجديد -->
 <!-- عداد الطلبات المضافة -->
<!-- عداد الطلبات المضافة -->
<div class="counter-card" data-type="added" id="addQuantityCard" onclick="openQuantityInputModal()" style="cursor: pointer;">
    <div class="counter-icon" style="
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 20px;
        cursor: pointer;
    " onclick="openQuantityInputModal()">
   
        <i class="fas fa-plus-circle"></i>

    </div>
    </div>
          <div class="counter-value" style="
        font-size: 24px;
        font-weight: 700;
        color: #e74c3c;
        text-align: center;
        margin-bottom: 5px;
    " id="counter-QuantityInputNo">0">نشط</div>
    <div class="counter-value" style="
        font-size: 24px;
        font-weight: 700;
        color: #e74c3c;
        text-align: center;
        margin-bottom: 5px;
    " id="counter-TotalPrice">0  </div>
</div>
     <button class="btn btn-add-product" id="addSendtBtn" style="display: none;">
               إرسال الطلب
            </button>
  <div class="counter-label" id="addSendtBtnLable" style="display: none; font-size: 18px; font-style: bold; color: red;">
    عند ارسال الطلب ، ارفق ايصال الدفع البنكي في رسالة الطلب ليتم تنشيط رصيدك
    (الدفع يكون عن طريق التحويل لنفس الرقم)
</div>
</div>
  <div class="counter-label" id="addSendtBtnLable" style="display: flex; font-size: 16px; font-style: bold; color: black;">
  بيانات الرصيد:-
</div>

        <!-- قسم العدادات (الأيقونات) -->
        <div class="counters-section" style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        ">
            <!-- عداد إجمالي الطلبات -->
            <div class="counter-card" data-type="total">
                <div class="counter-icon" style="
                    background: linear-gradient(135deg, #3498db, #2980b9);
                    color: white;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 10px;
                    font-size: 20px;
                ">
                    <i class="fas fa-shopping-basket"></i>
                </div>
                <div class="counter-value" style="
                    font-size: 24px;
                    font-weight: 700;
                    color: #2c3e50;
                    text-align: center;
                    margin-bottom: 5px;
                " id="counter-total">0</div>
                <div class="counter-label" style="
                    text-align: center;
                    color: #7f8c8d;
                    font-size: 14px;
                "> إجمالي الرصيد</div>
            </div>
            
            <!-- عداد الطلبات النشطة -->
            <div class="counter-card" data-type="active">
                <div class="counter-icon" style="
                    background: linear-gradient(135deg, #2ecc71, #27ae60);
                    color: white;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 10px;
                    font-size: 20px;
                ">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="counter-value" style="
                    font-size: 24px;
                    font-weight: 700;
                    color: #2ecc71;
                    text-align: center;
                    margin-bottom: 5px;
                " id="counter-active">0</div>
                <div class="counter-label" style="
                    text-align: center;
                    color: #7f8c8d;
                    font-size: 14px;
                ">نشط</div>
            </div>
    
           
            
           <!-- عداد الطلبات غير النشطة -->
<div class="counter-card" data-type="unactive">
    <div class="counter-icon" style="
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 20px;
    " onclick="activateUnactiveOrders()">
        <i class="fas fa-pause-circle"></i>
    </div>
    <div class="counter-value" style="
        font-size: 24px;
        font-weight: 700;
        color: #f39c12;
        text-align: center;
        margin-bottom: 5px;
    " id="counter-unactive">0</div>
    <div class="counter-label" style="
        text-align: center;
        color: #7f8c8d;
        font-size: 14px;
    ">
        غير نشط
   </div>  
        </div>    
      <!-- عداد الطلبات النشطة -->
            <div class="counter-card" data-type="active">
                <div class="counter-icon" style="
                    background: linear-gradient(135deg, #9b59b6, #8e44ad);
                    color: white;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 10px;
                    font-size: 20px;
                ">
                  <i class="fas fa-envelope"></i>
                </div>
                 <div id="activate-unactive-btn" style="
            font-size: 16px; 
            font-style:initial;
            color: #9b59b6; 
            margin-top: 5px; 
            cursor: pointer;
            display: none;" 
            onclick="activateUnactiveOrders()">
            <i class="fab fa-whatsapp"></i> تفعيل
            </div>
 </div>
    </div>
    

            <!-- زر إضافة طلب جديد -->
 <div class="add-product-section" id="addProductSection" style="display: none;">
            <button class="btn btn-add-product" id="addProductBtn">
                <i class="fas fa-plus-circle"></i>
                إضافة منتج
            </button>
        </div>
           
        
        
            <!-- قائمة الطلبات -->
       <div class="user-products-section" style="margin-top: 30px;">
    <div class="section-header" style="
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 15px;
    ">
        <i class="fas fa-boxes" style="color: #3498db; font-size: 16px;"></i>
        <span style="font-weight: 600; color: #2c3e50; font-size: 16px;">منتجاتي</span>
    </div>
    
<div style="padding: 15px; background: white; margin: 10px 0; border-radius: 8px;">
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" 
               id="orderSearchUserPro" 
               placeholder="ابحث برقم المنتج أو اسمه..." 
               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
               oninput="filterUserProducts()">
        
        <select id="statusUserFilter" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="filterUserProducts()">
            <option value="all">جميع الحالات</option>
            <option value="Active">مفعل</option>
            <option value="UnActive">انتهى</option>
            <option value="Pending">معلق</option>
            <option value="Deleting">محذوف</option>
        </select>
    </div>
</div>

    <div id="userProductsContainer">
        <!-- سيتم عرض المنتجات هنا ديناميكياً -->
    </div>
</div>
        </div>
        
        <div class="my-orders-footer">
            <button class="close-btn" id="closeMyOrdersBtn">X</button>
        </div>
    </div>
 </div>



<!-- نافذة إضافة المبلغ -->
<div class="modal" id="quantityInputModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; margin: auto; position: relative;">
        <div class="modal-header">
            <h2>إضافة عدد المنتجات</h2>
            <button class="close-modal" onclick="closeQuantityInputModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="quantityInput"><i class="fas fa-box"></i> العدد المطلوب:</label>
                <input type="number" id="quantityInput" class="form-control" 
           min="1" max="1000" value="1" required 
           style="text-align: center; font-size: 20px; font-weight: bold; padding: 12px;">
    
    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-weight: 600; color: #2c3e50;">العدد × 0.500:</span>
            <span style="font-weight: 700; color: #e74c3c;" id="calculationResult">0.500</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-weight: 600; color: #2c3e50;">الضريبة (5%):</span>
            <span style="font-weight: 700; color: #e74c3c;" id="taxResult">0.025</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span style="font-weight: 600; color: #2c3e50;">الإجمالي:</span>
            <span style="font-weight: 700; color: #27ae60;" id="totalResult">0.525</span>
        </div>
    </div>
            </div>
            
            <button type="button" class="btn btn-submit" onclick="confirmQuantityAddition()" 
                    style="width: 100%; margin-top: 20px; padding: 14px; font-size: 18px; background: linear-gradient(135deg, #2ecc71, #27ae60);">
                <i class="fas fa-check-circle"></i> حساب المبلغ
            </button>
        </div>
    </div>
</div>

    <!-- نافذة إضافة المنتج -->
    <div class="product-modal" id="addProductModal">
    <div class="product-modal-content">
        <div class="product-modal-header">
            <h2>إضافة منتج جديد</h2>
            <button class="close-product-modal" id="closeProductModal">&times;</button>
        </div>
        
        <div class="product-modal-body">
            <!-- قسم إضافة المنتج مباشرة -->
            <div class="form-body">
                <form id="addProductForm">
                    <div class="form-row">
                        <div class="form-group hidden">
                            <label for="productTimestamp">تاريخ الإضافة</label>
                            <input type="datetime-local" id="productTimestamp" class="form-control" readonly>
                        </div>
          
                        <div class="form-group hidden">
                            <label for="productNo">رقم المنتج</label>
                            <input type="text" id="productNo" class="form-control" readonly>
                        </div>
                    </div>
                    
               <div class="form-row">
    <div class="form-group">
        <label for="productName">اسم المنتج(لا يمكن تغييره)</label>
        <input type="text" id="productName" class="form-control" 
               maxlength="25" 
               required
               oninput="updateCounterPro(this)">
        <small class="text-muted">عدد الأحرف: <span id="charCount">35</span></small>
    </div>
                        <div class="form-group">
                            <label for="custel">هاتف المستخدم(لايتغير)</label>
                            <input type="tel" id="custel" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productCategory">قسم المنتج(لا يمكن تغييره)</label>
                            <select id="productCategory" class="form-control" required>
                                <option value="">اختر نوع المنتج</option>
                                <option value="إلكترونيات">إلكترونيات</option>
                                <option value="أجهزةمنزلية">أجهزةمنزلية</option>
                                <option value="ملابس">ملابس</option>
                                <option value="أثاث">أثاث</option>
                                <option value="ألعاب">ألعاب</option>
                                <option value="سيارات">مركبات</option>
                                <option value="عقارات">عقارات</option>
                                <option value="صحةوجمال">صحةوجمال</option>
                                <option value="موادغذائية">موادغذائية</option>
                                <option value="غذاء">غذاء</option>
                                 <option value="خدمات">خدمات</option>
                                  <option value="وظائف">وظائف</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productWarranty">النوع(لا يمكن تغييره)</label>
                            <input type="text" id="productWarranty" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="productPrice">السعر</label>
                            <input type="number" id="productPrice" class="form-control" step="0.01" min="0" required>
                        </div>
                 
                       <div class="form-group">
                            <label for="productQuantity">الكمية</label>
                            <input type="number" id="productQuantity" class="form-control" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productState">الحالة</label>
                            <select id="productState" class="form-control" required>
                                <option value="">اختر الحالة</option>
                                <option value="جديد">جديد</option>
                                <option value="مستعمل">مستعمل</option>
                                <option value="غرده">خرده</option>
                            </select>
                        </div>
                   
                        <div class="form-group">
                            <label for="productColor">اللون</label>
                            <select id="productColor" class="form-control" required>
                                <option value="">اختر اللون</option>
                                <option value="أسود">أسود</option>
                                <option value="أبيض">أبيض</option>
                                <option value="رمادي">رمادي</option>
                                <option value="فضي">فضي</option>
                                <option value="ذهبي">ذهبي</option>
                                <option value="أزرق">أزرق</option>
                                <option value="أحمر">أحمر</option>
                                <option value="أخضر">أخضر</option>
                                <option value="أصفر">أصفر</option>
                                <option value="برتقالي">برتقالي</option>
                                <option value="بنفسجي">بنفسجي</option>
                                <option value="وردي">وردي</option>
                                <option value="بني">بني</option>
                                <option value="كريمي">كريمي</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                    </div>
       
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productLocationState">المنطقة</label>
                           <select id="productLocationState" class="form-control" required>
    <option value="">اختر المنطقة</option>
    <option value="مسقط">مسقط</option>
    <option value="الداخلية">الداخلية</option>
    <option value="جنوب الباطنة">جنوب الباطنة</option>
    <option value="شمال الباطنة">شمال الباطنة</option>
    <option value="الظاهرة">الظاهرة</option>
    <option value="البريمي">البريمي</option>
    <option value="شمال الشرقية">شمال الشرقية</option>
    <option value="جنوب الشرقية">جنوب الشرقية</option>
    <option value="الوسطى">الوسطى</option>
    <option value="ظفار">ظفار</option>
</select>
                        </div>
                         <div class="form-group">
                            <label for="productLocationName">اسم الموقع</label>
                            <input type="text" id="productLocationName" class="form-control" required>
                            <div class="location-name" id="productLocationCoordinates"></div>
                        </div>
                                    </div>
          <div class="product-map-controls">
              <button type="button" class="btn btn-secondary" id="product-search-location">
                                <i class="fas fa-search"></i>
                                بحث عن موقع
                            </button>
                            <button type="button" class="btn btn-primary" id="product-current-location">
                                <i class="fas fa-location-arrow"></i>
                                الموقع الحالي
                            </button>
                          
                        </div>
                    <!-- قسم الخريطة المصغرة -->
                    <div class="product-map-section">
                        <div class="section-header">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>تحديد موقع المنتج على الخريطة</span>
                        </div>
                        <div class="map-container">
                            <div id="product-map"></div>
                        </div>
                                <div class="form-group">
                            <label for="productLocationLink">رابط الموقع</label>
                            <input type="text" id="productLocationLink" class="form-control" placeholder="سيتم تعبئته تلقائياً" readonly>
                        </div>
              
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="productDescription">وصف المنتج</label>
                            <textarea id="productDescription" class="form-control" rows="5" required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>صور المنتج (3 صور كحد أقصى)</label>
                            <div class="product-images-upload" id="productImagesPreview">
                                <!-- سيتم إضافة الصور هنا ديناميكياً -->
                            </div>
                        </div>
                    </div>
                    
        
                <div class="form-group hidden">
    <label for="productAddDate ">📅 تاريخ الإضافة</label>
    <input type="date" id="productAddDate" class="form-control" readonly>
    </div>
                <div class="form-row">
                         <div class="form-group hidden ">
                            <select id="productSituation" class="form-control" required>
                                <option value="Active">مفعل</option>
                                <option value="Pending">معلق</option>
                                <option value="Unactive">انتهى</option>
                                <option value="Deleting">محذوف</option>
                            </select>
                        </div>
                    </div>
      <div class="form-group ">
    <label for="productExpiredDate">⏳ تاريخ الانتهاء</label>
    <input type="date" id="productExpiredDate" class="form-control" readonly>
</div>
      
                    <button type="submit" class="btn btn-submit">حفظ المنتج</button>
                </form>
                </div>
                <div class="modal-footer">
                    <button class="close-btn" id="closeAddProductBtn">X</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HTML - إضافة نافذة تسجيل الدخول -->
    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <h2>تسجيل الدخول</h2>
                <button class="close-login-modal" id="closeLoginModal">&times;</button>
            </div>
            <div class="login-modal-body">
                <form id="loginForm">
                    <div class="login-form-group">
                        <label for="loginPhone">رقم الهاتف</label>
                        <input type="tel" id="loginPhone" class="login-form-control" 
                               placeholder="أدخل رقم هاتفك" required>
                    </div>
                    
             <div class="login-form-group">
    <label for="loginPassword">كلمة المرور</label>
    <div class="password-input-wrapper">
        <input type="password" id="loginPassword" class="login-form-control" 
               placeholder="أدخل كلمة المرور" required>
        <button type="button" class="toggle-password" data-target="loginPassword">
            <i class="far fa-eye"></i>
        </button>
    </div>
</div>
               
                    <div class="login-buttons">
                        <button type="submit" class="btn-login-submit">تسجيل الدخول</button>
                        
                        <label for="button" class="btn-login-secondary" id="openSignupFromLogin">
                            تسجيل جديد
                        </label>
                          
                        <label for="button" class="btn-forgot-password" id="forgotPasswordBtn">
                            نسيت كلمة المرور
                        </label>
                        <label for="button" class="close-login-btn" id="closeLoginBtn">
                            إغلاق
                        </label>
                 
                    </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


<!-- نافذة إدارة الطلبات -->
<div class="order-management-modal" id="orderManagementModal">
    <div class="order-management-content">
        <div class="order-management-header">
            <h2><i class="fas fa-shopping-cart"></i> إدارة الطلبات</h2>
            <button class="close-order-management" id="closeOrderManagement">&times;</button>
        </div>
    <!-- أزرار الإدارة -->
 <div class="management-buttons">
    <a href="https://almobseroon-hash.github.io/ALMOBSEROONUsers/"
       class="btn btn-users"
       target="_blank">
        <i class="fas fa-users"></i> إدارة المستخدمين
    </a>
    <a href="https://almobseroon-hash.github.io/ALMOBSEROONProducts/"
       class="btn btn-products"
       target="_blank">
        <i class="fas fa-box"></i> إدارة المنتجات
    </a>
    </div>
  <div class="order-management-body">

 <div class="form-container">

    <!-- الصف الأول -->
    <div class="form-row">
      <!-- رقم الطلب -->
      <div class="form-field-inline">
        <div class="field-label">رقم الطلب</div>
        <input type="text" id="orderNo" class="form-control-inline" value="يتم توليده تلقائياً" readonly>
      </div>
      
      <!-- تاريخ الطلب -->
      <div class="form-field-inline">
        <div class="field-label">تاريخ الطلب</div>
        <input type="date" id="orderDate" class="form-control-inline" required>
      </div>
      
      <!-- تاريخ الانتهاء -->
      <div class="form-field-inline">
        <div class="field-label">تاريخ الانتهاء</div>
        <input type="date" id="expiryDate" class="form-control-inline" readonly>
      </div>

    <!-- الصف الثاني -->
    <div class="form-row">
      <!-- العدد -->
      <div class="form-field-inline">
        <div class="field-label">العدد</div>
        <input type="number" id="orderQuantity" class="form-control-inline" min="" value="" required>
      </div>
      
      <!-- سعر الواحد -->
      <div class="form-field-inline">
        <div class="field-label">سعر الواحد</div>
        <input type="number" id="unitPrice" class="form-control-inline" value="0.500" readonly>
      </div>
      
      <!-- سعر الكل -->
      <div class="form-field-inline">
        <div class="field-label">سعر الكل</div>
        <input type="number" id="totalPrice" class="form-control-inline" value="0.500" readonly>
      </div>
      
      <!-- الضريبة -->
      <div class="form-field-inline">
        <div class="field-label">الضريبة (5%)</div>
        <input type="number" id="taxAmount" class="form-control-inline" value="0.025" readonly>
      </div>
      
      <!-- الإجمالي -->
      <div class="form-field-inline">
        <div class="field-label">الإجمالي</div>
        <input type="number" id="grandTotal" class="form-control-inline" value="0.525" readonly>
      </div>
 </div>
  </div>
   <div class="form-row">
        <!-- الحالة (للمسؤول فقط) -->
      <div class="form-group">
        <div class="field-label">الحالة</div>
        <select id="orderStatus" class="form-control-inline">
          <option value="غير نشط">غير نشط</option>
          <option value="نشط">نشط</option>
          <option value="منتهي">منتهي</option>
          <option value="ملغي">ملغي</option>
        </select>
      </div>
  <!-- أزرار الإجراء -->
 <div class="form-group">
    <div class="form-group full-width" style="display: flex; gap: 10px; margin-top: 20px;">
      <button type="button" class="btn btn-submit" style="flex: 1;">
        <i class="fas fa-save"></i> إضافة الطلب
      </button>
      <button type="button" class="btn btn-secondary" id="cancelOrderBtn" style="flex: 1; display: none;">
        <i class="fas fa-times"></i> إلغاء
      </button>
    </div>
  </div>
</div>

<div class="orders-stats">
  <div class="stat-card total">
    <div class="stat-value" id="totalOrders">0</div>
    <div class="stat-label">إجمالي الطلبات</div>
  </div>
  <div class="stat-card active">
    <div class="stat-value" id="activeOrders">0</div>
    <div class="stat-label">نشط</div>
  </div>
  <div class="stat-card inactive">
    <div class="stat-value" id="inactiveOrders">0</div>
    <div class="stat-label">غير نشط</div>
  </div>
  <div class="stat-card expired">
    <div class="stat-value" id="expiredOrders">0</div>
    <div class="stat-label">منتهي</div>
  </div>
</div>
<div class="search-filter-section" style="
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
">
    <div class="form-row" style="
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    ">
        <!-- حقل البحث -->
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="orderSearch" style="
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 14px;
            ">
                <i class="fas fa-search"></i> بحث سريع
            </label>
            <input type="text" 
                   id="orderSearch" 
                   placeholder="ابحث برقم الهاتف أو رقم الطلب..." 
                   style="
                        width: 100%;
                        padding: 10px 15px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                        transition: all 0.3s;
                   "
                   onfocus="this.style.borderColor='#3498db'; this.style.boxShadow='0 0 0 3px rgba(52,152,219,0.2)'"
                   onblur="this.style.borderColor='#ddd'; this.style.boxShadow='none'">
        </div>
        
        <!-- زر التصفية -->
        <div class="form-group" style="margin-top: 25px;">
            <button id="filterOrdersBtn" style="
                background: linear-gradient(135deg, #3498db, #2980b9);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
          
                align-items: center;
                gap: 8px;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(52,152,219,0.3)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-filter"></i>
                تصفية النتائج
            </button>
        </div>
        
          <!-- زر إعادة التعيين -->
    
            <button id="resetFilterBtn" style="
                background: linear-gradient(135deg, #95a5a6, #7f8c8d);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 8px;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(149,165,166,0.3)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-redo"></i>
                إعادة تعيين
            </button>
        </div>
    </div>
    
    <!-- عرض نتيجة البحث -->
    <div id="searchResultsInfo" style="
        margin-top: 10px;
        padding: 8px 12px;
        background: #e3f2fd;
        border-radius: 4px;
        border-right: 4px solid #3498db;
        display: none;
    ">
        <span style="font-weight: 600; color: #2c3e50;">
            <i class="fas fa-info-circle"></i>
            <span id="searchResultsText"></span>
        </span>
    </div>

            <!-- جدول الطلبات -->
           
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>تاريخ الطلب</th>
                            <th> الهاتف</th>
                            <th>العدد</th>
                            <th>سعر الواحد</th>
                            <th>سعر الكل</th>
                            <th>الضريبة</th>
                            <th>الإجمالي</th>
                            <th>تاريخ الانتهاء</th>
                            <th>الحالة</th>
                             <th>طلب التنشيط</th>
                           <th>الإجراءات</th> 
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- سيتم ملء الطلبات هنا ديناميكياً -->
                    </tbody>
                </table>
            </div>
       <!-- زر إضافة طلب جديد -->
             <div class="admin-only">
            <div class="add-order-section" style="margin-top: 20px; text-align: center;">
                <button type="button" class="btn btn-add-order" id="addOrderBtn" >
                    <i class="fas fa-plus-circle"></i> إضافة طلب جديد
                </button>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إضافة/تعديل الطلب -->
<div class="order-modal" id="orderModal">
    <div class="order-modal-content">
        <div class="order-modal-header">
            <h2 id="orderModalTitle">إضافة طلب جديد</h2>
            <button class="close-order-modal" id="closeOrderModal">&times;</button>
        </div>
        
        <div class="order-modal-body">
            <form id="orderForm">
                <!-- الحقول غير المتاحة -->
                
            </form>
        </div>
    </div>
</div>
<!-- نافذة التعديل المستقلة -->
<div id="standaloneEditModal" class="edit-product-modal">
    <div class="edit-product-modal-content">
        <div class="edit-product-modal-header">
            <h3>
                <i class="fas fa-edit"></i>
                <span id="editModalTitle">تعديل المنتج</span>
                <span id="editProductNo" style="font-size: 14px; margin-right: 10px;"></span>
            </h3>
            <button class="edit-product-modal-close" onclick="closeStandaloneEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="edit-product-modal-body" id="standaloneEditFormContainer">
            <!-- سيتم تعبئة النموذج هنا ديناميكياً -->
            <div id="editFormLoading" style="text-align: center; padding: 50px;">
                <i class="fas fa-spinner fa-spin fa-3x" style="color: #3498db;"></i>
                <p style="margin-top: 20px; font-size: 16px;">جاري تحميل بيانات المنتج...</p>
            </div>
        </div>
        
        <div class="edit-product-modal-footer">
            <button class="edit-modal-btn edit-modal-btn-save" onclick="saveStandaloneEdit()">
                <i class="fas fa-save"></i>
                حفظ التعديلات
            </button>
            <button class="edit-modal-btn edit-modal-btn-close" onclick="closeStandaloneEditModal()">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>
</div>
<!-- نافذة فلترة المنتجات -->
<div class="filter-modal" id="filterModal">
    <div class="filter-modal-content">
        <div class="filter-modal-header">
            <h2><i class="fas fa-filter"></i> فلترة المنتجات</h2>
            <button class="close-filter-modal" id="closeFilterModal">&times;</button>
        </div>
        <div class="filter-modal-body">
            <form id="filterForm">
                <!-- صف 1: بحث اسم المنتج ورقم المنتج -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterProductName"><i class="fas fa-search"></i> اسم المنتج</label>
                        <input type="text" id="filterProductName" class="form-control" placeholder="ابحث باسم المنتج...">
                    </div>
                    <div class="form-group">
                        <label for="filterProductNumber"><i class="fas fa-hashtag"></i> رقم المنتج</label>
                        <input type="text" id="filterProductNumber" class="form-control" placeholder="ابحث برقم المنتج...">
                    </div>
                </div>

                <!-- صف 2: هاتف المستخدم والمنطقة -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterUserPhone"><i class="fas fa-phone"></i> هاتف المستخدم</label>
                        <input type="text" id="filterUserPhone" class="form-control" placeholder="ابحث برقم هاتف المستخدم...">
                    </div>
                    <div class="form-group">
                        <label for="filterRegion"><i class="fas fa-map-marker-alt"></i> المنطقة</label>
                        <select id="filterRegion" class="form-control">
                           <option value="">اختر المنطقة</option>
    <option value="مسقط">مسقط</option>
    <option value="الداخلية">الداخلية</option>
    <option value="جنوب الباطنة">جنوب الباطنة</option>
    <option value="شمال الباطنة">شمال الباطنة</option>
    <option value="الظاهرة">الظاهرة</option>
    <option value="البريمي">البريمي</option>
    <option value="شمال الشرقية">شمال الشرقية</option>
    <option value="جنوب الشرقية">جنوب الشرقية</option>
    <option value="الوسطى">الوسطى</option>
    <option value="ظفار">ظفار</option>
                        </select>
                    </div>
                </div>

                <!-- صف 3: الموقع وقسم المنتجات -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterLocation"><i class="fas fa-map-pin"></i> الموقع</label>
                        <input type="text" id="filterLocation" class="form-control" placeholder="ابحث بالموقع...">
                    </div>
                    <div class="form-group">
                        <label for="filterCategory"><i class="fas fa-tags"></i> قسم المنتجات</label>
                        <select id="filterCategory" class="form-control">
                            <option value="">جميع الأقسام</option>
                            <option value="إلكترونيات">إلكترونيات</option>
                            <option value="أجهزةمنزلية">أجهزةمنزلية</option>
                            <option value="ملابس">ملابس</option>
                            <option value="أثاث">أثاث</option>
                            <option value="ألعاب">ألعاب</option>
                            <option value="سيارات">مركبات</option>
                            <option value="عقارات">عقارات</option>
                            <option value="صحةوجمال">صحةوجمال</option>
                            <option value="موادغذائية">موادغذائية</option>
                            <option value="غذاء">غذاء</option>
                            <option value="خدمات">خدمات</option>
                            <option value="وظائف">وظائف</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                </div>

                <!-- صف 4: نوع المنتج والسعر -->
     <div class="form-row">
    <div class="form-group">
        <label for="filterProductWarranty"><i class="fas fa-cube"></i> نوع المنتج</label>
        <input type="text" id="filterProductWarranty" class="form-control" placeholder="ابحث بنوع المنتج مثل: سيارة, هاتف, دراجة...">
    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill-wave"></i> نطاق السعر</label>
                        <div class="price-range">
                            <input type="number" id="filterPriceFrom" class="form-control" placeholder="من" min="0">
                            <span class="price-separator">إلى</span>
                            <input type="number" id="filterPriceTo" class="form-control" placeholder="إلى" min="0">
                        </div>
                    </div>
                </div>

                <!-- صف 5: اللون والحالة -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterColor"><i class="fas fa-palette"></i> اللون</label>
                        <select id="filterColor" class="form-control">
                            <option value="">جميع الألوان</option>
                            <option value="أسود">أسود</option>
                            <option value="أبيض">أبيض</option>
                            <option value="رمادي">رمادي</option>
                            <option value="فضي">فضي</option>
                            <option value="ذهبي">ذهبي</option>
                            <option value="أزرق">أزرق</option>
                            <option value="أحمر">أحمر</option>
                            <option value="أخضر">أخضر</option>
                            <option value="أصفر">أصفر</option>
                            <option value="برتقالي">برتقالي</option>
                            <option value="بنفسجي">بنفسجي</option>
                            <option value="وردي">وردي</option>
                            <option value="بني">بني</option>
                            <option value="كريمي">كريمي</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterCondition"><i class="fas fa-star"></i> الحالة</label>
                        <select id="filterCondition" class="form-control">
                            <option value="">جميع الحالات</option>
                            <option value="جديد">جديد</option>
                            <option value="مستعمل">مستعمل</option>
                            <option value="خردة">خردة</option>
                            <option value="غرده">غرده</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    <div class="filter-modal-footer">
    <button class="btn btn-secondary" id="modalResetFilterBtn">
        <i class="fas fa-redo"></i> إعادة تعيين الفلترة
    </button>
    <button class="btn btn-primary" id="modalApplyFilterBtn">
        <i class="fas fa-check"></i> تطبيق الفلترة
    </button>
</div>
    </div>
</div>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-box">
    <h3 id="confirmTitle">تأكيد الإجراء</h3>
    <p id="confirmMessage"></p>

    <div class="confirm-actions">
      <button id="confirmCancel" class="btn cancel">إلغاء</button>
      <button id="confirmOk" class="btn confirm">تأكيد</button>
    </div>
  </div>
</div>

    <!-- إضافة مكتبة Leaflet للخرائط -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script>
const ORDERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2kc8gPij60JNxh1vDnyLEqpHfjk5DuaiYqGjMQj-8n_SVjjoiRloiIGQDzeIY7AK-/exec'; // استبدل بالرابط الحقيقي
const PRODUCTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEEDhBYNK82_NkiGK14bA_w76EM7Wa1hB42ZluKputFMlVTD370Hy7zO2ztSYYTsw/exec';
        // تعريف المتغيرات العامة
      // تعريف المتغيرات العامة
let productImages = [];
let productDetails = {};
let productDetailMap = null;
let fullSizeMap = null;
let productMarker = null;
let fullProductMarker = null;
let currentProductLocation = null;
let userOrders = [];
let favoriteProducts = [];
let currentEditingOrder = null;
let currentEditingProduct = null;
let currentEditingProductNo = null;
let productCounts = {
    all: 0,
    new: 0,
    sale: 0,
    popular: 0,
    favorite: 0
};
let currentFilterParams = {};
let isFilterApplied = false;

           // إخفاء شعار الشركة بعد 3 ثواني وإظهار المحتوى
     window.addEventListener('load', function () {
    setTimeout(async function () {

        const splashLogo = document.getElementById('splashLogo');
        const mainContent = document.getElementById('mainContent');

        splashLogo.classList.add('hide');

        setTimeout(async function () {

            mainContent.classList.add('show');
            showLoading(true, 'جاري التحقق ...');

            // ✅ تحقق من الإكسل مباشرة
            const result = await validateUserFromSheetOnly();

            if (!result.allow) {
                showLoading(false);
                return;
            }

            // ✅ تحميل المنتجات فقط إذا الحالة سليمة
            loadProductsFromGoogleSheets();

            // التصفية
            const filterTabs = document.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    filterTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    filterProducts(this.dataset.filter);
                });
            });

            showLoading(false);

        }, 500);

    }, 5000);
});

async function validateUserFromSheetOnly() {
    const storedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const phone = storedUser.phone || storedUser.signupPhone;

    // 👤 زائر (لا يوجد رقم)
    if (!phone) {
        return { allow: true };
    }

    try {
        const url = LOGIN_SCRIPT_URL +
            '?action=getUser&phone=' +
            encodeURIComponent(phone) +
            '&t=' + Date.now();

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success || !data.userData) {
            logout();
            return { allow: false };
        }

        const userState = data.userData.userstate;

        // ❌ حساب محذوف
        if (userState === 'Delete') {
            logout();
            showAccountRestorationModal(data.userData);
            return { allow: false };
        }

        // ⛔ حساب معلق
        if (userState === 'Employer') {
            logout();
            showSuspendedAccountModal(data.userData);
            return { allow: false };
        }

        // ✅ مستخدم سليم → تحديث البيانات من الإكسل
        localStorage.setItem('currentUser', JSON.stringify(data.userData));
        localStorage.setItem('isLoggedIn', 'true');
        updateUIAfterRegistration(data.userData);

        return { allow: true };

    } catch (error) {
        console.error('❌ فشل التحقق من الإكسل:', error);
        logout();
        return { allow: false };
    }
}

        // رابط Google Apps Script لتحميل البيانات من Google Sheets
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwpIXSdUoLhIaTCvf0HQbpUS4mKVKYmO1mWRVcaIZw24QOFzejJayd4lr4G2pdkVYw/exec';

        // دالة لتحميل البيانات من Google Sheets باستخدام JSONP
        async function loadProductsFromGoogleSheets() {
            try {
                console.log('جاري تحميل المنتجات من Google Sheets...');
                
                // إضافة timestamp لمنع التخزين المؤقت
                const url = SCRIPT_URL + '?t=' + new Date().getTime();
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('تم تحميل البيانات:', data);
                
                if (data && data.success === true) {
                    const products = data.products || [];
                    console.log('عدد المنتجات:', products.length);
                    
                    if (products.length === 0) {
                        // إذا لم توجد منتجات، عرض رسالة
                        showNoProductsMessage();
                               console.log('الأعمدة المتاحة في أول منتج:', Object.keys(products[0]));
                console.log('قيمة productNo في أول منتج:', products[0].productNo);
                console.log('قيمة productNo في ثاني منتج:', products[1]?.productNo);
            
                    } else {
                        const formattedProducts = formatProductsData(products);
                        displayProducts(formattedProducts);
                        showLoading(false);
                    }
                    return products;
                } else {
                    throw new Error(data.error || 'خطأ في البيانات');
                }
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showErrorMessage('تعذر تحميل البيانات. الرجاء المحاولة لاحقا...');
                loadDefaultProducts();
                return [];
            }
        }

        // دالة لعرض رسالة عدم وجود منتجات
        function showNoProductsMessage() {
            const productsGrid = document.getElementById('productsGrid');
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>لا توجد منتجات متاحة حالياً</h3>
                        <p>سيتم عرض المنتجات هنا بمجرد إضافتها إلى النظام</p>
                    </div>
                `;
            }
        }

        // دالة لعرض رسالة خطأ
        function showErrorMessage(message) {
            const productsGrid = document.getElementById('productsGrid');
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>${message}</h3>
                   <button onclick="window.location.reload()" class="btn" style="background: #3498db; color: white; margin-top: 15px;">
                    <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                    </div>
                `;
            }
        }

        // دالة لتحميل المنتجات الافتراضية
        function loadDefaultProducts() {
            console.log('تحميل المنتجات الافتراضية...');
            
            const defaultProducts = [
                
             console.log('يوجد خلل في الاتصال ، الرجاء معاودة دخول النظام مره اخرى')

            ];
            
            // حفظ البيانات في productDetails للاستخدام في نافذة التفاصيل
            defaultProducts.forEach(product => {
                productDetails[product.id] = product;
            });
            
            displayProducts(defaultProducts);
        }

        // دالة لتحويل البيانات من Google Sheets إلى تنسيق مناسب
        function formatProductsData(productsData) {
            if (!productsData || !Array.isArray(productsData)) {
        console.warn('بيانات المنتجات غير صالحة:', productsData);
        return [];
    }
    
    // تصفية المنتجات التي situation = Active
    const activeProducts = productsData.filter(product => {
        const situation = getFieldValue(product, ['situation', 'Situation', 'الحالة', 'حالة المنتج']);
        return situation.toLowerCase() === 'active' || 
               situation.toLowerCase() === 'مفعل' ||
               situation.toLowerCase() === 'نشط' ||
               situation === ''; // إذا كان الحقل فارغاً، اعتبره نشط
    });
    
    console.log('المنتجات النشطة:', activeProducts.length, 'من', productsData.length);
    
    // ترتيب المنتجات حسب تاريخ الإضافة (من الأحدث إلى الأقدم)
    const sortedProducts = activeProducts.sort((a, b) => {
        const dateA = getProductDate(a);
        const dateB = getProductDate(b);
        return new Date(dateB) - new Date(dateA);
    });
    
    return sortedProducts.map((product, index) => {
        // البحث عن جميع الصور المتاحة
        let images = [];
        
        for (let i = 1; i <= 3; i++) {
            const imageField = `image${i}`;
            if (product[imageField] && product[imageField].toString().trim() !== '') {
                const imageUrl = product[imageField].toString().trim();
                if (imageUrl.startsWith('http')) {
                    images.push(imageUrl);
                }
            }
        }
        
        if (images.length === 0) {
            for (let key in product) {
                if (typeof product[key] === 'string' && 
                    (key.toLowerCase().includes('image') || key.toLowerCase().includes('صورة')) && 
                    product[key]) {
                    const imageValue = product[key].toString();
                    if (imageValue.includes(',')) {
                        const tempImages = imageValue.split(',').map(img => img.trim()).filter(img => img.startsWith('http'));
                        images = [...images, ...tempImages].slice(0, 3);
                    } else if (imageValue.startsWith('http')) {
                        images.push(imageValue);
                    }
                    if (images.length >= 3) break;
                }
            }
        }
        
        if (images.length === 0) {
            images = ['https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'];
        }
        
        images = images.slice(0, 3);
        
        // البحث عن تاريخ الانتهاء
        const expiredDate = product.productExpiredDate || 
                           product.expiredDate || 
                           calculateExpiredDateFromProduct(product);
        
        const formattedProduct = {
            id: index,
            productNo: product.productNo || `PRO-${String(index + 1).padStart(4, '0')}`,
            name: product.productName || '',
            description: product.productDescription || '',
            price: formatPrice(product.productPrice || ''),
            location: product.state || 'غير محدد',
            locationstate: product.productLocationName || product.state || 'غير محدد',
            locationLink: product.locationLink || product.storeLat || 'غير محدد',
            type: product.productCategory || 'عام',
            quantity: product.productQuantity || '0',
            condition: product.productState || 'جديد',
            warranty: product.productWarranty || 'لا يوجد',
            color: product.productColor || 'غير محدد',
            phone: product.custel || '07701234567',
            situation: product.situation || 'Active',
            images: images,
            date: getProductDate(product), // تاريخ الإضافة
            expiredDate: expiredDate, // تاريخ الانتهاء
            timestamp: product.timestamp || product.Timestamp || getProductDate(product) // تاريخ الإضافة للعرض
        };
        
        // تعيين قيم افتراضية إذا كانت فارغة
        if (!formattedProduct.name) formattedProduct.name = 'منتج بدون اسم';
        if (!formattedProduct.description) formattedProduct.description = 'لا يوجد وصف للمنتج';
        if (!formattedProduct.price) formattedProduct.price = 'غير محدد';
        if (!formattedProduct.location) formattedProduct.location = 'غير محدد';
        if (!formattedProduct.type) formattedProduct.type = 'عام';
        if (!formattedProduct.quantity) formattedProduct.quantity = '0';
        if (!formattedProduct.condition) formattedProduct.condition = 'جديد';
        if (!formattedProduct.warranty) formattedProduct.warranty = 'لا يوجد';
        if (!formattedProduct.color) formattedProduct.color = 'غير محدد';
        if (!formattedProduct.phone) formattedProduct.phone = '07701234567';
        if (!formattedProduct.situation) formattedProduct.situation = 'Active';
        if (!formattedProduct.locationstate) formattedProduct.locationstate = formattedProduct.location;
        if (!formattedProduct.expiredDate) formattedProduct.expiredDate = calculateExpiredDateFromProduct(product);
        
        console.log(`المنتج ${formattedProduct.name} - تاريخ الإضافة: ${formattedProduct.date}, تاريخ الانتهاء: ${formattedProduct.expiredDate}`);
        
        return formattedProduct;
    });
}
//دالة كتابة اسم المنتج 25 حرف
function updateCounterProd(input) {
    const maxLength = 35;
    const currentLength = input.value.length;
    const remaining = maxLength - currentLength;
    
    document.getElementById('charCount').textContent = remaining;
    
    // تغيير لون العداد عندما يكون عدد الأحرف قريبًا من الحد
    const counter = document.getElementById('charCount');
    if (remaining <= 5) {
        counter.style.color = 'red';
    } else if (remaining <= 10) {
        counter.style.color = 'orange';
    } else {
        counter.style.color = '';
    }
}
        // دالة مساعدة لاستخراج تاريخ المنتج
        function getProductDate(product) {
            // محاولة الحصول على التاريخ من الحقول المختلفة
            const timestamp = product.timestamp || product.Timestamp || product.date || product.Date || product.creationDate || product.updateDate;
            
            if (timestamp) {
                return new Date(timestamp);
            }
            
            // إذا لم يوجد تاريخ، استخدم التاريخ الحالي
            return new Date();
        }

        // دالة مساعدة للبحث عن قيمة الحقل
        function getFieldValue(product, fieldNames) {
            for (let fieldName of fieldNames) {
                if (product[fieldName] !== undefined && product[fieldName] !== null && product[fieldName] !== '') {
                    return product[fieldName].toString().trim();
                }
            }
            return '';
        }

        // دالة لتنسيق السعر
        function formatPrice(price) {
            if (!price) return 'غير محدد';
            
            try {
                // تحويل السعر إلى رقم
                const priceNumber = typeof price === 'string' ? 
                    parseFloat(price.replace(/[^\d.-]/g, '')) : 
                    parseFloat(price);
                    
                if (isNaN(priceNumber)) return 'غير محدد';
                
                return `${priceNumber.toLocaleString('RO-OM')} ر.ع`;
            } catch (error) {
                console.error('خطأ في تنسيق السعر:', error);
                return 'غير محدد';
            }
        }

        // دالة لعرض المنتجات في الصفحة
         function displayProducts(products) {
            const productsGrid = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>لا توجد منتجات متاحة حالياً</h3>
                        <p>سيتم عرض المنتجات هنا بمجرد إضافتها إلى النظام</p>
                    </div>
                `;
                
                // تحديث العدادات لتصفر
                calculateProductCounts([]);
                return;
            }
            
            productsGrid.innerHTML = '';
            
            // حفظ البيانات في productDetails للاستخدام في نافذة التفاصيل
            products.forEach((product, index) => {
                productDetails[index] = product;
            });
            
            products.forEach((product, index) => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-index', index);
                
                // تحديد الفئة بناءً على حالة المنتج
                let category = 'all';
                if (product.condition === 'جديد') category = 'new';
                else if (product.condition === 'مستعمل') category = 'sale';
                else category = 'popular';
                
                productCard.setAttribute('data-category', category);
                
                // تحديد البادج بناءً على حالة المنتج
                let badgeClass = '';
                let badgeText = '';
                if (product.condition === 'جديد') {
                    badgeClass = 'new';
                    badgeText = 'جديد';
                } else if (product.condition === 'مستعمل') {
                    badgeClass = 'sale';
                    badgeText = 'مستعمل';
                } else {
                    badgeClass = 'popular';
                    badgeText = 'خردة';
                }
                
                // التحقق مما إذا كان المنتج مفضلاً
                const isProductFavorite = isFavorite(index.toString());
                const favoriteIconClass = isProductFavorite ? 'fas fa-heart' : 'far fa-heart';
                const favoriteActiveClass = isProductFavorite ? 'active' : '';
                
   productCard.innerHTML = `
<div class="product-image">
    <img src="${product.images[0]}" alt="${product.name}" 
         class="product-image-slide fade-in" 
         id="main-image-${index}"
         onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'"
         data-product-id="${product.id || product.productId || index}">
    <div class="product-badge ${badgeClass}">${badgeText}</div>
    <button class="view-details-btn" data-product="${index}">عرض</button>
</div>
<div class="product-price">
    السعر: ${product.price}  
</div>
<div class="product-info">
    <div class="product-name">${product.name}</div>
    <div class="product-details-container">
        <div class="product-details-row">
            <div class="product-details-item type">
                <i class="fas fa-tag"></i>
                ${product.type}
            </div>
        </div>
        <div class="product-details-item location">
            <i class="fas fa-map-marker-alt"></i>
            الموقع: ${product.location}
        </div>
    </div>
    <div class="product-actions">
        <button class="whatsapp-btn">
            <i class="fab fa-whatsapp"></i>
            <span class="phone-number">${product.phone}</span>
            <span class="product-id" style="display:none">${product.id || product.productId || index}</span>
        </button>
        <button class="call-btn">
            <i class="fas fa-phone"></i>
        </button>
        <button class="favorite-icon ${favoriteActiveClass}" data-product="${index}">
            <i class="${favoriteIconClass}"></i>
        </button>
    </div>
</div>`;
                
                productsGrid.appendChild(productCard);
            });
            
            calculateProductCounts(products);
            // إضافة مستمعين للأحداث لأيقونات المفضلة
            attachFavoriteEventListeners();
        }


        // دالة لإضافة مستمعي الأحداث لأيقونات المفضلة
        function attachFavoriteEventListeners() {
            document.querySelectorAll('.favorite-icon').forEach(icon => {
                icon.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const productId = this.getAttribute('data-product');
                    toggleFavorite(productId);
                });
            });
        }

        // دالة للحصول على التاريخ والوقت الحالي بالتنسيق المحلي
       function getCurrentDateTime() {
            const now = new Date();
            return now.toISOString().slice(0, 16).replace('T', ' ');
        }

        // دالة للحصول على التاريخ الحالي بتنسيق YYYY-MM-DD
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        // تهيئة حقول التاريخ عند فتح النموذج
        function initializeDateFields() {
            const currentDateTime = getCurrentDateTime();
            const currentDate = getCurrentDate();
            
            document.getElementById('creationDate').value = currentDateTime; 
            document.getElementById('updateDate').value = currentDateTime;
            document.getElementById('date').value = currentDate;
            document.getElementById('userstate').value = 'User';
        }

        // تحديث تاريخ التعديل فقط
        function updateModificationDate() {
            document.getElementById('updateDate').value = getCurrentDateTime();
        }
/**
 * تحديث مكان الصورة
 */
function updateImageSlot(slotIndex, imageData, fileName) {
    const slotElement = document.querySelector(`.image-preview-item[data-image-index="${slotIndex}"]`);
    if (!slotElement) return;
    
    // تحديث العنصر
    slotElement.className = 'image-preview-item';
    slotElement.setAttribute('data-image-type', 'existing');
    slotElement.setAttribute('data-image-src', imageData);
    
    slotElement.innerHTML = `
        <span class="image-number">${slotIndex + 1}</span>
        <img src="${imageData}" 
             alt="${fileName}"
             onerror="handleImageError(this)"
             data-original-src="${imageData}">
        <div class="image-replace-overlay">
            <button type="button" class="replace-image-btn" onclick="replaceSingleImage(${slotIndex})">
                <i class="fas fa-exchange-alt"></i> استبدال
            </button>
            <button type="button" class="replace-image-btn delete-btn" onclick="deleteImageFromPreview(${slotIndex})">
                <i class="fas fa-trash"></i> حذف
            </button>
        </div>
        <div class="image-actions">
            <span class="image-size-info">${fileName.length > 15 ? fileName.substring(0, 12) + '...' : fileName}</span>
        </div>
    `;
    
    // تحديث الحالة
    window.imageSlotsStatus[slotIndex] = 'filled';
    window.currentProductImages[slotIndex] = imageData;
}
        // دالة لرفع الصورة إلى ImgBB
        function uploadToImgBB(file) {
            return new Promise((resolve, reject) => {
                const apiKey = '34aed8baf7c00d234fab6035ec3ca3f1';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`خطأ في الخادم: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Upload response:', data);
                    if (data.success) {
                        resolve(data.data.url);
                    } else {
                        reject(new Error(data.error.message || 'فشل في رفع الصورة'));
                    }
                })
                .catch(error => {
                    console.error('Error uploading image:', error);
                    reject(error);
                });
            });
        }

        // توليد معرف فريد للمستخدم
        function generateCustomerID() {
            // timestamp + عشوائية عالية + أداء النظام
            const uniqueHash = 
                Date.now().toString(36) + 
                Math.random().toString(36).substring(2) +
                performance.now().toString(36).replace('.', '');
            
            // أخذ 12 حرف فقط
            const shortHash = uniqueHash.toUpperCase().slice(0, 12);
            
            // تقسيم لسهولة القراءة
            const formattedId = `CUS-${shortHash.slice(0,4)}${shortHash.slice(4,8)}${shortHash.slice(8,12)}`;
            
            return formattedId;
        }

        // إرسال البيانات إلى Google Form
        function submitToGoogleForm(formData) {
    
            const FORM_ID = '1FAIpQLSeY87kZef7FJjrLKPa3Q9pE6c-F_YQnbBY8nrBQtZN3dpO2Vw';
            const formURL = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
            
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'formTarget';
            document.body.appendChild(iframe);
            
            const form = document.createElement('form');
            form.action = formURL;
            form.method = 'POST';
            form.target = 'formTarget';
            form.style.display = 'none';
            
            const formFields = {
                'entry.1430147432': formData.fullname,
                'entry.1725873193': formData.signupPhone,
                'entry.139862680': formData.state,
                'entry.1197844604': formData.signupPassword,
                'entry.339793544': formData.locationAddress,
                'entry.328639051': formData.storeLat,
                'entry.634415460': formData.userstate,
                'entry.1476594722': formData.creationDate,
                'entry.1631630338': formData.updateDate,
                'entry.1724330402': formData.ID,
                'entry.998031888': formData.photoUrl,
                'entry.1955696355': formData.TotalQuantity,
                'entry.1762881322': formData.ActiveNo,
                'entry.1511212264': formData.UnActiveNo,
                'entry.1683041230': formData.ExpiredNo,
                'entry.420023323': formData.DeleteNo,
                'entry.886121646': formData.AddNo
            };

            Object.keys(formFields).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = formFields[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            
            setTimeout(() => {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
            }, 3000);
            
            return true;
        }

const PHONE_CHECK_SCRIPT = 'https://script.google.com/macros/s/AKfycbxuMpNxQ0YDM109Q03iWa6hrcZe6c4YTUsWxN_iZRYNVjJnhazyqvL7w6hrKcs7kOlc/exec';
// تعديل معالج النموذج
document.getElementById('signupForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
     const submitBtn = this.querySelector('.btn-submit');
    const mode = submitBtn.dataset.mode || 'create';
    const termsContainer = document.querySelector('.terms-checkbox')?.parentElement;
    
    // التحقق من الشروط فقط في وضع التسجيل الجديد
    if (mode === 'create' && termsContainer && termsContainer.style.display !== 'none') {
        const agreeTermsCheckbox = document.getElementById('agreeTerms');
        if (!agreeTermsCheckbox || !agreeTermsCheckbox.checked) {
            showNotification('يجب الموافقة على شروط التسجيل والاستخدام للمتابعة');
            
            // إظهار الشروط للمستخدم
            const termsContent = document.getElementById('termsContent');
            if (termsContent) {
                termsContent.style.display = 'block';
                termsContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return;
        }
    }
    
    if (mode === 'edit') {
        await updateUserData();
    } else {
        await handleNewRegistration();
    }
});

function completeRegistration(imageUrl, phone, password) {
    const agreeTermsCheckbox = document.getElementById('agreeTerms');
    const termsContainer = document.querySelector('.terms-checkbox')?.parentElement;
    
    // إذا كان قسم الشروط ظاهراً (وضع التسجيل الجديد)
    if (termsContainer && termsContainer.style.display !== 'none') {
        if (!agreeTermsCheckbox || !agreeTermsCheckbox.checked) {
            showNotification('يجب الموافقة على شروط التسجيل والاستخدام');
            
            // إظهار الشروط للمستخدم
            const termsContent = document.getElementById('termsContent');
            if (termsContent) {
                termsContent.style.display = 'block';
                termsContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return;
        }
    }
    
    // يمكن إزالة التحقق من هنا أو تركها كإجراء وقائي إضافي
    /*
    if (password.length < 6) {
        alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
        return;
    }
    if (phone.length < 8) {
        alert('رقم الهاتف يجب أن يكون 8 أرقام على الأقل');
        return;
    }
    */
    
    const customerID = generateCustomerID();
    updateModificationDate();
    const formData = {
        Timestamp: new Date().toISOString(),
        ID: customerID,
        fullname: document.getElementById('fullname').value,
        signupPhone: phone,
        state: document.getElementById('state').value,
        signupPassword: password,
        locationAddress: document.getElementById('locationAddress')?.value || '',
        storeLat: document.getElementById('storeLat').value,
        DATE: document.getElementById('date').value,
        userstate: document.getElementById('userstate').value,
        creationDate: document.getElementById('creationDate').value,
        updateDate: document.getElementById('updateDate').value,
        photoUrl: imageUrl,
        TotalQuantity: '5',
        ActiveNo: '5',
        UnActiveNo: '0',
        ExpiredNo: '0',
        DeleteNo: '0',
        AddNo: '0'
    };
    
    try {
        submitToGoogleForm(formData);
        localStorage.setItem('userPassword', password);
        showLoading(false);
        setTimeout(() => {
            showNotification('تم التسجيل بنجاح');
            
            document.getElementById('signupModal').style.display = 'none';
            
            const loginPhone = phone;
            const loginPassword = password;
            
            document.getElementById('loginPhone').value = loginPhone;
            document.getElementById('loginPassword').value = loginPassword;
            
            document.getElementById('loginModal').style.display = 'flex';
            
            setTimeout(() => {
                const loginForm = document.getElementById('loginForm');
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                loginForm.dispatchEvent(submitEvent);
                
                if (!submitEvent.defaultPrevented) {
                    loginWithCredentials(loginPhone, loginPassword);
                }
            }, 500);
            
            document.getElementById('signupForm').reset();
            document.getElementById('previewImage').style.display = 'none';
            document.querySelector('#photoUpload i').style.display = 'block';
            document.getElementById('photoUrl').value = '';
            initializeDateFields();
            const submitBtn = document.querySelector('.btn-submit');
            submitBtn.textContent = 'تسجيل الحساب';
            submitBtn.disabled = false;
        }, 1000);
        
    } catch (error) {
        showNotification('حدث خطأ أثناء حفظ البيانات. يرجى المحاولة مرة أخرى.');
        console.error('Error:', error);
        const submitBtn = document.querySelector('.btn-submit');
        submitBtn.textContent = 'تسجيل الحساب';
        submitBtn.disabled = false;
        showLoading(false);
    }
}

// مشاركة المنتج
document.addEventListener('click', function(e){

    const shareBtn = e.target.closest('.share-btn');
    if(!shareBtn) return;

    const modal = document.querySelector('.product-detail-content');
    const productId = modal.getAttribute('data-product-id');
    const product = productDetails[productId];

    if(!product){
        alert('❌ لا يمكن مشاركة المنتج');
        return;
    }

    const shareText = buildShareText(product);
    const productUrl = 'https://almobseroon-hash.github.io/ALMOBSEROON/';

    // ✅ إذا المتصفح يدعم المشاركة العامة (موبايل)
    if (navigator.share) {
        navigator.share({
            title: product.name,
            text: shareText,
            url: productUrl
        }).catch(err => console.log(err));
    } 
    // ✅ fallback → واتساب
    else {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
        window.open(whatsappUrl, '_blank');
    }
});

function buildShareText(product) {

    const imageUrl = product.images && product.images.length > 0 
        ? product.images[0] 
        : '';

    const productUrl = `${window.location.origin}${window.location.pathname}?productId=${product.id || product.productId}`;

    return `
📦 *${product.name}*

🆔 رقم المنتج: ${product.productNo}
📂 النوع: ${product.type}
💰 السعر: ${product.price}
📞 رقم التواصل: ${product.phone}

🖼 صورة المنتج:
${imageUrl}

🔗 رابط المنتج:
${productUrl}
    `.trim();
}


        // إضافة تفاعل لأزرار واتساب
      document.addEventListener('click', function(event) {
    if (event.target.closest('.whatsapp-btn')) {
        const button = event.target.closest('.whatsapp-btn');
        const phoneNumber = button.querySelector('.phone-number').textContent;

        let productName, productPrice, productNumber, productImage, productId;

        // تحديد المكان: بطاقة منتج في الشبكة أم نافذة تفاصيل
        if (button.closest('.product-card')) {
            // داخل بطاقة منتج في الصفحة الرئيسية
            const productCard = button.closest('.product-card');
            productName = productCard.querySelector('.product-name').textContent;
            productPrice = productCard.querySelector('.product-price').textContent;
            
            // الحصول على الصورة الرئيسية
            const imgElement = productCard.querySelector('img');
            productImage = imgElement ? imgElement.src : '';
            
            // الحصول على رقم المنتج وID من كائن productDetails
            const productIndex = productCard.getAttribute('data-index');
            if (productIndex !== null && productDetails[productIndex]) {
                productNumber = productDetails[productIndex].productNo || 'غير محدد';
                productId = productDetails[productIndex].id || 
                           productDetails[productIndex].productId || 
                           productIndex;
            } else {
                productNumber = 'غير محدد';
                productId = productIndex || '0';
            }
        } else if (document.getElementById('productDetailModal').style.display === 'flex') {
            // داخل نافذة تفاصيل المنتج
            productName = document.getElementById('detail-product-name').textContent;
            productPrice = document.getElementById('detail-product-price').textContent;
            productNumber = document.getElementById('detail-product-number').textContent || 'غير محدد';
            
            // الحصول على الصورة من نافذة التفاصيل
            const detailImg = document.getElementById('detail-product-image');
            productImage = detailImg ? detailImg.src : '';
            
            // الحصول على ID المنتج من النافذة
            const productIndex = document.getElementById('productDetailModal').getAttribute('data-product-index');
            if (productIndex !== null && productDetails[productIndex]) {
                productId = productDetails[productIndex].id || 
                           productDetails[productIndex].productId || 
                           productIndex;
            } else {
                productId = productIndex || '0';
            }
        } else {
            // حالة احتياطية
            productName = 'منتج';
            productPrice = 'غير محدد';
            productNumber = 'غير محدد';
            productImage = '';
            productId = '0';
        }

        // بناء رابط الموقع مع المعرف
     const baseUrl = 'https://almobseroon-hash.github.io/ALMOBSERON7/';
// إضافة معلمة productId إلى رابط موقعك
const productDeepLink = `${baseUrl}?productId=${productId}`;

// بناء الرسالة النهائية مع وضع الروابط في الأعلى
const message = `📸 *صورة المنتج:* ${productImage}\n\n` + // رابط الصورة
               `🔗 *عرض تفاصيل المنتج:*\n${productDeepLink}\n\n` + // رابط موقعك
               `🌟 أنا مهتم بهذا المنتج 🌟\n\n` +
               `📦 *رقم المنتج:* ${productNumber}\n` +
               `🏷️ *اسم المنتج:* ${productName}\n` +
               `💰 *السعر:* ${productPrice}`;
                `📞 للاستفسار: ${phoneNumber}`;

        // إنشاء رابط واتساب
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
});
// دالة لقراءة معلمة productId من URL وفتح المنتج
function openProductFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('productId');
    
    if (productId) {
        // البحث عن المنتج في productDetails
        let productIndex = null;
        
        // البحث في productDetails
        for (const key in productDetails) {
            if (productDetails[key]) {
                const product = productDetails[key];
                const currentId = product.id || product.productId || key;
                if (currentId.toString() === productId.toString()) {
                    productIndex = key;
                    break;
                }
            }
        }
        
        // إذا وجد المنتج، افتح نافذة التفاصيل
        if (productIndex !== null) {
            setTimeout(() => {
                openProductDetailModal(parseInt(productIndex));
            }, 1000);
            
            // تحديث URL لإزالة المعلمة بعد فتح المنتج
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
    }
}

// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    openProductFromUrl();
    
    // إضافة خاصية data-product-id لأزرار الواتساب
    document.querySelectorAll('.whatsapp-btn').forEach(button => {
        const productCard = button.closest('.product-card');
        if (productCard) {
            const productIndex = productCard.getAttribute('data-index');
            if (productIndex !== null && productDetails[productIndex]) {
                const productId = productDetails[productIndex].id || 
                                 productDetails[productIndex].productId || 
                                 productIndex;
                
                // إضافة عنصر خفي يحمل ID المنتج
                const idElement = document.createElement('span');
                idElement.className = 'product-id';
                idElement.style.display = 'none';
                idElement.textContent = productId;
                button.appendChild(idElement);
            }
        }
    });
});

        // إضافة تفاعل لأزرار الاتصال
   // دالة مستقلة للاتصال
function makePhoneCall(phoneNumber) {
    if (!phoneNumber) {
        console.error('لم يتم تحديد رقم الهاتف');
        return;
    }
    
    // تنظيف الرقم
    const cleanNumber = phoneNumber.toString().replace(/\D/g, '');
    
    // إنشاء رابط الاتصال
    const telLink = document.createElement('a');
    telLink.href = `tel:${cleanNumber}`;
    telLink.style.display = 'none';
    
    // إضافة الرابط إلى الصفحة والنقر عليه برمجياً
    document.body.appendChild(telLink);
    telLink.click();
    
    // إزالة الرابط بعد ثانية
    setTimeout(() => {
        document.body.removeChild(telLink);
    }, 1000);
    
    console.log('تم محاولة الاتصال بـ:', cleanNumber);
}

// استدعاء الدالة عند النقر على زر الاتصال
document.addEventListener('click', function(event) {
    const callBtn = event.target.closest('.call-btn');
    if (!callBtn) return;

    event.preventDefault();

    let productPhone = '';

    // 1️⃣ محاولة الحصول على الرقم من كرت المنتج
    const productCard = callBtn.closest('.product-card');
    if (productCard) {
        const productIndex = productCard.getAttribute('data-index');
        if (productIndex !== null && productDetails && productDetails[productIndex]) {
            productPhone = productDetails[productIndex].phone;
        }
    }

    // 2️⃣ إذا لم يكن داخل كرت منتج → خذه من نافذة التفاصيل
    if (!productPhone) {
        const detailNumber = document.getElementById('detail-whatsapp-number');
        if (detailNumber) {
            productPhone = detailNumber.textContent.trim();
        }
    }

    // 3️⃣ تنفيذ الاتصال
    if (productPhone) {
        makePhoneCall(productPhone);
    } else {
        alert('❌ لا يمكن العثور على رقم الهاتف');
        console.warn('لم يتم العثور على رقم الهاتف للاتصال');
    }
});

        // إضافة تفاعل للصور المصغرة مع تأثير الشرائح
        document.addEventListener('click', function(event) {
            if (event.target.closest('.thumbnail')) {
                const thumbnail = event.target.closest('.thumbnail');
                const productId = thumbnail.getAttribute('data-product');
                const imageSrc = thumbnail.getAttribute('data-image');
                const mainImage = document.getElementById(`main-image-${productId}`);
                
                thumbnail.closest('.product-thumbnails').querySelectorAll('.thumbnail').forEach(t => {
                    t.classList.remove('active');
                });
                
                thumbnail.classList.add('active');
                mainImage.style.opacity = 0;
                
                setTimeout(() => {
                    mainImage.src = imageSrc;
                    setTimeout(() => {
                        mainImage.style.opacity = 1;
                    }, 50);
                }, 300);
            }
        });

        // فلتر المنتجات
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => {
                    t.classList.remove('active');
                });
                resetFilter();
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                const products = document.querySelectorAll('.product-card');
                
                products.forEach(product => {
                    if (filter === 'all' || product.getAttribute('data-category') === filter) {
                        product.style.display = 'flex';
                    } else {
                        product.style.display = 'none';
                    }
                });
            });
        });

        // إضافة تفاعل لأيقونة المفضلة
        document.addEventListener('click', function(event) {
            if (event.target.closest('.favorite-icon')) {
                const icon = event.target.closest('.favorite-icon');
                icon.classList.toggle('active');
                const heartIcon = icon.querySelector('i');
                if (icon.classList.contains('active')) {
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                    const productName = icon.closest('.product-card') ? 
                        icon.closest('.product-card').querySelector('.product-name').textContent :
                        document.getElementById('detail-product-name').textContent;
                    console.log(`تمت إضافة ${productName} إلى المفضلة`);
                } else {
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                    const productName = icon.closest('.product-card') ? 
                        icon.closest('.product-card').querySelector('.product-name').textContent :
                        document.getElementById('detail-product-name').textContent;
                    console.log(`تمت إزالة ${productName} من المفضلة`);
                }
            }
        });
        // إضافة تفاعل لزر العرض
       document.addEventListener('click', function(event) {
            if (event.target.closest('.view-details-btn')) {
                const button = event.target.closest('.view-details-btn');
                const productId = button.getAttribute('data-product');
                showProductDetails(productId);
              
            }
        });
        // دالة لعرض/إخفاء أيقونة التحميل
        function showLoading(show, message = 'جاري الحفظ...') {
            // إزالة أي أيقونة تحميل سابقة
            const existingLoader = document.getElementById('custom-loader');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            if (show) {
                // إنشاء عنصر التحميل
                const loader = document.createElement('div');
                loader.id = 'custom-loader';
                loader.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    color: white;
                    font-size: 18px;
                `;
                
                loader.innerHTML = `
                    <div class="spinner" style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin-bottom: 20px;
                    "></div>
                    <div>${message}</div>
                `;
                
                // إضافة أنيميشن للتدوير
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(loader);
            }
        }
        // عرض تفاصيل المنتج
      function showProductDetails(productId) {
            console.log('====== عرض تفاصيل المنتج ======');
            console.log('ID المنتج:', productId);
            console.log('كائن المنتج الكامل:', productDetails[productId]);
            
            const product = productDetails[productId];
            if (!product) {
                console.error('المنتج غير موجود!');
                return;
            }
            
            // التحقق من خصائص الكائن
            console.log('خصائص المنتج المتاحة:', Object.keys(product));
            console.log('product.location:', product.location);
            console.log('product.locationstate:', product.locationstate);
            
            // تعيين معرف المنتج في النافذة
            document.querySelector('.product-detail-content').setAttribute('data-product-id', productId);
            
            // جلب عناصر DOM
            const locationElement = document.getElementById('detail-product-location');
            const locationstateElement = document.getElementById('detail-product-locationstate');
            
            console.log('عنصر المنطقة في DOM:', locationElement);
            console.log('عنصر الموقع في DOM:', locationstateElement);
            
            if (locationElement) {
                // استخدم القيمة الصحيحة
                locationElement.textContent = product.location || 'غير محدد';
                console.log('تم تعيين المنطقة:', product.location);
            }
            
            if (locationstateElement) {
                // استخدم القيمة الصحيحة - قد يكون الاسم مختلفًا
                const locationStateValue = product.locationstate || product.locationName || product.location || 'غير محدد';
                locationstateElement.textContent = locationStateValue;
                console.log('تم تعيين الموقع:', locationStateValue);
            }
            
            // بقية الحقول
            const elementsToUpdate = {
                'detail-product-number': product.productNo || `PRO-${String(productId + 1).padStart(4, '0')}`,
                'detail-product-name': product.name,
                'detail-product-description': product.description,
                'detail-product-price': product.price,
                'detail-product-type': product.type,
                'detail-product-quantity': product.quantity,
                'detail-product-condition': product.condition,
                'detail-product-warranty': product.warranty,
                'detail-product-color': product.color,
                'detail-product-phone': product.phone,
                'detail-product-location': product.location,
                'detail-product-locationstate': product.locationstate || product.location
            };
            
            for (const [id, value] of Object.entries(elementsToUpdate)) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || 'غير محدد';
                }
            }
            document.getElementById('detail-product-number').textContent = product.productNo || `PRO-${String(productId + 1).padStart(4, '0')}`;
            document.getElementById('detail-whatsapp-number').textContent = product.phone || '07701234567';
            
            // الصور
            const mainImage = document.getElementById('detail-main-image');
            if (product.images && product.images.length > 0) {
                mainImage.src = product.images[0];
            }
            
            const thumbnailsContainer = document.getElementById('detail-thumbnails');
            thumbnailsContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                product.images.forEach((imageSrc, index) => {
                    const thumbnail = document.createElement('div');
                    thumbnail.className = `product-detail-thumbnail ${index === 0 ? 'active' : ''}`;
                    
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.alt = `صورة ${product.name}`;
                    
                    thumbnail.appendChild(img);
                    thumbnailsContainer.appendChild(thumbnail);
                    
                    thumbnail.addEventListener('click', function() {
                        document.querySelectorAll('.product-detail-thumbnail').forEach(t => {
                            t.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        mainImage.style.opacity = 0;
                        
                        setTimeout(() => {
                            mainImage.src = imageSrc;
                            setTimeout(() => {
                                mainImage.style.opacity = 1;
                            }, 50);
                        }, 300);
                    });
                });
            }
            
            // تحديث أيقونة المفضلة في نافذة التفاصيل
            const detailFavoriteIcon = document.querySelector('.product-detail-actions .favorite-icon');
            if (detailFavoriteIcon) {
                detailFavoriteIcon.setAttribute('data-product', productId);
                
                // تحديث الحالة بناءً على ما إذا كان المنتج مفضلاً
                const isProductFavorite = isFavorite(productId);
                const heartIcon = detailFavoriteIcon.querySelector('i');
                
                if (isProductFavorite) {
                    detailFavoriteIcon.classList.add('active');
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                } else {
                    detailFavoriteIcon.classList.remove('active');
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                }
            }
            
            // دالة لتحديث أيقونة المفضلة في نافذة التفاصيل
            function updateDetailFavoriteIcon(productId) {
                const detailFavoriteIcon = document.querySelector('.product-detail-actions .favorite-icon');
                if (detailFavoriteIcon) {
                    detailFavoriteIcon.setAttribute('data-product', productId);
                    
                    const isProductFavorite = isFavorite(productId);
                    const heartIcon = detailFavoriteIcon.querySelector('i');
                    
                    if (isProductFavorite) {
                        detailFavoriteIcon.classList.add('active');
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                    } else {
                        detailFavoriteIcon.classList.remove('active');
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                    }
                }
            }
            
            // تهيئة الخريطة المصغرة
            const locationData = {
                location: product.location,
                locationName: product.locationstate,
                locationLink: product.locationLink // استخدم رابط الموقع المحفوظ
            };

            setTimeout(() => {
                // استخدم رابط الموقع إذا كان متوفرًا، وإلا استخدم اسم المدينة
                if (product.locationLink) {
                    const coords = extractCoordinatesFromLink(product.locationLink);
                    if (coords) {
                        initProductDetailMap(coords.lat, coords.lng, product.locationstate || product.location, product);
                    } else {
                        const fallbackLocation = getLocationCoordinates(product.location);
                        initProductDetailMap(fallbackLocation.lat, fallbackLocation.lng, fallbackLocation.name, product);
                    }
                } else {
                    const fallbackLocation = getLocationCoordinates(product.location);
                    initProductDetailMap(fallbackLocation.lat, fallbackLocation.lng, fallbackLocation.name, product);
                }
            }, 100);
            
            // تحديث أيقونة المفضلة
            updateDetailFavoriteIcon(productId);
            
            // عرض النافذة
               document.getElementById('productDetailModal').style.display = 'flex';
        }

        // إضافة مستمعي الأحداث للخريطة
        document.addEventListener('DOMContentLoaded', function() {
            // مستمعي أحداث الخريطة
            document.getElementById('open-full-map').addEventListener('click', openFullMap);
            document.getElementById('get-directions').addEventListener('click', getDirections);
            document.getElementById('closeFullMap').addEventListener('click', closeFullMap);
            document.getElementById('copy-location-link').addEventListener('click', copyLocationLink);
            
            // ربط زر تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', openLoginModal);
            
            // ربط زر الإغلاق في نافذة تسجيل الدخول
            document.getElementById('closeLoginModal').addEventListener('click', closeLoginModal);
            
            // ربط زر إغلاق
            document.getElementById('closeLoginBtn').addEventListener('click', closeLoginModal);
            
            // ربط زر تسجيل جديد من نافذة الدخول
            document.getElementById('openSignupFromLogin').addEventListener('click', function() {
                closeLoginModal();
                document.getElementById('signupModal').style.display = 'flex';
   
            });
    document.getElementById('manageOrdersBtn').addEventListener('click', async function() {
        openOrderManagementModal();
        // تحميل الطلبات المفعلة عند فتح النافذة
        await loadActiveOrders();
    });
            // ربط زر نسيت كلمة المرور
        document.getElementById('forgotPasswordBtn').addEventListener('click', function () {

    const userPhoneInput = document.getElementById('loginPhone');
    const userPhone = userPhoneInput.value.trim();

    if (!userPhone) {
        alert('❌ الرجاء إدخال رقم هاتفك أولاً');
        userPhoneInput.focus();
        return;
    }

    // تنظيف الرقم (إزالة أي رموز)
    const cleanUserPhone = userPhone.replace(/\D/g, '');

    const adminPhone = '96895209623';

    // نص الرسالة
    const message = `
مرحبا إدارة النظام،
نسيت كلمة المرور.

رقم هاتفي:
${cleanUserPhone}

أرجو المساعدة في إعادة تعيين كلمة المرور.
`.trim();

    // ترميز الرسالة للرابط
    const encodedMessage = encodeURIComponent(message);

    // رابط واتساب
    const whatsappUrl = `https://wa.me/${adminPhone}?text=${encodedMessage}`;

    // فتح واتساب في نافذة جديدة
    window.open(whatsappUrl, '_blank');
});
            
               const saveOrderBtn = document.querySelector('#orderManagementModal .btn-submit');
    if (saveOrderBtn) {
        saveOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveOrder();
        });
    }
      // زر إدارة الطلبات في الشريط العلوي
    manageOrdersBtnNav = document.getElementById('manageOrdersBtnNav');
    if (manageOrdersBtnNav) {
        manageOrdersBtnNav.addEventListener('click', openOrderManagementFromNav);
        console.log('تم ربط زر إدارة الطلبات في الشريط العلوي');
    }
    
    // تحديث رؤية زر إدارة الطلبات عند تحميل الصفحة
    updateManageOrdersButtonVisibility();

    // زر الإلغاء
    const cancelBtn = document.getElementById('cancelOrderBtn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            initOrderForm();
        });
    }
    
    // حساب القيم عند تغيير الكمية
    document.getElementById('orderQuantity').addEventListener('input', calculateOrderValues);
            // إغلاق النافذة بمفتاح ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && document.getElementById('loginModal').style.display === 'flex') {
                    closeLoginModal();
                }
            });
            
            // إغلاق نافذة الخريطة عند النقر خارجها
            document.getElementById('fullMapModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeFullMap();
                }
            });
            
            // التحقق من حالة الدخول
            checkLoginStatus();
        });

        // دالة لتحديث واجهة المستخدم بعد تسجيل الدخول (المحدثة)
       function updateUIAfterRegistration(userData) {
    console.log('🔄 تحديث الواجهة ببيانات:', userData);
    
    try {
        // 1. إخفاء أزرار الدخول والتسجيل
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('openSignup');
        const termsContainer = document.querySelector('.terms-container');
    if (termsContainer) {
        termsContainer.style.display = 'none';
    }
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        
        // 2. إظهار الملف الشخصي
        const userProfile = document.getElementById('userProfile');
        if (userProfile) {
            userProfile.style.display = 'flex';
        }
        
        // 3. تحديث بيانات المستخدم في شريط التنقل
     const userPhoneElement = document.getElementById('userPhone');
        if (userPhoneElement && (userData.phone || userData.signupPhone)) {
            userPhoneElement.textContent = userData.phone || userData.signupPhone;
            
            // إضافة مستمع الحدث للنقر على رقم الهاتف
        updateMyOrdersNavButtonVisibility();
        updateManageOrdersButtonVisibility();
        showAddProductButton();
        
        // ربط الأحداث
        setupMyOrdersNavButton();
        setupManageOrdersNavButton();
        }
        
        // 4. تحديث صورة الملف الشخصي
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) {
            if (userData.photoUrl && userData.photoUrl.trim() !== '') {
                userAvatar.src = userData.photoUrl;
                userAvatar.onerror = function() {
                    // إذا فشل تحميل الصورة، استخدم الصورة الافتراضية
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMGIiIHI9IjIwIiBmaWxsPSIjMzQ5OERCIi8+CjxwYXRoIGQ9Ik0yMCAyMkMyMy4zMTM3IDIyIDI2IDE5LjMxMzcgMjYgMTZDMjYgMTIuNjg2MyAyMy4zMTM3IDEwIDIwIDEwQzE2LjY4NjMgMTAgMTQgMTIuNjg2MyAxNCAxNkMxNCAxOS4zMTM3IDE2LjY4NjMgMjIgMjAgMjJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjggMzBDMjggMjcuNzkwOSAyNi4yMDkxIDI2IDI0IDI2SDE2LjAwMDFDMTMuNzkxIDI2IDEyIDI3Ljc5MDkgMTIgMzBDMTIgMzIuMjA5MSAxMy43OTEgMzQgMTYuMDAwMSAzNEgyNEMyNi4yMDkxIDM0IDI4IDMyLjIwOTEgMjggMzBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K';
                };
            } else {
                userAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4REIiLz4KPC9zdmc+';
            }
        }
         updateMyOrdersButtonVisibility();
        updateManageOrdersButtonVisibility(); // ← أضف هذا السطر
        // 5. إظهار زر إضافة المنتج
        showAddProductButton();
        updateMyOrdersButtonVisibility();
        // 6. تحديث نموذج إضافة المنتج ببيانات المستخدم المحدثة
        updateProductFormWithUserData(userData);
        
        // 7. تحديث أي معلومات أخرى في الصفحة
        updateOtherUIElements(userData);
        
        console.log('✅ تم تحديث واجهة المستخدم بنجاح');
        
    } catch (error) {
        console.error('❌ خطأ في تحديث الواجهة:', error);
    }
}


        // دالة تسجيل الخروج
    function logout() {
    // إخفاء الملف الشخصي
    const userProfile = document.getElementById('userProfile');
    if (userProfile) {
        userProfile.style.display = 'none';
    }
    
    // إخفاء زر إضافة المنتج
        // إخفاء زر طلباتي
    const myOrdersSectionNav = document.getElementById('myOrdersSectionNav');
    if (myOrdersSectionNav) {
        myOrdersSectionNav.style.display = 'none';
      
    }
    // إظهار أزرار الدخول والتسجيل
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('openSignup');
    if (loginBtn) loginBtn.style.display = 'block';
    if (signupBtn) signupBtn.style.display = 'block';

    // إعادة تعيين أيقونة الهاتف
    const userPhoneElement = document.getElementById('userPhone');
    if (userPhoneElement) {
        userPhoneElement.style.cursor = 'default';
        userPhoneElement.style.textDecoration = 'none';
    }
     const ordersManagementSection = document.getElementById('ordersManagementSection');
    if (ordersManagementSection) {
        ordersManagementSection.style.display = 'none';
    }
    // مسح بيانات المستخدم من localStorage
    localStorage.removeItem('currentUser');
    localStorage.removeItem('isLoggedIn');
    
    // إغلاق جميع النوافذ المفتوحة
    closeLoginModal();
    document.getElementById('signupModal').style.display = 'none';
    document.getElementById('addProductModal').style.display = 'none';
    document.getElementById('signupPhone').readOnly = false;
    document.getElementById('signupPhone').background = '#ffffff';
    document.getElementById('signupPhone').style.cursor = 'allowed';
    // إعادة تعيين نموذج التسجيل
    resetSignupForm();
    
    // إعادة تحميل المنتجات
    loadProductsFromGoogleSheets();
    
    // إظهار رسالة نجاح
    showNotification('تم تسجيل الخروج بنجاح');
}
        // تهيئة الحقول المخفية
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('userstate').value = 'USER';

        // دالة لإظهار زر إضافة المنتج بعد تسجيل الدخول
        function showAddProductButton() {
            document.getElementById('addProductSection').style.display = 'block';
        }

        // دالة لإخفاء زر إضافة المنتج بعد تسجيل الخروج
     function openAddProductModal() {
    document.getElementById('addProductModal').style.display = 'flex';
    
    // تهيئة التواريخ
    initProductDates();
    
    // إعادة تعيين النموذج
    resetProductForm();
          const situationField = document.getElementById('productSituation');
                situationField.disabled = true;
                situationField.hidden = true;
}

       document.getElementById('addProductBtn').addEventListener('click', async function() {
            const activeCount = parseInt(document.getElementById('counter-active').textContent) || 0;
    
    // إذا كان عدد الطلبات النشطة أقل من 1
    if (activeCount < 1) {
        // عرض رسالة عائمة حمراء
        showFloatingAlert('لايوجد رصيد نشط لإضافة منتج جديد، اضف رصيد او نشط اذا كان هناك رصيد غير نشط');
        return; // نخرج من الدالة ولا نفتح النافذة
    }
            try {
                await openAddProductModal();
              //  checkUserSituation();
                    const situationField = document.getElementById('productSituation');
                situationField.disabled = true;
                situationField.hidden = true;
                removeRenewalSuccessMessage();
                removeExpiryMessage();
                removeRenewButton();
            } catch (error) {
                console.error('خطأ في فتح نافذة المنتج:', error);
                alert('حدث خطأ أثناء تحضير النموذج. يرجى المحاولة مرة أخرى.');
            }
        });

        
  // 🔥 **تعديل دالة closeAddProductModal**
function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
    
    // إعادة تعيين النموذج
    resetProductForm();
    
    // 🔥 **إعادة تعيين المتغيرات**
    currentEditingProduct = null;
    currentEditingProductNo = null;
    productImages = [];
    
    // إزالة الخريطة إذا كانت موجودة
    if (productMap) {
        productMap.remove();
        productMap = null;
        productLocationMarker = null;
    }
    
    console.log('🧹 تم إعادة تعيين متغيرات التعديل');
}

        // دالة لتوليد رقم المنتج التلقائي بناءً على آخر رقم
        async function generateProductNo() {
            // timestamp + عشوائية عالية + أداء النظام
            const uniqueHash = 
                Date.now().toString(36) + 
                Math.random().toString(36).substring(2) +
                performance.now().toString(36).replace('.', '');
            
            // أخذ 12 حرف فقط
            const shortHash = uniqueHash.toUpperCase().slice(0, 12);
            
            // تقسيم لسهولة القراءة
            const formattedId = `PRO-${shortHash.slice(0,4)}${shortHash.slice(4,8)}${shortHash.slice(8,12)}`;
            
            return formattedId;
        }

        // دالة لإعادة تعيين نموذج المنتج
   /**
 * دالة محسنة لإعادة تعيين نموذج المنتج
 */
async function resetProductForm() {
    try {
        const form = document.getElementById('addProductForm');
        if (form) {
            form.reset();
        }
        
        // إعادة تعيين الصور
        productImages = [];
        updateProductImagesPreview();
        
        // إعادة تعيين زر الحفظ
        const submitBtn = document.querySelector('#addProductForm .btn-submit');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ المنتج';
            submitBtn.dataset.mode = 'create';
            submitBtn.dataset.productNo = '';
            submitBtn.disabled = false;
            submitBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
        }
        
        // إعادة تعيين العنوان
        const modalTitle = document.querySelector('#addProductModal h2');
        if (modalTitle) {
            modalTitle.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-plus-circle" style="color: #2ecc71;"></i>
                    <span>إضافة منتج جديد</span>
                </div>
            `;
        }
        
        // تمكين الحقول المعطلة
        document.getElementById('productNo').readOnly = false;
        document.getElementById('productName').readOnly = false;
        document.getElementById('custel').readOnly = true;
        document.getElementById('productWarranty').readOnly = false;
         document.getElementById('productCategory').disabled = false;
        
        // إعادة تعيين أنماط الحقول
        const fieldsToReset = ['productName', 'productCategory','productWarranty'];
        fieldsToReset.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.style.backgroundColor = '';
                field.style.cursor = 'text';
            }
        });
        
        // إعادة تعيين التواريخ
        document.getElementById('productTimestamp').value = getCurrentDateTime();
        initProductDatesExpired();
        
        // توليد رقم منتج جديد
        const newProductNo = await generateProductNo();
        document.getElementById('productNo').value = newProductNo;
        
        // تعيين بيانات المستخدم
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (currentUser.signupPhone) {
            document.getElementById('custel').value = currentUser.signupPhone;
        }
        
        // إعادة تعيين الخريطة
      if (productMap) {
    // عرض الخريطة على مسقط
    productMap.setView([23.5880, 58.3829], 11);

    if (productLocationMarker) {
        // وضع الماركر في مسقط
        productLocationMarker.setLatLng([23.5880, 58.3829]);
        updateProductLocationFields(23.5880, 58.3829);
    }
}
        
        console.log('✅ تم إعادة تعيين النموذج');
        
    } catch (error) {
        console.error('❌ خطأ في إعادة تعيين النموذج:', error);
    }
}
        // دالة لتحديث معاينة صور المنتج
        function updateProductImagesPreview() {
            const container = document.getElementById('productImagesPreview');
            container.innerHTML = '';
            
            const uploadSlot = document.createElement('div');
            uploadSlot.className = 'product-image-upload';
            uploadSlot.innerHTML = `
                <i class="fas fa-plus"></i>
                <input type="file" class="product-image-input" accept="image/*" style="display: none;">
            `;
            
            uploadSlot.addEventListener('click', function() {
                if (productImages.length < 3) {
                    this.querySelector('.product-image-input').click();
                } else {
                    alert('يمكنك إضافة 3 صور كحد أقصى');
                }
            });
            
            const fileInput = uploadSlot.querySelector('.product-image-input');
            fileInput.addEventListener('change', function(e) {
                handleProductImageUpload(e);
            });
            
            container.appendChild(uploadSlot);
            
            productImages.forEach((image, index) => {
                const imageSlot = document.createElement('div');
                imageSlot.className = 'product-image-upload';
                imageSlot.innerHTML = `
                    <img src="${image.preview}" alt="صورة المنتج">
                    <button type="button" class="remove-image" data-index="${index}">&times;</button>
                `;
                
                container.appendChild(imageSlot);
            });
            
            document.querySelectorAll('.remove-image').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    productImages.splice(index, 1);
                    updateProductImagesPreview();
                });
            });
        }

        // دالة لمعالجة رفع صورة المنتج
        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.match('image.*')) {
                    alert('يرجى اختيار ملف صورة فقط');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('حجم الصورة يجب أن يكون أقل من 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    productImages.push({
                        file: file,
                        preview: e.target.result
                    });
                    updateProductImagesPreview();
                };
                reader.onerror = function() {
                    alert('خطأ في قراءة الملف');
                };
                reader.readAsDataURL(file);
            }
        }

        // دالة لرفع صور المنتج إلى ImgBB
        async function uploadProductImages() {
            const imageUrls = [];
            
            for (const image of productImages) {
                try {
                    const url = await uploadToImgBB(image.file);
                    imageUrls.push(url);
                } catch (error) {
                    console.error('Error uploading product image:', error);
                    throw new Error('فشل في رفع صورة المنتج');
                }
            }
            
            return imageUrls;
        }

function initProductDates() {
    const today = new Date().toISOString().split('T')[0];
    
    // تاريخ الإضافة (تاريخ اليوم - غير قابل للتعديل)
    document.getElementById('productAddDate').value = today;
    
    // تاريخ الانتهاء (بعد سنة من اليوم)
    const nextYear = new Date();
    nextYear.setFullYear(nextYear.getFullYear() + 1);
    const nextYearDate = nextYear.toISOString().split('T')[0];
    document.getElementById('productExpiredDate').value = nextYearDate;
    
    console.log('📅 تم تهيئة تواريخ المنتج');
}

/**
 * دالة لتهيئة تاريخ الانتهاء فقط
 */
function initProductDatesExpired() {
    // تاريخ الانتهاء (بعد 6 أشهر من اليوم)
    const nextSixMonths = new Date();
    nextSixMonths.setMonth(nextSixMonths.getMonth() + 6);
    const nextSixMonthsDate = nextSixMonths.toISOString().split('T')[0];
    document.getElementById('productExpiredDate').value = nextSixMonthsDate;
    
    console.log('📅 تم تهيئة تاريخ الانتهاء بعد 6 أشهر:', nextSixMonthsDate);
}

        // دالة لإرسال بيانات المنتج إلى Google Form
    function submitProductToGoogleForm(formData) {
    const FORM_ID = '1FAIpQLSeheC4UYllmeIXBtf2qKj9foqsu8r1JQS54DPmbzUXslqFojQ';
    const formURL = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
    
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.name = 'productFormTarget';
    document.body.appendChild(iframe);
    
    const form = document.createElement('form');
    form.action = formURL;
    form.method = 'POST';
    form.target = 'productFormTarget';
    form.style.display = 'none';
    
    // تأكد من أن formData تحتوي على productExpiredDate
    console.log('بيانات المنتج المرسلة إلى Google Form:', formData);
    
    const formFields = {
        'entry.1234567890': formData.timestamp,
        'entry.803229415': formData.productNo,
        'entry.391832576': formData.productName,
        'entry.1916542035': formData.custel,
        'entry.858427936': formData.productCategory,
        'entry.842995801': formData.productPrice,
        'entry.1894337439': formData.productState,
        'entry.1368760975': formData.productQuantity,
        'entry.438442807': formData.productDescription,
        'entry.1479506583': formData.state,
        'entry.1265170769': formData.locationName,
        'entry.1954231527': formData.locationLink,
        'entry.203808232': formData.image1,
        'entry.1989969410': formData.image2,
        'entry.1087143476': formData.image3,
        'entry.1526601892': formData.situation,
        'entry.369158192': formData.productColor,
        'entry.569056350': formData.productWarranty,
        'entry.867887576': formData.productExpiredDate  // هذا هو حقل تاريخ الانتهاء
    };

    Object.keys(formFields).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = formFields[key] || ''; // تأكد من عدم وجود قيم undefined
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
    setTimeout(() => {
        document.body.removeChild(form);
        document.body.removeChild(iframe);
    }, 3000);
    
    return true;
}

        // دالة لإضافة منتج جديد
      async function addNewProduct(productData) {
    try {
        // عرض أيقونة التحميل
        showLoading(true, 'جاري حفظ المنتج...');
        
        // أولاً: خصم رصيد ActiveNo قبل حفظ المنتج
        console.log('🔔 محاولة خصم الرصيد قبل إضافة المنتج...');
        const deductionResult = await deductActiveNoBalance({
            operation: 'إضافة منتج جديد',
            productName: productData.productName,
            productNo: productData.productNo,
            timestamp: productData.timestamp
        });
        
        if (!deductionResult.success) {
            throw new Error(`فشل في خصم الرصيد: ${deductionResult.error || 'رصيد غير كافي'}`);
        }
        
        console.log('✅ تم خصم الرصيد بنجاح، الرصيد المتبقي:', deductionResult.newBalance);
        
       
        // ثانياً: رفع الصور
        const imageUrls = await uploadProductImages();
        
        productData.image1 = imageUrls[0] || '';
        productData.image2 = imageUrls[1] || '';
        productData.image3 = imageUrls[2] || '';
        
        productData.locationLink = document.getElementById('productLocationLink').value || '';
        
        // إضافة تاريخ الانتهاء من الحقل مباشرة
        const expiredDateField = document.getElementById('productExpiredDate');
        if (expiredDateField && expiredDateField.value) {
            productData.productExpiredDate = expiredDateField.value;
        } else {
            // إذا لم يكن هناك تاريخ، استخدم القيمة المحسوبة
            productData.productExpiredDate = productData.productExpiredDate || calculateExpiredDate();
        }
        
        // إضافة حقل إضافي يوضح أن المنتج تمت إضافه بعد خصم الرصيد
        productData.balanceDeducted = 'نعم';
        productData.previousBalance = deductionResult.previousBalance || 'غير معروف';
        productData.newBalance = deductionResult.newBalance;
        
        console.log('📦 بيانات المنتج النهائية بعد خصم الرصيد:', productData);
        
        // ثالثاً: إرسال البيانات إلى Google Form
        await submitProductToGoogleForm(productData);
        
        // رابعاً: الانتظار قليلاً ثم ترتيب البيانات
        setTimeout(async () => {
            try {
                 // تحديث العداد المحلي للرصيد
        updateLocalBalanceCounter();
        loadUserProductsFromExcel();
        loadMyOrdersInterface();
                await sortProductsByDateDescending();
                console.log('✅ تم ترتيب المنتجات بنجاح');
                
                // عرض رسالة نجاح للمستخدم
                showSuccessMessage('تم إضافة المنتج وخصم الرصيد بنجاح!');
                
            } catch (sortError) {
                console.error('❌ خطأ في ترتيب المنتجات:', sortError);
            }
        }, 1000);
        
        return {
            success: true,
            message: 'تم إضافة المنتج وخصم الرصيد بنجاح',
            newBalance: deductionResult.newBalance,
            productNo: productData.productNo
        };
        
    } catch (error) {
        console.error('❌ خطأ في إضافة المنتج:', error);
        
        // عرض رسالة الخطأ للمستخدم
        showErrorMessage(`فشل في إضافة المنتج: ${error.message}`);
        
        // إرجاع الخطأ
        return {
            success: false,
            error: error.message
        };
    } finally {
        // إخفاء أيقونة التحميل
        showLoading(false);
    }
}

// دالة مساعدة لحساب تاريخ الانتهاء
function calculateExpiredDateFromProduct(product) {
    try {
        // إذا كان هناك تاريخ انتهاء محدد
        if (product.productExpiredDate) {
            return new Date(product.productExpiredDate);
        }
        
        // إذا كان هناك تاريخ إضافة، أضف 6 أشهر
        const creationDate = getProductDate(product);
        const expiredDate = new Date(creationDate);
        expiredDate.setMonth(expiredDate.getMonth() + 6);
        
        return expiredDate;
    } catch (error) {
        // إذا حدث خطأ، أضف 6 أشهر من اليوم
        const today = new Date();
        const defaultExpired = new Date();
        defaultExpired.setMonth(today.getMonth() + 6);
        return defaultExpired;
    }
}
// دالة لتنسيق التاريخ للعرض
function formatDateForDisplay(date) {
    if (!date) return 'غير محدد';
    
    try {
        const dateObj = new Date(date);
        if (isNaN(dateObj.getTime())) return 'غير محدد';
        
        // تنسيق التاريخ باللغة العربية
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        
        return dateObj.toLocaleDateString('ar-OM', options);
    } catch (error) {
        console.error('خطأ في تنسيق التاريخ:', error);
        return 'غير محدد';
    }
}
        // معالجة نموذج إضافة المنتج
 
 document.getElementById('addProductForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const submitBtn = document.querySelector('#addProductForm .btn-submit');
    const mode = submitBtn.dataset.mode || 'create';
    
    if (mode === 'edit') {
        // حالة التعديل
        await updateExistingProduct();
    } else {
        // حالة الإضافة (الكود الحالي)
        if (productImages.length === 0) {
            alert('يرجى إضافة صورة واحدة على الأقل للمنتج');
            return;
        }
        
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'جاري إضافة المنتج...';
        submitBtn.disabled = true;
        
        // تأكد من وجود تاريخ انتهاء حديث
        initProductDatesExpired();
        
        try {
            // جمع البيانات من النموذج
            const productData = {
                timestamp: document.getElementById('productTimestamp').value,
                productNo: document.getElementById('productNo').value,
                productName: document.getElementById('productName').value,
                custel: document.getElementById('custel').value,
                productCategory: document.getElementById('productCategory').value,
                productPrice: document.getElementById('productPrice').value,
                productState: document.getElementById('productState').value,
                productQuantity: document.getElementById('productQuantity').value,
                productDescription: document.getElementById('productDescription').value,
                state: document.getElementById('productLocationState').value,
                locationName: document.getElementById('productLocationName').value,
                locationLink: document.getElementById('productLocationLink').value,
                situation: document.getElementById('productSituation').value,
                productColor: document.getElementById('productColor').value,
                productWarranty: document.getElementById('productWarranty').value,
                productExpiredDate: document.getElementById('productExpiredDate').value,
                image1: '',
                image2: '',
                image3: ''
            };
            
            console.log('بيانات المنتج قبل الإرسال:', productData);
            
            await addNewProduct(productData);
            
            // توليد رقم منتج جديد
            const newProductNo = await generateProductNo();
            
            setTimeout(() => {
                alert('تم إضافة المنتج بنجاح! سيظهر في قائمة المنتجات بعد التفعيل.');
                
                // إعادة تعيين نموذج المنتج
                document.getElementById('addProductForm').reset();
                productImages = [];
                updateProductImagesPreview();
                document.getElementById('productTimestamp').value = getCurrentDateTime();
                document.getElementById('productNo').value = newProductNo;
                initProductDatesExpired(); // تعيين تاريخ انتهاء جديد
                
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                closeAddProductModal();
                // إعادة تحميل المنتجات
                loadProductsFromGoogleSheets();
                
            }, 2000);
            
        } catch (error) {
            alert('حدث خطأ أثناء إضافة المنتج. يرجى المحاولة مرة أخرى.');
            console.error('Error:', error);
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            showLoading(false);
        }
    }
});

// دالة لتحديث المنتج الحالي
async function updateExistingProduct() {
     const submitBtn = document.querySelector('#addProductForm .btn-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = 'جاري الحفظ...';
    
    // التحقق السريع من التاريخ
    const expiryDate = document.getElementById('productExpiredDate').value;
    if (expiryDate && new Date(expiryDate) < new Date()) {
        showNotification('❌ تاريخ الانتهاء منتهي', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'تحديث المنتج';
        return;
    }
    
    try {
        // البيانات الأساسية فقط
        const data = {
            productNo: document.getElementById('productNo').value,
            productExpiredDate: expiryDate,
            productSituation: 'Active',
            timestamp: new Date().toISOString()
        };
        
        // تحديث سريع
        await fetch(`https://script.google.com/macros/s/AKfycbzmilIObCMaMHo7oAzXo7gG_5TL8Z77LwYEXy7frVyZRzrBC2ETPDw3mxN-Ef883yo3/exec?action=updateProduct&productNo=${data.productNo}&expiryDate=${data.productExpiredDate}&situation=${data.productSituation}`, {
            method: 'GET',
            mode: 'no-cors' // 🔥 لتجنب مشاكل CORS
        });
        
        showNotification('✅ تم الحفظ بنجاح', 'success');
        setTimeout(closeAddProductModal, 1000);
        
    } catch (error) {
        showNotification('⚠️ تم الحفظ محلياً', 'warning');
        closeAddProductModal();
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'تحديث المنتج';
    }
}

// مثال على دالة updateProductInGoogleSheets (يجب تنفيذها حسب نظامك)
// 🔥 **تعديل دالة updateProductInGoogleSheets لتشمل جميع الحقول**
async function updateProductInExcel(productData) {
    try {
        console.log('💾 جاري تحديث المنتج في Google Sheets:', productData);
        
        const UPDATE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmilIObCMaMHo7oAzXo7gG_5TL8Z77LwYEXy7frVyZRzrBC2ETPDw3mxN-Ef883yo3/exec';
        
        // إضافة timestamp للتعديل
        productData.updateDate = new Date().toISOString();
        
        // تحويل البيانات إلى FormData
        const formData = new URLSearchParams();
        formData.append('action', 'updateProduct');
        formData.append('productNo', productData.productNo);
        formData.append('data', JSON.stringify(productData));
        
        const url = `${UPDATE_SCRIPT_URL}?${formData.toString()}&t=${Date.now()}`;
        
        showLoading(true, 'جاري تحديث المنتج...');
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`خطأ في الخادم: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success === true) {
            console.log('✅ تم تحديث المنتج بنجاح:', result);
            return true;
        } else {
            throw new Error(result.error || 'فشل في تحديث المنتج');
        }
        
    } catch (error) {
        console.error('❌ خطأ في تحديث المنتج:', error);
        throw error;
    } finally {
        showLoading(false);
    }
}

// 🔥 **دالة لتحويل التاريخ إلى صيغة Google Sheets**
function formatDateForGoogleSheets(dateString) {
    if (!dateString) return '';
    
    try {
        const date = new Date(dateString);
        
        // Google Sheets تفضل صيغة YYYY-MM-DD
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
        
    } catch (error) {
        console.error('❌ خطأ في تحويل التاريخ:', error);
        return dateString; // إرجاع القيمة الأصلية
    }
}
 

        // التحكم في فتح وإغلاق نافذة التسجيل
        document.addEventListener('DOMContentLoaded', function() {
            loadFavorites();
            initializeProducts();
            loadProductsFromGoogleSheets();
            checkLoginStatus();
            setupFilterListeners();
            setupPhoneClickHandler();
              setupPasswordToggle();
               initTermsEvents();
                showTermsSection();
                 initFilterEvents();
              
            // إضافة مستمع الحدث لأيقونة المفضلة في نافذة التفاصيل
            document.addEventListener('click', function(event) {
                if (event.target.closest('.product-detail-actions .favorite-icon')) {
                    const icon = event.target.closest('.favorite-icon');
                    const productId = icon.getAttribute('data-product');
                    if (productId) {
                        toggleFavorite(productId);
                        updateFavoriteIcons();
                    }
                }
            });

            // ربط زر تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            document.getElementById('openSignup').addEventListener('click', function() {
                document.getElementById('signupModal').style.display = 'flex';
                 showTermsSection();
                initializeDateFields();
                // تهيئة الخريطة بعد عرض النافذة
                setTimeout(() => {
                    initMap();
                }, 100);
          
 const termsContainer = document.querySelector('.terms-container');
    if (termsContainer) {
        termsContainer.style.display = 'block';
    }
    
    // إعادة تعيين حالة المربع
    const agreeTermsCheckbox = document.getElementById('agreeTerms');
    if (agreeTermsCheckbox) {
        agreeTermsCheckbox.checked = false;
    }
  });
            document.getElementById('closeSignup').addEventListener('click', function() {
                document.getElementById('signupModal').style.display = 'none';
            });
            
            document.getElementById('closeRegister').addEventListener('click', function() {
                document.getElementById('signupModal').style.display = 'none';
                    const termsContainer = document.querySelector('.terms-container');
    if (termsContainer) {
        termsContainer.style.display = 'block';
    }
            });
            
            document.getElementById('closeDetailModal').addEventListener('click', function() {
                document.getElementById('productDetailModal').style.display = 'none';
            });
            
            document.getElementById('closeShowPord').addEventListener('click', function() {
                document.getElementById('productDetailModal').style.display = 'none';
            });
            
   

            document.getElementById('closeAddProductBtn').addEventListener('click', function() {
                closeAddProductModal();
            });
document.getElementById('closeProductModal').addEventListener('click', function() {
                closeAddProductModal();
            });
            document.getElementById('photoUpload').addEventListener('click', function() {
                document.getElementById('photoInput').click();
            });

            document.getElementById('photoInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.match('image.*')) {
                        alert('يرجى اختيار ملف صورة فقط');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert('حجم الصورة يجب أن يكون أقل من 5MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('previewImage');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        document.querySelector('#photoUpload i').style.display = 'none';
                        
                        document.getElementById('photoInput').userFile = file;
                        
                        const uploadText = document.querySelector('.photo-upload span');
                        uploadText.textContent = 'الصورة جاهزة للحفظ';
                        uploadText.style.color = '#3498db';
                    };
                    reader.onerror = function() {
                        alert('خطأ في قراءة الملف');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        let map, marker, currentLocationMarker;
        
        // تهيئة الخريطة
  function initMap() {
    // التحقق من وجود عنصر الخريطة
    const mapElement = document.getElementById('map');
    if (!mapElement) return;
    
    // إزالة الخريطة القديمة إذا كانت موجودة
    if (map) {
        map.remove();
        map = null;
    }
    
    // إحداثيات مسقط، عمان
    const muscatCoords = [23.5880, 58.3829];
    
    // تهيئة الخريطة مع عرض مسقط
    map = L.map('map').setView(muscatCoords, 12);
    
    // إضافة طبقة الخريطة
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // إضافة علامة افتراضية في مسقط
    marker = L.marker(muscatCoords, {draggable: true}).addTo(map)
        .bindPopup('موقع في مسقط، عمان')
        .openPopup();
    
    // تحديث إحداثيات العلامة عند سحبها
    marker.on('dragend', function(event) {
        const position = marker.getLatLng();
        updateLocationFields(position.lat, position.lng);
        reverseGeocode(position.lat, position.lng);
    });

    
    // تحديث العلامة عند النقر على الخريطة
    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        updateLocationFields(e.latlng.lat, e.latlng.lng);
        reverseGeocode(e.latlng.lat, e.latlng.lng);
    });
    
    // إذا كان هناك موقع سابق، عرضه
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (currentUser.storeLat) {
        const coords = extractCoordinatesFromLink(currentUser.storeLat);
        if (coords) {
            map.setView([coords.lat, coords.lng], 15);
            marker.setLatLng([coords.lat, coords.lng]);
            updateLocationFields(coords.lat, coords.lng);
            reverseGeocode(coords.lat, coords.lng);
        }
    }
}
// تحديث دالة updateLocationFields
function updateLocationFields(lat, lng) {
    const locationLink = `https://www.google.com/maps?q=${lat},${lng}`;
    document.getElementById('storeLat').value = locationLink;
    const coordinatesElement = document.getElementById('locationCoordinates');
    if (coordinatesElement) {
        coordinatesElement.textContent = `الإحداثيات: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
}
// تحديث دالة العكس الجغرافي
function reverseGeocode(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
        .then(response => response.json())
        .then(data => {
            if (data && data.display_name) {
                const address = data.display_name.split(',').slice(0, 3).join(', ');
                document.getElementById('locationAddress').value = address;
            } else {
                document.getElementById('locationAddress').value = `موقع عند ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        })
        .catch(error => {
            console.error('Error in reverse geocoding:', error);
            document.getElementById('locationAddress').value = `موقع عند ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        });
}

        // تحديد الموقع الحالي
        document.getElementById('currentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                // إظهار رسالة تحميل
                const currentLocationBtn = document.getElementById('currentLocation');
                const originalText = currentLocationBtn.textContent;
                currentLocationBtn.textContent = 'جاري تحديد الموقع...';
                currentLocationBtn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // تحديث الخريطة إلى الموقع الحالي
                        map.setView([lat, lng], 15);
                        marker.setLatLng([lat, lng]);
                        
                        // تحديث الحقول
                        updateLocationFields(lat, lng);
                        reverseGeocode(lat, lng);
                        
                        // إضافة علامة للموقع الحالي
                        if (currentLocationMarker) {
                            map.removeLayer(currentLocationMarker);
                        }
                        currentLocationMarker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup('موقعك الحالي')
                            .openPopup();
                        
                        // إعادة تعيين الزر
                        currentLocationBtn.textContent = originalText;
                        currentLocationBtn.disabled = false;
                    }, 
                    function(error) {
                        let errorMessage = 'تعذر الحصول على موقعك الحالي';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'تم رفض الإذن للوصول إلى الموقع';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'معلومات الموقع غير متاحة';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'انتهت مهلة طلب الموقع';
                                break;
                        }
                        alert(errorMessage);
                        
                        // إعادة تعيين الزر
                        currentLocationBtn.textContent = originalText;
                        currentLocationBtn.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert('متصفحك لا يدعم خدمة تحديد الموقع');
            }
        });

        // البحث عن موقع
        document.getElementById('searchLocation').addEventListener('click', function() {
            const address = document.getElementById('locationAddress').value;
            if (address) {
                // استخدام خدمة Nominatim للبحث عن الموقع
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=ar`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            
                            map.setView([lat, lon], 15);
                            marker.setLatLng([lat, lon]);
                            updateLocationFields(lat, lon);
                            reverseGeocode(lat, lon);
                        } else {
                            alert('لم يتم العثور على الموقع المطلوب');
                        }
                    })
                    .catch(error => {
                        console.error('Error in geocoding:', error);
                        alert('حدث خطأ أثناء البحث عن الموقع');
                    });
            } else {
                alert('يرجى إدخال اسم موقع للبحث');
            }
        });

        // دالة لتحميل المفضلة من التخزين المحلي
        function loadFavorites() {
            try {
                const savedFavorites = localStorage.getItem('favoriteProducts');
                if (savedFavorites) {
                    favoriteProducts = JSON.parse(savedFavorites);
                    console.log('تم تحميل المنتجات المفضلة:', favoriteProducts.length);
                } else {
                    favoriteProducts = [];
                }
                updateFavoriteCount();
            } catch (error) {
                console.error('خطأ في تحميل المفضلة:', error);
                favoriteProducts = [];
            }
        }

        // دالة لحفظ المفضلة في التخزين المحلي
        function saveFavorites() {
            try {
                localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
                updateFavoriteCount();
                console.log('تم حفظ المنتجات المفضلة:', favoriteProducts.length);
            } catch (error) {
                console.error('خطأ في حفظ المفضلة:', error);
            }
        }

        // دالة لتحديث عداد المفضلة
        function updateFavoriteCount() {
            const favoriteCountElement = document.getElementById('favorite-count');
            if (favoriteCountElement) {
                favoriteCountElement.textContent = favoriteProducts.length;
            }
        }

        // دالة لإضافة/إزالة منتج من المفضلة
        function toggleFavorite(productId) {
            const productIndex = favoriteProducts.indexOf(productId);
            
            if (productIndex === -1) {
                favoriteProducts.push(productId);
                showNotification('تمت إضافة المنتج إلى المفضلة');
            } else {
                favoriteProducts.splice(productIndex, 1);
                showNotification('تمت إزالة المنتج من المفضلة');
            }
            
            saveFavorites();
            updateFavoriteCountOnly(); // تحديث عداد المفضلة فقط
            updateFavoriteIcons();
            
            // إذا كانت الفلترة نشطة على المفضلة، قم بتحديث العرض
            if (document.querySelector('.filter-tab.favorite.active')) {
                filterProducts('favorite');
            }
        }

        // دالة لتحديث أيقونات المفضلة
        function updateFavoriteIcons() {
            // تحديث أيقونات المفضلة في البطاقات الرئيسية
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = Array.from(card.parentNode.children).indexOf(card);
                const favoriteIcon = card.querySelector('.favorite-icon');
                
                if (favoriteIcon) {
                    const heartIcon = favoriteIcon.querySelector('i');
                    if (favoriteProducts.includes(productId.toString())) {
                        favoriteIcon.classList.add('active');
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                    } else {
                        favoriteIcon.classList.remove('active');
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                    }
                }
            });
            
            // تحديث أيقونة المفضلة في نافذة التفاصيل
            const detailFavoriteIcon = document.querySelector('.product-detail-actions .favorite-icon');
            if (detailFavoriteIcon) {
                const currentProductId = document.querySelector('.product-detail-content')?.getAttribute('data-product-id');
                if (currentProductId && favoriteProducts.includes(currentProductId)) {
                    detailFavoriteIcon.classList.add('active');
                    detailFavoriteIcon.querySelector('i').classList.remove('far');
                    detailFavoriteIcon.querySelector('i').classList.add('fas');
                } else {
                    detailFavoriteIcon.classList.remove('active');
                    detailFavoriteIcon.querySelector('i').classList.remove('fas');
                    detailFavoriteIcon.querySelector('i').classList.add('far');
                }
            }
        }

        // دالة للتحقق مما إذا كان المنتج مفضلاً
        function isFavorite(productId) {
            return favoriteProducts.includes(productId.toString());
        }

        // دالة لعرض إشعار
        // دالة محسنة لإظهار الإشعارات
function showNotification(message, type = 'success') {
    // إزالة أي إشعار سابق
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // تحديد اللون حسب النوع
    let bgColor = '#2ecc71'; // أخضر للنجاح
    if (type === 'error') bgColor = '#e74c3c'; // أحمر للخطأ
    if (type === 'warning') bgColor = '#f39c12'; // أصفر للتحذير
    if (type === 'info') bgColor = '#3498db'; // أزرق للمعلومات
    
    // إنشاء إشعار جديد
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
        <i class="fas fa-times close-notification"></i>
    `;
    
    // إضافة أنماط CSS للإشعار
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 15px;
        animation: slideDown 0.4s ease-out;
        min-width: 300px;
        max-width: 500px;
        font-size: 16px;
    `;
    
    // إضافة أنيميشن
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
    `;
    document.head.appendChild(style);

            
            // إضافة زر الإغلاق
           notification.querySelector('.close-notification').addEventListener('click', () => {
        notification.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    });
    
    document.body.appendChild(notification);
    
    // إزالة الإشعار تلقائياً بعد 4 ثواني
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, 3000);
}

        // دالة لفلترة المنتجات حسب المفضلة
        function filterFavorites() {
            const products = document.querySelectorAll('.product-card');
            products.forEach(product => {
                const productId = Array.from(product.parentNode.children).indexOf(product);
                if (favoriteProducts.includes(productId.toString())) {
                    product.style.display = 'flex';
                } else {
                    product.style.display = 'none';
                }
            });
        }

        // دالة لفلترة المنتجات
  // دالة واحدة بسيطة للبحث
function filterProducts() {
    const searchText = document.getElementById('orderSearchPro').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    // إذا كانت المنتجات محفوظة في window.userProducts
    if (!window.userProducts || !Array.isArray(window.userProducts)) {
        console.error('لا توجد بيانات منتجات');
        return;
    }
    
    let filtered = window.userProducts.filter(product => {
        // البحث في النص
        const matchesSearch = !searchText || 
            (product.productName && product.productName.toLowerCase().includes(searchText)) ||
            (product.productNo && product.productNo.toLowerCase().includes(searchText));
        
        // البحث في الحالة
        const matchesStatus = statusFilter === 'all' || 
            (product.situation && product.situation.includes(statusFilter));
        
        return matchesSearch && matchesStatus;
    });
    
    // عرض النتائج
    displayProducts(filtered);
}

// دالة مسح البحث
function clearSearch() {
    document.getElementById('orderSearchPro').value = '';
    document.getElementById('statusFilter').value = 'all';
    filterUserProducts();
}
// تهيئة البحث عند تحميل المنتجات
function initSearchAfterLoad() {
    // انتظر قليلاً للتأكد من تحميل المنتجات
    setTimeout(() => {
        const searchInput = document.getElementById('orderSearchPro');
        const statusSelect = document.getElementById('statusFilter');
        
        if (searchInput) {
            // إزالة أي أحداث سابقة
            searchInput.oninput = null;
            searchInput.onkeyup = null;
            
            // إضافة الأحداث الجديدة
            searchInput.addEventListener('input', filterProducts);
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') filterProducts();
            });
            
            // إضافة زر مسح
            searchInput.style.paddingRight = '30px';
            if (!document.getElementById('clearSearchBtn')) {
                const clearBtn = document.createElement('button');
                clearBtn.id = 'clearSearchBtn';
                clearBtn.innerHTML = '×';
                clearBtn.style.cssText = `
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #e74c3c;
                    font-size: 20px;
                    cursor: pointer;
                    display: ${searchInput.value ? 'block' : 'none'};
                `;
                clearBtn.onclick = clearSearch;
                
                const inputContainer = searchInput.parentElement;
                inputContainer.style.position = 'relative';
                inputContainer.appendChild(clearBtn);
            }
        }
        
        if (statusSelect) {
            statusSelect.onchange = null;
            statusSelect.addEventListener('change', filterProducts);
        }
        
        console.log('✅ تم تهيئة البحث');
    }, 1000);
}
        // تحديث مستمع الأحداث للفلترة
        function setupFilterListeners() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    filterProducts(filter);
                });
            });
        }
        // دالة لتهيئة خريطة تفاصيل المنتج
        function initProductDetailMap(lat, lng, locationName) {
            if (productDetailMap) {
                productDetailMap.remove();
            }
            
            // إنشاء الخريطة المصغرة
            productDetailMap = L.map('product-detail-map').setView([lat, lng], 13);
            
            // إضافة طبقة الخريطة
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(productDetailMap);
            
            // إضافة علامة للمنتج
            productMarker = L.marker([lat, lng]).addTo(productDetailMap)
                .bindPopup(`<b>${locationName}</b><br>موقع المنتج`)
                .openPopup();
            
            // حفظ الموقع الحالي
            currentProductLocation = { lat, lng, name: locationName };
            
            // جعل الخريطة أكثر تفاعلية
            productDetailMap.scrollWheelZoom.disable();
            productDetailMap.doubleClickZoom.disable();
            productDetailMap.dragging.disable();
            productDetailMap.touchZoom.disable();
        }

        // دالة لتهيئة الخريطة الكاملة
        function initFullSizeMap() {
            if (!currentProductLocation) return;
            
            if (fullSizeMap) {
                fullSizeMap.remove();
            }
            
            // إنشاء الخريطة الكاملة
            fullSizeMap = L.map('full-size-map').setView([currentProductLocation.lat, currentProductLocation.lng], 15);
            
            // إضافة طبقة الخريطة
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(fullSizeMap);
            
            // إضافة علامة للمنتج
            fullProductMarker = L.marker([currentProductLocation.lat, currentProductLocation.lng]).addTo(fullSizeMap)
                .bindPopup(`<b>${currentProductLocation.name}</b><br>موقع المنتج`)
                .openPopup();
            
            // تحديث معلومات الموقع
            document.getElementById('full-map-location').textContent = currentProductLocation.name;
            
            // إضافة طبقة تحكم
            L.control.scale().addTo(fullSizeMap);
        }

        // دالة محسنة للحصول على إحداثيات الموقع
        function getLocationCoordinates(locationData) {
            // إذا كان locationData كائنًا يحتوي على رابط
            if (typeof locationData === 'object' && locationData.locationLink) {
                const coords = extractCoordinatesFromLink(locationData.locationLink);
                if (coords) {
                    return {
                        lat: coords.lat,
                        lng: coords.lng,
                        name: locationData.locationName || locationData.location || 'موقع المنتج'
                    };
                }
            }
            
            // إذا كان نصًا فقط، ابحث عن المدينة
            if (typeof locationData === 'string') {
                const cities = {
                    'بغداد': { lat: 33.3128, lng: 44.3615, name: 'بغداد' },
                    'البصرة': { lat: 30.5, lng: 47.8167, name: 'البصرة' },
                    'نينوى': { lat: 36.35, lng: 43.15, name: 'نينوى' },
                    'أربيل': { lat: 36.19, lng: 44.0089, name: 'أربيل' },
                    'الأنبار': { lat: 32.5, lng: 42.5, name: 'الأنبار' }
                };
                
                for (const [city, data] of Object.entries(cities)) {
                    if (locationData.includes(city) || city.includes(locationData)) {
                        return data;
                    }
                }
            }
            
            // إذا لم يتم العثور، استخدام إحداثيات بغداد كافتراضية
            return { lat: 33.3128, lng: 44.3615, name: 'بغداد' };
        }

        // دالة لعرض الخريطة الكاملة
        function openFullMap() {
            initFullSizeMap();
            document.getElementById('fullMapModal').style.display = 'flex';
        }

        // دالة لإغلاق الخريطة الكاملة
        function closeFullMap() {
            document.getElementById('fullMapModal').style.display = 'none';
        }

        // دالة للحصول على اتجاهات
        function getDirections() {
            if (!currentProductLocation) return;
            
            let destination;
            
            // إذا كان هناك رابط موقع، استخدمه
            if (currentProductLocation.productData && currentProductLocation.productData.locationLink) {
                destination = currentProductLocation.productData.locationLink;
            } else {
                // وإلا استخدم الإحداثيات
                destination = `${currentProductLocation.lat},${currentProductLocation.lng}`;
            }
            
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}`;
            window.open(googleMapsUrl, '_blank');
        }

        // دالة لنسخ رابط الموقع
        function copyLocationLink() {
            if (!currentProductLocation) return;
            
            const locationUrl = `https://maps.google.com/?q=${currentProductLocation.lat},${currentProductLocation.lng}`;
            
            navigator.clipboard.writeText(locationUrl).then(() => {
                showNotification('تم نسخ رابط الموقع إلى الحافظة');
            }).catch(err => {
                console.error('فشل نسخ الرابط: ', err);
                
                // طريقة بديلة للمتصفحات القديمة
                const tempInput = document.createElement('input');
                tempInput.value = locationUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                showNotification('تم نسخ رابط الموقع إلى الحافظة');
            });
        }

        // بعد تعريف المتغيرات العامة في بداية script
        let productMap = null;
        let productLocationMarker = null;
        let productCurrentLocationMarker = null;

        // دالة لتهيئة خريطة المنتج
   function initProductMap() {
    const mapElement = document.getElementById('product-map');
    if (!mapElement) {
        console.error('❌ عنصر الخريطة (product-map) غير موجود في DOM');
        return;
    }
    
    // إزالة الخريطة القديمة
    if (productMap) {
        productMap.remove();
        productMap = null;
    }
    
    // إنشاء الخريطة
   productMap = L.map('product-map').setView([23.5880, 58.3829], 11);
    
    // إضافة طبقة الخريطة
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(productMap);
    
    // إضافة علامة
    productLocationMarker = L.marker([33.3128, 44.3615], {draggable: true}).addTo(productMap)
        .bindPopup('موقع المنتج')
        .openPopup();
    
    // إضافة الأحداث
    productLocationMarker.on('dragend', function(event) {
        const position = productLocationMarker.getLatLng();
        updateProductLocationFields(position.lat, position.lng);
        reverseProductGeocode(position.lat, position.lng);
    });
    
    productMap.on('click', function(e) {
        productLocationMarker.setLatLng(e.latlng);
        updateProductLocationFields(e.latlng.lat, e.latlng.lng);
        reverseProductGeocode(e.latlng.lat, e.latlng.lng);
    });
    
    console.log('✅ تم تهيئة خريطة المنتج');
}

        // دالة لتحديث حقول موقع المنتج
 function updateProductLocationFields(lat, lng) {
    if (!lat || !lng) {
        console.error('❌ إحداثيات غير صالحة:', lat, lng);
        return;
    }
    
    const locationLink = `https://maps.google.com/?q=${lat},${lng}`;
    document.getElementById('productLocationLink').value = locationLink;
    
    const coordinatesElement = document.getElementById('productLocationCoordinates');
    if (coordinatesElement) {
        coordinatesElement.textContent = `الإحداثيات: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        coordinatesElement.style.color = '#3498db';
        coordinatesElement.style.fontWeight = 'bold';
    }
    
    console.log('📍 تم تحديث الإحداثيات:', lat, lng);
}

        // العكس الجغرافي لموقع المنتج
        function reverseProductGeocode(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        const address = data.display_name.split(',').slice(0, 3).join(', ');
                        document.getElementById('productLocationName').value = address;
                    } else {
                        document.getElementById('productLocationName').value = `موقع عند ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    }
                })
                .catch(error => {
                    console.error('Error in reverse geocoding:', error);
                    document.getElementById('productLocationName').value = `موقع عند ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                });
        }

        // تحديد الموقع الحالي للمنتج
        document.getElementById('product-current-location').addEventListener('click', function() {
            if (navigator.geolocation) {
                const btn = document.getElementById('product-current-location');
                const originalText = btn.textContent;
                btn.textContent = 'جاري تحديد الموقع...';
                btn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        productMap.setView([lat, lng], 15);
                        productLocationMarker.setLatLng([lat, lng]);
                        
                        updateProductLocationFields(lat, lng);
                        reverseProductGeocode(lat, lng);
                        
                        if (productCurrentLocationMarker) {
                            productMap.removeLayer(productCurrentLocationMarker);
                        }
                        productCurrentLocationMarker = L.marker([lat, lng])
                            .addTo(productMap)
                            .bindPopup('موقعك الحالي')
                            .openPopup();
                        
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 
                    function(error) {
                        let errorMessage = 'تعذر الحصول على موقعك الحالي';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'تم رفض الإذن للوصول إلى الموقع';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'معلومات الموقع غير متاحة';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'انتهت مهلة طلب الموقع';
                                break;
                        }
                        alert(errorMessage);
                        
                        btn.textContent = originalText;
                        btn.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert('متصفحك لا يدعم خدمة تحديد الموقع');
            }
        });

        // البحث عن موقع للمنتج
        document.getElementById('product-search-location').addEventListener('click', function() {
            const address = document.getElementById('productLocationName').value;
            if (address) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=ar`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            
                            productMap.setView([lat, lon], 15);
                            productLocationMarker.setLatLng([lat, lon]);
                            updateProductLocationFields(lat, lon);
                            reverseProductGeocode(lat, lon);
                        } else {
                            alert('لم يتم العثور على الموقع المطلوب');
                        }
                    })
                    .catch(error => {
                        console.error('Error in geocoding:', error);
                        alert('حدث خطأ أثناء البحث عن الموقع');
                    });
            } else {
                alert('يرجى إدخال اسم موقع للبحث');
            }
        });

        // دالة لفتح نافذة إضافة المنتج
  async function openAddProductModal() {
       const activeCount = parseInt(document.getElementById('counter-active').textContent) || 0;
    
    // إذا كان عدد الطلبات النشطة أقل من 1
    if (activeCount < 1) {
        // عرض رسالة عائمة حمراء
        showFloatingAlert('لايوجد رصيد نشط لإضافة منتج جديد، اضف رصيد او نشط اذا كان هناك رصيد غير نشط');
        return; // نخرج من الدالة ولا نفتح النافذة
    }
           
        
    document.getElementById('addProductModal').style.display = 'flex';
    
    // إعادة تعيين النموذج فقط
    document.getElementById('addProductForm').reset();
    productImages = [];
    updateProductImagesPreview();
    
    // تعيين القيم الافتراضية
    document.getElementById('productTimestamp').value = getCurrentDateTime(); 
    document.getElementById('productSituation').disabled = true;
    const newProductNo = await generateProductNo();
    document.getElementById('productNo').value = newProductNo;
     document.getElementById('productAddDate').value = getCurrentDateTime();
     initProductDatesExpired();
    // تعيين بيانات المستخدم
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (currentUser.signupPhone) {
        document.getElementById('custel').value = currentUser.signupPhone;
    }
    
    if (currentUser.state) {
        document.getElementById('productLocationState').value = currentUser.state;
    }
    
    if (currentUser.locationAddress) {
        document.getElementById('productLocationName').value = currentUser.locationAddress;
    }
    
    if (currentUser.storeLat) {
        document.getElementById('productLocationLink').value = currentUser.storeLat;
    }
    
    // تهيئة الخريطة بعد عرض النافذة
    setTimeout(() => {
        if (!productMap) {
            initProductMap();
        }
    }, 100);
     try {
              
                   const situationField = document.getElementById('productSituation');
                situationField.disabled = true;
                situationField.hidden = true;
            } catch (error) {
                console.error('خطأ في فتح نافذة المنتج:', error);
                alert('حدث خطأ أثناء تحضير النموذج. يرجى المحاولة مرة أخرى.');
            }
}

        // استبدال زر إضافة المنتج القديم بالمستدعى الجديد
        document.getElementById('addProductBtn').addEventListener('click', async function() {
            const activeCount = parseInt(document.getElementById('counter-active').textContent) || 0;
    
    // إذا كان عدد الطلبات النشطة أقل من 1
    if (activeCount < 1) {
        // عرض رسالة عائمة حمراء
        showFloatingAlert('لايوجد رصيد نشط لإضافة منتج جديد، اضف رصيد او نشط اذا كان هناك رصيد غير نشط');
        return; // نخرج من الدالة ولا نفتح النافذة
    }
            try {
                await openAddProductModal();
           
            } catch (error) {
                console.error('خطأ في فتح نافذة المنتج:', error);
                alert('حدث خطأ أثناء تحضير النموذج. يرجى المحاولة مرة أخرى.');
            }
        });

        // دالة لاستخراج الإحداثيات من رابط Google Maps
      function extractCoordinatesFromLink(locationLink) {
    if (!locationLink) return null;
    
    try {
        // تحليل روابط Google Maps المختلفة
        let lat, lng;
        
        // رابط بصيغة ?q=lat,lng
        if (locationLink.includes('?q=')) {
            const match = locationLink.match(/[?&]q=([-\d.]+),([-\d.]+)/);
            if (match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
                return { lat, lng };
            }
        }
        
        // رابط بصيغة /@lat,lng
        if (locationLink.includes('@')) {
            const match = locationLink.match(/@([-\d.]+),([-\d.]+)/);
            if (match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
                return { lat, lng };
            }
        }
        
        // رابط بصيغة !1dlat!2dlng
        if (locationLink.includes('!1d')) {
            const match = locationLink.match(/!1d([-\d.]+)!2d([-\d.]+)/);
            if (match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
                return { lat, lng };
            }
        }
        
        // إحداثيات مباشرة
        const coordMatch = locationLink.match(/([-\d.]+)[, ]+([-\d.]+)/);
        if (coordMatch) {
            lat = parseFloat(coordMatch[1]);
            lng = parseFloat(coordMatch[2]);
            return { lat, lng };
        }
        
        return null;
    } catch (error) {
        console.error('خطأ في استخراج الإحداثيات:', error);
        return null;
    }
}
        // في DOMContentLoaded
        document.getElementById('copy-product-location-link').addEventListener('click', copyProductLocationLink);

        // دالة لنسخ رابط موقع المنتج
        function copyProductLocationLink() {
            if (!currentProductLocation) return;
            
            let locationUrl;
            
            if (currentProductLocation.productData && currentProductLocation.productData.locationLink) {
                // استخدم رابط الموقع المحفوظ
                locationUrl = currentProductLocation.productData.locationLink;
            } else {
                // أو أنشئ رابط من الإحداثيات
                locationUrl = `https://maps.google.com/?q=${currentProductLocation.lat},${currentProductLocation.lng}`;
            }
            
            navigator.clipboard.writeText(locationUrl).then(() => {
                showNotification('تم نسخ رابط موقع المنتج إلى الحافظة');
            }).catch(err => {
                console.error('فشل نسخ الرابط: ', err);
                
                // طريقة بديلة
                const tempInput = document.createElement('input');
                tempInput.value = locationUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                showNotification('تم نسخ رابط موقع المنتج إلى الحافظة');
            });
        }

        // دالة لترتيب المنتجات عند تحميل الصفحة
        async function initializeProducts() {
            try {
                // عرض أيقونة تحميل خفيفة
                
                
                // تحميل المنتجات
                const products = await loadProductsFromGoogleSheets();
             
                // عرض المنتجات بعد الترتيب
                if (products && products.length > 0) {
                    const formattedProducts = formatProductsData(products);
                    displayProducts(formattedProducts);
                    
                    console.log(`تم ترتيب وعرض ${formattedProducts.length} منتج من الأحدث إلى الأقدم`);
                    
                    // عرض أول 5 منتجات وتواريخها للتأكد من الترتيب
                    formattedProducts.slice(0, 5).forEach((product, index) => {
                        console.log(`المنتج ${index + 1}: ${product.name} - التاريخ: ${product.date}`);
                    });
                }
                
                return products;
            } catch (error) {
                console.error('خطأ في تهيئة المنتجات:', error);
                loadDefaultProducts();
            } finally {
                // إخفاء أيقونة التحميل
                setTimeout(() => {
                    showLoading(false);
                }, 1000);
            }
        }

        // دالة لحساب عدد المنتجات حسب الفئة
       function calculateProductCounts(products) {
    // إعادة تعيين العداد
    productCounts = {
        all: 0,
        new: 0,
        sale: 0,
        popular: 0,
        favorite: 0
    };
    
    if (!products || !Array.isArray(products)) return;
    
    products.forEach(product => {
        productCounts.all++;
        
        // التحقق من حالة المنتج بدقة
        console.log(`تحليل المنتج: ${product.name} - الحالة: ${product.condition}`);
        
        if (product.condition === 'جديد') {
            productCounts.new++;
        } else if (product.condition === 'مستعمل') {
            productCounts.sale++;
        } else if (product.condition === 'خردة' || product.condition === 'غرده') {
            productCounts.popular++;
        } else {
            // إذا كانت الحالة مختلفة، اعتبارها خردة
            console.log(`حالة غير معروفة: ${product.condition}، تم اعتبارها خردة`);
            productCounts.popular++;
        }
    });
    
    // حساب المفضلة من localStorage
    const favorites = JSON.parse(localStorage.getItem('favoriteProducts') || '[]');
    productCounts.favorite = favorites.length;
    
    // طباعة الأعداد للتتبع
    console.log('عدد المنتجات الكلي:', productCounts.all);
    console.log('عدد المنتجات الجديدة:', productCounts.new);
    console.log('عدد المنتجات المستعملة:', productCounts.sale);
    console.log('عدد المنتجات الخردة:', productCounts.popular);
    console.log('عدد المنتجات المفضلة:', productCounts.favorite);
    
    updateFilterCounts();
}

        // دالة لتحديث الأرقام في أزرار الفلترة
      function updateFilterCounts() {
    const filters = {
        'all': productCounts.all,
        'new': productCounts.new,
        'sale': productCounts.sale,
        'popular': productCounts.popular,
        'favorite': productCounts.favorite
    };
    
    // تحديث كل زر فلترة
    document.querySelectorAll('.filter-tab').forEach(tab => {
        const filterType = tab.getAttribute('data-filter');
        const count = filters[filterType] || 0;
        
        // إزالة العداد القديم إذا كان موجوداً
        const oldCount = tab.querySelector('.filter-count');
        if (oldCount) {
            oldCount.remove();
        }
        
        // إضافة العداد الجديد
        if (count > 0) {
            const countBadge = document.createElement('span');
            countBadge.className = 'filter-count';
            countBadge.textContent = count;
            countBadge.style.cssText = `
                background-color: white;
                color: ${filterType === 'popular' ? '#9b59b6' : 
                        filterType === 'new' ? '#2ecc71' :
                        filterType === 'sale' ? '#e74c3c' :
                        filterType === 'favorite' ? '#e74c3c' : '#9b59b6'};
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 12px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-right: 5px;
                font-weight: bold;
            `;
            tab.insertBefore(countBadge, tab.firstChild);
        }
    });
}

        // دالة تحديث عدد المفضلة فقط
        function updateFavoriteCountOnly() {
            const favorites = JSON.parse(localStorage.getItem('favoriteProducts') || '[]');
            productCounts.favorite = favorites.length;
            
            const favoriteTab = document.querySelector('.filter-tab[data-filter="favorite"]');
            if (favoriteTab) {
                const oldCount = favoriteTab.querySelector('.filter-count');
                if (oldCount) {
                    oldCount.remove();
                }
                
                if (productCounts.favorite > 0) {
                    const countBadge = document.createElement('span');
                    countBadge.className = 'filter-count';
                    countBadge.textContent = productCounts.favorite;
                    favoriteTab.appendChild(countBadge);
                }
            }
        }

        const LOGIN_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_E5SYdG5DiVjvHqKYLvhdw4P3PrPgCns08HkgcHLM9u0BbwWV42D3gA5LrGbbZi0/exec';

        // دالة للتحقق من بيانات تسجيل الدخول من Google Sheets
        async function verifyLoginFromGoogleSheets(phone, password) {
            try {
                showLoading(true,'جاري التحقق من بيانات الدخول...');
                
                // إضافة timestamp لمنع التخزين المؤقت
                const url = LOGIN_SCRIPT_URL + '?action=login&phone=' + encodeURIComponent(phone) + 
                           '&password=' + encodeURIComponent(password) + '&t=' + new Date().getTime();
 
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('استجابة التحقق:', data);
                
                if (data && data.success === true) {
                    return {
                        success: true,
                        userData: data.userData
                    };
                } else {
                    return {
                        success: false,
                        message: data.message || 'رقم الهاتف أو كلمة المرور غير صحيحة'
                    };
                }
                
            } catch (error) {
                console.error('خطأ في التحقق من الدخول:', error);
                return {
                    success: false,
                    message: 'حدث خطأ أثناء الاتصال بالخادم'
                };
            } finally {
                showLoading(false);
            }
        }

        // معالجة نموذج تسجيل الدخول
  document.getElementById('loginForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const phone = document.getElementById('loginPhone').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!phone || !password) {
        alert('يرجى ملء جميع الحقول');
        return;
    }
    
    // تحقق من صيغة كلمة المرور
    if (password.length < 6) {
        alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
        return;
        
    }
    
    if (phone.length < 8) {
        alert('رقم الهاتف يجب أن يكون 8 أحرف على الأقل');
        return;
    }
    
    // عرض أيقونة التحميل
    const submitBtn = document.querySelector('#loginForm .btn-login-submit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'جاري التحقق...';
    submitBtn.disabled = true;
    
    try {
        // التحقق من بيانات الدخول من Google Sheets
        const result = await verifyLoginFromGoogleSheets(phone, password);
        
        if (result.success) {
            // التحقق من حالة المستخدم
            const userState = result.userData.userstate;
            
            if (userState === 'Delete') {
                // عرض رسالة استعادة الحساب
                showAccountRestorationModal(result.userData);
            } else if (userState === 'Employer') {
                // عرض رسالة الحساب المعلق للـ Employer
                showSuspendedAccountModal(result.userData);
            } else {
                // حفظ بيانات المستخدم في localStorage
                localStorage.setItem('currentUser', JSON.stringify(result.userData));
                localStorage.setItem('isLoggedIn', 'true');
                
                // إخفاء نافذة تسجيل الدخول
                closeLoginModal();
                
                // تحديث واجهة المستخدم
                updateUIAfterRegistration(result.userData);
                myOrdersSectionNav.style.display = "flex";
                
                // إظهار رسالة نجاح
                showNotification('تم تسجيل الدخول بنجاح!');
                
                // إعادة تحميل المنتجات
                loadProductsFromGoogleSheets();
            }
        } else {
            alert(result.message || 'رقم الهاتف أو كلمة المرور غير صحيحة');
        }
        
    } catch (error) {
        console.error('خطأ في عملية الدخول:', error);
        alert('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.');
    } finally {
        // إعادة تعيين الزر
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// دالة لعرض نافذة استعادة الحساب المحذوف
function showAccountRestorationModal(userData) {
    // إنشاء نافذة الاستعادة
    const restorationModal = document.createElement('div');
    restorationModal.id = 'accountRestorationModal';
    restorationModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    restorationModal.innerHTML = `
        <div class="restoration-content" style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease-out;
        ">
            <div class="restoration-icon" style="
                font-size: 60px;
                color: #3498db;
                margin-bottom: 20px;
            ">
                <i class="fas fa-user-slash"></i>
            </div>
            
            <h3 style="color: #2c3e50; margin-bottom: 15px;">حساب محذوف</h3>
            
            <p style="color: #666; line-height: 1.6; margin-bottom: 25px;">
                <strong style="color: #e74c3c;">تنبيه:</strong> هذا المستخدم تم حذفه!
                <br><br>
                هل تريد استعادة الحساب والدخول؟
            </p>
            
            <div class="user-info" style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 25px;
                text-align: right;
            ">
                <div style="margin-bottom: 8px;">
                    <strong>الاسم:</strong> ${userData.fullname || 'غير محدد'}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>الهاتف:</strong> ${userData.phone || userData.signupPhone || 'غير محدد'}
                </div>
                <div>
                    <strong>الحالة:</strong> <span style="color: #e74c3c; font-weight: bold;">محذوف</span>
                </div>
            </div>
            
            <div class="restoration-buttons" style="
                display: flex;
                gap: 10px;
                justify-content: center;
            ">
                <button id="restoreAccountBtn" style="
                    background: linear-gradient(135deg, #3498db, #2980b9);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                    flex: 1;
                    transition: all 0.3s ease;
                ">
                    <i class="fas fa-undo"></i> نعم، استعادة الحساب
                </button>
                
                <button id="cancelRestorationBtn" style="
                    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                    flex: 1;
                    transition: all 0.3s ease;
                ">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(restorationModal);
    
    // إضافة تأثير hover للأزرار
    const restoreBtn = document.getElementById('restoreAccountBtn');
    const cancelBtn = document.getElementById('cancelRestorationBtn');
    
    restoreBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 8px rgba(52, 152, 219, 0.3)';
    });
    
    restoreBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
    cancelBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 8px rgba(149, 165, 166, 0.3)';
    });
    
    cancelBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
    // إضافة أحداث الأزرار
    restoreBtn.addEventListener('click', async function() {
    // تغيير نص الزر أثناء المعالجة
    restoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاستعادة...';
    restoreBtn.disabled = true;
    
    try {
        // استعادة الحساب
        const restoreResult = await restoreUserAccount(userData.ID || userData.userId);
        
        if (restoreResult.success) {
            // تحديث بيانات المستخدم المحلية
            userData.userstate = 'User';
            localStorage.setItem('currentUser', JSON.stringify(userData));
            localStorage.setItem('isLoggedIn', 'true');
            
            // إغلاق النافذة
            document.body.removeChild(restorationModal);
            
            // إعادة تعيين حقل كلمة المرور فقط (هنا يكمن التعديل المطلوب)
            document.getElementById('loginPassword').value = '';
            
            // إظهار رسالة نجاح
            showNotification('تم استعادة الحساب بنجاح! مرحباً بعودتك.');
            openLoginModal();
            // إعادة تحميل المنتجات
            if (typeof loadProductsFromGoogleSheets === 'function') {
                loadProductsFromGoogleSheets();
            }
        } else {
            alert('فشل في استعادة الحساب: ' + (restoreResult.message || ''));
            restoreBtn.innerHTML = '<i class="fas fa-undo"></i> نعم، استعادة الحساب';
            restoreBtn.disabled = false;
        }
    } catch (error) {
        console.error('خطأ في استعادة الحساب:', error);
        alert('حدث خطأ أثناء استعادة الحساب. يرجى المحاولة مرة أخرى.');
        restoreBtn.innerHTML = '<i class="fas fa-undo"></i> نعم، استعادة الحساب';
        restoreBtn.disabled = false;
    }
});
    
    cancelBtn.addEventListener('click', function() {
        document.body.removeChild(restorationModal);
        // إعادة تعيين حقول تسجيل الدخول
        document.getElementById('loginPhone').value = '';
        document.getElementById('loginPassword').value = '';
    });
    
    // إغلاق النافذة عند النقر خارجها
    restorationModal.addEventListener('click', function(event) {
        if (event.target === this) {
            document.body.removeChild(restorationModal);
            // إعادة تعيين حقول تسجيل الدخول
            document.getElementById('loginPhone').value = '';
            document.getElementById('loginPassword').value = '';
        }
    });
    
    // إغلاق النافذة بمفتاح ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('accountRestorationModal');
            if (modal) {
                document.body.removeChild(modal);
                // إعادة تعيين حقول تسجيل الدخول
                document.getElementById('loginPhone').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }
    });
}

// دالة لاستعادة حساب المستخدم المحذوف
async function restoreUserAccount(userId) {
    return new Promise((resolve, reject) => {
        // استخدم نفس رابط سكريبت التحديث أو رابط خاص بالاستعادة
        const RESTORE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTK6t1TgtxWYc1txt7Y5w-9-xyPldjzMvqkmrXpzQLf1T6e4Sl5keOl4ndqDgui-xu/exec';
        
        if (!userId) {
            reject(new Error('معرف المستخدم مطلوب'));
            return;
        }
        
        // بناء URL لاستعادة الحساب
        let url = RESTORE_SCRIPT_URL + 
                 '?action=restoreUser' +
                 '&userId=' + encodeURIComponent(userId) +
                 '&userstate=User' +
                 '&callback=handleRestoreResponse' +
                 '&t=' + new Date().getTime();
        
        console.log('🔗 إرسال طلب استعادة حساب إلى:', url);
        
        // استخدام JSONP
        const script = document.createElement('script');
        script.src = url;
        
        window.handleRestoreResponse = function(response) {
            console.log('📥 استجابة من السيرفر للاستعادة:', response);
            
            // تنظيف
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleRestoreResponse;
            
            if (response && response.success) {
                resolve(response);
            } else {
                reject(new Error(response ? response.message : 'لا توجد استجابة من السيرفر'));
            }
        };
        
        script.onerror = function(error) {
            console.error('💥 خطأ في تحميل السكريبت للاستعادة:', error);
            
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleRestoreResponse;
            
            reject(new Error('فشل في الاتصال. تأكد من اتصال الإنترنت'));
        };
        
        document.head.appendChild(script);
        
        // إضافة timeout
        setTimeout(() => {
            if (window.handleRestoreResponse) {
                console.warn('⚠️ انتهت مهلة طلب الاستعادة');
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleRestoreResponse;
                reject(new Error('انتهت مهلة الطلب. جرب مرة أخرى'));
            }
        }, 30000);
    });
}

// دالة لعرض رسالة الحساب المعلق للـ Employer
function showSuspendedAccountModal(userData) {
    // إنشاء الـ modal
    const modalHtml = `
        <div id="suspendedAccountModal" class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: #ff9800;"></i>
                </div>
                <h3 style="color: #333; margin-bottom: 15px;">حسابك معلق</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 16px; line-height: 1.5;">
                    عذراً، حسابك معلق حالياً. يرجى التواصل مع إدارة النظام لمعرفة السبب وحل المشكلة.
                </p>
                <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: right;">
                    <p style="margin: 0;">
                        <strong>معلومات الاتصال:</strong><br>
                        - البريد الإلكتروني: almobseroon@gmail.com<br>
                        - +الهاتف: 968 95209623<br>
                        - سيتم الرد عليك في اقرب فرصة
                    </p>
                </div>
                <div style="margin-top: 20px;">
                    <button id="closeSuspendedModal" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        فهمت
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // إضافة الـ modal إلى الصفحة
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer.firstElementChild);
    
    // إضافة event listener لإغلاق الـ modal
    document.getElementById('closeSuspendedModal').addEventListener('click', function() {
        closeSuspendedAccountModal();
    });
    
    // إغلاق الـ modal عند النقر خارج المحتوى
    document.getElementById('suspendedAccountModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeSuspendedAccountModal();
        }
    });
}

// دالة لإغلاق رسالة الحساب المعلق
function closeSuspendedAccountModal() {
    const modal = document.getElementById('suspendedAccountModal');
    if (modal) {
        modal.remove();
    }
    
    // تنظيف حقول نموذج الدخول
    document.getElementById('loginPhone').value = '';
    document.getElementById('loginPassword').value = '';
    
    // إعادة تفعيل زر الدخول
    const submitBtn = document.querySelector('#loginForm .btn-login-submit');
    submitBtn.disabled = false;
    submitBtn.textContent = 'تسجيل الدخول';
}
        // دالة للتحقق من صحة رقم الهاتف
        function isValidPhoneNumber(phone) {
            // تقبل الأرقام العراقية والعالمية
            const phoneRegex = /^(\+?\d{1,3}[- ]?)?\d{10,14}$/;
            return phoneRegex.test(phone);
        }

        // دالة للتحقق من حالة تسجيل الدخول عند تحميل الصفحة
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (isLoggedIn && currentUser.signupPhone) {
                updateUIAfterRegistration(currentUser);
                
                // إذا كانت بيانات المستخدم غير مكتملة، جلبها من السيرفر
                if (!currentUser.fullname || !currentUser.state) {
                    syncUserDataFromServer(currentUser.signupPhone);
                }
            }
        }

        // دالة محاكاة تسجيل الدخول
        function login() {
            signupPhone();
        }

        // دالة لمزامنة بيانات المستخدم من السيرفر
        async function syncUserDataFromServer(phone) {
            try {
                const url = LOGIN_SCRIPT_URL + '?action=getUser&phone=' + encodeURIComponent(phone) + 
                           '&t=' + new Date().getTime();
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data && data.success === true && data.userData) {
                        // تحديث بيانات المستخدم المحلية
                        localStorage.setItem('currentUser', JSON.stringify(data.userData));
                        
                        // تحديث الواجهة إذا كان المستخدم مسجل دخول
                        if (localStorage.getItem('isLoggedIn') === 'true') {
                            updateUIAfterRegistration(data.userData);
                        }
                    }
                }
            } catch (error) {
                console.error('خطأ في مزامنة بيانات المستخدم:', error);
            }
        }

        // دالة لتحديث نموذج إضافة المنتج ببيانات المستخدم
       function updateProductFormWithUserData(userData) {
    try {
        // تحديث حقل هاتف المستخدم
        const custelField = document.getElementById('custel');
        if (custelField && (userData.phone || userData.signupPhone)) {
            custelField.value = userData.phone || userData.signupPhone;
        }
        
        // تحديث حقل المنطقة
        const locationStateField = document.getElementById('productLocationState');
        if (locationStateField && userData.state) {
            locationStateField.value = userData.state;
        }
        
        // تحديث حقل اسم الموقع
        const locationNameField = document.getElementById('productLocationName');
        if (locationNameField && userData.locationAddress) {
            locationNameField.value = userData.locationAddress;
        }
        
        // تحديث حقل رابط الموقع
        const locationLinkField = document.getElementById('productLocationLink');
        if (locationLinkField && userData.storeLat) {
            locationLinkField.value = userData.storeLat;
        }
        
    } catch (error) {
        console.warn('⚠️ خطأ في تحديث نموذج المنتج:', error);
    }
}

        // دالة لفتح نافذة تسجيل الدخول
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            // مسح الحقول عند الفتح
            document.getElementById('loginForm').reset();
        }

        // دالة لإغلاق نافذة تسجيل الدخول
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // دالة لترتيب المنتجات حسب التاريخ تنازلياً
        async function sortProductsByDateDescending() {
            try {
                const url = SCRIPT_URL + '?action=sortProducts&t=' + new Date().getTime();
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('تم ترتيب المنتجات بنجاح');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('خطأ في ترتيب المنتجات:', error);
                return false;
            }
        }

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل المفضلة من التخزين المحلي
            loadFavorites();
            
            // تعيين الحدث لزر تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', openLoginModal);
            
            // تعيين الحدث لزر إغلاق نافذة تسجيل الدخول
            document.getElementById('closeLoginModal').addEventListener('click', closeLoginModal);
            
            // تعيين الحدث لزر الإغلاق في نافذة تسجيل الدخول
            document.getElementById('closeLoginBtn').addEventListener('click', closeLoginModal);
            
            // تعيين الحدث لزر نسيت كلمة المرور
            document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
                alert('لإعادة تعيين كلمة المرور، يرجى التواصل مع إدارة النظام');
            });
            
            // تحميل المنتجات
            loadProductsFromGoogleSheets();
        });
// دالة للتعامل مع النقر على رقم الهاتف
function handlePhoneClick() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (currentUser && currentUser.signupPhone) {
        openUserEditModal(currentUser);
    } else {
        alert('بيانات المستخدم غير متاحة. يرجى تسجيل الدخول مرة أخرى.');
    }
}
// إضافة هذه الدالة في نهاية الـ script
function setupPhoneClickHandler() {
    const userPhoneElement = document.getElementById('userPhone');
    if (userPhoneElement) {
        // إزالة أي مستمعين سابقين
        userPhoneElement.removeEventListener('click', handlePhoneClick);
        
        // إضافة مستمع جديد
        userPhoneElement.addEventListener('click', handlePhoneClick);
        hideTermsSection();
        // إضافة الأنماط
        userPhoneElement.style.cursor = 'pointer';
        userPhoneElement.style.textDecoration = 'underline';
        userPhoneElement.style.padding = '5px 10px';
        userPhoneElement.style.borderRadius = '5px';
        userPhoneElement.style.transition = 'all 0.3s ease';
        
        // إضافة تأثير hover
        userPhoneElement.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            this.style.transform = 'translateY(-2px)';
        });
        
        userPhoneElement.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'transparent';
            this.style.transform = 'translateY(0)';
        });
    }
}

// دالة لفتح نافذة تعديل بيانات المستخدم
function openUserEditModal(userData) {
    console.log('فتح نافذة تعديل بيانات المستخدم:', userData);
    
    // ملء حقول النموذج ببيانات المستخدم
    const fields = {
        'fullname': userData.fullname || '',
        'signupPhone': userData.signupPhone || '',
        'state': userData.state || '',
        'signupPassword': userData.signupPassword || '',
        'locationAddress': userData.locationAddress || '',
        'storeLat': userData.storeLat || '',
        'date': userData.date || getCurrentDate(),
        'userstate': userData.userstate || 'User',
        'photoUrl': userData.photoUrl || ''
    };
    
    // تعبئة الحقول
    Object.keys(fields).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.value = fields[fieldId];
            
            // جعل رقم الهاتف للقراءة فقط في حالة التعديل
            if (fieldId === 'signupPhone') {
                element.readOnly = true;
                element.style.backgroundColor = '#f5f5f5';
                element.style.cursor = 'not-allowed';
            }
        }
    });
    
    // عرض صورة المستخدم إذا كانت موجودة
    const previewImage = document.getElementById('previewImage');
    const photoUploadIcon = document.querySelector('#photoUpload i');
    
    if (userData.photoUrl && userData.photoUrl !== '') {
        previewImage.src = userData.photoUrl;
        previewImage.style.display = 'block';
        if (photoUploadIcon) {
            photoUploadIcon.style.display = 'none';
        }
    } else {
        previewImage.style.display = 'none';
        if (photoUploadIcon) {
            photoUploadIcon.style.display = 'block';
        }
    }
    
    // تحديث حقول التاريخ المخفية
    document.getElementById('creationDate').value = userData.creationDate || getCurrentDateTime();
    document.getElementById('updateDate').value = getCurrentDateTime();
    
    // تغيير زر الحفظ إلى زر التعديل
    const submitBtn = document.querySelector('#signupForm .btn-submit');
    if (submitBtn) {
        submitBtn.textContent = 'تحديث البيانات';
        submitBtn.dataset.mode = 'edit';
        submitBtn.dataset.userId = userData.ID || '';
        submitBtn.dataset.originalPhone = userData.signupPhone || '';
    }
    setupPasswordToggle();
    // hideTermsSection();
    // إضافة زر الحذف
    setTimeout(() => {
        addDeleteButton();
    }, 100);
    
    // تهيئة زر إظهار/إخفاء كلمة المرور
    setTimeout(() => {
        setupPasswordToggle();
    }, 100);
    
    // فتح النافذة
    document.getElementById('signupModal').style.display = 'flex';
    
    // تهيئة الخريطة بعد فتح النافذة
    setTimeout(() => {
        if (typeof initMap === 'function') {
            initMap();
            
            // إذا كان هناك موقع محفوظ، عرضه على الخريطة
            if (userData.storeLat && map) {
                setTimeout(() => {
                    const coords = extractCoordinatesFromLink(userData.storeLat);
                    if (coords) {
                        map.setView([coords.lat, coords.lng], 15);
                        if (marker) {
                            marker.setLatLng([coords.lat, coords.lng]);
                            updateLocationFields(coords.lat, coords.lng);
                        }
                    }
                }, 500);
            }
        }
    }, 300);
}

// دالة لإضافة زر الحذف
function addDeleteButton() {
    // إزالة زر الحذف القديم إذا كان موجوداً
    const existingDeleteBtn = document.querySelector('#signupForm .btn-delete');
    if (existingDeleteBtn) {
        existingDeleteBtn.remove();
    }
    
    // إنشاء زر الحذف
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-delete';
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> حذف الحساب';
    
    // إضافة الأنماط مباشرة
    Object.assign(deleteBtn.style, {
        background: 'linear-gradient(135deg, #e74c3c, #c0392b)',
        color: 'white',
        width: '100%',
        padding: '12px',
        fontSize: '16px',
        fontWeight: '600',
        marginTop: '10px',
        border: 'none',
        borderRadius: '6px',
        cursor: 'pointer',
        transition: 'all 0.3s ease',
        display: 'block'
    });
    
    // إضافة تأثير hover
    deleteBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 8px rgba(231, 76, 60, 0.3)';
    });
    
    deleteBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
    // إضافة حدث النقر مع تأكيد
    deleteBtn.addEventListener('click', function() {
        showDeleteConfirmation();
    });
    
    // إضافة زر الحذف إلى النموذج
    const form = document.getElementById('signupForm');
    if (form) {
        form.appendChild(deleteBtn);
    }
}

// دالة لعرض نافذة تأكيد الحذف
function showDeleteConfirmation() {
    // إنشاء نافذة تأكيد
    const confirmationModal = document.createElement('div');
    confirmationModal.id = 'deleteConfirmationModal';
    confirmationModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    confirmationModal.innerHTML = `
        <div class="confirmation-content" style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease-out;
        ">
            <div class="confirmation-icon" style="
                font-size: 60px;
                color: #e74c3c;
                margin-bottom: 20px;
            ">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            
            <h3 style="color: #2c3e50; margin-bottom: 15px;">تأكيد حذف الحساب</h3>
            
            <p style="color: #666; line-height: 1.6; margin-bottom: 25px;">
                هل أنت متأكد أنك تريد حذف حسابك؟
                <br>
                <span style="color: #e74c3c; font-weight: bold;">
                    سيتم تحديث حالة حسابك إلى "محذوف" ولا يمكن استخدامه بعد الآن!
                </span>
            </p>
            
            <div class="confirmation-buttons" style="
                display: flex;
                gap: 10px;
                justify-content: center;
            ">
                <button id="confirmDeleteBtn" style="
                    background: linear-gradient(135deg, #e74c3c, #c0392b);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                    flex: 1;
                    transition: all 0.3s ease;
                ">
                    نعم، احذف الحساب
                </button>
                
                <button id="cancelDeleteBtn" style="
                    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                    flex: 1;
                    transition: all 0.3s ease;
                ">
                    إلغاء
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmationModal);
    
    // إضافة تأثير hover للأزرار
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    
    confirmBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 8px rgba(231, 76, 60, 0.3)';
    });
    
    confirmBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
    cancelBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 8px rgba(149, 165, 166, 0.3)';
    });
    
    cancelBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
    // إضافة أحداث الأزرار
    confirmBtn.addEventListener('click', function() {
        deleteUserAccount();
    });
    
    cancelBtn.addEventListener('click', function() {
        document.body.removeChild(confirmationModal);
    });
    
    // إغلاق النافذة عند النقر خارجها
    confirmationModal.addEventListener('click', function(event) {
        if (event.target === this) {
            document.body.removeChild(confirmationModal);
        }
    });
    
    // إغلاق النافذة بمفتاح ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('deleteConfirmationModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
    });
}


// دالة محسنة لحذف حساب المستخدم مع عرض التحميل
async function deleteUserAccount() {
    const submitBtn = document.querySelector('#signupForm .btn-submit');
    const userId = submitBtn.dataset.userId;
    
    if (!userId) {
        alert('خطأ: لا يوجد معرف للمستخدم');
        return;
    }
    
    // إغلاق نافذة التأكيد
    const confirmationModal = document.getElementById('deleteConfirmationModal');
    if (confirmationModal) {
        document.body.removeChild(confirmationModal);
    }
    
    // إظهار مؤشر التحميل
    showLoading(true, 'جاري حذف الحساب...');
    
    try {
        console.log(`🔄 محاولة حذف المستخدم ${userId}...`);
        
        // إرسال طلب الحذف الناعم فقط مع userId
        const response = await softDeleteUserInGoogleSheets(userId);
        
        if (response.success) {
            console.log('✅ تم تحديث حالة المستخدم إلى Delete بنجاح');
            
            // إظهار رسالة نجاح
            showLoading(true, 'تم حذف الحساب بنجاح! جاري تسجيل الخروج...');
            
            // الانتظار قليلاً ثم تسجيل الخروج
            setTimeout(() => {
                showLoading(false);
                showNotification('تم حذف الحساب بنجاح');
                
                // إغلاق نافذة التسجيل
                const signupModal = document.getElementById('signupModal');
                if (signupModal) {
                    signupModal.style.display = 'none';
                }
                
                // تنفيذ تسجيل الخروج
                logout();
                
                // إعادة تعيين النموذج
                resetSignupForm();
            }, 1500);
        } else {
            showLoading(false);
            alert('حدث خطأ أثناء حذف الحساب: ' + (response.message || ''));
        }
    } catch (error) {
        console.error('💥 خطأ في حذف الحساب:', error);
        showLoading(false);
        alert('فشل في حذف الحساب: ' + error.message);
    }
}


// دالة لإعادة تعيين نموذج التسجيل
function resetSignupForm() {
    document.getElementById('signupForm').reset();
    document.getElementById('previewImage').style.display = 'none';
    const photoUploadIcon = document.querySelector('#photoUpload i');
    if (photoUploadIcon) {
        photoUploadIcon.style.display = 'block';
    }
    document.getElementById('photoUrl').value = '';
    showTermsSection();
            
    // إزالة زر الحذف
    const deleteBtn = document.querySelector('.btn-delete');
    if (deleteBtn) {
        deleteBtn.remove();
    }
    
    // إعادة زر الحفظ إلى حالته الأصلية
    const submitBtn = document.querySelector('#signupForm .btn-submit');
    if (submitBtn) {
        submitBtn.textContent = 'تسجيل الحساب';
        submitBtn.dataset.mode = 'create';
        submitBtn.dataset.userId = '';
    }
   
}
// دالة لتحديث بيانات المستخدم
async function updateUserData() {
    const submitBtn = document.querySelector('#signupForm .btn-submit');
    const userId = submitBtn.dataset.userId;
    const originalPhone = submitBtn.dataset.originalPhone;
    
    if (!userId) {
        alert('خطأ: لا يوجد معرف للمستخدم');
        return;
    }
    
    // تعطيل الزر أثناء المعالجة
    const originalBtnText = submitBtn.textContent;
   showLoading(true, 'جاري تحديث  بيانات المستخدم...');
    submitBtn.disabled = true;
    
    try {
        // 1. رفع الصورة إذا تم تغييرها
        let imageUrl = document.getElementById('photoUrl').value || '';
        const fileInput = document.getElementById('photoInput');
        
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                console.log('📤 رفع الصورة:', file.name);
                imageUrl = await uploadToImgBB(file);
                console.log('✅ تم رفع الصورة:', imageUrl);
            } catch (error) {
                console.warn('⚠️ فشل رفع الصورة:', error);
                // إذا فشل رفع الصورة، احتفظ بالصورة القديمة
                if (!imageUrl) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    imageUrl = currentUser.photoUrl || '';
                }
            }
        }
        
        // 2. جمع البيانات من النموذج
        const updatedData = {
            ID: userId,
            fullname: document.getElementById('fullname')?.value || '',
            phone: document.getElementById('signupPhone')?.value || '',
            state: document.getElementById('state')?.value || '',
            password: document.getElementById('signupPassword')?.value || '',
            locationAddress: document.getElementById('locationAddress')?.value || '',
            storeLat: document.getElementById('storeLat')?.value || '',
            date: document.getElementById('date')?.value || new Date().toISOString().split('T')[0],
            userstate: document.getElementById('userstate')?.value || 'User',
            photoUrl: imageUrl,
            originalPhone: originalPhone || ''
        };
        
        console.log('📋 البيانات المرسلة للتحديث:', updatedData);
        
        // 3. التحقق من البيانات الأساسية
        if (!updatedData.phone) {
            throw new Error('رقم الهاتف مطلوب');
        }
        
        // 4. تحديث الواجهة المحلية أولاً (لتحسين تجربة المستخدم)
        updateUILocally(updatedData);
        
        // 5. إرسال البيانات إلى Google Sheets
        const response = await updateUserInGoogleSheets(updatedData);
        
        if (!response.success) {
            throw new Error(response.message || 'فشل في تحديث البيانات في السيرفر');
        }
        
        // 6. تحديث بيانات المستخدم في localStorage مع البيانات المحدثة من السيرفر
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const finalUpdatedUser = { 
            ...currentUser,
            ...updatedData,
            ...(response.userData || {}), // البيانات المرجعة من السيرفر
            signupPhone: updatedData.phone, // الحفاظ على التوافق
            signupPassword: updatedData.password,
            updateDate: new Date().toISOString()
        };
        
        localStorage.setItem('currentUser', JSON.stringify(finalUpdatedUser));
        
        // 7. تحديث واجهة المستخدم نهائياً
        updateUIAfterRegistration(finalUpdatedUser);
        showLoading(false);
        showNotification('✅ تم تحديث البيانات بنجاح في السيرفر والمتصفح');
        
        // 8. إغلاق النافذة بعد تأخير
        setTimeout(() => {
            document.getElementById('signupModal').style.display = 'none';
            resetSignupForm();
            submitBtn.textContent = originalBtnText;
            submitBtn.disabled = false;
        }, 1500);
        
    } catch (error) {
        console.error('💥 خطأ في التحديث:', error);
        
        // إعادة تحميل بيانات المستخدم الأصلية في حالة الفشل
        reloadOriginalUserData();
        
        alert('❌ حدث خطأ أثناء تحديث البيانات:\n' + error.message);
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
    }
}

// دالة لتحديث الواجهة المحلية فوراً
function updateUILocally(updatedData) {
    try {
        // 1. تحديث شريط التنقل العلوي
        const userPhoneElement = document.getElementById('userPhone');
        if (userPhoneElement && updatedData.phone) {
            userPhoneElement.textContent = updatedData.phone;
        }
        
        // 2. تحديث صورة الملف الشخصي
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar && updatedData.photoUrl) {
            userAvatar.src = updatedData.photoUrl;
            userAvatar.onerror = function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4REIiLz4KPC9zdmc+';
            };
        }
        
        // 3. تحديث نموذج إضافة المنتج
        if (updatedData.phone) {
            const custelField = document.getElementById('custel');
            if (custelField) {
                custelField.value = updatedData.phone;
            }
        }
        
        if (updatedData.state) {
            const locationStateField = document.getElementById('productLocationState');
            if (locationStateField) {
                locationStateField.value = updatedData.state;
            }
        }
        
        console.log('✅ تم تحديث الواجهة المحلية');
        
    } catch (error) {
        console.warn('⚠️ خطأ في تحديث الواجهة المحلية:', error);
    }
}

// دالة لتحديث بيانات المستخدم في Google Sheets (المعدلة)
async function updateUserInGoogleSheets(formData) {
    return new Promise((resolve, reject) => {
        const UPDATE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwfA0WSJi3-FdRBguEW-FtCXy7BWeW4ONIVLNzOZfFA6Y2tiJcfmCReeyjxYaL0Shwg/exec';
        
        // بناء URL مع جميع المعلمات
        let url = UPDATE_SCRIPT_URL + 
                 '?action=updateUser' +
                 '&userId=' + encodeURIComponent(formData.ID || '') +
                 '&fullname=' + encodeURIComponent(formData.fullname || '') +
                 '&phone=' + encodeURIComponent(formData.phone || '') +
                 '&state=' + encodeURIComponent(formData.state || '') +
                 '&password=' + encodeURIComponent(formData.password || '') +
                 '&locationAddress=' + encodeURIComponent(formData.locationAddress || '') +
                 '&storeLat=' + encodeURIComponent(formData.storeLat || '') +
                 '&date=' + encodeURIComponent(formData.date || '') +
                 '&userstate=' + encodeURIComponent(formData.userstate || 'User') +
                 '&photoUrl=' + encodeURIComponent(formData.photoUrl || '') +
                 '&callback=handleUpdateResponse' +
                 '&t=' + new Date().getTime();
        
        // إضافة originalPhone إذا كان موجوداً
        if (formData.originalPhone) {
            url += '&originalPhone=' + encodeURIComponent(formData.originalPhone);
        }
        
        console.log('🔗 إرسال طلب JSONP إلى:', url);
        
        // استخدام JSONP فقط (لا تستخدم fetch)
        const script = document.createElement('script');
        script.src = url;
        
        window.handleUpdateResponse = function(response) {
            console.log('📥 استجابة من السيرفر:', response);
            
            // تنظيف
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleUpdateResponse;
            
            if (response && response.success) {
                resolve(response);
            } else {
                reject(new Error(response ? response.message : 'لا توجد استجابة من السيرفر'));
            }
        };
        
        script.onerror = function(error) {
            console.error('💥 خطأ في تحميل السكريبت:', error);
            
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleUpdateResponse;
            
            // رسالة خطأ أكثر وضوحاً
            reject(new Error('فشل في الاتصال. تأكد من: 1) الإنترنت يعمل 2) السكريبت منشور 3) افتح الملف عبر خادم محلي'));
        };
        
        document.head.appendChild(script);
        
        // إضافة timeout
        setTimeout(() => {
            if (window.handleUpdateResponse) {
                console.warn('⚠️ انتهت مهلة الطلب');
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleUpdateResponse;
                reject(new Error('انتهت مهلة الطلب. جرب مرة أخرى'));
            }
        }, 30000);
    });
}

async function softDeleteUserInGoogleSheets(userId) {
    return new Promise((resolve, reject) => {
        // رابط النشر الخاص بك
        const DELETE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwAVHCiJOraHHWDwjh3L_3i5amZcAOpKut6b1Hy-zNCp0yCoxSKVKRIEfUQBBTw1D3h/exec';
        
        if (!userId) {
            reject(new Error('معرف المستخدم مطلوب'));
            return;
        }
        
        // بناء URL - فقط action و userId
        let url = DELETE_SCRIPT_URL + 
                 '?action=softDelete' +
                 '&userId=' + encodeURIComponent(userId) +
                 '&callback=handleSoftDeleteResponse' +
                 '&t=' + new Date().getTime();
        
        console.log('🔗 إرسال طلب حذف ناعم إلى:', url);
        
        // استخدام JSONP
        const script = document.createElement('script');
        script.src = url;
        
        window.handleSoftDeleteResponse = function(response) {
            console.log('📥 استجابة من السيرفر للحذف الناعم:', response);
            
            // تنظيف
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleSoftDeleteResponse;
            
            if (response && response.success) {
                resolve(response);
            } else {
                reject(new Error(response ? response.message : 'لا توجد استجابة من السيرفر'));
            }
        };
        
        script.onerror = function(error) {
            console.error('💥 خطأ في تحميل السكريبت للحذف الناعم:', error);
            
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleSoftDeleteResponse;
            
            reject(new Error('فشل في الاتصال. تأكد من اتصال الإنترنت'));
        };
        
        document.head.appendChild(script);
        
        // إضافة timeout
        setTimeout(() => {
            if (window.handleSoftDeleteResponse) {
                console.warn('⚠️ انتهت مهلة طلب الحذف الناعم');
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleSoftDeleteResponse;
                reject(new Error('انتهت مهلة الطلب. جرب مرة أخرى'));
            }
        }, 30000);
    });
}


// دالة للاستخدام
async function deleteUser(userId) {
    try {
        console.log(`حذف المستخدم ${userId}...`);
        const result = await DeleteUserInGoogleSheets(userId);
        console.log('✅ تم تحديث حالة المستخدم إلى Delete بنجاح:', result);
        return result;
    } catch (error) {
        console.error('❌ خطأ في تحديث حالة المستخدم:', error);
        throw error;
    }
}


async function handleNewRegistration() {
    const submitBtn = document.querySelector('.btn-submit');
    const originalBtnText = submitBtn.textContent;
    
    // الحصول على البيانات من الحقول
    const phone = document.getElementById('signupPhone').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    
    // التحقق من طول الهاتف وكلمة المرور في البداية
    if (phone.length < 8) {
        alert('رقم الهاتف يجب أن يكون 8 أرقام على الأقل');
        return;
    }
    
    if (password.length < 6) {
        alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
        return;
    }
    
    // إذا اجتاز التحقق الأساسي، تابع عملية التسجيل
    showLoading(true, 'جاري التحقق من بيانات التسجيل ...');
    submitBtn.disabled = true;
    
    try {
        console.log('🔍 جاري التحقق من رقم الهاتف:', phone);
        
        const response = await fetch(`${PHONE_CHECK_SCRIPT}?phone=${encodeURIComponent(phone)}`);
        const result = await response.json();
        console.log('📋 استجابة السيرفر:', result);
        
        if (result.exists === true) {
            alert('🚫 ' + (result.message || 'رقم الهاتف موجود مسبقاً،اذا كنت تريد استعادة الحساب قم بتسجيل الدخول!'));
            submitBtn.textContent = originalBtnText;
            submitBtn.disabled = false;
            showLoading(false);
            return;
        }
        
        console.log('✅ الرقم غير موجود، أكمل التسجيل');
        submitBtn.textContent = 'جاري التسجيل...';
        
        let imageUrl = 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png';
        const fileInput = document.getElementById('photoInput');
        
        if (fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                submitBtn.textContent = 'جاري رفع الصورة...';
                imageUrl = await uploadToImgBB(file);
                console.log('📷 تم رفع الصورة:', imageUrl);
            } catch (error) {
                console.warn('⚠️ فشل رفع الصورة، استخدم الصورة الافتراضية');
            }
        } else {
            console.log('📷 لم يتم رفع صورة، استخدم الصورة الافتراضية');
        }
        
        // تمرير password كمعامل ثالث
        await completeRegistration(imageUrl, phone, password);
        
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('💥 خطأ:', error);
        alert('❌ حدث خطأ: ' + error.message);
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
        showLoading(false);
    }
}



// دالة لتمكين إظهار/إخفاء كلمة المرور
function setupPasswordToggle() {
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                this.setAttribute('title', 'إخفاء كلمة المرور');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                this.setAttribute('title', 'إظهار كلمة المرور');
            }
        });
    });
}
// إضافة دالة لإعادة تهيئة الخريطة عند فتح النافذة
function reinitMapForEdit(userData) {
    // الانتظار حتى يتم تحميل عنصر الخريطة
    setTimeout(() => {
        initMap();
        
        // إذا كان هناك موقع محفوظ، عرضه على الخريطة
        if (userData.storeLat) {
            setTimeout(() => {
                const coords = extractCoordinatesFromLink(userData.storeLat);
                if (coords && map) {
                    map.setView([coords.lat, coords.lng], 15);
                    if (marker) {
                        marker.setLatLng([coords.lat, coords.lng]);
                        updateLocationFields(coords.lat, coords.lng);
                    }
                }
            }, 500);
        }
    }, 300);
}
// دالة لتحميل بيانات المستخدم المحدثة من السيرفر
async function refreshUserDataFromServer(userId) {
    try {
        console.log('🔄 جاري تحديث بيانات المستخدم من السيرفر...');
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwfA0WSJi3-FdRBguEW-FtCXy7BWeW4ONIVLNzOZfFA6Y2tiJcfmCReeyjxYaL0Shwg/exec';
        const url = `${SCRIPT_URL}?action=getUser&userId=${encodeURIComponent(userId)}&callback=handleUserRefresh&t=${new Date().getTime()}`;
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            
            window.handleUserRefresh = function(response) {
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleUserRefresh;
                
                if (response && response.success && response.userData) {
                    console.log('✅ تم تحميل بيانات المستخدم من السيرفر:', response.userData);
                    
                    // تحديث localStorage
                    localStorage.setItem('currentUser', JSON.stringify(response.userData));
                    
                    // تحديث الواجهة
                    updateUIAfterRegistration(response.userData);
                    
                    resolve(response.userData);
                } else {
                    reject(new Error(response ? response.message : 'فشل في تحميل البيانات'));
                }
            };
            
            script.onerror = function() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleUserRefresh;
                reject(new Error('فشل في الاتصال بالسيرفر'));
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window.handleUserRefresh) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window.handleUserRefresh;
                    reject(new Error('انتهت مهلة الطلب'));
                }
            }, 10000);
        });
        
    } catch (error) {
        console.error('❌ خطأ في تحديث البيانات:', error);
        throw error;
    }
}
// متغيرات إدارة الطلبات

// متغيرات إدارة الطلبات
let ordersData = [];
let currentOrderId = null;

// تهيئة تواريخ الطلبات
// دالة تهيئة التواريخ المحسنة
function initOrderDates() {
    const today = new Date();
    
    // إضافة 6 أشهر
    const nextSixMonths = new Date();
    nextSixMonths.setMonth(today.getMonth() + 6);
    
    // تنسيق التاريخ ليكون YYYY-MM-DD
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // تعيين التواريخ
    document.getElementById('orderDate').value = formatDate(today);
    document.getElementById('expiryDate').value = formatDate(nextSixMonths);
    
    console.log('تاريخ الطلب:', formatDate(today));
    console.log('تاريخ الانتهاء:', formatDate(nextSixMonths));
}

// توليد رقم طلب تلقائي
function generateOrderNo() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `ORD-${timestamp}-${random}`;
}

// حساب القيم التلقائية للطلب
// دالة حساب القيم التلقائية
function calculateOrderValues() {
    const quantity = parseInt(document.getElementById('orderQuantity').value) || 0;
    const unitPrice = 0.500;
    const totalPrice = quantity * unitPrice;
    const taxRate = 0.05; // 5%
    const taxAmount = totalPrice * taxRate;
    const grandTotal = totalPrice + taxAmount;
    
    // تحديث الحقول
    document.getElementById('unitPrice').value = unitPrice.toFixed(3);
    document.getElementById('totalPrice').value = totalPrice.toFixed(3);
    document.getElementById('taxAmount').value = taxAmount.toFixed(3);
    document.getElementById('grandTotal').value = grandTotal.toFixed(3);
}


function openOrderManagementModal() {
    console.log('فتح نافذة إدارة الطلبات...');
    
    // فتح النافذة
    document.getElementById('orderManagementModal').style.display = 'flex';
    
    // توليد رقم طلب جديد عند فتح النافذة
    const newOrderNo = generateOrderNo();
    document.getElementById('orderNo').value = newOrderNo;
    console.log('تم توليد رقم الطلب:', newOrderNo);
   
    // تهيئة التواريخ
    initOrderDates();
     closeAddProductModal();
    // تعيين القيم الافتراضية
    document.getElementById('orderQuantity').value = '';
    document.getElementById('orderStatus').value = 'غير نشط';
    
    // حساب القيم التلقائية
    calculateOrderValues();
    
    // مسح معرف الطلب الحالي (لطلب جديد)
    currentOrderId = null;
    
    // تحميل بيانات الطلبات
    loadOrdersData();
}

// إغلاق نافذة إدارة الطلبات
function closeOrderManagementModal() {
    document.getElementById('orderManagementModal').style.display = 'none';
}

// فتح نافذة إضافة/تعديل الطلب
function openOrderModal(isEdit = false, orderId = null) {
    const modal = document.getElementById('orderModal');
    const title = document.getElementById('orderModalTitle');
    
    if (isEdit && orderId) {
        title.textContent = 'تعديل الطلب';
        loadOrderForEdit(orderId);
        currentOrderId = orderId;
    } else {
        title.textContent = 'إضافة طلب جديد';
        resetOrderForm();
        currentOrderId = null;
    }
    
  modal.style.display = 'flex';
modal.style.justifyContent = 'center';
modal.style.alignItems = 'center';
}

// إغلاق نافذة إضافة/تعديل الطلب
function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
    resetOrderForm();
    currentOrderId = null;
}

// إعادة تعيين نموذج الطلب
function resetOrderForm() {
    // إعادة تعيين حقل العدد
    const quantityInput = document.getElementById('quantityInput');
    if (quantityInput) {
        quantityInput.value = '1';
    }
    
    // إعادة تعيين العدادات المعروضة
    document.getElementById('counter-QuantityInputNo').innerHTML = `
        <span style="font-size: 16px; color: #7f8c8d; margin-left: 5px;">العدد:</span>
        <span style="font-size: 22px; font-weight: 700; color: #e74c3c;">0</span>
        <span style="font-size: 14px; color: #95a5a6;"> منتج</span>
    `;
    
    document.getElementById('counter-TotalPrice').innerHTML = `
        <span style="font-size: 16px; color: #7f8c8d; margin-left: 5px;">الإجمالي:</span>
        <span style="font-size: 22px; font-weight: 700; color: #27ae60;">0.000</span>
        <span style="font-size: 14px; color: #95a5a6;">ريال</span>
    `;
    
    // إخفاء زر الإرسال
   const sendBtn = document.getElementById('addSendtBtn');
const sendBtnLabel = document.getElementById('addSendtBtnLable');

if (sendBtn) {
    sendBtn.style.display = 'none';
}

if (sendBtnLabel) {
    sendBtnLabel.style.display = 'none';
}
    
    // إعادة تعيين الحسابات
    updateQuantityCalculation();
}


// تحميل بيانات الطلبات (محاكاة)
function loadOrdersData() {
    // هذه بيانات تجريبية - يجب استبدالها ببيانات حقيقية من Google Sheets
   ordersData = [
        {
            id: 1,
            orderNo: 'ORD-ABC123',
            orderDate: '2024-01-15',
            quantity: 10,
            unitPrice: 0.500,
            totalPrice: 5.000,
            taxAmount: 0.250,
            grandTotal: 5.250,
            expiryDate: '2025-01-15',
            status: 'غير نشط'
        },
        {
            id: 2,
            orderNo: 'ORD-DEF456',
            orderDate: '2024-01-16',
            quantity: 20,
            unitPrice: 0.500,
            totalPrice: 10.000,
            taxAmount: 0.500,
            grandTotal: 10.500,
            expiryDate: '2025-01-16',
            status: 'نشط'
        }
    ];
    
    updateOrdersTable();
    updateOrdersStats(); 
}
function updateOrderRowAfterActivation(orderId, orderNo) {
    const tableRows = document.querySelectorAll('#ordersTableBody tr');
    
    tableRows.forEach(row => {
        if (row.getAttribute('data-order-id') == orderId) {
            // تحديث حالة الطلب في العمود
            const statusCell = row.querySelector('td:nth-child(10)'); // عمود الحالة
            if (statusCell) {
                statusCell.innerHTML = `
                    <span class="status-badge" style="
                        background: #2ecc71;
                        color: white;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        display: inline-block;
                        font-weight: bold;
                        min-width: 70px;
                        text-align: center;
                    ">
                        نشط
                    </span>
                `;
            }
            
            // تحديث زر التنشيط في العمود
            const activateCell = row.querySelector('td:nth-child(11)'); // عمود التنشيط
            if (activateCell) {
                activateCell.innerHTML = `
                    <span style="color: #27ae60; font-size: 12px; padding: 6px 12px; display: inline-block;">
                        <i class="fas fa-check-circle"></i> نشط
                    </span>
                `;
            }
            
            // إضافة تأثير مرئي
            row.style.animation = 'highlightRow 2s ease-in-out';
            console.log(`✅ تم تحديث الصف للطلب ${orderNo}`);
        }
    });
}
// تحديث جدول الطلبات
// تحديث جدول الطلبات بالبيانات من Google Sheets
function updateOrdersTable(orders = ordersData) {
    console.log('🎯 تحديث جدول الطلبات...');
    
    const tableBody = document.getElementById('ordersTableBody');
    if (!tableBody) {
        console.error('❌ العنصر #ordersTableBody غير موجود');
        return;
    }
    
    // الحصول على المستخدم الحالي
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    const isAdmin = currentUser.userstate === 'Admin';
    
    if (!userPhone) {
        console.warn('⚠️ لا يوجد مستخدم مسجل دخول');
        tableBody.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-user-lock" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <h3 style="margin: 10px 0;">يجب تسجيل الدخول</h3>
                    <p style="color: #999;">سجل الدخول لعرض الطلبات</p>
                </td>
            </tr>
        `;
        return;
    }
    
    console.log(`📊 عدد الطلبات قبل التصفية: ${orders.length}`);
    console.log(`👤 حالة المستخدم: ${isAdmin ? 'مسؤول (Admin)' : 'مستخدم عادي'}`);
    
    let displayOrders = [];
    
    if (isAdmin) {
        // 🔥 **المسؤول يرى جميع الطلبات**
        console.log('👑 المستخدم مسؤول - عرض جميع الطلبات');
        displayOrders = orders.map(order => normalizeOrderData(order));
    } else {
        // المستخدم العادي يرى طلباته فقط
        const userOrders = orders
            .map(order => normalizeOrderData(order))
            .filter(order => {
                const orderPhone = order.signupPhoneUser || order.userPhone || order.phone || '';
                const isUserOrder = orderPhone.toString() === userPhone.toString();
                
                if (!isUserOrder) {
                    console.log(`❌ استبعاد طلب: ${order.orderNo} (رقم الهاتف: ${orderPhone})`);
                }
                
                return isUserOrder;
            });
        
        displayOrders = userOrders;
    }
    
    // 🔥 **ترتيب الطلبات من الأحدث إلى الأقدم**
    displayOrders.sort((a, b) => {
        const dateA = new Date(a.timestamp || a.orderDate || 0);
        const dateB = new Date(b.timestamp || b.orderDate || 0);
        return dateB - dateA; // ترتيب تنازلي (الأحدث أولاً)
    });
    
    console.log(`📊 عدد الطلبات للعرض: ${displayOrders.length}`);
    
    if (displayOrders.length === 0) {
        let message = '';
        
        if (isAdmin) {
            message = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin: 10px 0;">لا توجد طلبات في النظام</h3>
                        <p style="color: #999;">لم يتم إضافة أي طلبات بعد</p>
                    </td>
                </tr>
            `;
        } else {
            message = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin: 10px 0;">لا توجد طلبات حالياً</h3>
                        <p style="color: #999;">قم بإضافة أول طلب باستخدام الزر أعلاه</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">
                            المستخدم: ${userPhone}<br>
                            تم تحميل ${orders.length} طلب من السيرفر
                        </p>
                    </td>
                </tr>
            `;
        }
        
        tableBody.innerHTML = message;
        return;
    }
    
    // 🔥 **إضافة مؤشر ترتيب للطلبات**
    let rowsHTML = '';
    
    displayOrders.forEach((order, index) => {
        // إضافة رقم الترتيب
        const orderNumber = index + 1;
        
        // تلوين صف المسؤول بشكل مميز
        const rowClass = isAdmin ? 'admin-order-row' : '';
        const rowStyle = isAdmin ? 'background-color: #f8f9fa;' : '';
        
        // تنسيق التاريخ
        const orderDate = formatDisplayDate(order.orderDate || order.timestamp);
        const expiryDate = formatDisplayDate(order.expiryDate);
        
        // الحصول على حالة الطلب
        const orderStatus = order.orderStatus || order.status || 'غير نشط';
        const isActive = orderStatus.toLowerCase().includes('نشط') || 
                        orderStatus.toLowerCase().includes('active');
        
        // تحديد لون الحالة
        const statusLower = orderStatus.toLowerCase();
        let statusColor = '#e74c3c'; // غير نشط - أحمر
        
        if (statusLower.includes('نشط') || statusLower.includes('active')) {
            statusColor = '#2ecc71'; // نشط - أخضر
        } else if (statusLower.includes('منتهي') || statusLower.includes('expired')) {
            statusColor = '#f39c12'; // منتهي - برتقالي
        } else if (statusLower.includes('ملغي') || statusLower.includes('cancelled')) {
            statusColor = '#95a5a6'; // ملغي - رمادي
        }
        
        const statusText = orderStatus;
        
        // عرض معلومات إضافية للمسؤول
        let adminInfo = '';
        if (isAdmin) {
            adminInfo = `
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    <i class="fas fa-user"></i> ${order.userName || 'غير معروف'}
                    <i class="fas fa-phone" style="margin-right: 10px;"></i> ${order.userPhone || 'غير معروف'}
                </div>
            `;
        }
        
        rowsHTML += `
            <tr class="${rowClass}" style="${rowStyle}">
                <td style="text-align: center; font-weight: bold; color: #7f8c8d;">
                    ${orderNumber}
                </td>
                <td style="font-weight: bold; color: #2c3e50;">
                    ${order.orderNo || 'ORD-' + (index + 1)}
                    ${adminInfo}
                </td>
                <td>${orderDate}</td>
                <td style="color: #e74c3c; font-weight: bold; text-align: center;">${order.quantity || 0}</td>
                <td style="text-align: center;">${parseFloat(order.unitPrice || 0).toFixed(3)}</td>
                <td style="color: #27ae60; font-weight: bold; text-align: center;">${parseFloat(order.totalPrice || 0).toFixed(3)}</td>
                <td style="text-align: center;">${parseFloat(order.taxAmount || 0).toFixed(3)}</td>
                <td style="color: #d35400; font-weight: bold; text-align: center;">${parseFloat(order.grandTotal || 0).toFixed(3)}</td>
                <td>${expiryDate}</td>
                <td>
                    <span class="status-badge" style="
                        background: ${statusColor};
                        color: white;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        display: inline-block;
                        font-weight: bold;
                        min-width: 70px;
                        text-align: center;
                    ">
                        ${statusText}
                    </span>
                </td>
                <td>
                    ${isActive ? 
                        `<button onclick="sendActivationRequest('${order.orderNo}')" 
                                class="btn-activate" 
                                style="
                                    background: linear-gradient(135deg, #25D366, #128C7E);
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 600;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 5px;
                                ">
                            <i class="fab fa-whatsapp"></i> تنشيط
                        </button>` 
                        : 
                        `<span style="color: #999; font-size: 12px; padding: 6px 12px; display: inline-block;">
                            ${statusText}
                        </span>`
                    }
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = rowsHTML;
    console.log(`✅ تم تحديث الجدول بـ ${displayOrders.length} صف`);
    
    // 🔥 **إضافة عنوان يوضح نوع العرض**
    updateTableHeader(isAdmin);
}


// تحديث إحصائيات الطلبات
// تحديث إحصائيات الطلبات
function updateOrdersStats(orders = ordersData) {
    // الحصول على المستخدم الحالي للتحقق
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    
    // تصفية الطلبات للمستخدم الحالي فقط
    const userOrders = orders.filter(order => {
        const orderPhone = order.signupPhoneUser || order.userPhone || order.phone || '';
        return orderPhone === userPhone;
    });
    
    if (!Array.isArray(userOrders)) {
        console.warn('⚠️ لا توجد بيانات للإحصائيات');
        userOrders = [];
    }
    
    const totalOrders = userOrders.length;
    const activeOrders = userOrders.filter(order => {
        const status = order.orderStatus || order.status;
        return status === 'نشط';
    }).length;
    const inactiveOrders = userOrders.filter(order => {
        const status = order.orderStatus || order.status;
        return status === 'غير نشط';
    }).length;
    const expiredOrders = userOrders.filter(order => {
        const status = order.orderStatus || order.status;
        return status === 'منتهي';
    }).length;
    
    // تحديث العناصر
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('activeOrders').textContent = activeOrders;
    document.getElementById('inactiveOrders').textContent = inactiveOrders;
    document.getElementById('expiredOrders').textContent = expiredOrders;
    
    console.log(`📊 إحصائيات المستخدم ${userPhone}: ${totalOrders} إجمالي, ${activeOrders} نشط`);
}

// تحميل طلب للتعديل
function loadOrderForEdit(orderId) {
    const order = ordersData.find(o => o.id === orderId);
    if (order) {
        document.getElementById('orderNo').value = order.orderNo;
        document.getElementById('orderDate').value = order.orderDate;
        document.getElementById('orderQuantity').value = order.quantity;
        document.getElementById('expiryDate').value = order.expiryDate;
        document.getElementById('orderStatus').value = order.status;
        calculateOrderValues();
    }
}

// تعديل طلب
// تعديل طلب
// دالة فتح نافذة تعديل الطلب
function editOrder(orderId) {
    const order = userOrders.find(o => o.id == orderId);
    
    if (!order) {
        showNotification('الطلب غير موجود', 'error');
        return;
    }
    
    currentEditingOrder = order;
    
    // حفظ بيانات الطلب في النموذج
    document.getElementById('edit-order-id').value = order.id;
    document.getElementById('edit-order-price').value = order.unitPrice || 0.500;
    document.getElementById('edit-order-color').value = order.color || '';
    document.getElementById('edit-order-description').value = order.description || '';
    document.getElementById('edit-order-quantity').value = order.quantity || 1;
    document.getElementById('edit-order-status').value = order.orderStatus || 'غير نشط';
    document.getElementById('edit-order-location').value = order.location || '';
    document.getElementById('edit-order-region').value = order.region || '';
    document.getElementById('edit-order-address').value = order.address || '';
    
    // عرض النافذة
    document.getElementById('orderEditModal').style.display = 'flex';
}

// حذف طلب
function deleteOrder(orderId) {
    if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
        ordersData = ordersData.filter(order => order.id !== orderId);
        updateOrdersTable();
        updateOrdersStats();
        showNotification('تم حذف الطلب بنجاح');
    }
}

// معالجة نموذج الطلب
document.getElementById('orderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const orderData = {
        id: currentOrderId || ordersData.length + 1,
        orderNo: document.getElementById('orderNo').value,
        orderDate: document.getElementById('orderDate').value,
        quantity: parseInt(document.getElementById('orderQuantity').value),
        unitPrice: 0.500,
        totalPrice: parseFloat(document.getElementById('totalPrice').value),
        taxAmount: parseFloat(document.getElementById('taxAmount').value),
        grandTotal: parseFloat(document.getElementById('grandTotal').value),
        expiryDate: document.getElementById('expiryDate').value,
        status: document.getElementById('orderStatus').value
    };
    
    if (currentOrderId) {
        // تحديث طلب موجود
        const index = ordersData.findIndex(o => o.id === currentOrderId);
        if (index !== -1) {
            ordersData[index] = orderData;
            showNotification('تم تحديث الطلب بنجاح');
        }
    } else {
        // إضافة طلب جديد
        ordersData.push(orderData);
        showNotification('تم إضافة الطلب بنجاح');
    }
    
    updateOrdersTable();
    updateOrdersStats();
    closeOrderModal();
});

// إضافة مستمعي الأحداث عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // زر إدارة الطلبات
     document.getElementById('manageOrdersBtn').addEventListener('click', openOrderManagementModal);
    
    // إغلاق نافذة إدارة الطلبات
    document.getElementById('closeOrderManagement').addEventListener('click', closeOrderManagementModal);
    
    // زر إضافة طلب جديد
    document.getElementById('addOrderBtn').addEventListener('click', function() {
        // تمكين حقل الحالة للمسؤول فقط
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (currentUser.userstate === 'Admin') {
            document.getElementById('orderStatus').disabled = false;
        } else {
            document.getElementById('orderStatus').disabled = true;
        }
        openOrderModal();
      
    });
    
    // إغلاق نافذة الطلب
    document.getElementById('closeMyOrders').addEventListener('click', closeMyOrdersModal);
    document.getElementById('closeMyOrdersBtn').addEventListener('click', closeMyOrdersModal);
    
    // حساب القيم التلقائية عند تغيير العدد
      document.getElementById('orderQuantity').addEventListener('input', function() {
        console.log('تغيير الكمية:', this.value);
        calculateOrderValues();
    });
    
    // إغلاق النافذة عند النقر خارجها
    document.getElementById('orderManagementModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeOrderManagementModal();
        }
    });
    
    
    document.getElementById('orderModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeOrderModal();
        }
    });
    
    // إغلاق بمفتاح ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            if (document.getElementById('orderManagementModal').style.display === 'flex') {
                closeOrderManagementModal();
            }
            if (document.getElementById('orderModal').style.display === 'flex') {
                closeOrderModal();
            }
        }
    });
      // إضافة event listener لزر الحفظ
    const saveOrderBtn = document.querySelector('#orderManagementModal .btn-submit');
    if (saveOrderBtn) {
        saveOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('حفظ الطلب...');
            saveOrder();
        });
    }
    // إضافة زر حفظ الطلب
document.addEventListener('DOMContentLoaded', function() {
    
    // زر حفظ الطلب في نموذج الطلبات
    const saveOrderBtn = document.querySelector('#orderManagementModal .btn-submit');
    if (saveOrderBtn) {
        saveOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveOrder();
        });
    }
});
    // تهيئة تواريخ الطلبات
    initOrderDates();
});

// تحديث تنسيق أوامر البيع
function updateOrdersStats() {
    const totalOrders = ordersData.length;
    const activeOrders = ordersData.filter(order => order.status === 'نشط').length;
    const inactiveOrders = ordersData.filter(order => order.status === 'غير نشط').length;
    const expiredOrders = ordersData.filter(order => order.status === 'منتهي').length;
    
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('activeOrders').textContent = activeOrders;
    document.getElementById('inactiveOrders').textContent = inactiveOrders;
    document.getElementById('expiredOrders').textContent = expiredOrders;
}
// دالة حفظ الطلب
function saveOrder() {
    const orderData = {
        id: currentOrderId || Date.now(), // معرف فريد
        orderNo: document.getElementById('orderNo').value,
        orderDate: document.getElementById('orderDate').value,
        quantity: parseInt(document.getElementById('orderQuantity').value) || 0,
        unitPrice: parseFloat(document.getElementById('unitPrice').value) || 0.500,
        totalPrice: parseFloat(document.getElementById('totalPrice').value) || 0,
        taxAmount: parseFloat(document.getElementById('taxAmount').value) || 0,
        grandTotal: parseFloat(document.getElementById('grandTotal').value) || 0,
        expiryDate: document.getElementById('expiryDate').value,
        status: document.getElementById('orderStatus').value
    };
    
    // التحقق من البيانات
    if (!orderData.orderNo || orderData.quantity <= 0) {
        alert('يرجى إدخال بيانات صحيحة للطلب');
        return;
    }
    
    if (currentOrderId) {
        // تحديث طلب موجود
        const index = ordersData.findIndex(o => o.id === currentOrderId);
        if (index !== -1) {
            ordersData[index] = orderData;
            showNotification('تم تحديث الطلب بنجاح');
        }
    } else {
        // إضافة طلب جديد
        ordersData.push(orderData);
        showNotification('تم إضافة الطلب بنجاح');
    }
    
    // تحديث الجدول والإحصائيات
    updateOrdersTable();
    updateOrdersStats();
    
    // إعادة تهيئة النموذج
    initOrderForm();
}

async function checkUserBalanceInUsersSheet(userPhone) {
    return new Promise((resolve, reject) => {
        try {
            // رابط سكريبت Google Apps المنشور
            const USERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-Ue0IciHlcSm4u6y-I-Ox1zJV90uoZUQ9OWOEeUcoRxVdPMmNkB72tpJSHY30_Jss/exec'; // استبدل برابطك المنشور
            
            // إنشاء callback فريد
            const callbackName = 'handleUserBalanceResponse_' + Date.now();
            
            const url = USERS_SCRIPT_URL + 
                       '?action=getUserBalance' +
                       '&phone=' + encodeURIComponent(userPhone) +
                       '&callback=' + callbackName +
                       '&t=' + new Date().getTime();
            
            console.log('Fetching user balance from:', url);
            
            // تعريف callback function
            window[callbackName] = function(response) {
                console.log('Balance response:', response);
                
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                resolve(response);
            };
            
            // إنشاء script element
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = function(error) {
                console.error('Script error:', error);
                
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                resolve({
                    success: false,
                    message: 'فشل في تحميل السكريبت'
                });
            };
            
            document.head.appendChild(script);
            
            // إضافة timeout
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                    resolve({
                        success: false,
                        message: 'انتهت مهلة الاتصال'
                    });
                }
            }, 10000);
            
        } catch (error) {
            console.error('Error in checkUserBalanceInUsersSheet:', error);
            resolve({
                success: false,
                message: error.toString()
            });
        }
    });
}

// دالة تحديث رصيد المستخدم في جدول Users
async function updateUserBalanceInUsersSheet(userPhone, quantity, orderNo) {
    return new Promise((resolve, reject) => {
        try {
            const USERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-Ue0IciHlcSm4u6y-I-Ox1zJV90uoZUQ9OWOEeUcoRxVdPMmNkB72tpJSHY30_Jss/exec'; // استبدل برابطك
            
            // إنشاء callback فريد
            const callbackName = 'handleUpdateBalanceResponse_' + Date.now();
            
            const url = USERS_SCRIPT_URL + 
                       '?action=updateUserBalance' +
                       '&phone=' + encodeURIComponent(userPhone) +
                       '&quantity=' + encodeURIComponent(quantity) +
                       '&orderNo=' + encodeURIComponent(orderNo) +
                       '&callback=' + callbackName +
                       '&t=' + new Date().getTime();
            
            console.log('Updating user balance via:', url);
            
            // تعريف callback function
            window[callbackName] = function(response) {
                console.log('Update balance response:', response);
                
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                if (response.success) {
                    resolve(response);
                } else {
                    reject(new Error(response.message || 'فشل في تحديث الرصيد'));
                }
            };
            
            // إنشاء script element
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = function(error) {
                console.error('Script error:', error);
                
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                reject(new Error('فشل في تحميل السكريبت'));
            };
            
            document.head.appendChild(script);
            
            // إضافة timeout
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                    reject(new Error('انتهت مهلة الاتصال'));
                }
            }, 15000);
            
        } catch (error) {
            console.error('Error in updateUserBalanceInUsersSheet:', error);
            reject(error);
        }
    });
}
async function quickActivationRequest(orderId) {
    console.log('تفعيل الطلب السريع للطلب ID:', orderId);
    
    try {
        const order = ordersData.find(o => o.id == orderId);
        if (!order) {
            showNotification('❌ الطلب غير موجود', 'error');
            return;
        }
        
        if (order.status === 'نشط' || order.orderStatus === 'نشط') {
            showNotification('⚠️ هذا الطلب مفعل بالفعل', 'warning');
            return;
        }
        
        const userPhone = order.signupPhoneUser || order.userPhone || order.phone;
        if (!userPhone) {
            showNotification('❌ لا يمكن العثور على رقم هاتف المستخدم', 'error');
            return;
        }
        
        // التحقق من صلاحيات المسؤول
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (currentUser.userstate !== 'Admin') {
            showNotification('❌ هذه الميزة متاحة فقط للمسؤولين', 'error');
            return;
        }
        
        // التحقق من الرصيد
        showLoading(true, 'جاري التحقق من رصيد المستخدم...');
        const balanceCheck = await checkUserBalanceInUsersSheet(userPhone);
        showLoading(false);
        
        if (!balanceCheck.success) {
            showNotification(`❌ ${balanceCheck.message}`, 'error');
            return;
        }
        
        const userBalance = balanceCheck.data;
        
        if (userBalance.UnActiveNo < order.quantity) {
            showNotification(`❌ الرصيد غير النشط غير كافٍ\nالمتوفر: ${userBalance.UnActiveNo}\nالمطلوب: ${order.quantity}`, 'error');
            return;
        }
        
        // تأكيد العملية
        if (!confirm(`هل تريد تفعيل الطلب ${order.orderNo} للمستخدم ${userPhone}؟`)) {
            return;
        }
        
        // تنفيذ العملية
        showLoading(true, 'جاري تفعيل الطلب وتحويل الرصيد...');
        
        // 1. تحديث الرصيد في جدول Users
        const updateBalanceResult = await updateUserBalanceInUsersSheet(
            userPhone, 
            order.quantity,
            order.orderNo
        );
        
        if (!updateBalanceResult.success) {
            throw new Error(updateBalanceResult.message || 'فشل في تحديث الرصيد');
        }
        
        // 2. تحديث حالة الطلب في Google Sheets
        const updateOrderStatusResult = await updateOrderStatusInOrdersSheet(order.orderNo, 'نشط');
        if (!updateOrderStatusResult.success) {
            throw new Error(updateOrderStatusResult.message || 'فشل في تحديث حالة الطلب في السجلات');
        }
        
        // 3. تحديث حالة الطلب في البيانات المحلية
        order.status = 'نشط';
        order.orderStatus = 'نشط';
        
        // 4. تحديث الواجهة - تحديث الصف مباشرة
        updateOrderRowAfterActivation(orderId, order.orderNo);
        
        // 5. تحديث الإحصائيات
        updateOrdersStats(ordersData);
        loadOrdersFromGoogleSheets();
        // 6. إرسال إشعار واتساب
        await sendApproveActivationWhatsAppMessage(order, userPhone, updateBalanceResult.data);
        
        // إكمال العملية
        showLoading(false);
        showNotification(`✅ تم تفعيل الطلب ${order.orderNo} بنجاح!`, 'success');
        
    } catch (error) {
        console.error('❌ خطأ في تفعيل الطلب:', error);
        showLoading(false);
        showNotification(`❌ ${error.message || 'حدث خطأ في عملية التفعيل'}`, 'error');
    }
}

// دالة إرسال رسالة واتساب للتنشيط
async function sendActivationWhatsAppMessage(order, userPhone) {
    try {
        // رقم الإدمن
        const adminNumber = '+96895209623';
        
        // بناء الرسالة
        const message = `📦 **تم تفعيل طلب جديد**\n\n` +
                       `👤 **المستخدم:** ${userPhone}\n` +
                       `🆔 **رقم الطلب:** ${order.orderNo}\n` +
                       `📅 **تاريخ الطلب:** ${order.orderDate}\n` +
                       `🔢 **الكمية:** ${order.quantity}\n` +
                       `💰 **القيمة الإجمالية:** ${order.grandTotal} ريال\n` +
                       `📅 **تاريخ الانتهاء:** ${order.expiryDate}\n` +
                       `✅ **الحالة:** تم التفعيل\n\n` +
                       `---\n` +
                       `🔄 تم نقل ${order.quantity} منتج من الرصيد الغير النشط إلى النشط`;
        
        // فتح واتساب
        const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        
        console.log('📤 تم إرسال رسالة واتساب للتنشيط:', message);
        
        return true;
        
    } catch (error) {
        console.error('❌ خطأ في إرسال رسالة واتساب:', error);
        throw new Error('فشل في إرسال رسالة واتساب');
    }
}

async function sendApproveActivationWhatsAppMessage(order, userPhone) {
    try {

        // بناء الرسالة
        const message = `📦 **تم تفعيل طلب جديد**\n\n` +
                       `👤 **المستخدم:** ${userPhone}\n` +
                       `🆔 **رقم الطلب:** ${order.orderNo}\n` +
                       `📅 **تاريخ الطلب:** ${order.orderDate}\n` +
                       `🔢 **الكمية:** ${order.quantity}\n` +
                       `💰 **القيمة الإجمالية:** ${order.grandTotal} ريال\n` +
                       `✅ **الحالة:** تم التفعيل\n\n` +
                       `---\n` +
                       `🔄 تم نقل ${order.quantity} منتج من الرصيد الغير النشط إلى النشط`;
        
        // فتح واتساب
        const whatsappUrl = `https://wa.me/${userPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        
        console.log('📤 تم إرسال رسالة واتساب للتنشيط:', message);
        
        return true;
        
    } catch (error) {
        console.error('❌ خطأ في إرسال رسالة واتساب:', error);
        throw new Error('فشل في إرسال رسالة واتساب');
    }
}
// وتعديل updateOrdersTable لاستخدام النسخة البسيطة
function updateOrdersTable() {
    const tableBody = document.getElementById('ordersTableBody');
    tableBody.innerHTML = '';
    
    ordersData.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${order.orderNo}</td>
            <td>${order.orderDate}</td>
            <td>${order.signupPhoneUser}</td>
            <td>${order.quantity}</td>
            <td>${order.unitPrice.toFixed(3)}</td>
            <td>${order.totalPrice.toFixed(3)}</td>
            <td>${order.taxAmount.toFixed(3)}</td>
            <td>${order.grandTotal.toFixed(3)}</td>
            <td>${order.expiryDate}</td>
            <td>${order.status}</td>
            <td>
                <button class="btn-activate" onclick="quickActivationRequest(${order.id})">
                    <i class="fab fa-whatsapp"></i> تنشيط
                </button>
            </td>
            <td>
                <div class="admin-only">
                <button class="btn-edit" onclick="editOrder(${order.id})">تعديل</button>
                <button class="btn-delete" onclick="deleteOrder(${order.id})">حذف</button>
                 </div >
            </td>
        `;
        tableBody.appendChild(row);
    });
}
// متغيرات إدارة الطلبات المفعلة
let activeOrders = [];
let currentSelectedOrder = null;
let productsAddedToOrder = 0;

// دالة لتحميل الطلبات المفعلة فقط
async function loadActiveOrders() {
    try {
        console.log('جاري تحميل الطلبات المفعلة...');
        
        // في الحقيقة، هنا يجب استدعاء API لجلب الطلبات من Google Sheets
        // سأستخدم ordersData المتاحة حالياً لكن بعد تصفيتها
        const activeOrdersList = ordersData.filter(order => 
            order.status === 'نشط' && 
            parseInt(order.quantity) > 0
        );
        
        console.log('الطلبات المفعلة:', activeOrdersList);
        
        activeOrders = activeOrdersList;
        populateActiveOrdersDropdown(activeOrdersList);
        
        return activeOrdersList;
    } catch (error) {
        console.error('خطأ في تحميل الطلبات المفعلة:', error);
        return [];
    }
}

// دالة لملء القائمة المنسدلة بالطلبات المفعلة
function populateActiveOrdersDropdown(orders) {
    const selectElement = document.getElementById('activeOrdersSelect');
    selectElement.innerHTML = '<option value="">-- اختر طلب --</option>';
    
    if (orders.length === 0) {
        selectElement.innerHTML += '<option value="" disabled>لا توجد طلبات مفعلة</option>';
        return;
    }
    
    orders.forEach(order => {
        const option = document.createElement('option');
        option.value = order.id;
        option.textContent = `طلب ${order.orderNo} (متاح: ${order.quantity})`;
        option.dataset.quantity = order.quantity;
        option.dataset.orderData = JSON.stringify(order);
        selectElement.appendChild(option);
    });
}

// دالة تحديث العدد المتبقي
function updateRemainingQuantity() {
    const remainingElement = document.getElementById('remainingQuantity');
    
    if (!currentSelectedOrder) {
        remainingElement.textContent = '0';
        remainingElement.style.background = '#e74c3c';
        return;
    }
    
    const remaining = currentSelectedOrder.quantity - productsAddedToOrder;
    
    remainingElement.textContent = remaining;
    
    // تغيير اللون حسب الكمية المتبقية
    if (remaining <= 0) {
        remainingElement.style.background = '#e74c3c';
        remainingElement.textContent = '0 (مكتمل)';
    } else if (remaining <= 3) {
        remainingElement.style.background = '#f39c12';
    } else {
        remainingElement.style.background = '#27ae60';
    }
}

// دالة عرض تفاصيل الطلب المختار
function showOrderDetails(order) {
    const detailsDiv = document.getElementById('orderDetails');
    const orderNoElement = document.getElementById('selectedOrderNo');
    const expiryDateElement = document.getElementById('selectedExpiryDate');
    const orderQuantityElement = document.getElementById('selectedOrderQuantity');
    const usedProductsElement = document.getElementById('usedProductsCount');
    
    orderNoElement.textContent = order.orderNo;
    expiryDateElement.textContent = order.expiryDate;
    orderQuantityElement.textContent = order.quantity;
    usedProductsElement.textContent = productsAddedToOrder;
    
    detailsDiv.style.display = 'block';
    
    // تحديث العداد
    updateRemainingQuantity();
}

// دالة إخفاء تفاصيل الطلب
function hideOrderDetails() {
    const detailsDiv = document.getElementById('orderDetails');
    if (detailsDiv) {
        detailsDiv.style.display = 'none';
    }
    currentSelectedOrder = null;
    productsAddedToOrder = 0;
    updateRemainingQuantity();
}

// دالة التحقق مما إذا كان يمكن إضافة منتج
function canAddProduct() {
    if (!currentSelectedOrder) {
        showNotification('يرجى اختيار طلب مفعل أولاً', 'error');
        return false;
    }
    
    const remaining = currentSelectedOrder.quantity - productsAddedToOrder;
    
    if (remaining <= 0) {
        showNotification('تم استهلاك جميع المنتجات في هذا الطلب', 'error');
        return false;
    }
    
    return true;
}

// دالة تسجيل إضافة منتج جديد
function recordProductAdded() {
    if (!currentSelectedOrder) return;
    
    productsAddedToOrder++;
    
    // تحديث الواجهة
    document.getElementById('usedProductsCount').textContent = productsAddedToOrder;
    updateRemainingQuantity();
    
    // إذا نفذت الكمية، إخفاء نموذج المنتج
    if (productsAddedToOrder >= currentSelectedOrder.quantity) {
        hideProductForm();
        showNotification('تم استهلاك جميع المنتجات في هذا الطلب', 'warning');
    }
}

// دالة إظهار نموذج المنتج
function showProductForm() {
    const formBody = document.querySelector('.form-body');
    formBody.classList.remove('hidden');
    formBody.classList.add('visible');
    
    // تمرير إلى نموذج المنتج
    setTimeout(() => {
        formBody.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
}

// دالة إخفاء نموذج المنتج
function hideProductForm() {
    const formBody = document.querySelector('.form-body');
    if (formBody) {
        formBody.classList.remove('visible');
        formBody.classList.add('hidden');
    }
}

// دالة تحديث نموذج المنتج ببيانات الطلب
function updateProductFormWithOrder(order) {
    // يمكنك هنا تعيين بعض القيم الافتراضية في نموذج المنتج
    // بناءً على بيانات الطلب إذا لزم الأمر
    console.log('تحديث نموذج المنتج ببيانات الطلب:', order);
    
    // مثال: تعيين حالة المنتج
    document.getElementById('productSituation').value = 'Active';
}

// معالجة اختيار طلب من القائمة المنسدلة
document.getElementById('activeOrdersSelect').addEventListener('change', function() {
    const selectedId = this.value;
    
    if (!selectedId) {
        hideOrderDetails();
        hideProductForm();
        return;
    }
    
    // البحث عن الطلب المختار
    const selectedOrder = activeOrders.find(order => order.id == selectedId);
    
    if (!selectedOrder) {
        showNotification('الطلب المختار غير موجود', 'error');
        return;
    }
    
    // التحقق من توفر المنتجات
    if (parseInt(selectedOrder.quantity) <= 0) {
        showNotification('هذا الطلب لا يحتوي على منتجات متاحة', 'error');
        this.value = '';
        return;
    }
    
    currentSelectedOrder = selectedOrder;
    productsAddedToOrder = 0; // إعادة تعيين العداد
    
    showOrderDetails(selectedOrder);
    showProductForm();
    updateProductFormWithOrder(selectedOrder);
    
    showNotification(`تم اختيار الطلب ${selectedOrder.orderNo}`);
});

// زر تحديث القائمة
document.getElementById('refreshOrdersBtn').addEventListener('click', function() {
    loadActiveOrders();
    showNotification('تم تحديث قائمة الطلبات');
});
// دالة لتحديث عدد المنتجات المتبقية في الطلب
async function updateOrderRemainingQuantity(orderId, productsAdded) {
    try {
        // هنا سيتم استدعاء API لتحديث عدد المنتجات في Google Sheets
        console.log(`تحديث الطلب ${orderId}: تمت إضافة ${productsAdded} منتج`);
        
        // يمكنك إرسال طلب AJAX لتحديث البيانات في Google Sheets
        const response = await fetch(`${SCRIPT_URL}?action=updateOrderQuantity&orderId=${orderId}&productsAdded=${productsAdded}`);
        const result = await response.json();
        
        if (result.success) {
            console.log('تم تحديث عدد المنتجات في الطلب');
        }
    } catch (error) {
        console.error('خطأ في تحديث عدد المنتجات:', error);
    }
}


// رابط Google Apps Script للطلبات


// دالة لجلب جميع الطلبات من Google Sheets
async function loadOrdersFromGoogleSheets() {
    return new Promise((resolve, reject) => {
        try {
            console.log('🚀 بدء تحميل الطلبات من Google Sheets...');
            
            // الحصول على المستخدم الحالي
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userPhone = currentUser.signupPhone || currentUser.phone;
            
            if (!userPhone) {
                console.warn('⚠️ لا يوجد مستخدم مسجل دخول');
                showNotification('⚠️ يجب تسجيل الدخول لعرض الطلبات', 'warning');
                resolve([]);
                return;
            }
            
            // إنشاء callback فريد لكل طلب لمنع التعارض
            const callbackName = 'handleOrdersResponse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log(`📞 Callback name: ${callbackName}`);
            
            const url = `${ORDERS_SCRIPT_URL}?action=getOrders&callback=${callbackName}&t=${Date.now()}`;
            console.log('📡 رابط تحميل الطلبات:', url);
            
            // عرض أيقونة تحميل
            showLoading(true, `جاري تحميل الطلبات...`);
            
            // تعريف دالة ال callback قبل إنشاء السكريبت
            window[callbackName] = function(response) {
                console.log('📦 استجابة الطلبات:', response);
                
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                if (response && response.success === true) {
                    // معالجة البيانات مع الترتيب
                    processOrdersDataWithSorting(response);
                    
                    showLoading(false);
                    resolve(ordersData);
                } else {
                    showLoading(false);
                    reject(new Error(response?.error || response?.message || 'فشل في تحميل الطلبات'));
                }
            };
            
            // إنشاء السكريبت
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = function(error) {
                console.error('❌ خطأ في تحميل سكريبت الطلبات:', error);
                
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                showLoading(false);
                reject(new Error('فشل في الاتصال بالسيرفر'));
            };
            
            document.head.appendChild(script);
            
            // إضافة timeout
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                    showLoading(false);
                    reject(new Error('انتهت مهلة تحميل الطلبات (15 ثانية)'));
                }
            }, 15000);
            
        } catch (error) {
            console.error('❌ خطأ في loadOrdersFromGoogleSheets:', error);
            showLoading(false);
            reject(error);
        }
    });
}

// دالة معالجة البيانات مع الترتيب
function processOrdersDataWithSorting(response) {
    console.log('🔄 معالجة بيانات الطلبات مع الترتيب...');
    
    let rawOrders = response.orders || response.data || [];
    
    // إذا كانت البيانات سلسلة نصية بدلاً من مصفوفة
    if (typeof rawOrders === 'string') {
        try {
            rawOrders = JSON.parse(rawOrders);
        } catch (e) {
            console.error('❌ فشل تحليل JSON:', e);
            rawOrders = [];
        }
    }
    
    if (!Array.isArray(rawOrders)) {
        console.error('❌ البيانات ليست مصفوفة:', typeof rawOrders);
        ordersData = [];
        return;
    }
    
    if (rawOrders.length === 0) {
        console.log('📭 لا توجد طلبات في النظام');
        ordersData = [];
        return;
    }
    
    // تحليل بنية البيانات
    analyzeDataStructure(rawOrders);
    
    // تطبيع البيانات
    const processedOrders = rawOrders.map(order => normalizeOrderData(order));
    
    // 🔥 **ترتيب الطلبات من الأحدث إلى الأقدم**
    processedOrders.sort((a, b) => {
        // محاولة الحصول على التاريخ من عدة مصادر
        const dateA = getOrderDate(a);
        const dateB = getOrderDate(b);
        
        return dateB - dateA; // ترتيب تنازلي (الأحدث أولاً)
    });
    
    ordersData = processedOrders;
    console.log(`✅ تمت معالجة وترتيب ${ordersData.length} طلب`);
    
    // تحديث الواجهة
    updateOrdersTable(ordersData);
    updateOrdersStats(ordersData);
}


// دالة لحفظ الطلب في Google Sheets
async function saveOrderToGoogleSheets(orderData) {
    return new Promise((resolve, reject) => {
        try {
            console.log('💾 جاري حفظ الطلب في Google Sheets...');
            
            // الحصول على المستخدم الحالي
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userPhone = currentUser.signupPhone || currentUser.phone;
            
            if (!userPhone) {
                reject(new Error('يجب تسجيل الدخول أولاً'));
                return;
            }
            
            // إضافة بيانات المستخدم إلى orderData
            orderData.idUser = currentUser.ID || '';
            orderData.signupPhoneUser = userPhone;
            orderData.userPhone = userPhone; // نسخة إضافية للتأكد
            
            const url = ORDERS_SCRIPT_URL + 
                '?action=saveOrder' +
                '&idUser=' + encodeURIComponent(orderData.idUser) +
                '&signupPhoneUser=' + encodeURIComponent(orderData.signupPhoneUser) +
                '&userPhone=' + encodeURIComponent(orderData.userPhone) +
                '&orderNo=' + encodeURIComponent(orderData.orderNo) +
                '&orderDate=' + encodeURIComponent(orderData.orderDate) +
                '&quantity=' + encodeURIComponent(orderData.quantity) +
                '&unitPrice=' + encodeURIComponent(orderData.unitPrice) +
                '&totalPrice=' + encodeURIComponent(orderData.totalPrice) +
                '&taxAmount=' + encodeURIComponent(orderData.taxAmount) +
                '&grandTotal=' + encodeURIComponent(orderData.grandTotal) +
                '&expiryDate=' + encodeURIComponent(orderData.expiryDate) +
                '&orderStatus=' + encodeURIComponent(orderData.orderStatus) +
                '&callback=handleSaveOrderResponse' +
                '&t=' + new Date().getTime();
            
            console.log('📡 رابط حفظ الطلب:', url);
            
            // استخدام JSONP
            const script = document.createElement('script');
            script.src = url;
            
            window.handleSaveOrderResponse = function(response) {
                console.log('📥 استجابة الحفظ:', response);
                
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleSaveOrderResponse;
                
                if (response && response.success) {
                    resolve(response);
                } else {
                    reject(new Error(response ? response.message : 'فشل في حفظ الطلب'));
                }
            };
            
            script.onerror = function(error) {
                console.error('❌ خطأ في تحميل سكريبت الحفظ:', error);
                
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleSaveOrderResponse;
                
                reject(new Error('فشل في الاتصال بالسيرفر للحفظ'));
            };
            
            document.head.appendChild(script);
            
            // إضافة timeout
            setTimeout(() => {
                if (window.handleSaveOrderResponse) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window.handleSaveOrderResponse;
                    reject(new Error('انتهت مهلة حفظ الطلب'));
                }
            }, 15000);
            
        } catch (error) {
            console.error('❌ خطأ في saveOrderToGoogleSheets:', error);
            reject(error);
        }
    });
}

// دالة لحذف الطلب من Google Sheets
async function deleteOrderFromGoogleSheets(orderNo) {
    return new Promise((resolve, reject) => {
        try {
            const url = ORDERS_SCRIPT_URL + 
                       '?action=deleteOrder' +
                       '&orderNo=' + encodeURIComponent(orderNo) +
                       '&callback=handleDeleteOrderResponse' +
                       '&t=' + new Date().getTime();
            
            const script = document.createElement('script');
            script.src = url;
            
            window.handleDeleteOrderResponse = function(response) {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleDeleteOrderResponse;
                
                if (response && response.success) {
                    resolve(response);
                } else {
                    reject(new Error(response ? response.message : 'فشل في حذف الطلب'));
                }
            };
            
            script.onerror = function() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleDeleteOrderResponse;
                reject(new Error('فشل في الاتصال بالسيرفر'));
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window.handleDeleteOrderResponse) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window.handleDeleteOrderResponse;
                    reject(new Error('انتهت مهلة حذف الطلب'));
                }
            }, 10000);
            
        } catch (error) {
            reject(error);
        }
    });
}

// دالة لتحديث حالة الطلب في Google Sheets
async function updateOrderStatusInOrdersSheet(orderNo, status) {
    return new Promise((resolve, reject) => {
        try {
            const ORDERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdfW_H1P3EN_oVAOISL2xWy26eMfOCz9UAXLA6OO6B-5Ld1RoteQxdFpkdqXx6B0Py/exec';
            
            const callbackName = 'handleUpdateOrderStatusResponse_' + Date.now();
            
            const url = ORDERS_SCRIPT_URL + 
                       '?action=updateOrderStatus' +
                       '&orderNo=' + encodeURIComponent(orderNo) +
                       '&status=' + encodeURIComponent(status) +
                       '&callback=' + callbackName +
                       '&t=' + new Date().getTime();
            
            console.log('📤 تحديث حالة الطلب في Google Sheets:', url);
            
            window[callbackName] = function(response) {
                // تنظيف
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                
                console.log('📥 استجابة تحديث حالة الطلب:', response);
                
                if (response && response.success) {
                    resolve(response);
                } else {
                    reject(new Error(response?.message || 'فشل في تحديث حالة الطلب في Google Sheets'));
                }
            };
            
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = function() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
                clearTimeout(timeoutId);
                reject(new Error('فشل في الاتصال لتحديث حالة الطلب'));
            };
            
            document.head.appendChild(script);
            
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                    reject(new Error('انتهت مهلة تحديث حالة الطلب'));
                }
            }, 15000);
            
        } catch (error) {
            reject(error);
        }
    });
}

// دالة رئيسية لحفظ الطلب
async function saveOrder() {
    // إظهار رسالة تحميل
    const saveBtn = document.querySelector('#orderManagementModal .btn-submit');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'جاري الحفظ...';
    saveBtn.disabled = true;
    
    try {
        // الحصول على بيانات المستخدم الحالي
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        // جمع بيانات الطلب من النموذج
        const orderData = {
            timestamp: new Date().toISOString(),
            idUser: currentUser.ID || '',
            signupPhoneUser: currentUser.signupPhone || currentUser.phone || '',
            orderNo: document.getElementById('orderNo').value,
            orderDate: document.getElementById('orderDate').value,
            quantity: parseInt(document.getElementById('orderQuantity').value) || 0,
            unitPrice: parseFloat(document.getElementById('unitPrice').value) || 0.500,
            totalPrice: parseFloat(document.getElementById('totalPrice').value) || 0,
            taxAmount: parseFloat(document.getElementById('taxAmount').value) || 0,
            grandTotal: parseFloat(document.getElementById('grandTotal').value) || 0,
            expiryDate: document.getElementById('expiryDate').value,
            status: document.getElementById('orderStatus').value || 'غير نشط'
        };
        
        console.log('📋 بيانات الطلب المجمعة:', orderData);
        
        // التحقق من البيانات الأساسية
        if (!orderData.orderNo || orderData.orderNo === 'يتم توليده تلقائياً') {
            throw new Error('يرجى توليد رقم طلب صحيح');
        }
        
        if (!orderData.quantity || orderData.quantity <= 0) {
            throw new Error('يرجى إدخال عدد صحيح للمنتجات');
        }
        
        if (!orderData.orderDate) {
            throw new Error('تاريخ الطلب مطلوب');
        }
        
        // حفظ الطلب في Google Sheets
        const result = await saveOrderToGoogleSheets(orderData);
        
     if (result.success) {
    // أظهر رسالة تأكيد تفصيلية
    const confirmationMessage = `
        ✅ تم إضافة الطلب بنجاح!
        
        📋 تفاصيل الطلب:
        - رقم الطلب: ${orderData.orderNo}
        - التاريخ: ${orderData.orderDate}
        - عدد المنتجات: ${orderData.quantity}
        - السعر الإجمالي: ${orderData.grandTotal} ريال
        
        💰 المبلغ المطلوب دفعه: ${orderData.grandTotal} ريال
        
        ⚠️ سيتم تفعيل الطلب بعد تأكيد الدفع.
    `;
    
    // استخدم alert مع تنسيق محسن
    alert(confirmationMessage);
    
    // أو استخدم SweetAlert إذا كان مثبتاً لديك
    // Swal.fire('تمت إضافة الطلب بنجاح!', confirmationMessage, 'success');
    
    showNotification('✅ تم حفظ الطلب بنجاح');
            
            // إعادة تعيين النموذج
            initOrderForm();
            
            // إعادة تحميل الطلبات من السيرفر
            await loadOrdersFromGoogleSheets();
            
            saveBtn.textContent = 'إضافة الطلب';
            saveBtn.disabled = false;
        }
        
    } catch (error) {
        console.error('❌ خطأ في حفظ الطلب:', error);
        alert('❌ حدث خطأ أثناء حفظ الطلب:\n' + error.message);
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}
// دالة تنسيق التاريخ للعرض
function formatDisplayDate(dateString) {
    if (!dateString) return 'غير محدد';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}
// دالة لتحديد كلاس الحالة
function getStatusClass(status) {
    switch(status) {
        case 'نشط': return 'active';
        case 'غير نشط': return 'inactive';
        case 'منتهي': return 'expired';
        case 'ملغي': return 'cancelled';
        default: return 'inactive';
    }
}
// دالة تحميل طلب للتعديل
async function editOrderFromTable(orderNo) {
    try {
        // جلب جميع الطلبات
        const orders = await loadOrdersFromGoogleSheets();
        
        // البحث عن الطلب المطلوب
        const order = orders.find(o => 
            (o.orderNo || o.orderNo) === orderNo
        );
        
        if (!order) {
            showNotification('❌ الطلب غير موجود', 'error');
            return;
        }
        
        // تعبئة النموذج ببيانات الطلب
        document.getElementById('orderNo').value = order.orderNo || order.orderNo;
        document.getElementById('orderDate').value = formatDateForInput(order.orderDate || order.OrderDate);
        document.getElementById('orderQuantity').value = parseInt(order.quantity || order.Quantity) || 0;
        document.getElementById('expiryDate').value = formatDateForInput(order.expiryDate || order.ExpiryDate);
        document.getElementById('orderStatus').value = order.orderStatus || order.status || 'غير نشط';
        
        // إعادة حساب القيم
        calculateOrderValues();
        
        // حفظ معرف الطلب الحالي
        currentOrderId = orderNo;
        
        // تغيير زر الحفظ إلى تحديث
        const saveBtn = document.querySelector('#orderManagementModal .btn-submit');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> تحديث الطلب';
        
        // إظهار زر الإلغاء
        document.getElementById('cancelOrderBtn').style.display = 'block';
        
        // التمرير إلى أعلى النموذج
        document.querySelector('.form-container').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        
        showNotification('✅ تم تحميل بيانات الطلب للتعديل');
        
    } catch (error) {
        console.error('❌ خطأ في تحميل الطلب:', error);
        showNotification('❌ تعذر تحميل بيانات الطلب', 'error');
    }
}

// دالة تنسيق التاريخ لحقل الإدخال
function formatDateForInput(dateDMY) {
    if (!dateDMY) return '';
    
    try {
        // إذا كان كائن Date
        if (dateDMY instanceof Date && !isNaN(dateDMY.getTime())) {
            return formatDateForInputFromDate(dateDMY);
        }
        
        // إذا كان نصاً بتنسيق DD/MM/YYYY
        if (typeof dateDMY === 'string' && dateDMY.includes('/')) {
            const parts = dateDMY.split('/');
            if (parts.length === 3) {
                const [day, month, year] = parts;
                // التأكد من أن السنة 4 أرقام
                const fullYear = (year.length === 2) ? `20${year}` : year;
                return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
        }
        
        // محاولة تحويل أي تنسيق نصي
        const date = new Date(dateDMY);
        if (!isNaN(date.getTime())) {
            return formatDateForInputFromDate(date);
        }
        
        return '';
    } catch (error) {
        console.error('❌ خطأ في تحويل التاريخ:', error);
        return '';
    }
}

/**
 * إضافة أنماط إضافية
 */
function addRenewalStyles() {
    if (!document.getElementById('renewal-styles')) {
        const style = document.createElement('style');
        style.id = 'renewal-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .date-display.renewed {
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
                border-color: #28a745;
                color: #155724;
                font-weight: bold;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
                70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
                100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
            }
            
            .renew-button:disabled {
                background: #28a745 !important;
                cursor: not-allowed !important;
                opacity: 0.8 !important;
            }
        `;
        document.head.appendChild(style);
    }
}
// دالة حذف الطلب
async function deleteOrderFromTable(orderNo) {
    if (!confirm(`هل أنت متأكد من حذف الطلب ${orderNo}؟`)) {
        return;
    }
    
    try {
        showLoading(true, 'جاري حذف الطلب...');
        
        const result = await deleteOrderFromGoogleSheets(orderNo);
        
        if (result.success) {
            showNotification('✅ تم حذف الطلب بنجاح');
            
            // إعادة تحميل الطلبات
            await loadOrdersFromGoogleSheets();
            
            // إذا كان الطلب المحذوف هو الحالي، إعادة تعيين النموذج
            if (currentOrderId === orderNo) {
                initOrderForm();
                currentOrderId = null;
            }
        }
        
    } catch (error) {
        console.error('❌ خطأ في حذف الطلب:', error);
        showNotification('❌ تعذر حذف الطلب', 'error');
    } finally {
        showLoading(false);
    }
}
// دالة إرسال طلب التنشيط
function sendActivationRequest(orderNo) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone || 'غير محدد';
    
    const message = `طلب تنشيط منتج\n` +
                   `رقم هاتف المستخدم: ${userPhone}\n` +
                   `رقم الطلب: ${orderNo}\n` +
                   `يرجى تفعيل هذا الطلب`;
    
    const whatsappNumber = '+96895209623'; // استبدل برقم المسؤول
    
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    
    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
    
    showNotification('✅ تم فتح واتساب لإرسال طلب التنشيط');
}
// دالة فتح نافذة إدارة الطلبات
async function openOrderManagementModal() {
    console.log('🔓 فتح نافذة إدارة الطلبات...');
    
    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            showNotification('⚠️ يجب تسجيل الدخول أولاً لعرض الطلبات', 'warning');
            openLoginModal();
            return;
        }
        
        // فتح النافذة
        document.getElementById('orderManagementModal').style.display = 'flex';
        
        // تحديث العنوان
        const header = document.querySelector('.order-management-header h2');
        if (header) {
            const isAdmin = currentUser.userstate === 'Admin';
            header.innerHTML = `<i class="fas fa-shopping-cart"></i> إدارة الطلبات ${isAdmin ? '(جميع المستخدمين)' : ''}`;
        }
        
        // تهيئة النموذج
        initOrderForm();
        
        // تهيئة نظام البحث
        initSearchSystem();
        
        // تعطيل زر حفظ أثناء التحميل
        const saveBtn = document.querySelector('#orderManagementModal .btn-submit');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
        saveBtn.disabled = true;
        
        try {
            await loadOrdersFromGoogleSheets();
        } catch (error) {
            console.warn('⚠️ فشل تحميل البيانات من السيرفر:', error.message);
            showNotification('⚠️ جاري تحميل بيانات محلية...', 'warning');
            loadSampleOrdersForUser(userPhone);
        }
        
        // تمكين زر الحفظ
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        console.log(`✅ تم فتح نافذة إدارة الطلبات للمستخدم ${userPhone}`);
        
    } catch (error) {
        console.error('❌ خطأ في فتح النافذة:', error);
        showLoading(false);
        showNotification('❌ تعذر فتح نافذة الطلبات', 'error');
    }
}

// في DOMContentLoaded، أضف تهيئة نظام البحث
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة نظام البحث عند تحميل الصفحة
    setTimeout(() => {
        initSearchSystem();
    }, 1000);
});


// دالة تهيئة نموذج الطلب
function initOrderForm() {
    console.log('تهيئة نموذج الطلب...');
    
    // توليد رقم طلب جديد
    const newOrderNo = generateOrderNo();
    document.getElementById('orderNo').value = newOrderNo;
    
    // تعيين التواريخ
    const today = new Date();
    const nextSixMonths = new Date();
    nextSixMonths.setMonth(today.getMonth() + 6);
    
    document.getElementById('orderDate').value = formatDateForInput(today);
    document.getElementById('expiryDate').value = formatDateForInput(nextSixMonths);
    
    // إعادة تعيين القيم
    document.getElementById('orderQuantity').value = '';
    document.getElementById('orderStatus').value = 'غير نشط';
    
    // إعادة الحساب
    calculateOrderValues();
    
    // إعادة زر الحفظ إلى حالته الأصلية
    const saveBtn = document.querySelector('#orderManagementModal .btn-submit');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save"></i> إضافة الطلب';
        saveBtn.disabled = false;
    }
    
    // إخفاء زر الإلغاء
    const cancelBtn = document.getElementById('cancelOrderBtn');
    if (cancelBtn) {
        cancelBtn.style.display = 'none';
    }
    
    // مسح معرف الطلب الحالي
    currentOrderId = null;
    
    console.log('✅ تمت تهيئة نموذج الطلب');
}
function showLoading(show, message = 'جاري التحميل...') {
    const loadingElement = document.getElementById('loadingOverlay');
    if (loadingElement) {
        loadingElement.style.display = show ? 'flex' : 'none';
        if (show) {
            loadingElement.innerHTML = `
                <div style="text-align: center; background: gray; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div class="spinner" style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    "></div>
                    <p style="margin: 0; color: #2c3e50; font-weight: 500;">${message}</p>
                </div>
            `;
        }
    }
}

// إضافة أنماط CSS للتحميل
if (!document.querySelector('#loadingStyles')) {
    const style = document.createElement('style');
    style.id = 'loadingStyles';
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    `;
    document.head.appendChild(style);
}
// دالة إظهار/إخفاء التحميل
// دالة لإظهار التحميل
function showLoading(show, message = 'جاري المعالجة...') {
    // إزالة أي أيقونة تحميل سابقة
            const existingLoader = document.getElementById('custom-loader');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            if (show) {
                // إنشاء عنصر التحميل
                const loader = document.createElement('div');
                loader.id = 'custom-loader';
                loader.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    color: white;
                    font-size: 18px;
                `;
                
                loader.innerHTML = `
                    <div class="spinner" style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin-bottom: 20px;
                    "></div>
                    <div>${message}</div>
                `;
                
                // إضافة أنيميشن للتدوير
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(loader);
            }
        }

// دالة لإظهار الإشعارات
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 5px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    `;
    
    // تحديد اللون حسب النوع
    if (type === 'success') {
        notification.style.background = '#2ecc71';
    } else if (type === 'error') {
        notification.style.background = '#e74c3c';
    } else if (type === 'warning') {
        notification.style.background = '#f39c12';
    } else {
        notification.style.background = '#3498db';
    }
    
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                      type === 'error' ? 'fa-exclamation-circle' : 
                      type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}" 
           style="margin-left: 10px;"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// إضافة أنماط CSS
const styles = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;

if (!document.querySelector('#appStyles')) {
    const styleEl = document.createElement('style');
    styleEl.id = 'appStyles';
    styleEl.textContent = styles;
    document.head.appendChild(styleEl);
}

// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 الصفحة محملة، جاهز لتحميل المنتجات');
    
    // إذا كان هناك مستخدم مسجل الدخول، حمّل المنتجات بعد ثانيتين
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (currentUser && currentUser.phone) {
        setTimeout(() => {
            loadUserProductsFromExcel();
        }, 2000);
    }
});
// بديل باستخدام Fetch مع Proxy
async function submitOrderViaFetch(formData) {
    try {
        const response = await fetch('https://cors-anywhere.herokuapp.com/' + ORDERS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
               // 'entry.1': formData.timestamp,
                'entry.312882855': formData.idUser,
                'entry.1483518317': formData.signupPhoneUser,
                'entry.1597321591': formData.orderNo,
                'entry.1394191894': formData.orderDate,
                'entry.185125038': formData.quantity,
                'entry.779089028': formData.unitPrice,
                'entry.750534150': formData.totalPrice,
                'entry.239604995': formData.taxAmount,
                'entry.149828706': formData.grandTotal,
                'entry.965870726': formData.expiryDate,
                'entry.851179584': formData.orderStatus
            })
        });
        
        console.log('Response status:', response.status);
        return { success: true };
        
    } catch (error) {
        console.error('Fetch error:', error);
        throw error;
    }
}
// دالة لمعالجة بيانات الطلبات القادمة من السيرفر
function processOrdersData(response, userPhone) {
    console.log('🔄 معالجة بيانات الطلبات للمستخدم:', userPhone);
    
    let rawOrders = response.orders || response.data || [];
    
    // إذا كانت البيانات سلسلة نصية بدلاً من مصفوفة
    if (typeof rawOrders === 'string') {
        try {
            rawOrders = JSON.parse(rawOrders);
        } catch (e) {
            console.error('❌ فشل تحليل JSON:', e);
            rawOrders = [];
        }
    }
    
    console.log('📊 البيانات الخام:', rawOrders);
    
    if (!Array.isArray(rawOrders)) {
        console.error('❌ البيانات ليست مصفوفة:', typeof rawOrders);
        ordersData = [];
        return;
    }
    
    if (rawOrders.length === 0) {
        console.log('📭 لا توجد طلبات للمستخدم:', userPhone);
        ordersData = [];
        return;
    }
    
    // تحليل بنية البيانات
    analyzeDataStructure(rawOrders);
    
    // تطبيع وتصفية البيانات
    const processedOrders = rawOrders
        .map(order => normalizeOrderData(order))
        .filter(order => {
            const orderPhone = order.signupPhoneUser || order.userPhone || order.phone || '';
            return orderPhone.toString() === userPhone.toString();
        });
    
    ordersData = processedOrders;
    console.log(`✅ تمت معالجة ${ordersData.length} طلب للمستخدم ${userPhone}`);
    
    // تحديث الواجهة
    updateOrdersTable(ordersData);
    updateOrdersStats(ordersData);
}
// دالة لتحليل بنية البيانات القادمة من السيرفر
function analyzeDataStructure(orders) {
    console.log('🔍 تحليل بنية البيانات...');
    
    if (!Array.isArray(orders) || orders.length === 0) {
        console.warn('⚠️ لا توجد بيانات للتحليل');
        return;
    }
    
    const sampleOrder = orders[0];
    console.log('📋 نموذج البيانات:', sampleOrder);
    
    // إظهار جميع المفاتيح والقيم
    console.log('🔑 جميع المفاتيح والقيم:');
    Object.entries(sampleOrder).forEach(([key, value]) => {
        console.log(`  "${key}": ${JSON.stringify(value)} (نوع: ${typeof value})`);
    });
    
    // البحث عن حالة الطلب
    console.log('\n🔎 البحث عن حالة الطلب:');
    const possibleStatusKeys = [
        'orderStatus', 'OrderStatus', 'orderstatus',
        'status', 'Status', 'STATUS',
        'حالة', 'الحالة', 'حالة الطلب',
        'situation', 'Situation', 'SITUATION',
        'state', 'State', 'STATE'
    ];
    
    let foundStatus = null;
    possibleStatusKeys.forEach(key => {
        if (sampleOrder.hasOwnProperty(key)) {
            const value = sampleOrder[key];
            if (value !== null && value !== undefined && value !== '') {
                foundStatus = { key, value };
                console.log(`✅ وجدت حالة الطلب في "${key}": ${value}`);
            }
        }
    });
    
    if (!foundStatus) {
        console.log('❌ لم أجد أي مفتاح يحتوي على حالة الطلب');
        console.log('📝 المفاتيح المتاحة:', Object.keys(sampleOrder).join(', '));
    }
    
    // البحث عن رقم الهاتف
    console.log('\n🔎 البحث عن رقم الهاتف:');
    const possiblePhoneKeys = [
        'signupPhoneUser', 'userPhone', 'phone', 'Phone',
        'رقم الهاتف', 'هاتف', 'الهاتف',
        'userPhoneNumber', 'phoneNumber'
    ];
    
    possiblePhoneKeys.forEach(key => {
        if (sampleOrder.hasOwnProperty(key)) {
            const value = sampleOrder[key];
            if (value !== null && value !== undefined && value !== '') {
                console.log(`✅ وجدت رقم الهاتف في "${key}": ${value}`);
            }
        }
    });
}
// دالة متقدمة لتطبيع بيانات الطلب
function normalizeOrderData(order) {
    const normalized = { ...order };
    
    // 1. تطبيع حالة الطلب
    const possibleStatusKeys = [
        'orderStatus', 'OrderStatus', 'orderstatus',
        'status', 'Status', 'STATUS',
        'حالة', 'الحالة', 'حالة الطلب',
        'situation', 'Situation', 'SITUATION',
        'state', 'State', 'STATE'
    ];
    
    let orderStatus = 'غير نشط'; // القيمة الافتراضية
    
    for (const key of possibleStatusKeys) {
        if (order[key] !== undefined && order[key] !== null && order[key] !== '') {
            const value = order[key].toString().trim();
            if (value) {
                orderStatus = value;
                console.log(`✅ تطبيع: وجدت حالة الطلب "${value}" في المفتاح "${key}"`);
                break;
            }
        }
    }
    
    normalized.orderStatus = orderStatus;
    normalized.status = orderStatus;
    
    // 2. تطبيع رقم الهاتف
    const possiblePhoneKeys = [
        'signupPhoneUser', 'userPhone', 'phone', 'Phone',
        'رقم الهاتف', 'هاتف', 'الهاتف',
        'userPhoneNumber', 'phoneNumber'
    ];
    
    for (const key of possiblePhoneKeys) {
        if (order[key] !== undefined && order[key] !== null && order[key] !== '') {
            const phone = order[key].toString().trim();
            if (phone) {
                normalized.signupPhoneUser = phone;
                normalized.userPhone = phone;
                break;
            }
        }
    }
    
    // 3. تأكد من وجود جميع الحقول المطلوبة
    if (!normalized.orderNo && normalized.id) {
        normalized.orderNo = `ORD-${normalized.id}`;
    }
    
    if (!normalized.orderDate && normalized.timestamp) {
        normalized.orderDate = normalized.timestamp.split('T')[0];
    }
    
    // 4. تحويل القيم الرقمية
    const numericFields = ['quantity', 'unitPrice', 'totalPrice', 'taxAmount', 'grandTotal'];
    numericFields.forEach(field => {
        if (normalized[field]) {
            const numValue = parseFloat(normalized[field]);
            if (!isNaN(numValue)) {
                normalized[field] = numValue;
            }
        }
    });
    
    return normalized;
}
// دالة إظهار/إخفاء قسم طلباتي حسب حالة الدخول
function updateMyOrdersNavButtonVisibility() {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const myOrdersSectionNav = document.getElementById('myOrdersSectionNav');
    
    console.log('حالة زر طلباتي في الشريط:', {
        isLoggedIn: isLoggedIn,
        elementExists: !!myOrdersSectionNav
    });
    
    if (myOrdersSectionNav) {
        myOrdersSectionNav.style.display = isLoggedIn ? 'flex' : 'none';
        console.log('تم تحديث رؤية زر طلباتي في الشريط:', isLoggedIn ? 'مرئي' : 'مخفي');
    } else {
        console.error('❌ قسم زر طلباتي في الشريط غير موجود!');
    }
}


// ==================== دالة فتح نافذة طلباتي ====================
// دالة واحدة بسيطة للبحث
function filterUserProducts() {
    const searchText = document.getElementById('orderSearchUserPro').value.toLowerCase();
    const statusUserFilter = document.getElementById('statusUserFilter').value;
    
    // إذا كانت المنتجات محفوظة في window.userProducts
    if (!window.userProducts || !Array.isArray(window.userProducts)) {
        console.error('لا توجد بيانات منتجات');
        return;
    }
    
    let filtered = window.userProducts.filter(product => {
        // البحث في النص
        const matchesSearch = !searchText || 
            (product.productName && product.productName.toLowerCase().includes(searchText)) ||
            (product.productNo && product.productNo.toLowerCase().includes(searchText));
        
        // البحث في الحالة
        const matchesStatus = statusUserFilter === 'all' || 
            (product.situation && product.situation.includes(statusUserFilter));
        
        return matchesSearch && matchesStatus;
    });
    
    // عرض النتائج
    displayUserProducts(filtered);
}

async function openMyOrdersModal() {
    console.log('فتح نافذة طلباتي...');
    
    try {
        // التحقق من تسجيل الدخول
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        if (!isLoggedIn || !currentUser.signupPhone) {
            showNotification('يجب تسجيل الدخول لعرض الطلبات', 'error');
            openLoginModal();
            return;
        }
        
        // فتح النافذة
        document.getElementById('myOrdersModal').style.display = 'flex';
        // تحميل المنتجات
        setTimeout(() => {
            initSearchAfterLoad();
            addScrollToTopButtonToModal();
            // فحص وإظهار زر التفعيل
            setTimeout(checkAndShowActivateButton, 1000);
             displayTotalAmountForUnactiveOrders();
        }, 500);

        // إضافة الأنماط
        addScrollToTopStyles();
        
        // تحميل الواجهة
        const results = await Promise.allSettled([
            loadUserProductsFromExcel(),
            loadMyOrdersInterface()
        ]);
        
        // حساب وعرض المبلغ الإجمالي للطلبات غير النشطة
       
        
    } catch (error) {
        console.error('خطأ في فتح نافذة الطلبات:', error);
        showNotification('حدث خطأ أثناء تحميل الطلبات', 'error');
    }
}


// دالة طارئة لإنشاء نافذة إذا لم تكن موجودة
function createEmergencyMyOrdersModal() {
    console.log('🆘 إنشاء نافذة طلباتي طارئة...');
    
    const emergencyModal = document.createElement('div');
    emergencyModal.id = 'emergencyMyOrdersModal';
    emergencyModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    emergencyModal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        ">
            <h2 style="color: #e74c3c; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
                نافذة طلباتي غير موجودة
            </h2>
            <p style="margin-bottom: 20px; color: #666;">
                لم يتم العثور على نافذة طلباتي في الصفحة.
                يرجى تحديث الصفحة أو التواصل مع الدعم الفني.
            </p>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="
                        background: #3498db;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">
                إغلاق
            </button>
        </div>
    `;
    
    document.body.appendChild(emergencyModal);
    console.log('✅ تم إنشاء نافذة طارئة');
}

// دالة إغلاق نافذة طلباتي
function closeMyOrdersModal() {
document.getElementById('myOrdersModal').style.display = 'none';
}

// دالة تحميل طلبات المستخدم
function loadUserOrders() {
    console.log('جاري تحميل طلبات المستخدم...');
    
    // الحصول على المستخدم الحالي
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    
    console.log('هاتف المستخدم:', userPhone);
    
    // عرض رسالة تحميل
    const ordersList = document.getElementById('ordersList');
    if (ordersList) {
        ordersList.innerHTML = `
            <div class="loading-orders">
                <div class="spinner"></div>
                <p>جاري تحميل الطلبات...</p>
            </div>
        `;
    }
    
    // محاكاة البيانات للاختبار
    setTimeout(() => {
        // بيانات تجريبية
         userOrders = [
            {
                id: 1,
                orderNo: 'ORD-' + Date.now().toString().slice(-6),
                orderDate: new Date().toISOString().split('T')[0],
                quantity: 10,
                unitPrice: 0.500,
                totalPrice: 5.000,
                taxAmount: 0.250,
                grandTotal: 5.250,
                expiryDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                orderStatus: 'نشط',
                color: 'أسود',
                description: 'منتجات إلكترونية متنوعة',
                location: 'بغداد',
                region: 'الكرادة',
                address: 'شارع الصناعة'
            },
            {
                id: 2,
                orderNo: 'ORD-' + (Date.now() - 1000000).toString().slice(-6),
                orderDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                quantity: 5,
                unitPrice: 0.500,
                totalPrice: 2.500,
                taxAmount: 0.125,
                grandTotal: 2.625,
                expiryDate: new Date(Date.now() + 173 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                orderStatus: 'غير نشط',
                color: 'أبيض',
                description: 'ملابس وأزياء',
                location: 'أربيل',
                region: 'وسط المدينة',
                address: 'شارع السلام'
            }
        ];
        
        // تحديث الإحصائيات
        updateOrdersStatsDisplay();
        
        // عرض الطلبات
        displayUserOrders();
        
        console.log('تم تحميل', userOrders.length, 'طلب');
        
    }, 1500);
}

// دالة تحديث الإحصائيات المعروضة
function updateOrdersStatsDisplay() {
    const TotalQuantity = userOrders.length;
    const ActiveNo = userOrders.filter(order => order.orderStatus === 'نشط').length;
    const UnActiveNo = userOrders.filter(order => order.orderStatus === 'غير نشط').length;
    const ExpiredNo = userOrders.filter(order => order.orderStatus === 'منتهي').length;
    const DeleteNo = userOrders.filter(order => order.orderStatus === 'ملغي').length;
    const AddNo = userOrders.filter(order => order.orderStatus === 'إضافة').length;
    
    document.getElementById('my-total-orders').textContent = TotalQuantity;
    document.getElementById('my-active-orders').textContent = ActiveNo;
    document.getElementById('my-inactive-orders').textContent = UnActiveNo;
    document.getElementById('my-expired-orders').textContent = ExpiredNo;
    document.getElementById('my-cancelled-orders').textContent = DeleteNo;
    document.getElementById('my-added-orders').textContent = AddNo;
}

// دالة جديدة لتحليل التاريخ بأمان
function parseDateSafely(dateString) {
    if (!dateString) return null;
    
    try {
        // إذا كان التاريخ كائن Date بالفعل
        if (dateString instanceof Date) {
            return isNaN(dateString.getTime()) ? null : dateString;
        }
        
        // إذا كان نصاً، حاول تحليله بطرق مختلفة
        if (typeof dateString === 'string') {
            // 1. محاولة تحليل التاريخ كـ ISO string
            let date = new Date(dateString);
            if (!isNaN(date.getTime())) return date;
            
            // 2. إذا كان التاريخ بصيغة DD/MM/YYYY أو DD-MM-YYYY
            const parts = dateString.split(/[/\-]/);
            if (parts.length === 3) {
                const [day, month, year] = parts;
                
                // تحقق من أن الأجزاء أرقام
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    // تأكد من أن السنة كاملة (4 أرقام)
                    const fullYear = year.length === 2 ? '20' + year : year;
                    date = new Date(fullYear, month - 1, day);
                    if (!isNaN(date.getTime())) return date;
                }
            }
            
            // 3. إذا كان التاريخ بصيغة MM/DD/YYYY (الأمريكية)
            date = new Date(dateString.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
            if (!isNaN(date.getTime())) return date;
            
            // 4. محاولة تحليل التاريخ من Excel serial number
            if (/^\d+(\.\d+)?$/.test(dateString)) {
                const serialNumber = parseFloat(dateString);
                if (!isNaN(serialNumber)) {
                    // تحويل من Excel serial date (حيث 1 = 1 يناير 1900)
                    const excelEpoch = new Date(1899, 11, 30); // 30 ديسمبر 1899
                    date = new Date(excelEpoch.getTime() + (serialNumber * 24 * 60 * 60 * 1000));
                    if (!isNaN(date.getTime())) return date;
                }
            }
        }
        
        // 5. إذا كان رقماً (Excel serial date)
        if (typeof dateString === 'number') {
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + (dateString * 24 * 60 * 60 * 1000));
            if (!isNaN(date.getTime())) return date;
        }
        
        console.warn('⚠️ لا يمكن تحليل التاريخ:', dateString, 'النوع:', typeof dateString);
        return null;
    } catch (error) {
        console.error('❌ خطأ في تحليل التاريخ:', error, 'القيمة:', dateString);
        return null;
    }
}

// دالة عرض طلبات المستخدم
function displayUserOrders() {
    const ordersList = document.getElementById('ordersList');
    
    if (!ordersList) {
        console.error('لم يتم العثور على عنصر ordersList');
        return;
    }
    
    if (!userOrders || userOrders.length === 0) {
        ordersList.innerHTML = `
            <div class="no-orders-message">
                <i class="fas fa-shopping-basket"></i>
                <h3>لا توجد طلبات حالياً</h3>
                <p>قم بإضافة أول طلب باستخدام الزر أعلاه</p>
            </div>
        `;
        return;
    }
    
    let ordersHTML = '';
    
    userOrders.forEach(order => {
        const statusClass = getOrderStatusClass(order.orderStatus);
        const statusText = getOrderStatusText(order.orderStatus);
        
        ordersHTML += `
            <div class="order-card" data-order-id="${order.id}">
                <div class="order-header">
                    <div class="order-number">
                        <i class="fas fa-shopping-cart"></i>
                        ${order.orderNo || 'طلب بدون رقم'}
                    </div>
                    <div class="order-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                
                <div class="order-details">
                    <div class="order-detail-item">
                        <span class="detail-label">تاريخ الطلب</span>
                        <span class="detail-value">${order.orderDate || 'غير محدد'}</span>
                    </div>
                    <div class="order-detail-item">
                        <span class="detail-label">العدد</span>
                        <span class="detail-value">${order.quantity || 0}</span>
                    </div>
                    <div class="order-detail-item">
                        <span class="detail-label">السعر الإجمالي</span>
                        <span class="detail-value">${parseFloat(order.grandTotal || 0).toFixed(3)} ريال</span>
                    </div>
                    <div class="order-detail-item">
                        <span class="detail-label">تاريخ الانتهاء</span>
                        <span class="detail-value">${order.expiryDate || 'غير محدد'}</span>
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="btn-edit-order" onclick="editOrder(${order.id})">
                        <i class="fas fa-edit"></i>
                        تعديل الطلب
                    </button>
                    <button class="btn-share-order" onclick="shareOrder(${order.id})">
                        <i class="fas fa-share-alt"></i>
                        مشاركة الطلب
                    </button>
                </div>
            </div>
        `;
    });
    
    ordersList.innerHTML = ordersHTML;
    console.log('تم عرض', userOrders.length, 'طلب');
}

// دالة الحصول على كلاس الحالة
function getOrderStatusClass(status) {
    switch(status) {
        case 'نشط': return 'status-active';
        case 'غير نشط': return 'status-inactive';
        case 'منتهي': return 'status-expired';
        case 'ملغي': return 'status-cancelled';
         case 'إضافة': return 'status-added';
        default: return 'status-inactive';
    }
}
// دالة الحصول على نص الحالة
function getOrderStatusText(status) {
    return status || 'غير نشط';
}
// دالة حفظ تعديل الطلب
async function saveOrderEdit() {
    try {
        const orderId = document.getElementById('edit-order-id').value;
        
        const updatedData = {
            id: orderId,
            unitPrice: document.getElementById('edit-order-price').value,
            color: document.getElementById('edit-order-color').value,
            description: document.getElementById('edit-order-description').value,
            quantity: document.getElementById('edit-order-quantity').value,
            orderStatus: document.getElementById('edit-order-status').value,
            location: document.getElementById('edit-order-location').value,
            region: document.getElementById('edit-order-region').value,
            address: document.getElementById('edit-order-address').value,
            // إعادة حساب القيم بناءً على التغييرات
            totalPrice: (parseFloat(document.getElementById('edit-order-price').value) * 
                       parseInt(document.getElementById('edit-order-quantity').value)).toFixed(3),
            taxAmount: (parseFloat(document.getElementById('edit-order-price').value) * 
                       parseInt(document.getElementById('edit-order-quantity').value) * 0.05).toFixed(3),
            grandTotal: (parseFloat(document.getElementById('edit-order-price').value) * 
                        parseInt(document.getElementById('edit-order-quantity').value) * 1.05).toFixed(3)
        };
        
        // هنا سيتم إرسال البيانات إلى Google Sheets
        const result = await updateOrderInGoogleSheets(updatedData);
        
        if (result.success) {
            showNotification('تم تحديث الطلب بنجاح');
            closeOrderEditModal();
            loadUserOrders(); // إعادة تحميل الطلبات
        } else {
            throw new Error(result.message || 'فشل في تحديث الطلب');
        }
        
    } catch (error) {
        console.error('خطأ في حفظ التعديلات:', error);
        showNotification('حدث خطأ أثناء حفظ التعديلات', 'error');
    }
}

// دالة مشاركة الطلب
function shareOrder(orderId) {
    const order = userOrders.find(o => o.id == orderId);
    
    if (!order) {
        showNotification('الطلب غير موجود', 'error');
        return;
    }
    
    currentEditingOrder = order;
    
    // تحديث معلومات المشاركة
    document.getElementById('share-order-number').textContent = order.orderNo || 'طلب بدون رقم';
    
    // إنشاء رابط المشاركة
    const orderLink = generateOrderShareLink(order);
    document.getElementById('share-order-link').value = orderLink;
    
    // عرض نافذة المشاركة
    document.getElementById('shareOrderModal').style.display = 'flex';
}

// دالة إنشاء رابط مشاركة الطلب
function generateOrderShareLink(order) {
    const baseUrl = window.location.origin + window.location.pathname;
    const orderData = encodeURIComponent(JSON.stringify({
        orderNo: order.orderNo,
        quantity: order.quantity,
        price: order.grandTotal,
        status: order.orderStatus
    }));
    
    return `${baseUrl}?order=${orderData}`;
}

// دالة نسخ رابط الطلب
function copyOrderLink() {
    const linkInput = document.getElementById('share-order-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(linkInput.value).then(() => {
        showNotification('تم نسخ رابط الطلب إلى الحافظة');
    }).catch(err => {
        // Fallback for older browsers
        document.execCommand('copy');
        showNotification('تم نسخ رابط الطلب إلى الحافظة');
    });
}

// دالة مشاركة عبر واتساب
function shareViaWhatsApp() {
    const order = currentEditingOrder;
    if (!order) return;
    
    const message = `طلب منتج جديد\n` +
                   `رقم الطلب: ${order.orderNo}\n` +
                   `العدد: ${order.quantity}\n` +
                   `السعر: ${order.grandTotal} ريال\n` +
                   `الحالة: ${order.orderStatus}\n` +
                   `رابط الطلب: ${generateOrderShareLink(order)}`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// دالة مشاركة عبر تليجرام
function shareViaTelegram() {
    const order = currentEditingOrder;
    if (!order) return;
    
    const message = `طلب منتج جديد%0A` +
                   `رقم الطلب: ${order.orderNo}%0A` +
                   `العدد: ${order.quantity}%0A` +
                   `السعر: ${order.grandTotal} ريال%0A` +
                   `الحالة: ${order.orderStatus}%0A` +
                   `رابط الطلب: ${generateOrderShareLink(order)}`;
    
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(generateOrderShareLink(order))}&text=${message}`;
    window.open(telegramUrl, '_blank');
}

// دالة مشاركة عبر فيسبوك
function shareViaFacebook() {
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(generateOrderShareLink(currentEditingOrder))}`;
    window.open(facebookUrl, '_blank');
}

// دالة إغلاق نافذة التعديل
function closeOrderEditModal() {
    document.getElementById('orderEditModal').style.display = 'none';
    currentEditingOrder = null;
}

// دالة إغلاق نافذة المشاركة
function closeShareOrderModal() {
    document.getElementById('shareOrderModal').style.display = 'none';
    currentEditingOrder = null;
}

// دالة إضافة طلب جديد
function addNewOrder() {
    // فتح نافذة إدارة الطلبات لإضافة طلب جديد
    closeMyOrdersModal();
    openOrderManagementModal();
}


// إضافة event listeners عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
     
    // زر طلباتي في الشريط العلوي
  const myOrdersBtn = document.getElementById('myOrdersBtn');
    if (myOrdersBtn) {
        myOrdersBtn.addEventListener('click', openMyOrdersModal);
        console.log('✅ تم ربط زر طلباتي');
    } else {
        console.error('❌ زر طلباتي (myOrdersBtn) غير موجود في الصفحة!');
        console.log('⏳ جاري محاولة إنشائه...');
        createMyOrdersButton();
    }
    
    // 2. زر إدارة الطلبات - التحقق والربط
    const manageOrdersBtnNav = document.getElementById('manageOrdersBtnNav');
    if (manageOrdersBtnNav) {
        manageOrdersBtnNav.addEventListener('click', openOrderManagementModal);
        console.log('✅ تم ربط زر إدارة الطلبات في الشريط');
    } else {
        console.warn('⚠️ زر إدارة الطلبات (manageOrdersBtnNav) غير موجود');
    }

// إضافة مستمعات أحداث لأزرار الإغلاق في نافذة طلباتي
 const closeMyOrdersBtn = document.getElementById('closeMyOrders');
    if (closeMyOrdersBtn) {
        closeMyOrdersBtn.addEventListener('click', closeMyOrdersModal);
        console.log('✅ تم ربط زر الإغلاق السفلي');
    }
    
    // زر الإغلاق في الهيدر (X)
    const closeMyOrders = document.getElementById('closeMyOrders');
    if (closeMyOrders) {
        closeMyOrders.addEventListener('click', closeMyOrdersModal);
        console.log('✅ تم ربط زر الإغلاق في الهيدر');
    }

   setupMyOrdersNavButton();
    setupManageOrdersNavButton();
// إضافة مستمع حدث لزر إضافة طلب جديد داخل نافذة طلباتي
const addNewOrderBtn = document.getElementById('addNewOrderBtn');
if (addNewOrderBtn) {
    addNewOrderBtn.addEventListener('click', function() {
        closeMyOrdersModal();
        openOrderManagementModal();
    });
}
    
    // إغلاق النوافذ عند النقر خارجها
    document.getElementById('myOrdersModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeMyOrdersModal();
        }
    });
    
    document.getElementById('orderEditModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeOrderEditModal();
        }
    });
    
    document.getElementById('shareOrderModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeShareOrderModal();
        }
    });
    
    // تحديث رؤية زر طلباتي عند تحميل الصفحة
    updateMyOrdersButtonVisibility();
});

// في بداية الـ script مع المتغيرات العامة
let manageOrdersBtnNav;

// دالة لإظهار/إخفاء زر إدارة الطلبات حسب حالة المستخدم
function updateManageOrdersButtonVisibility() {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const isAdmin = currentUser.userstate === 'Admin'; // المسؤول فقط يمكنه إدارة الطلبات
    
    const ordersManagementSection = document.getElementById('ordersManagementSection');
    
    console.log('حالة المستخدم:', {
        isLoggedIn: isLoggedIn,
        userstate: currentUser.userstate,
        isAdmin: isAdmin
    });
    
    if (ordersManagementSection) {
        ordersManagementSection.style.display = (isLoggedIn && isAdmin) ? 'flex' : 'none';
        console.log('تم تحديث رؤية زر إدارة الطلبات:', (isLoggedIn && isAdmin) ? 'مرئي' : 'مخفي');
    }
}

// دالة لفتح نافذة إدارة الطلبات من الزر الجديد
function openOrderManagementFromNav() {
    console.log('فتح نافذة إدارة الطلبات من شريط التنقل...');
    openOrderManagementModal();
}
function setupMyOrdersNavButton() {
    const myOrdersBtnNav = document.getElementById('myOrdersBtnNav');
    
    if (myOrdersBtnNav) {
        // إزالة أي مستمعين سابقين
        const newBtn = myOrdersBtnNav.cloneNode(true);
        myOrdersBtnNav.parentNode.replaceChild(newBtn, myOrdersBtnNav);
        
        // إعادة الحصول على العنصر الجديد
        const freshBtn = document.getElementById('myOrdersBtnNav');
        
        freshBtn.addEventListener('click', function() {
            console.log('🎯 النقر على زر طلباتي في الشريط العلوي');
            openMyOrdersModal();
             document.getElementById('addSendtBtn').style.display = 'none';
             document.getElementById('addSendtBtnLable').style.display = 'none';
        });
        
        console.log('✅ تم ربط زر طلباتي في الشريط العلوي');
    } else {
        console.error('❌ زر طلباتي في الشريط غير موجود!');
    }
}
// دالة لإعداد زر إدارة الطلبات في الشريط
function setupManageOrdersNavButton() {
    const manageOrdersBtnNav = document.getElementById('manageOrdersBtnNav');
    
    if (manageOrdersBtnNav) {
        // إزالة أي مستمعين سابقين
        const newBtn = manageOrdersBtnNav.cloneNode(true);
        manageOrdersBtnNav.parentNode.replaceChild(newBtn, manageOrdersBtnNav);
        
        // إعادة الحصول على العنصر الجديد
        const freshBtn = document.getElementById('manageOrdersBtnNav');
        
        freshBtn.addEventListener('click', function() {
            console.log('🎯 النقر على زر إدارة الطلبات في الشريط');
            openOrderManagementModal();
        });
        
        console.log('✅ تم ربط زر إدارة الطلبات في الشريط');
    }
}

const PRODUCTSUSER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIP1tVlPSMtvOfPK0G5bROBFB58REwPFJ6rDAT8-GM1Jr8aCb_bo46a3GpOMcr8SIk/exec';

// دالة تحميل المنتجات الخاصة بالمستخدم
async function loadUserProductsFromExcel() {
    try {
        console.log('🚀 بدء تحميل منتجات المستخدم...');
        
   
            // محاولة استخدام اسم بديل
            if (typeof PRODUCTSU_SCRIPT_URL !== 'undefined') {
                console.log('⚠️ استخدام PRODUCTSUSER_SCRIPT_URL بدلاً من ذلك');
                var scriptUrl = PRODUCTSUSER_SCRIPT_URL;
            } else {
                // تعريف افتراضي
                console.log('⚠️ استخدام رابط افتراضي');
                var scriptUrl = 'https://script.google.com/macros/s/AKfycbyIP1tVlPSMtvOfPK0G5bROBFB58REwPFJ6rDAT8-GM1Jr8aCb_bo46a3GpOMcr8SIk/exec';
            }
       
        
        // التحقق من صحة الرابط
        if (!scriptUrl || scriptUrl.includes('YOUR_DEPLOYED_WEB_APP_ID')) {
            console.error('❌ رابط الخادم غير مضبوط:', scriptUrl);
            showNotification('❌ رابط الخادم غير مضبوط. الرجاء الاتصال بالدعم لتحديث الرابط.', 'error');
            return [];
        }
        
        console.log('✅ استخدام رابط الخادم:', scriptUrl);
        
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            console.warn('⚠️ يجب تسجيل الدخول أولاً');
            showNotification('يجب تسجيل الدخول لعرض منتجاتك', 'warning');
            return [];
        }
        
        console.log('📱 هاتف المستخدم:', userPhone);
        
        // ============================================
        // 3. اختبار الاتصال بالخادم
        // ============================================
        
        const testUrl = `${scriptUrl}?action=getSheetInfo&t=${Date.now()}`;
        console.log('🔗 اختبار الاتصال:', testUrl);
        
       showLoading(true, `جاري تحميل المنتجات`);
        
        let testData;
        try {
            const testResponse = await fetch(testUrl);
            if (!testResponse.ok) {
                throw new Error(`فشل الاتصال: ${testResponse.status}`);
            }
            testData = await testResponse.json();
            console.log('✅ معلومات الـ Sheet:', testData);
            
            if (!testData.success) {
                throw new Error(testData.message || 'فشل في جلب معلومات الـ Sheet');
            }
            
            
        } catch (testError) {
            console.error('❌ فشل اختبار الاتصال:', testError);
            showLoading(false);
            showNotification('❌ تعذر الاتصال بـ Google Sheets. تأكد من نشر الـ Script بشكل صحيح.', 'error');
            return [];
        }
        
        // ============================================
        // 4. جلب بيانات المنتجات
        // ============================================
        
      
        
        const url = `${scriptUrl}?action=getUserProducts&phone=${encodeURIComponent(userPhone)}&t=${Date.now()}`;
        console.log('📡 رابط جلب المنتجات:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            redirect: 'follow',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`خطأ في الاستجابة: ${response.status} ${response.statusText}`);
        }
        
        const textResponse = await response.text();
        console.log('📦 استجابة الخادم:', textResponse.substring(0, 500));
        
        let data;
        try {
            data = JSON.parse(textResponse);
        } catch (parseError) {
            console.error('❌ خطأ في تحويل JSON:', parseError);
            console.error('📝 النص الذي فشل في التحويل:', textResponse);
            throw new Error('تنسيق الاستجابة غير صالح');
        }
        
        console.log('📊 بيانات المنتجات المستلمة:', data);
        
        let products = [];
        
        if (data.success === true) {
            products = Array.isArray(data.products) ? data.products : [];
            console.log(`✅ تم تحميل ${products.length} منتج`);
            
            if (products.length === 0) {
                showNotification(`❗ لم يتم العثور على منتجات للهاتف ${userPhone}`, 'info');
                console.log('🔍 تفاصيل البحث:', {
                    userPhone: userPhone,
                    normalizedPhone: data.normalizedUserPhone,
                    totalRows: data.totalRows,
                    headers: data.headers
                });
            } else {
                showNotification(`✅ تم العثور على ${products.length} منتج`, 'success');
                showLoading(false);
            }
        } else {
            console.warn('⚠️ لم تنجح العملية:', data.message);
            showNotification(`⚠️ ${data.message || 'حدث خطأ في جلب البيانات'}`, 'warning');
            
            // استخدام بيانات تجريبية للاختبار
            products = getTestProducts();
            console.log('📝 استخدام بيانات تجريبية:', products.length, 'منتج');
        }
        
        // ============================================
        // 5. معالجة وعرض البيانات
        // ============================================
        
        // معالجة البيانات
        const processedProducts = processGoogleSheetsData(products);
        
        // ترتيب حسب التاريخ (الأحدث أولاً)
        processedProducts.sort((a, b) => {
            const dateA = new Date(a.timestamp || 0);
            const dateB = new Date(b.timestamp || 0);
            return dateB.getTime() - dateA.getTime();
        });
        
        // حفظ في المتغير العام
        window.userProducts = processedProducts;
        checkAndShowActivateButton();
         // تهيئة البحث بعد تحميل البيانات
        setTimeout(() => {
            if (document.getElementById('orderSearchUserPro')) {
                initSearchAfterLoad();
            }
        }, 1500);
        // حفظ في localStorage للاستخدام لاحقاً
        localStorage.setItem('userProducts', JSON.stringify(processedProducts));
        
        // عرض المنتجات
       
        displayUserProducts(processedProducts);
        
        // تسجيل الإحصائيات
        console.log('📈 إحصائيات:', {
            totalProducts: processedProducts.length,
            firstProduct: processedProducts.length > 0 ? processedProducts[0].productName : 'لا يوجد',
            lastUpdate: new Date().toLocaleString('ar-IQ'),
            scriptUrl: scriptUrl
        });
        
        return processedProducts;
        
    } catch (error) {
        console.error('❌ خطأ في تحميل المنتجات:', error);
        showLoading(false);
        showNotification(`❌ تعذر تحميل المنتجات: ${error.message}`, 'error');
        return [];
    }
}


// دالة معالجة بيانات المنتجات
// دالة معالجة بيانات المنتجات من Google Sheets
function processGoogleSheetsData(sheetsData) {
    if (!Array.isArray(sheetsData)) {
        console.warn('⚠️ sheetsData ليس مصفوفة:', sheetsData);
        return [];
    }
    
    console.log(`🔧 معالجة ${sheetsData.length} منتج من Google Sheets`);
    
    return sheetsData.map((row, index) => {
        try {
            // جمع الصور من image1, image2, image3
            let images = [];
            
            // البحث عن حقول الصور بأسماء مختلفة
            const imageFields = ['image1', 'image2', 'image3', 'Image1', 'Image2', 'Image3', 'صورة1', 'صورة2', 'صورة3'];
            
            imageFields.forEach(field => {
                if (row[field] && typeof row[field] === 'string' && row[field].trim().startsWith('http')) {
                    images.push(row[field].trim());
                }
            });
            
            // إذا لم توجد صور، استخدم صورة افتراضية
            if (images.length === 0) {
                images = ['https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'];
            }
            
            // البحث عن حقول الهاتف بأسماء مختلفة
            let phoneValue = '';
            const phoneFields = ['custel', 'phone', 'Phone', 'PHONE', 'هاتف', 'الهاتف', 'تلفون'];
            
            phoneFields.forEach(field => {
                if (row[field] && !phoneValue) {
                    phoneValue = row[field].toString().trim();
                }
            });
            
            // إنشاء كائن المنتج
            const product = {
                // المعرف والاسم
                id: index,
                productNo: row.productNo || row.ProductNo || `PROD-${index + 1000}`,
                productName: row.productName || row.ProductName || 'منتج بدون اسم',
                
                // الهاتف
                custel: phoneValue,
                productPhone: phoneValue,
                
                // السعر
                productPrice: row.productPrice || row.ProductPrice || row.Price || '0',
                
                // الموقع
                state: row.state || row.State || '',
                productLocationState: row.state || row.State || '',
                productLocationName: row.productLocationName || row.ProductLocationName || '',
                locationLink: row.locationLink || row.LocationLink || '',
                
                // التفاصيل
                productCategory: row.productCategory || row.ProductCategory || row.Category || '',
                productQuantity: row.productQuantity || row.ProductQuantity || row.Quantity || '1',
                productDescription: row.productDescription || row.ProductDescription || row.Description || 'لا يوجد وصف',
                productColor: row.productColor || row.ProductColor || row.Color || '',
                productWarranty: row.productWarranty || row.ProductWarranty || row.Warranty || 'لا يوجد',
                
                // الحالة
                situation: row.situation || row.Situation || 'Active',
                productSituation: row.situation || row.Situation || 'Active',
                productState: row.productState || row.ProductState || row.State || 'جديد',
                productCondition: row.productState || row.ProductState || row.State || 'جديد',
                
                // تاريخ الانتهاء
                productExpiredDate: row.productExpiredDate || row.ProductExpiredDate || row.ExpiredDate || '',
                
                // الصور
                images: images.slice(0, 3), // أخذ أول 3 صور فقط
                
                // التاريخ
                timestamp: row.Timestamp || row.timestamp || new Date().toISOString(),
                
                // البيانات الأصلية للرجوع إليها
                rawData: row
            };
            
            // تسجيل للمراقبة
            if (index === 0) {
                console.log('🔍 منتج معالج نموذجي:', {
                    name: product.productName,
                    phone: product.productPhone,
                    price: product.productPrice,
                    state: product.state,
                    imagesCount: product.images.length
                });
            }
            
            return product;
            
        } catch (error) {
            console.error(`❌ خطأ في معالجة المنتج ${index}:`, error);
            console.error('📝 بيانات الصف:', row);
            return null;
        }
    }).filter(product => product !== null); // إزالة المنتجات الفاشلة
}


// دالة تنسيق التاريخ لحقل الإدخال
function formatDateForInputFromDate(date) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        console.warn('⚠️ تاريخ غير صالح:', date);
        return '';
    }
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}
// دالة تنسيق السعر
function formatProductPrice(price) {
    if (!price) return '0 ريال';
    
    try {
        // تحويل السعر إلى رقم
        let num = parseFloat(price.toString().replace(/[^0-9.]/g, ''));
        
        if (isNaN(num)) {
            return price + ' ريال';
        }
        
        // تنسيق الرقم
        return num.toLocaleString('ar-IQ') + ' ريال';
        
    } catch (error) {
        return price + ' ريال';
    }
}
// دالة عرض المنتجات الخاصة بالمستخدم
// دالة عرض المنتجات الخاصة بالمستخدم
function displayUserProducts(products) {
    const container = document.getElementById('userProductsContainer');
    
    if (!container) {
        console.error('❌ حاوية المنتجات غير موجودة');
        return;
    }
    
    if (!products || !Array.isArray(products) || products.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <i class="fas fa-box-open" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                <h3 style="color: #666; margin-bottom: 10px;">لا توجد منتجات</h3>
                <p style="color: #999; margin-bottom: 20px;">لم يتم العثور على منتجات مرتبطة بحسابك</p>
                <button onclick="openAddProductModal()" style="
                    background: #3498db;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                ">
                    <i class="fas fa-plus"></i> إضافة منتج جديد
                </button>
            </div>
        `;
        return;
    }
    
    // عرض عدد المنتجات
    let html = `
        <div style="margin-bottom: 20px; color: #666; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <i class="fas fa-box" style="margin-left: 8px;"></i>
            عدد المنتجات: <strong>${products.length}</strong>
        </div>
        <div style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        ">
    `;
    
    products.forEach((product, index) => {
        // 🔥 **تصحيح التواريخ - سجل أول 3 منتجات للتصحيح**
        if (index < 3) {
            logDateDebug(product, product.productNo);
        }
        
        // 🔥 **استخدام الدالة الجديدة لتحليل التواريخ بأمان**
        const addDate = product.timestamp ? 
            formatDateToDMY(parseDateSafely(product.timestamp)) : 
            'غير محدد';
        
        const expiryDate = product.productExpiredDate ? 
            formatDateToDMY(parseDateSafely(product.productExpiredDate)) : 
            'غير محدد';
        
        // 🔥 **التحقق من انتهاء الصلاحية**
        const expiryDateObj = parseDateSafely(product.productExpiredDate);
        const isExpired = expiryDateObj ? checkIfExpired(expiryDateObj) : false;
        
        const price = formatProductPrice(product.productPrice);
        
        // 🔥 **إنشاء رسالة التحذير إذا انتهى**
        const expiryWarning = isExpired ? 
            `<span style="
                color: #dc3545;
                background: #f8d7da;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 16px;
                margin-right: 8px;
                display: inline-flex;
                align-items: center;
                gap: 4px;
                animation: pulse 1.5s infinite;
            ">
                <i class="fas fa-exclamation-triangle" style="font-size: 10px;"></i>
                انتهى
            </span>` : '';
        
        // الحصول على معلومات الحالة
        const statusInfo = getProductStatusInfo(product.situation);
        const statusMessage = getStatusMessage(product.situation);
        const statusBgColor = getStatusBackgroundColor(statusInfo.text);
        
        html += `
            <div class="myorders-product-card" 
                 id="myorders-product-card-${index}"
                 data-product-index="${index}"
                 style="
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                    transition: transform 0.3s;
                    border-left: 4px solid ${statusInfo.color};
                 ">
                
                <!-- رأس المنتج مع الحالة -->
                <div style="
                    background: #f8f9fa;
                    padding: 10px 15px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div style="font-weight: bold; color: #2c3e50; display: flex; align-items: center;">
                        <i class="fas fa-hashtag" style="margin-left: 5px;"></i>
                        ${product.productNo}
                    </div>
                    <div style="
                        background: ${statusInfo.color};
                        color: white;
                        padding: 3px 10px;
                        border-radius: 15px;
                        font-size: 12px;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                    ">
                        <i class="fas ${statusInfo.icon}"></i>
                        <span>${statusInfo.text}</span>
                    </div>
                </div>
                
                <!-- صورة المنتج الرئيسية -->
                <div class="myorders-product-main-image" style="
                    height: 180px;
                    overflow: hidden;
                    position: relative;
                    background: #f8f9fa;
                ">
                    <img class="myorders-main-product-image"
                         id="myorders-main-image-${index}"
                         src="${product.images && product.images[0] ? product.images[0] : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'}" 
                         alt="${product.productName}"
                         data-product-index="${index}"
                         style="
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            transition: opacity 0.3s ease;
                         "
                         onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'">
                </div>
                
                <!-- الصور المصغرة -->
                ${generateProductThumbnails(product, index)}
                
                <!-- معلومات المنتج -->
                <div style="padding: 15px;">
                    <!-- الاسم والسعر -->
                    <h3 style="margin: 0 0 10px; color: #2c3e50; font-size: 18px;">
                        ${product.productName}
                    </h3>
                    <div style="color: #e74c3c; font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                        ${price}
                    </div>
                    
                    <!-- تفاصيل المنتج -->
                    <div style="
                        background: ${statusBgColor};
                        padding: 10px;
                        border-radius: 5px;
                        margin-bottom: 15px;
                        border: 1px solid ${statusInfo.color}30;
                    ">
                        <div style="margin-bottom: 5px; color: #666; display: flex; align-items: center;">
                            <i class="fas fa-phone" style="margin-left: 8px; color: #3498db; width: 20px;"></i>
                            <span>${product.productPhone || product.custel || 'غير محدد'}</span>
                        </div>
                        <div style="margin-bottom: 5px; color: #666; display: flex; align-items: center;">
                            <i class="fas fa-map-marker-alt" style="margin-left: 8px; color: #e74c3c; width: 20px;"></i>
                            <span>${product.state || product.productLocationState || 'غير محدد'}</span>
                        </div>
                        
                        <!-- التواريخ -->
                        <div style="margin-bottom: 5px; color: #666; display: flex; align-items: center;">
                            <i class="fas fa-calendar-plus" style="margin-left: 8px; color: #2ecc71; width: 20px;"></i>
                            <span style="flex: 1;">الإضافة: ${addDate}</span>
                        </div>
                        <div style="color: #666; display: flex; align-items: center;">
                            <i class="fas fa-calendar-times" style="
                                margin-left: 8px; 
                                color: ${isExpired ? '#dc3545' : '#e74c3c'}; 
                                width: 20px;
                            "></i>
                            <div style="flex: 1; display: flex; align-items: center; justify-content: space-between;">
                                <span>الانتهاء: ${expiryDate}</span>
                                ${expiryWarning}
                            </div>
                        </div>
                    </div>
                    
                    <!-- رسالة الحالة -->
                    <div style="margin-bottom: 15px; text-align: center;">
                        ${statusMessage}
                    </div>
                    
                    <!-- أزرار الإجراءات -->
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openStandaloneEditModal('${product.productNo}')" style="
                            flex: 1;
                            background: #3498db;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 5px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-edit"></i>
                        </button>
                        
                        <button onclick="handleDeleteProduct('${product.productNo}', this, '${product.situation}')" style="
                            flex: 1;
                            background: #e74c3c;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 5px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    container.innerHTML = html;
    
    // إضافة مستمعي الأحداث
    setTimeout(() => {
        attachMyOrdersThumbnailEvents();
          initProductThumbnails();
    attachThumbnailEvents();
   initImageZoom();
   checkAndShowActivateButton();
    }, 100);
    setTimeout(() => {
        const searchInput = document.getElementById('orderSearchUserPro');
        const statusSelect = document.getElementById('statusUserFilter');
        
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') filterUserProducts();
            });
        }
        
        if (statusSelect) {
            statusSelect.addEventListener('change', filterUserProducts);
        }
    }, 500);

    console.log('✅ تم عرض منتجات نافذة طلباتي:', products.length);
}
 
// 🔥 **دالة تحويل التاريخ إلى يوم/شهر/سنة**
function formatDateForInput(dateDMY) {
    if (!dateDMY) return '';
    
    try {
        // إذا كان تاريخاً من JavaScript Date
        if (dateDMY instanceof Date) {
            const year = dateDMY.getFullYear();
            const month = String(dateDMY.getMonth() + 1).padStart(2, '0');
            const day = String(dateDMY.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // إذا كان نصاً بصيغة DD/MM/YYYY
        if (typeof dateDMY === 'string') {
            // تحقق من صيغة DD/MM/YYYY
            const parts = dateDMY.split('/');
            if (parts.length === 3) {
                const [day, month, year] = parts;
                // تحقق من صحة الأرقام
                if (day && month && year && 
                    !isNaN(parseInt(day)) && 
                    !isNaN(parseInt(month)) && 
                    !isNaN(parseInt(year))) {
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            }
            
            // محاولة تحليل أي صيغة تاريخ أخرى
            const date = new Date(dateDMY);
            if (!isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
        }
        
        console.warn('⚠️ لا يمكن تحويل التاريخ:', dateDMY);
        return '';
        
    } catch (error) {
        console.error('❌ خطأ في تحويل التاريخ:', error);
        return '';
    }
}
/**
 * تحديث بادج حالة المنتج
 */
function updateProductStatusBadge(newStatus) {
    // تحديث البادج في قسم المعلومات الإضافية
    const situationBadge = document.querySelector('.product-info-badge:has(i.fa-circle)');
    if (situationBadge) {
        situationBadge.innerHTML = `<i class="fas fa-circle"></i> الحالة: ${newStatus}`;
        situationBadge.style.background = '#d4edda';
        situationBadge.style.borderColor = '#c3e6cb';
        situationBadge.style.color = '#155724';
    }
    
    // تحديث نص الحالة في مكان آخر إذا كان موجوداً
    const situationSpans = document.querySelectorAll('span:contains("الحالة:")');
    situationSpans.forEach(span => {
        if (span.textContent.includes('الحالة:')) {
            span.textContent = `الحالة: ${newStatus}`;
        }
    });
}
/**
 * دالة إضافية للتأكد من صحة التاريخ قبل الحفظ
 */
function validateDatesBeforeSave() {
    const timestampField = document.getElementById('standaloneTimestamp');
    const expiryField = document.getElementById('standaloneProductExpiredDate');
    
    if (!timestampField || !expiryField) return true;
    
    const addDate = new Date(timestampField.value);
    const expiryDate = new Date(expiryField.value);
    
    if (isNaN(addDate.getTime()) || isNaN(expiryDate.getTime())) {
        return false;
    }
    
    // التحقق أن تاريخ الانتهاء بعد تاريخ الإضافة
    return expiryDate > addDate;
}
/**
 * تنسيق التاريخ إلى يوم-شهر-سنة
 */
function formatDateToDMY(dateInput) {
    try {
        let date;
        
        if (typeof dateInput === 'string') {
            // تحليل التاريخ من النص
            date = new Date(dateInput);
            
            // إذا فشل التحليل، حاول تحليل صيغة DD/MM/YYYY
            if (isNaN(date.getTime())) {
                const parts = dateInput.split(/[/\-.]/);
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
        } else if (dateInput instanceof Date) {
            date = dateInput;
        } else {
            date = new Date();
        }
        
        // التحقق من صحة التاريخ
        if (isNaN(date.getTime())) {
            console.warn('⚠️ تاريخ غير صالح، استخدام تاريخ اليوم:', dateInput);
            date = new Date();
        }
        
        // تنسيق إلى DD/MM/YYYY
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
        
    } catch (error) {
        console.error('❌ خطأ في تنسيق التاريخ:', error);
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        return `${day}/${month}/${year}`;
    }
}
// 🔥 **دالة التحقق من انتهاء الصلاحية**
function checkIfExpired(expiryDate) {
    if (!expiryDate) return false;
    
    try {
        // إذا كان expiryDate كائن Date
        let dateObj;
        if (expiryDate instanceof Date) {
            dateObj = expiryDate;
        } else {
            dateObj = parseDateSafely(expiryDate);
        }
        
        if (!dateObj || isNaN(dateObj.getTime())) return false;
        
        const today = new Date();
        
        // إزالة الوقت للمقارنة الصحيحة
        dateObj.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        return dateObj < today;
        
    } catch (error) {
        console.error('❌ خطأ في التحقق من الصلاحية:', error);
        return false;
    }
}

// دالة لتصحيح التواريخ
function logDateDebug(product, productNo) {
    console.log(`🔍 تصحيح تواريخ المنتج ${productNo || product.productNo}:`);
    console.log('  - timestamp:', product.timestamp, 'Type:', typeof product.timestamp);
    console.log('  - productExpiredDate:', product.productExpiredDate, 'Type:', typeof product.productExpiredDate);
    console.log('  - parsed timestamp:', parseDateSafely(product.timestamp));
    console.log('  - parsed expiry:', parseDateSafely(product.productExpiredDate));
    
    // سجل التاريخ الأصلي من البيانات الخام إذا كان موجوداً
    if (product.rawData) {
        console.log('  - raw timestamp:', product.rawData.timestamp || product.rawData.Timestamp);
        console.log('  - raw expiry:', product.rawData.productExpiredDate || product.rawData.ExpiredDate);
        
        // سجل جميع حقول التاريخ الموجودة
        const dateFields = Object.keys(product.rawData).filter(key => 
            key.toLowerCase().includes('date') || 
            key.toLowerCase().includes('time') ||
            key.toLowerCase().includes('timestamp')
        );
        
        if (dateFields.length > 0) {
            console.log('  - جميع حقول التاريخ:', dateFields);
            dateFields.forEach(field => {
                console.log(`    - ${field}:`, product.rawData[field]);
            });
        }
    }
}
// 🔥 **دالة جديدة: التبديل بين الصور (تعمل مباشرة)**
function switchMyOrdersMainImage(productIndex, imageIndex, imageSrc) {
    console.log(`🖼️ [طلباتي] تبديل صورة المنتج ${productIndex} إلى الصورة ${imageIndex}`);
    
    // تحديث الصورة الرئيسية في نافذة طلباتي فقط
    const mainImage = document.getElementById(`myorders-main-image-${productIndex}`);
    if (mainImage) {
        // تأثير انتقال سلس
        mainImage.style.opacity = '0.3';
        setTimeout(() => {
            mainImage.src = imageSrc;
            setTimeout(() => {
                mainImage.style.opacity = '1';
                
                // تأثير إضافي
                mainImage.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    mainImage.style.transform = 'scale(1)';
                }, 300);
            }, 200);
        }, 200);
    }
    
    // تحديث حالة الصور المصغرة في نافذة طلباتي فقط
    const thumbnails = document.querySelectorAll(`#myorders-thumbnails-container-${productIndex} .myorders-product-thumbnail`);
    thumbnails.forEach((thumb, index) => {
        if (index === imageIndex) {
            thumb.style.borderColor = '#3498db';
            thumb.classList.add('active');
            
            // تأثير على الصورة النشطة
            thumb.style.transform = 'scale(0.95)';
            thumb.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.4)';
            
            setTimeout(() => {
                thumb.style.transform = 'scale(1)';
                thumb.style.boxShadow = '0 0 0 3px rgba(52, 152, 219, 0.2)';
            }, 300);
        } else {
            thumb.style.borderColor = '#ddd';
            thumb.classList.remove('active');
            thumb.style.transform = 'scale(1)';
            thumb.style.boxShadow = 'none';
        }
    });
    
    // حفظ الحالة في ذاكرة المتصفح
    if (window.userProducts && window.userProducts[productIndex]) {
        window.userProducts[productIndex].currentImageIndex = imageIndex;
    }
}


// 🔥 **دالة معالجة النقر على الصور المصغرة في طلباتي**
function handleMyOrdersThumbnailClick(event) {
    event.stopPropagation();
    event.preventDefault();
    
    const thumbnail = event.currentTarget;
    const productIndex = thumbnail.getAttribute('data-product-index');
    const imageIndex = thumbnail.getAttribute('data-image-index');
    const imageSrc = thumbnail.querySelector('img')?.src;
    
    if (productIndex !== null && imageIndex !== null && imageSrc) {
        switchMyOrdersMainImage(parseInt(productIndex), parseInt(imageIndex), imageSrc);
    } else {
        console.error('❌ [طلباتي] بيانات الصورة المصغرة غير مكتملة:', { productIndex, imageIndex, imageSrc });
    }
    
    return false;
}

// 🔥 **دالة إضافية لإرفاق الأحداث (بديل)**
// 🔥 **دالة إرفاق الأحداث لنافذة طلباتي فقط**
function attachMyOrdersThumbnailEvents() {
    console.log('🔗 [طلباتي] إرفاق أحداث الصور المصغرة...');
    
    // استخدام class خاص لنافذة طلباتي
    document.querySelectorAll('.myorders-product-thumbnail').forEach(thumbnail => {
        // إزالة أي أحداث سابقة
        thumbnail.removeEventListener('click', handleMyOrdersThumbnailClick);
        
        // إضافة حدث جديد
        thumbnail.addEventListener('click', handleMyOrdersThumbnailClick);
        
        // إضافة تأثيرات hover
        thumbnail.addEventListener('mouseenter', function() {
            if (!this.classList.contains('active')) {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            }
        });
        
        thumbnail.addEventListener('mouseleave', function() {
            if (!this.classList.contains('active')) {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            }
        });
    });
    
    console.log(`✅ [طلباتي] تم إرفاق أحداث لـ ${document.querySelectorAll('.myorders-product-thumbnail').length} صورة مصغرة`);
}
  
// 🔥 **دالة جديدة: إنشاء الصور المصغرة**
function generateProductThumbnails(product, productIndex) {
    const images = product.images || [];
    
    // إذا كان هناك صورة واحدة فقط، لا نعرض الصور المصغرة
    if (images.length <= 1) {
        return '';
    }
    
    let thumbnailsHtml = `
        <div class="product-thumbnails-container" 
             data-product-index="${productIndex}"
             style="
                display: flex;
                justify-content: center;
                gap: 8px;
                padding: 10px;
                background: #f8f9fa;
                border-bottom: 1px solid #eee;
             ">
    `;
    
    images.forEach((image, imgIndex) => {
        const isActive = imgIndex === 0 ? 'active' : '';
        thumbnailsHtml += `
            <div class="product-thumbnail ${isActive}" 
                 data-product-index="${productIndex}"
                 data-image-index="${imgIndex}"
                 data-image-src="${image}"
                 style="
                    width: 60px;
                    height: 60px;
                    border-radius: 8px;
                    overflow: hidden;
                    cursor: pointer;
                    border: 2px solid ${imgIndex === 0 ? '#3498db' : '#ddd'};
                    transition: all 0.3s;
                    background: white;
                 ">
                <img src="${image}" 
                     alt="صورة مصغرة"
                     style="width: 100%; height: 100%; object-fit: cover;"
                     onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=100&h=100&fit=crop'">
            </div>
        `;
    });
    
    thumbnailsHtml += `</div>`;
    return thumbnailsHtml;
}
// 🔥 **دالة بسيطة للتبديل (بديل آخر)**
function simpleImageSwitch(productIndex, imageIndex) {
    const product = window.userProducts[productIndex];
    if (!product || !product.images || !product.images[imageIndex]) return;
    
    const imageSrc = product.images[imageIndex];
    switchMainImage(productIndex, imageIndex, imageSrc);
}
// 🔥 **دالة جديدة: تهيئة الصور المصغرة**
function initProductThumbnails() {
    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const productIndex = this.getAttribute('data-product-index');
            const imageIndex = this.getAttribute('data-image-index');
            const imageSrc = this.getAttribute('data-image-src');
            
            changeProductImage(productIndex, imageIndex, imageSrc);
        });
    });
}

// 🔥 **دالة جديدة: تغيير الصورة الرئيسية عند النقر على الصور المصغرة**
function changeProductImage(productIndex, imageIndex, imageSrc) {
    // الحصول على بطاقة المنتج
    const productsCards = document.querySelectorAll('.products-card');
    const productsCard = productsCards[productIndex];
    
    if (!productsCard) return;
    
    // تحديث الصورة الرئيسية
    const mainImage = productsCard.querySelector('.main-image');
    if (mainImage) {
        // تأثير انتقال سلس
        mainImage.style.opacity = '0.3';
        setTimeout(() => {
            mainImage.src = imageSrc;
            setTimeout(() => {
                mainImage.style.opacity = '1';
            }, 200);
        }, 200);
    }
    
    // تحديث حالة الصور المصغرة
    const thumbnails = productsCard.querySelectorAll('.product-thumbnail');
    thumbnails.forEach((thumb, index) => {
        if (index === parseInt(imageIndex)) {
            thumb.style.borderColor = '#3498db';
            thumb.classList.add('active');
        } else {
            thumb.style.borderColor = '#ddd';
            thumb.classList.remove('active');
        }
    });
    
    console.log(`🖼️ تم تغيير صورة المنتج ${productIndex} إلى الصورة ${imageIndex}`);
}
// 🔥 **دالة جديدة: تغيير الصورة الرئيسية**
function changeProductImage(productIndex, imageIndex, imageSrc) {
    const productsCard = document.querySelectorAll('.userProductsContainer .products-card')[productIndex];
    if (!productsCard) return;
    
    const mainImage = productsCard.querySelector('.products-image img');
    const thumbnails = productsCard.querySelectorAll('.product-thumbnail');
    
    if (mainImage) {
        // تأثير انتقال سلس
        mainImage.style.opacity = '0.3';
        setTimeout(() => {
            mainImage.src = imageSrc;
            setTimeout(() => {
                mainImage.style.opacity = '1';
            }, 200);
        }, 200);
    }
    
    // تحديث الصور المصغرة النشطة
    thumbnails.forEach((thumb, index) => {
        if (index === imageIndex) {
            thumb.style.borderColor = '#3498db';
            thumb.classList.add('active');
        } else {
            thumb.style.borderColor = 'transparent';
            thumb.classList.remove('active');
        }
    });
}

// 🔥 **دالة جديدة: تهيئة الصور المصغرة**
function initProductThumbnails() {
    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const productIndex = this.getAttribute('data-product-index');
            const imageIndex = this.getAttribute('data-image-index');
            const imageSrc = this.getAttribute('data-image-src');
            
            changeProductImage(productIndex, imageIndex, imageSrc);
        });
    });
}

function getProductStatusInfo(situation) {
    const status = situation || 'Active';
    
    // دعم الحالات العربية والإنجليزية
    const statusMap = {
        'Active': { text: 'مفعل', color: '#2ecc71', icon: 'fa-check-circle' },
        'UnActive': { text: 'انتهى', color: '#e74c3c', icon: 'fa-times-circle' },
        'Pending': { text: 'معلق', color: '#f39c12', icon: 'fa-clock' },
        'Deleting': { text: 'محذوف', color: '#95a5a6', icon: 'fa-trash' },
        'مفعل': { text: 'مفعل', color: '#2ecc71', icon: 'fa-check-circle' },
        'انتهى': { text: 'انتهى', color: '#e74c3c', icon: 'fa-times-circle' },
        'معلق': { text: 'معلق', color: '#f39c12', icon: 'fa-clock' },
        'محذوف': { text: 'محذوف', color: '#95a5a6', icon: 'fa-trash' }
    };
    
    // البحث بدون حساسية لحالة الأحرف
    const normalizedStatus = Object.keys(statusMap).find(key => 
        key.toLowerCase() === status.toLowerCase()
    ) || 'Active';
    
    return statusMap[normalizedStatus];
}

// دالة للحصول على رسالة الحالة
function getStatusMessage(situation) {
    if (!situation) situation = 'Active';
    
    const status = situation.toString().toLowerCase();
    
    // 🔥 الترتيب مهم: تحقق من "انتهى" أولاً
    if (status.includes('unactive') || status.includes('انتهى')) {
        return '<span style="color: #e74c3c; font-size: 16px;"><i class="fas fa-exclamation-triangle"></i> منتج انتهى الصلاحية</span>';
    } else if (status.includes('active') || status.includes('مفعل')) {
        return '<span style="color: #27ae60; font-size: 16px;"><i class="fas fa-check-circle"></i> منتج نشط ومتاح</span>';
    } else if (status.includes('pending') || status.includes('معلق')) {
        return '<span style="color: #f39c12; font-size: 16px;"><i class="fas fa-clock"></i> قيد المراجعة</span>';
    } else if (status.includes('deleting') || status.includes('محذوف')) {
        return '<span style="color: #95a5a6; font-size: 16px;"><i class="fas fa-trash"></i> في طور الحذف</span>';
    } else {
        return '<span style="color: #3498db; font-size: 16px;"><i class="fas fa-info-circle"></i> حالة غير معروفة</span>';
    }
}

// دالة للحصول على لون خلفية حسب الحالة
function getStatusBackgroundColor(statusText) {
    if (!statusText) return '#f8f9fa';
    
    if (statusText === 'مفعل') return '#e8f6ef';
    if (statusText === 'انتهى') return '#fdecea';
    if (statusText === 'معلق') return '#fef9e7';
    if (statusText === 'محذوف') return '#f4f6f6';
    return '#f8f9fa';
}

// دالة تحديث عدد المنتجات المعروضة
function updateUserProductsCount(count) {
    const countElement = document.getElementById('userProductsCount');
    if (countElement) {
        countElement.textContent = `(${count} منتج)`;
    }
}



// إضافة مستمعي الأحداث للصور المصغرة
function addUserProductThumbnailsEventListeners() {
    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const productIndex = this.getAttribute('data-product');
            const imageUrl = this.getAttribute('data-image');
            
            const mainImage = this.closest('.product-card').querySelector('.product-image img');
            if (mainImage && imageUrl) {
                mainImage.style.opacity = '0.3';
                setTimeout(() => {
                    mainImage.src = imageUrl;
                    mainImage.style.opacity = '1';
                }, 200);
                
                // تحديث الصورة النشطة
                this.closest('.product-thumbnails-container')
                    .querySelectorAll('.product-thumbnail')
                    .forEach(t => {
                        t.style.borderColor = 'transparent';
                    });
                this.style.borderColor = '#3498db';
            }
        });
    });
}

// إضافة مستمعي الأحداث للصور المصغرة
function addThumbnailsEventListeners() {
    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const productId = this.getAttribute('data-product');
            const imageSrc = this.getAttribute('data-image');
            
            // تحديث الصورة الرئيسية
            const productCard = this.closest('.product-card');
            const mainImage = productCard.querySelector('.product-image img');
            
            if (mainImage) {
                // تأثير انتقال سلس
                mainImage.style.opacity = '0.5';
                setTimeout(() => {
                    mainImage.src = imageSrc;
                    setTimeout(() => {
                        mainImage.style.opacity = '1';
                    }, 100);
                }, 200);
            }
            
            // تحديث حالة الصور المصغرة
            const thumbnails = productCard.querySelectorAll('.product-thumbnail');
            thumbnails.forEach(t => {
                t.style.borderColor = 'transparent';
            });
            this.style.borderColor = '#3498db';
        });
    });
}

// إضافة مستمعي الأحداث لأزرار المنتجات
function addProductButtonsEventListeners(products) {
    // زر عرض التفاصيل
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product');
            showProductDetails(parseInt(productId), products);
        });
    });
    
    // زر تعديل المنتج
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product');
            editProduct(parseInt(productId), products);
        });
    });
    
    // زر حذف المنتج
    document.querySelectorAll('.delete-product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product');
            deleteProduct(parseInt(productId), products);
        });
    });
    
    // زر واتساب
    document.querySelectorAll('.whatsapp-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productCard = this.closest('.product-card');
            const productId = productCard.getAttribute('data-index');
            const product = products[productId];
            
            if (product) {
            const baseUrl = 'https://almobseroon-hash.github.io/ALMOBSERON7/';
// إضافة معلمة productId إلى رابط موقعك
const productDeepLink = `${baseUrl}?productId=${productId}`;

// بناء الرسالة النهائية مع وضع الروابط في الأعلى
const message = `📸 *صورة المنتج:* ${productImage}\n\n` + // رابط الصورة
               `🔗 *عرض تفاصيل المنتج:*\n${productDeepLink}\n\n` + // رابط موقعك
               `🌟 أنا مهتم بهذا المنتج 🌟\n\n` +
               `📦 *رقم المنتج:* ${productNumber}\n` +
               `🏷️ *اسم المنتج:* ${productName}\n` +
               `💰 *السعر:* ${productPrice}`;
                `📞 للاستفسار: ${phoneNumber}`;
                
                const whatsappUrl = `https://wa.me/${product.productPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        });
    });
}

// إضافة مستمعي الأحداث للصور المصغرة
function addThumbnailsEventListeners(products) {
    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-product'));
            const imageSrc = this.getAttribute('data-image');
            
            // تحديث الصورة الرئيسية
            const productCard = this.closest('.product-card');
            const mainImage = productCard.querySelector('.product-image img');
            
            if (mainImage) {
                // تأثير انتقال سلس
                mainImage.style.opacity = '0.5';
                setTimeout(() => {
                    mainImage.src = imageSrc;
                    setTimeout(() => {
                        mainImage.style.opacity = '1';
                    }, 100);
                }, 200);
            }
            
            // تحديث حالة الصور المصغرة
            const thumbnails = productCard.querySelectorAll('.product-thumbnail');
            thumbnails.forEach(t => {
                t.style.borderColor = 'transparent';
            });
            this.style.borderColor = '#3498db';
        });
    });
}
// دالة عرض تفاصيل منتج المستخدم
function showUserProductDetails(productId, products) {
    const product = products[productId];
    
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    // عرض في نافذة التفاصيل
    document.getElementById('detail-product-number').textContent = product.productNo || 'غير معروف';
    document.getElementById('detail-product-name').textContent = product.productName || 'منتج بدون اسم';
    document.getElementById('detail-product-price').textContent = product.productPrice || 'غير محدد';
    document.getElementById('detail-product-description').textContent = product.productDescription || 'لا يوجد وصف';
    document.getElementById('detail-product-type').textContent = product.productType || 'عام';
    document.getElementById('detail-product-quantity').textContent = product.productQuantity || '1';
    document.getElementById('detail-product-condition').textContent = product.productCondition || 'جديد';
    document.getElementById('detail-product-warranty').textContent = product.productWarranty || 'لا يوجد';
    document.getElementById('detail-product-color').textContent = product.productColor || 'غير محدد';
    document.getElementById('detail-product-location').textContent = product.productLocation || 'غير محدد';
    document.getElementById('detail-product-locationstate').textContent = product.productLocationState || 'غير محدد';
    document.getElementById('detail-whatsapp-number').textContent = product.productPhone || 'غير محدد';
    
    // الصور
    const productImages = product.images || [];
    const mainImage = document.getElementById('detail-main-image');
    if (mainImage && productImages.length > 0) {
        mainImage.src = productImages[0];
    }
    
    // الصور المصغرة في نافذة التفاصيل
    const thumbnailsContainer = document.getElementById('detail-thumbnails');
    if (thumbnailsContainer) {
        thumbnailsContainer.innerHTML = '';
        
        productImages.forEach((image, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = `product-detail-thumbnail ${index === 0 ? 'active' : ''}`;
            thumbnail.innerHTML = `<img src="${image}" alt="صورة المنتج">`;
            
            thumbnail.addEventListener('click', function() {
                // تحديث الصورة الرئيسية
                mainImage.style.opacity = '0.5';
                setTimeout(() => {
                    mainImage.src = image;
                    setTimeout(() => {
                        mainImage.style.opacity = '1';
                    }, 100);
                }, 200);
                
                // تحديث الصور المصغرة النشطة
                document.querySelectorAll('.product-detail-thumbnail').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
            });
            
            thumbnailsContainer.appendChild(thumbnail);
        });
    }
    
    // فتح النافذة
    document.getElementById('productDetailModal').style.display = 'flex';
}
// دالة واتساب لمنتج المستخدم
function whatsappUserProduct(productId, products) {
    const product = products[productId];
    
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    const message = `مرحباً، أنا مهتم بالمنتج التالي:\n` +
                   `📦 رقم المنتج: ${product.productNo || 'غير معروف'}\n` +
                   `🏷️ اسم المنتج: ${product.productName || 'منتج'}\n` +
                   `💰 السعر: ${product.productPrice || 'غير محدد'}\n` +
                   `📍 الموقع: ${product.productLocation || 'غير محدد'}\n` +
                   `📞 هاتف البائع: ${product.productPhone || 'غير محدد'}`;
    
    const whatsappUrl = `https://wa.me/${product.productPhone || '07701234567'}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    showNotification('تم فتح واتساب للمنتج', 'success');
}


// دالة حذف منتج المستخدم
async function handleDeleteProduct(productNo, button, situation) {
  if (!productNo) {
    showNotification('رقم المنتج غير صالح', 'error');
    return;
  }

  // 🟡 حذف مؤقت
  if (situation !== 'Deleting') {

    const ok = await showConfirmModal(
      'حذف مؤقت',
      'هل تريد نقل المنتج إلى الحذف المؤقت؟'
    );

    if (!ok) return;

    updateProductStatus(productNo, 'deleteTemp')
      .then(() => {
        showNotification('تم نقل المنتج إلى الحذف المؤقت', 'success');
        loadUserProductsFromExcel();
        loadProductsFromGoogleSheets();    
        button.textContent = 'حذف نهائي';
        button.setAttribute(
          'onclick',
          `handleDeleteProduct('${productNo}', this, 'Deleting')`
        );
      })
      .catch(() => {
        showNotification('فشل في تنفيذ العملية', 'error');
      });

  } 
  // 🔴 حذف نهائي
  else {

    const ok = await showConfirmModal(
      '⚠️ حذف نهائي',
      'هل أنت متأكد من الحذف النهائي؟ لا يمكن التراجع عن هذا الإجراء.'
    );

    if (!ok) return;

    updateProductStatus(productNo, 'deletePermanent')
      .then(() => {
        showNotification('تم حذف المنتج نهائياً', 'success');
        loadUserProductsFromExcel();
        loadProductsFromGoogleSheets();    
        const card = button.closest('.product-card');
        if (card) card.remove();
      })
      .catch(() => {
        showNotification('فشل في الحذف النهائي', 'error');
      });
  }
}
function showConfirmModal(title, message) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const titleEl = document.getElementById('confirmTitle');
    const messageEl = document.getElementById('confirmMessage');
    const btnOk = document.getElementById('confirmOk');
    const btnCancel = document.getElementById('confirmCancel');

    titleEl.textContent = title;
    messageEl.textContent = message;

    modal.style.display = 'flex';

    btnOk.onclick = () => {
      modal.style.display = 'none';
      resolve(true);
    };

    btnCancel.onclick = () => {
      modal.style.display = 'none';
      resolve(false);
    };
  });
}
function updateProductStatus(productNo, action) {
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxfQ5-z-qHKJTGfGPosGNIwRtCCbr5Qx20XE5N6fzLCBRyts55sW60PGafHKJzet4Ri/exec';

    return fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            productNo: productNo,
            action: action
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'خطأ غير معروف');
        }
        return data;
    });
}


// دالة لفتح نافذة التعديل
function openEditProductModal(productNo) {
    console.log('🔄 فتح تعديل المنتج رقم:', productNo);
    
    if (!productNo) {
        showNotification('رقم المنتج غير صالح', 'error');
        return;
    }
    
    // 🔥 البحث عن المنتج باستخدام رقم المنتج
    const product = findProductByProductNo(productNo);
    
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
       
    console.log('🔍 المنتج الموجود:', product);
    console.log('📞 الهاتف:', product.custel || product.productPhone);
    console.log('📍 المنطقة:', product.state || product.productLocationState);
    
    // حفظ المنتج الحالي للتعديل
    currentEditingProduct = product;
    currentEditingProductNo = productNo;
    
    // تعبئة النموذج
    fillEditProductForm(product);
    
    // فتح النافذة
    document.getElementById('addProductModal').style.display = 'flex';
    productPhone.style.readOnly = 'true';
    productPhone.style.background = '#e3f2fd'
    // تهيئة الخريطة بشكل مؤكد
    setTimeout(() => {
        initProductMapForEdit(product);
    }, 300);
}
// دالة للبحث عن المنتج برقم المنتج
function findProductByProductNo(productNo) {
    if (!window.userProducts || !Array.isArray(window.userProducts)) {
        console.error('❌ لا توجد بيانات المنتجات');
        return null;
    }
    
    console.log('🔍 البحث عن المنتج رقم:', productNo);
    console.log('📊 عدد المنتجات المتاحة:', window.userProducts.length);
    
    // البحث في المنتجات
    const product = window.userProducts.find(p => {
        return p.productNo === productNo || 
               (p.rawData && p.rawData.productNo === productNo);
               
    });
    
    if (product) {
        console.log('✅ تم العثور على المنتج');
        return product;
    } else {
        console.log('❌ المنتج غير موجود في:', window.userProducts.map(p => p.productNo));
        return null;
    }
}

// 🔥 **دالة التحقق من انتهاء الصلاحية وتحديث الحالة**
function checkAndUpdateExpiryStatus(productData) {
    // إذا لم يكن هناك تاريخ انتهاء، لا تفعل شيئاً
    if (!productData.productExpiredDate) {
        return productData.situation || 'Active';
    }
    
    try {
        // تحويل تاريخ الانتهاء إلى كائن تاريخ
        const expiryDate = new Date(productData.productExpiredDate);
        const today = new Date();
        
        // إزالة الوقت من التواريخ للمقارنة الصحيحة
        expiryDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        console.log('📅 مقارنة التواريخ:', {
            'تاريخ الانتهاء': expiryDate.toDateString(),
            'تاريخ اليوم': today.toDateString(),
            'هل انتهى؟': expiryDate < today
        });
        
        // إذا كان تاريخ الانتهاء قبل اليوم
        if (expiryDate < today) {
            console.log('⚠️ المنتج انتهت صلاحيته');
            return 'انتهى'; // أو 'UnActive' حسب ما تستخدم
        }
        
    } catch (error) {
        console.error('❌ خطأ في معالجة تاريخ الانتهاء:', error);
    }
    
    // إرجاع الحالة الأصلية إذا لم ينتهي
    return productData.situation || 'Active';
}


// دالة تنظيف السعر
function cleanPrice(price) {
    if (!price) return '0';
    
    if (typeof price === 'string') {
        // إزالة النص والرموز غير الرقمية
        const cleaned = price.replace(/[^\d.]/g, '');
        return cleaned === '' ? '0' : cleaned;
    }
    
    return price;
}

// تحديث عنوان نافذة التعديل
function updateEditModalHeader(productNo) {
    const modalHeader = document.querySelector('#addProductModal .product-modal-header h2');
    if (modalHeader) {
        modalHeader.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span>تعديل المنتج</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 14px; color: #ffffff;">رقم:</span>
                    <span style="font-weight: bold; color: #ffffff; font-size: 16px;">${productNo || ''}</span>
                </div>
            </div>
        `;
    }
}

// تحديث زر الحفظ
function updateEditSubmitButton() {
    const submitBtn = document.querySelector('#addProductForm .btn-submit');
    if (submitBtn) {
        submitBtn.textContent = 'تحديث المنتج';
        submitBtn.dataset.mode = 'edit';
        submitBtn.dataset.productNo = currentEditingProductNo;
    }
}


// دالة جديدة لتهيئة الخريطة للتعديل
function initProductMapForEdit(product) {
    const mapElement = document.getElementById('product-map');
    if (!mapElement) {
        console.error('❌ عنصر الخريطة غير موجود!');
        return;
    }
    
    // إزالة الخريطة القديمة إذا كانت موجودة
    if (productMap) {
        productMap.remove();
        productMap = null;
    }
    
    // إنشاء الخريطة
    productMap = L.map('product-map').setView([23.5880, 58.3829], 11);
    
    // إضافة طبقة الخريطة
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(productMap);
    
    // إضافة علامة
    productLocationMarker = L.marker([33.3128, 44.3615], {draggable: true}).addTo(productMap)
        .bindPopup('موقع المنتج')
        .openPopup();
    
    // إضافة الأحداث
    productLocationMarker.on('dragend', function(event) {
        const position = productLocationMarker.getLatLng();
        updateProductLocationFields(position.lat, position.lng);
        reverseProductGeocode(position.lat, position.lng);
    });
    
    productMap.on('click', function(e) {
        productLocationMarker.setLatLng(e.latlng);
        updateProductLocationFields(e.latlng.lat, e.latlng.lng);
        reverseProductGeocode(e.latlng.lat, e.latlng.lng);
    });
    
    // إذا كان هناك موقع محفوظ في المنتج، عرضه
    if (product.productLocationLink) {
        const coords = extractCoordinatesFromLink(product.productLocationLink);
        if (coords) {
            setTimeout(() => {
                productMap.setView([coords.lat, coords.lng], 15);
                productLocationMarker.setLatLng([coords.lat, coords.lng]);
                updateProductLocationFields(coords.lat, coords.lng);
                reverseProductGeocode(coords.lat, coords.lng);
            }, 500);
        }
    } else if (product.productLocation || product.productLocationState) {
        // محاولة جلب إحداثيات من اسم المنطقة
        setTimeout(() => {
            const locationName = product.productLocationState || product.productLocation;
            if (locationName) {
                // استخدام خدمة Nominatim للبحث عن الموقع
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1&accept-language=ar`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            productMap.setView([lat, lon], 15);
                            productLocationMarker.setLatLng([lat, lon]);
                            updateProductLocationFields(lat, lon);
                            reverseProductGeocode(lat, lon);
                        }
                    })
                    .catch(error => {
                        console.error('Error in geocoding:', error);
                    });
            }
        }, 500);
    }
    
    console.log('✅ تم تهيئة الخريطة للتعديل');
}

function debugProductData(productsData) {
    console.log('=== فحص هيكل بيانات المنتج ===');
    if (productsData && productsData.length > 0) {
        const sampleProduct = productsData[0];
        console.log('العينات الأولى:', sampleProduct);
        console.log('جميع المفاتيح:', Object.keys(sampleProduct));
        
        // ابحث عن أي حقل يحتوي على كلمة "سعر" أو "منطقة" أو "موقع"
        const allKeys = Object.keys(sampleProduct);
        const priceKeys = allKeys.filter(key => 
            key.toLowerCase().includes('price') || 
            key.toLowerCase().includes('cost') ||
            key.toLowerCase().includes('amount')
        );
        const locationKeys = allKeys.filter(key => 
            key.toLowerCase().includes('location') || 
            key.toLowerCase().includes('region') ||
            key.toLowerCase().includes('area')
        );
        const mapKeys = allKeys.filter(key => 
            key.toLowerCase().includes('map') || 
            key.toLowerCase().includes('coord')
        );
        
        console.log('مفاتيح السعر المحتملة:', priceKeys);
        console.log('مفاتيح المنطقة المحتملة:', locationKeys);
        console.log('مفاتيح الخريطة المحتملة:', mapKeys);
    }
}

// استدع الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // تأكد من أن productsData موجودة
    if (typeof productsData !== 'undefined') {
        debugProductData(productsData);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // إضافة CSS للدوران
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
                gap: 10px !important;
                border-radius: 10px;
            }
            
            .product-thumbnails-container {
                gap: 5px !important;
                padding: 8px !important;
            }
            
            .product-thumbnail {
                width: 45px !important;
                height: 45px !important;
            }
            
            .product-image {
                height: 160px !important;
            }
        }
        
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr !important;
                border-radius: 10px;
            }
            
            .product-thumbnail {
                width: 40px !important;
                height: 40px !important;
            }
        }
    `;
    document.head.appendChild(style);
    
    console.log('✅ تم تحميل نظام المنتجات');
});


// دالة لجلب جميع المنتجات من Google Sheets
async function loadAllProductsFromGoogleSheets() {
    try {
        console.log('📦 جاري تحميل جميع المنتجات...');
        
        // استخدام نفس رابط السكريبت ولكن مع معامل مختلف
        const url = `${PRODUCTS_SCRIPT_URL}?action=getAllProducts&t=${Date.now()}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`خطأ في الخادم: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('📦 استجابة جميع المنتجات:', data);
        
        if (data.success === true && Array.isArray(data.products)) {
            return data.products;
        } else {
            console.warn('⚠️ استخدام بيانات تجريبية');
            return getTestProducts();
        }
    } catch (error) {
        console.error('❌ خطأ في جلب المنتجات:', error);
        return getTestProducts();
    }
}



// دالة تصفية المنتجات حسب رقم الهاتف
function filterProductsByPhone(products, userPhone) {
    if (!Array.isArray(products)) return [];
    
    // تحويل رقم الهاتف للتطبيع (إزالة الرموز والمسافات)
    const normalizedUserPhone = normalizePhoneNumber(userPhone);
    
    return products.filter(product => {
        // البحث عن رقم الهاتف في الحقول المختلفة
        const possiblePhoneFields = [
            'custel', 'custelphone', 'phone', 'userPhone', 
            'customerPhone', 'clientPhone', 'رقم الهاتف', 'هاتف'
        ];
        
        let productPhone = '';
        for (const field of possiblePhoneFields) {
            if (product[field]) {
                productPhone = product[field].toString().trim();
                break;
            }
        }
        
        // تطبيع رقم هاتف المنتج
        const normalizedProductPhone = normalizePhoneNumber(productPhone);
        
        // المقارنة بعد التطبيع
        return normalizedProductPhone === normalizedUserPhone;
    });
}

// دالة تطبيع رقم الهاتف (إزالة الرموز والمسافات)
function normalizePhoneNumber(phone) {
    if (!phone) return '';
    
    // إزالة المسافات والرموز
    const cleaned = phone.toString().replace(/[\s+\-()]/g, '');
    
    // إضافة مفتاح الدولة إذا لم يكن موجوداً
    if (cleaned.startsWith('0')) {
        return '964' + cleaned.substring(1);
    }
    
    if (cleaned.startsWith('964')) {
        return cleaned;
    }
    
    return '964' + cleaned;
}

// دالة معالجة صور المنتجات
function processProductImages(products) {
    if (!Array.isArray(products)) return [];
    
    return products.map((product, index) => {
        // 1. البحث عن الصور في جميع الحقول الممكنة
        let images = [];
        
        // البحث في الحقول المعروفة للصور
        const possibleImageFields = [
            'image1', 'image2', 'image3', 'image', 'images',
            'صورة1', 'صورة2', 'صورة3', 'صورة', 'صور',
            'productImage1', 'productImage2', 'productImage3',
            'photo1', 'photo2', 'photo3'
        ];
        
        for (const field of possibleImageFields) {
            if (product[field]) {
                const fieldValue = product[field].toString().trim();
                
                // إذا كانت القيمة تحتوي على روابط متعددة (مفصولة بفاصلة)
                if (fieldValue.includes(',')) {
                    const imageUrls = fieldValue.split(',')
                        .map(url => url.trim())
                        .filter(url => isValidImageUrl(url));
                    
                    images = [...images, ...imageUrls];
                } 
                // إذا كانت قيمة واحدة
                else if (isValidImageUrl(fieldValue)) {
                    images.push(fieldValue);
                }
            }
        }
        
        // 2. إذا لم توجد صور، استخدم الصورة الافتراضية
        if (images.length === 0) {
            images = ['https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'];
        }
        
          // 🔥 **استخراج تاريخ الانتهاء**
        const expiredDate = getProductFieldValue(product, [
            'productExpiredDate', 'expiryDate', 'تاريخ الانتهاء',
            'expiredDate', 'endDate', 'تاريخ انتهاء الصلاحية'
        ]);
        
        
        // 3. استخدام الدالة المساعدة لجلب القيم الأخرى
        return {
            id: index,
            productNo: getProductFieldValue(product, ['productNo', 'رقم المنتج', 'id']) || `PROD-${Date.now().toString().slice(-6)}-${index}`,
            productName: getProductFieldValue(product, ['productName', 'اسم المنتج', 'name']) || 'منتج بدون اسم',
            productPrice: formatProductPrice(getProductFieldValue(product, ['productPrice', 'السعر', 'price']) || '0'),
            productDescription: getProductFieldValue(product, ['productDescription', 'الوصف', 'description']) || 'لا يوجد وصف',
            productType: getProductFieldValue(product, ['productCategory', 'productType', 'category', 'type', 'قسم المنتج', 'النوع']) || 'عام',
            productCondition: getProductFieldValue(product, ['productState', 'productCondition', 'condition', 'state', 'الحالة', 'حالة المنتج']) || 'جديد',
            productQuantity: getProductFieldValue(product, ['productQuantity', 'الكمية', 'quantity']) || '1',
            productWarranty: getProductFieldValue(product, ['productWarranty', 'الضمان', 'warranty']) || 'لا يوجد',
            productColor: getProductFieldValue(product, ['productColor', 'اللون', 'color']) || 'غير محدد',
            productLocation: getProductFieldValue(product, ['state', 'productLocationState', 'productLocation', 'location', 'الموقع', 'المنطقة']) || 'غير محدد',
            productLocationState: getProductFieldValue(product, ['productLocationName', 'locationName', 'اسم الموقع', 'موقع']) || 'غير محدد',
            productLocationLink: getProductFieldValue(product, ['locationLink', 'productLocationLink', 'رابط الموقع', 'storeLat']) || '',
            productPhone: getProductFieldValue(product, ['custel', 'phone', 'userPhone', 'productPhone', 'هاتف', 'رقم الهاتف']) || 'غير محدد',
            productSituation: getProductFieldValue(product, ['situation', 'productSituation', 'الحالة', 'حالة المنتج']) || 'Active',
            
            // 🔥 **تاريخ الانتهاء المضاف**
              productExpiredDate: expiredDate,
            
            images: images.slice(0, 3), // أخذ أول 3 صور فقط
            timestamp: getProductFieldValue(product, ['timestamp', 'التاريخ', 'date']) || new Date().toISOString(),
            rawData: product // حفظ البيانات الأصلية للرجوع إليها
        };
    });
}
// 🔥 **إضافة CSS خاص بنافذة طلباتي**
function addMyOrdersSpecificStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* أنماط خاصة بنافذة طلباتي */
        .myorders-product-thumbnail {
            cursor: pointer !important;
            user-select: none !important;
            position: relative;
        }
        
        /* تمييز نافذة طلباتي */
        .myorders-product-card {
            border-top: 3px solid #3498db !important;
        }
        
        .myorders-product-thumbnail.active {
            border-color: #3498db !important;
            position: relative;
        }
        
        .myorders-product-thumbnail.active::before {
            content: 'محدد';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
        }
        
        .myorders-product-thumbnail.active::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #3498db;
        }
        
        /* تأثيرات خاصة لنافذة طلباتي */
        .myorders-main-product-image {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .myorders-product-thumbnail:hover {
            transform: scale(1.05) !important;
            z-index: 5;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .myorders-product-thumbnail {
                width: 50px !important;
                height: 50px !important;
            }
            
            .myorders-product-thumbnail.active::before {
                font-size: 9px;
                padding: 1px 6px;
                top: -18px;
            }
        }
        
        /* مؤشر النقر للهواتف */
        @media (hover: none) and (pointer: coarse) {
            .myorders-product-thumbnail:active {
                background-color: rgba(52, 152, 219, 0.1) !important;
                transform: scale(0.95) !important;
            }
        }
        
        /* إزالة أي أنماط قد تتداخل */
        .myorders-product-thumbnail * {
            pointer-events: none !important;
        }
        
        /* تلوين خاص للنافذة */
        #userProductsContainer .myorders-product-card {
            background: linear-gradient(to bottom, white 0%, #f8f9fa 100%) !important;
        }
    `;
    
    // تأكد من عدم تكرار الإضافة
    if (!document.querySelector('style#myorders-styles')) {
        style.id = 'myorders-styles';
        document.head.appendChild(style);
        console.log('✅ تم إضافة أنماط خاصة بنافذة طلباتي');
    }
}

// استدعاء إضافة الأنماط عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', addMyOrdersSpecificStyles);


// 🔥 **دالة جديدة: تكبير الصورة الرئيسية عند النقر**
function initImageZoom() {
    // استخدام الـ class الصحيح لنافذة طلباتي
    document.querySelectorAll('.myorders-main-product-image').forEach(image => {
        // إزالة أي أحداث سابقة لمنع التكرار
        image.onclick = null;
        
        image.addEventListener('click', function() {
            const productIndex = this.getAttribute('data-product-index');
            const productCards = document.querySelectorAll('.myorders-product-card');
            const productCard = productCards[productIndex];
            
            if (!productCard) return;
            
            // إنشاء نافذة عرض الصورة
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = this.src;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 10px;
                box-shadow: 0 0 30px rgba(0,0,0,0.5);
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            // إغلاق النافذة عند النقر
            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // إغلاق بمفتاح ESC
            const closeOnEsc = function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);
        });
    });
}

// تحديث displayUserProducts لاستدعاء هذه الدالة
// بعد سطر initProductThumbnails(); أضف:
// 

function getProductFieldValue(product, fieldNames) {
    if (!product || !fieldNames || !Array.isArray(fieldNames)) {
        return '';
    }
    
    for (const fieldName of fieldNames) {
        if (product[fieldName] !== undefined && product[fieldName] !== null && product[fieldName] !== '') {
            return product[fieldName];
        }
    }
    
    return '';
}
// دالة التحقق من صحة رابط الصورة
function isValidImageUrl(url) {
    if (!url || typeof url !== 'string') return false;
    
    const trimmedUrl = url.trim();
    return (
        trimmedUrl.startsWith('http://') ||
        trimmedUrl.startsWith('https://') ||
        trimmedUrl.startsWith('data:image')
    );
}
// 🔥 **دالة جديدة: تنسيق تاريخ الانتهاء مع التنبيه**
function formatExpiryDate(expiryDate) {
    if (!expiryDate) {
        return {
            formatted: 'غير محدد',
            className: '',
            tooltip: ''
        };
    }
    
    try {
        const expiry = new Date(expiryDate);
        const today = new Date();
        const timeDiff = expiry.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        let className = '';
        let tooltip = '';
        
        if (daysDiff < 0) {
            // انتهى الصلاحية
            className = 'expiry-date-expired';
            tooltip = 'انتهت صلاحية المنتج';
        } else if (daysDiff <= 7) {
            // أقل من أسبوع
            className = 'expiry-date-warning';
            tooltip = `ينتهي خلال ${daysDiff} يوم${daysDiff === 1 ? '' : 'اً'}`;
        } else if (daysDiff <= 30) {
            // أقل من شهر
            className = 'expiry-date-coming';
            tooltip = `ينتهي خلال ${daysDiff} يوم`;
        }
        
        return {
            formatted: expiry.toLocaleDateString('ar-IQ'),
            className: className,
            tooltip: tooltip
        };
    } catch (error) {
        return {
            formatted: 'تاريخ غير صالح',
            className: '',
            tooltip: ''
        };
    }
}
// دالة تنسيق السعر
function formatProductPrice(price) {
    if (!price) return '0 ريال';
    
    try {
        // تحويل السعر إلى رقم
        let num = parseFloat(price.toString().replace(/[^0-9.]/g, ''));
        
        if (isNaN(num)) {
            return price + ' ريال';
        }
        
        // تنسيق الرقم
        return num.toLocaleString('ar-IQ') + ' ريال';
        
    } catch (error) {
        return price + ' ريال';
    }
}
/**
 * جلب رقم هاتف المستخدم من بيانات تسجيل الدخول وعرضه في الشريط العلوي
 */
function updateUserPhoneInNavbar() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (userPhone) {
            // تحديث رقم الهاتف في الشريط العلوي
            const userPhoneElement = document.getElementById('userPhone');
            if (userPhoneElement) {
                userPhoneElement.textContent = userPhone;
            }
            
            // تحديث حقول هاتف المستخدم في النماذج
            const custelField = document.getElementById('custel');
            if (custelField) {
                custelField.value = userPhone;
            }
        }
    } catch (error) {
        console.error('خطأ في تحديث رقم الهاتف:', error);
    }
}

// دالة لجلب بيانات العدادات من Google Sheets
async function fetchCountersData() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            console.warn('لا يوجد مستخدم مسجل دخول');
            return null;
        }
        
        // هنا يجب تغيير SCRIPT_URL إلى الرابط الحقيقي لـ Google Sheets
        const COUNTERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvQFP0-UoTQANtYjgFEVj68ma-rgdrOtUf6F9jp_IpUwfqyg0UVMjvGzVqf8Llusc/exec';
        const url = `${COUNTERS_SCRIPT_URL}?action=getCounters&phone=${encodeURIComponent(userPhone)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            return data;
        }
        
        return null;
    } catch (error) {
        console.error('خطأ في جلب بيانات العدادات:', error);
        return null;
    }
}

// دالة لعرض رقم الهاتف في نافذة طلباتي
function displayUserPhoneInModal() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    
    const phoneDisplayElement = document.getElementById('userPhoneDisplay');
    if (phoneDisplayElement && userPhone) {
        phoneDisplayElement.textContent = `إضف رصيد لعرض منتجاتك : ${userPhone}`;
    }
    
    // تحديث رقم الهاتف في الشريط العلوي
    const userPhoneElement = document.getElementById('userPhone');
    if (userPhoneElement) {
        userPhoneElement.textContent = userPhone;
    }
}

// دالة لتحديث العدادات
function updateCounters(countersData) {
    if (!countersData) return;
    
    // تحديث القيم
    const counters = {
        total: document.getElementById('counter-total'),
        active: document.getElementById('counter-active'),
        unactive: document.getElementById('counter-unactive'),
        expired: document.getElementById('counter-expired'),
        deleted: document.getElementById('counter-deleted'),
        added: document.getElementById('counter-added')
    };
    
    if (counters.total) counters.total.textContent = countersData.TotalQuantity || 0;
    if (counters.active) counters.active.textContent = countersData.ActiveNo || 0;
    if (counters.unactive) counters.unactive.textContent = countersData.UnActiveNo || 0;
    if (counters.expired) counters.expired.textContent = countersData.ExpiredNo || 0;
    if (counters.deleted) counters.deleted.textContent = countersData.DeleteNo || 0;
    if (counters.added) counters.added.textContent = countersData.AddNo || 0;
    
    // إضافة تأثير عند تحديث القيم
    Object.values(counters).forEach(counter => {
        if (counter) {
            counter.style.transform = 'scale(1.1)';
            setTimeout(() => {
                counter.style.transform = 'scale(1)';
            }, 300);
        }
    });
}

// دالة رئيسية لتحميل واجهة طلباتي
async function loadMyOrdersInterface() {
    try {
        // عرض رقم الهاتف
        displayUserPhoneInModal();
        
        // عرض رسالة تحميل للعدادات
        const counterValues = document.querySelectorAll('.counter-value');
        counterValues.forEach(counter => {
            counter.textContent = '...';
            counter.style.opacity = '0.5';
        });
        
        // جلب بيانات العدادات
        const countersData = await fetchCountersData();
        
        if (countersData) {
            updateCounters(countersData);
        } else {
            // استخدام قيم افتراضية إذا فشل الجلب
            updateCounters({
                TotalQuantity: 0,
                ActiveNo: 0,
                UnActiveNo: 0,
                ExpiredNo: 0,
                DeleteNo: 0,
                AddNo: 0
            });
        }
        
        // إضافة تأثيرات عند اكتمال التحميل
        setTimeout(() => {
            counterValues.forEach(counter => {
                counter.style.opacity = '1';
                counter.style.transition = 'opacity 0.5s ease';
            });
        }, 500);
        
    } catch (error) {
        console.error('خطأ في تحميل واجهة طلباتي:', error);
        showNotification('حدث خطأ في تحميل البيانات', 'error');
    }
}


// ==================== نظام إضافة العدد المطلوب ====================

// تهيئة نظام إدخال العدد
function initQuantityInputSystem() {
    console.log('تهيئة نظام إدخال العدد...');
    
    // 1. البحث عن عنصر زر الإضافة
    const addQuantityIcon = document.getElementById('addQuantityIcon');
    const addQuantityCard = document.getElementById('addQuantityCard');
    
    console.log('العناصر الموجودة:', { addQuantityIcon, addQuantityCard });
    
    // 2. ربط حدث النقر على الزر
    if (addQuantityIcon) {
        console.log('✅ تم العثور على زر الإضافة');
        
        // إزالة أي أحداث سابقة
        addQuantityIcon.removeEventListener('click', openQuantityInputModal);
        
        // إضافة حدث جديد
        addQuantityIcon.addEventListener('click', function(e) {
            console.log('🎯 تم النقر على زر الإضافة');
            e.stopPropagation();
            openQuantityInputModal();
        });
        
        // إضافة تأثير hover
        addQuantityIcon.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
            this.style.transition = 'transform 0.3s';
        });
        
        addQuantityIcon.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    }
    
    // ربط حدث النقر على البطاقة كاملة
    if (addQuantityCard) {
        addQuantityCard.addEventListener('click', function(e) {
            console.log('🎯 تم النقر على بطاقة الإضافة');
            e.stopPropagation();
            openQuantityInputModal();
        });
        
        // إضافة مؤشر يدوي
        addQuantityCard.style.cursor = 'pointer';
    }
    
    // 3. ربط أحداث الإغلاق
    const closeQuantityModal = document.getElementById('closeQuantityModal');
    if (closeQuantityModal) {
        closeQuantityModal.addEventListener('click', closeQuantityInputModal);
    }
    
    // 4. ربط حدث التأكيد
    const confirmQuantityBtn = document.getElementById('confirmQuantityBtn');
    if (confirmQuantityBtn) {
        confirmQuantityBtn.addEventListener('click', confirmQuantityAddition);
    }
    
    // 5. ربط حدث تحديث الحساب
    const quantityInput = document.getElementById('quantityInput');
    if (quantityInput) {
        quantityInput.addEventListener('input', updateQuantityCalculation);
        quantityInput.addEventListener('change', updateQuantityCalculation);
    }
    
    // 6. إغلاق النافذة عند النقر خارجها
    const quantityModal = document.getElementById('quantityInputModal');
    if (quantityModal) {
        quantityModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeQuantityInputModal();
            }
        });
    }
    
    // 7. إغلاق بمفتاح ESC
    document.addEventListener('keydown', function(event) {
        const quantityModal = document.getElementById('quantityInputModal');
        if (event.key === 'Escape' && quantityModal && quantityModal.style.display === 'flex') {
            closeQuantityInputModal();
        }
    });
}
 
// دالة تفعيل الطلبات غير النشطة عبر واتساب
function activateUnactiveOrders() {
    console.log('🚀 محاولة تفعيل الطلبات غير النشطة...');
    
    // الحصول على المستخدم الحالي
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    
    if (!userPhone) {
        showNotification('يجب تسجيل الدخول أولاً', 'error');
        openLoginModal();
        return;
    }
    
    // الحصول على عدد الطلبات غير النشطة من العداد
    const unactiveCountElement = document.getElementById('counter-unactive');
    const unactiveCount = parseInt(unactiveCountElement.textContent) || 0;
    
    console.log('📊 عدد الطلبات غير النشطة:', unactiveCount);
    console.log('📱 رقم المستخدم:', userPhone);
    
    // التحقق من وجود رصيد للتنشيط
    if (unactiveCount > 0) {
        // حساب المبلغ الإجمالي
        const unitPrice = 0.500;
        const subtotal = unactiveCount * unitPrice;
        const tax = subtotal * 0.05; // ضريبة 5%
        const total = subtotal + tax;
        
        // إعداد رسالة واتساب
        const adminPhone = '+96895209623';
        const message = `طلب تفعيل طلبات غير نشطة
👤 المستخدم: ${userPhone}
🔢 عدد الطلبات غير النشطة: ${unactiveCount}
💰 المبلغ الإجمالي: ${total.toFixed(3)} ريال (يشمل ضريبة 5%)
🕐 الوقت: ${new Date().toLocaleString('ar-IQ')}`;

        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${adminPhone.replace('+', '')}?text=${encodedMessage}`;
        
        // فتح واتساب
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        
        console.log('✅ تم فتح واتساب:', whatsappUrl);
        showNotification(`تم إرسال طلب التفعيل لـ ${unactiveCount} طلب غير نشط`, 'success');
        
    } else {
        // إذا لم يكن هناك رصيد
        console.log('⚠️ لا يوجد رصيد للتنشيط');
        showNotification('لا يوجد رصيد للتنشيط', 'warning');
    }
}
function displayTotalAmountForUnactiveOrders() {
    // الحصول على عدد الطلبات غير النشطة من العداد
    const unactiveCountElement = document.getElementById('counter-unactive');
    const unactiveCount = parseInt(unactiveCountElement.textContent) || 0;
    
    // حساب المبلغ الإجمالي
    const unitPrice = 0.500;
    const subtotal = unactiveCount * unitPrice;
    const tax = subtotal * 0.05; // ضريبة 5%
    const total = subtotal + tax;
    
    // البحث عن عنصر عرض المبلغ في نافذة الطلبات
    let totalAmountDisplay = document.getElementById('totalAmountDisplay');
    
    // إذا لم يكن موجودًا، ننشئه
    if (!totalAmountDisplay) {
        totalAmountDisplay = document.createElement('div');
        totalAmountDisplay.id = 'totalAmountDisplay';
        totalAmountDisplay.style.cssText = `
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        
        // إضافة العنصر في أعلى نافذة الطلبات
        const myOrdersModalContent = document.querySelector('#myOrdersModal .modal-content');
        if (myOrdersModalContent) {
            // إدراج العنصر في البداية
            myOrdersModalContent.insertBefore(totalAmountDisplay, myOrdersModalContent.firstChild);
        }
    }
    
    // تحديث محتوى العنصر
    if (unactiveCount > 0) {
        totalAmountDisplay.innerHTML = `
            <div style="font-size: 16px; margin-bottom: 5px;">المبلغ المطلوب لتفعيل ${unactiveCount} طلب غير نشط</div>
            <div style="font-size: 24px;">${total.toFixed(3)} ريال</div>
            <div style="font-size: 14px; margin-top: 5px;">يشمل ضريبة 5%</div>
        `;
        totalAmountDisplay.style.display = 'block';
    } else {
        totalAmountDisplay.style.display = 'none';
    }
}
// دالة لفحص وإظهار/إخفاء زر التفعيل بناءً على العداد الحالي
function checkAndShowActivateButton() {
    const unactiveCountElement = document.getElementById('counter-unactive');
    const activateBtn = document.getElementById('activate-unactive-btn');
    
    if (!unactiveCountElement || !activateBtn) return;
    
    const unactiveCount = parseInt(unactiveCountElement.textContent) || 0;
    
    if (unactiveCount > 0) {
        // حساب المبلغ الإجمالي
        const unitPrice = 0.500;
        const subtotal = unactiveCount * unitPrice;
        const tax = subtotal * 0.05;
        const total = subtotal + tax;
        
        activateBtn.style.display = 'block';
        // تحديث الزر بالمبلغ الإجمالي
        activateBtn.innerHTML = `
            <i class="fab fa-whatsapp"></i> طلب تنشيط (${unactiveCount})
            <div style="font-size: 14px; color: #f70b32; margin-top: 3px;">
                ${total.toFixed(3)} ريال
                (ارفق ايصال الدفع)
            </div>
        `;
        
        // تحديث المبلغ الإجمالي في نافذة الطلبات إذا كانت مفتوحة
        if (document.getElementById('myOrdersModal').style.display === 'flex') {
            displayTotalAmountForUnactiveOrders();
            
        }
    } else {
        activateBtn.style.display = 'none';
        // إخفاء المبلغ الإجمالي في نافذة الطلبات إذا كانت مفتوحة
        const totalAmountContainer = document.getElementById('total-amount-container');
        if (totalAmountContainer) {
            totalAmountContainer.style.display = 'none';
        }
    }
}
// دالة لتحديث المبلغ الإجمالي عند تغيير العداد
function updateTotalAmount() {
    const unactiveCountElement = document.getElementById('counter-unactive');
    const unactiveCount = parseInt(unactiveCountElement.textContent) || 0;
    
    if (unactiveCount > 0) {
        // تحديث المبلغ في نافذة الطلبات إذا كانت مفتوحة
        if (document.getElementById('myOrdersModal').style.display === 'flex') {
            displayTotalAmountForUnactiveOrders();
        }
        
        // تحديث زر التفعيل
        checkAndShowActivateButton();
       

    }
}
// أضف هذا الكود في نهاية ملفك أو في دالة تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // محاكاة حدث تغيير في العداد
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'counter-unactive' && mutation.type === 'childList') {
                updateTotalAmount();
           
            }
        });
    });
    
    const unactiveCounter = document.getElementById('counter-unactive');
    if (unactiveCounter) {
        observer.observe(unactiveCounter, { childList: true, characterData: true, subtree: true });
    }
});
// دالة فتح نافذة إدخال العدد
function openQuantityInputModal() {
    // الحصول على قيمة العداد غير النشط
    const unactiveElement = document.getElementById('counter-unactive');
    if (!unactiveElement) {
        // إذا لم يوجد العنصر، نعرض رسالة خطأ
        showFloatingAlert('تعذر العثور على عداد الطلبات غير النشطة.');
        return;
    }
    
    const unactiveText = unactiveElement.textContent.trim();
    const unactiveCount = parseInt(unactiveText);
    
    // إذا كان النص غير رقمي (NaN) أو كان الرقم أكبر من 0
    if (isNaN(unactiveCount) || unactiveCount > 0) {
        // عرض رسالة عائمة حمراء
        showFloatingAlert('لا يمكن إضافة طلب جديد لأنه يوجد طلبات غير نشطة. يرجى معالجة الطلبات غير النشطة أولاً.');
        return; // نخرج من الدالة ولا نفتح النافذة
    }
    
    // إذا لم يكن هناك طلبات غير نشطة، نفتح النافذة
    console.log('🔓 فتح نافذة إدخال العدد...');
    
    // فتح نافذة جديدة
    document.getElementById('quantityInputModal').style.display = 'flex';
   
    // حساب النتائج أول مرة
    if (typeof calculateQuantity === 'function') {
        calculateQuantity();
    }
    
    // تركيز على حقل الإدخال
    setTimeout(() => {
        const inputField = document.getElementById('quantityInput');
        if (inputField) {
            inputField.focus();
            inputField.select();
        }
    }, 300);
    
    console.log('✅ تم فتح النافذة بنجاح');
}

// دالة لعرض رسالة عائمة حمراء
function showFloatingAlert(message) {
    // إزالة أي رسالة سابقة
    const existingAlert = document.getElementById('center-floating-alert');
    if (existingAlert) existingAlert.remove();
    
    // إنشاء عنصر الرسالة
    const alertDiv = document.createElement('div');
    alertDiv.id = 'center-floating-alert';
    alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(231, 76, 60, 0.95);
        color: white;
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 999999;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        max-width: 500px;
        animation: fadeInScale 0.3s ease-out;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        backdrop-filter: blur(10px);
        border: 2px solid #ff7979;
    `;
    
    // محتوى الرسالة
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle" style="font-size: 40px; color: #ffdd59;"></i>
        <div style="font-size: 18px; line-height: 1.5;">${message}</div>
        <button onclick="this.parentElement.remove()" style="
            background: white;
            color: #e74c3c;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.3s;
        ">حسناً</button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // إضافة CSS للأنيميشن
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    `;
    document.head.appendChild(style);
    
    // إزالة الرسالة بعد 5 ثواني
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translate(-50%, -50%) scale(0.8)';
            alertDiv.style.transition = 'opacity 0.5s, transform 0.5s';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    }, 5000);
}

// دالة إغلاق نافذة إدخال العدد
function closeQuantityInputModal() {
    const modal = document.getElementById('quantityInputModal');
    if (modal) {
        modal.style.display = 'none';
        
    }
}

// دالة تحديث الحساب
function updateQuantityCalculation() {
    const quantityInput = document.getElementById('quantityInput');
    if (!quantityInput) return;
    
    let quantity = parseInt(quantityInput.value) || 1;
    
    // التأكد من أن العدد بين 1 و 1000
    if (quantity < 1) {
        quantity = 1;
        quantityInput.value = 1;
    }
    if (quantity > 1000) {
        quantity = 1000;
        quantityInput.value = 1000;
    }
    
    // الحساب: العدد × 0.500 × 5%
    const unitPrice = 0.500;
    const taxRate = 0.05;
    
    const subtotal = quantity * unitPrice;
    const tax = subtotal * taxRate;
    const total = subtotal + tax;
    
    // تحديث القيم مع تنسيق مناسب
    const calculationResult = document.getElementById('calculationResult');
    const taxResult = document.getElementById('taxResult');
    const totalResult = document.getElementById('totalResult');
    
    if (calculationResult) calculationResult.textContent = subtotal.toFixed(3);
    if (taxResult) taxResult.textContent = tax.toFixed(3);
    if (totalResult) totalResult.textContent = total.toFixed(3);
    
    // إضافة تأثيرات مرئية
    if (totalResult) {
        totalResult.style.transform = 'scale(1.1)';
        setTimeout(() => {
            totalResult.style.transform = 'scale(1)';
        }, 300);
    }
    
    console.log(`حساب العدد: ${quantity} × ${unitPrice} = ${subtotal.toFixed(3)} + ضريبة ${tax.toFixed(3)} = إجمالي ${total.toFixed(3)}`);
  setTimeout(checkAndShowActivateButton, 1000);
  activateUnactiveOrders();
}

// دالة تأكيد الإضافة
function confirmQuantityAddition() {
    const quantityInput = document.getElementById('quantityInput');
    const quantity = parseInt(quantityInput.value) || 1;
    
    // التحقق من صحة المدخلات
    if (quantity < 1 || quantity > 1000) {
        alert('⚠️ الرجاء إدخال عدد صحيح بين 1 و 1000');
        quantityInput.focus();
        quantityInput.select();
        return;
    }
    
    // حساب النتائج
    updateQuantityCalculation();
    currentAddedQuantity = quantity;
    
    // إظهار الأزرار
    const sendBtn = document.getElementById('addSendtBtn');
    const sendBtnLabel = document.getElementById('addSendtBtnLable');

    if (sendBtn) {
        sendBtn.style.display = 'flex';
        
        // إزالة أي أحداث سابقة وربط الحدث الجديد
        sendBtn.removeEventListener('click', sendOrderHandler);
        sendBtn.addEventListener('click', sendOrderHandler);
    }

    if (sendBtnLabel) {
        sendBtnLabel.style.display = 'flex';
    }
    
    // الحصول على القيم المحسوبة
    const subtotal = parseFloat(document.getElementById('calculationResult').textContent);
    const tax = parseFloat(document.getElementById('taxResult').textContent);
    const total = parseFloat(document.getElementById('totalResult').textContent);
    
    // ✅ **تحديث counter-TotalPrice (الإجمالي)**
    const counterElement = document.getElementById('counter-TotalPrice');
    if (counterElement) {
        counterElement.innerHTML = `
            <span style="font-size: 16px; color: #7f8c8d; margin-left: 5px;">الإجمالي:</span>
            <span style="font-size: 22px; font-weight: 700; color: #27ae60;">${total.toFixed(3)}</span>
            <span style="font-size: 14px; color: #95a5a6;">ريال</span>
        `;
        counterElement.style.transform = 'scale(1.3)';
        counterElement.style.color = '#27ae60';
        counterElement.style.transition = 'all 0.3s';
        
        setTimeout(() => {
            counterElement.style.transform = 'scale(1)';
            counterElement.style.color = '#e74c3c';
        }, 500);
    }
    
    const quantityCounter = document.getElementById('counter-QuantityInputNo');
    if (quantityCounter) {
        quantityCounter.innerHTML = `
            <span style="font-size: 16px; color: #7f8c8d; margin-left: 5px;">العدد:</span>
            <span style="font-size: 22px; font-weight: 700; color: #e74c3c;">${quantity}</span>
            <span style="font-size: 14px; color: #95a5a6;"> منتج</span>
        `;
        
        quantityCounter.style.transform = 'scale(1.2)';
        quantityCounter.style.color = '#3498db';
        quantityCounter.style.fontWeight = 'bold';
        quantityCounter.style.transition = 'all 0.3s';
        
        setTimeout(() => {
            quantityCounter.style.transform = 'scale(1)';
            quantityCounter.style.color = '#e74c3c';
        }, 500);
        
        console.log(`✅ تم تحديث counter-QuantityInputNo إلى ${quantity}`);
    } else {
        console.error('❌ counter-QuantityInputNo غير موجود!');
    }
    
    // ✅ **تحديث حقل orderQuantity في نموذج إدارة الطلبات**
    const orderQuantity = document.getElementById('orderQuantity');
    if (orderQuantity) {
        orderQuantity.value = quantity;
        calculateOrderValues();
        
        console.log(`✅ تم تحديث orderQuantity إلى ${quantity}`);
    }
    
    // ✅ **التمرير إلى أعلى myOrdersModal أولاً**
    scrollToTopMyOrdersModal();
    
    // ✅ **تأخير إغلاق نافذة الكمية قليلاً**
    setTimeout(() => {
        closeQuantityInputModal();
   
        // عرض رسالة نجاح
        showNotification(`✅ تم إضافة ${quantity} منتج بنجاح! الإجمالي: ${total.toFixed(3)}`, 'success');
        
        // تسجيل في الكونسول
        console.log(`✅ تم تأكيد الإضافة:
        - العدد: ${quantity}
        - السعر: ${subtotal.toFixed(3)}
        - الضريبة: ${tax.toFixed(3)}
        - الإجمالي: ${total.toFixed(3)}`);
    }, 300); // تأخير 300 مللي ثانية للتأكد من اكتمال التمرير
}

// دالة لحفظ البيانات في Google Sheets (اختياري)
async function saveQuantityToGoogleSheets(quantity, total) {
    try {
        // الحصول على المستخدم الحالي
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            console.warn('⚠️ يجب تسجيل الدخول أولاً');
            return;
        }
        
        const data = {
            timestamp: new Date().toISOString(),
            phone: userPhone,
            quantity: quantity,
            total: total,
            type: 'quantity_addition'
        };
        
        console.log('📤 إرسال بيانات الإضافة:', data);
        
        // هنا يمكنك إضافة كود الإرسال إلى Google Sheets
        // const response = await fetch('YOUR_GOOGLE_SCRIPT_URL', {...});
        
    } catch (error) {
        console.error('❌ خطأ في حفظ البيانات:', error);
    }
}

// تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // ربط حدث input لحقل الكمية
    const quantityInput = document.getElementById('quantityInput');
    if (quantityInput) {
        quantityInput.addEventListener('input', updateQuantityCalculation);
        quantityInput.addEventListener('change', updateQuantityCalculation);
   
        // ربط حدث التركيز لتحديد النص عند النقر
        quantityInput.addEventListener('focus', function() {
            this.select();
        });
    }
     document.getElementById('addSendtBtn').style.display = 'none';
      document.getElementById('addSendtBtnLable').style.display = 'none';
    // حساب القيم الابتدائية
    updateQuantityCalculation();
    initSendOrderButton();
});
document.addEventListener('click', function(event) {
    // إذا كان العنصر الذي تم النقر عليه هو زر إرسال الطلب
    if (event.target && event.target.id === 'addSendtBtn') {
        sendOrderHandler();
    }
});
    // أيضاً تهيئة عند فتح نافذة طلباتي
    document.getElementById('myOrdersModal').addEventListener('click', function() {
        setTimeout(() => {
            initQuantityInputSystem();
            initSendOrderButton(); 
        }, 500);
    });
function initSendOrderButton() {
    const sendOrderBtn = document.getElementById('addSendtBtn');
    
    if (sendOrderBtn) {
        // إزالة أي أحداث سابقة
        sendOrderBtn.removeEventListener('click', sendOrderHandler);
        
        // إضافة حدث جديد
        sendOrderBtn.addEventListener('click', sendOrderHandler);
        
        console.log('✅ تم تهيئة زر إرسال الطلب');
    } else {
        console.error('❌ زر إرسال الطلب غير موجود');
    }
}

// معالج إرسال الطلب


async function sendOrderHandler() {
    showLoading(true,'جاري ارسال الطلب  ')
    
    // الحصول على العدد المطلوب
    const quantityInputNoElement = document.getElementById('counter-QuantityInputNo');
    let quantity = 0;
    
    if (quantityInputNoElement) {
        const quantityText = quantityInputNoElement.textContent || quantityInputNoElement.innerText;
        quantity = parseInt(quantityText.replace(/[^\d]/g, '')) || 0;
        console.log(`📊 العدد المستخرج: ${quantity}`);
    }
    
    // التحقق من وجود كمية صالحة
    if (quantity <= 0) {
        alert('⚠️ الرجاء إدخال عدد صالح أولاً');
        return;
    }
    
    // الحصول على المستخدم الحالي
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userPhone = currentUser.signupPhone || currentUser.phone;
    const userId = currentUser.ID || '';
    const userName = currentUser.fullname || 'مستخدم';
    
    if (!userPhone) {
        alert('يجب تسجيل الدخول أولاً');
        return;
    }
    
    // حساب القيم
    const unitPrice = 0.500;
    const totalPrice = quantity * unitPrice;
    const taxRate = 0.05;
    const taxAmount = totalPrice * taxRate;
    const grandTotal = totalPrice + taxAmount;
    
    // إنشاء بيانات الطلب
    const orderData = {
        // بيانات الطلب الأساسية
        id: Date.now().toString(),
        orderNo: generateOrderNo(),
        orderDate: new Date().toISOString().split('T')[0],
        signupPhone: userPhone,
        expiryDate: getExpiryDate(180), // 6 أشهر
        quantity: quantity,
        unitPrice: unitPrice,
        totalPrice: totalPrice.toFixed(3),
        taxAmount: taxAmount.toFixed(3),
        grandTotal: grandTotal.toFixed(3),
        orderStatus: 'غير نشط',
        
        // بيانات المستخدم
        idUser: userId,
        userPhone: userPhone,
        userName: userName,
        signupPhoneUser: userPhone,
       
        // معلومات إضافية
        timestamp: new Date().toISOString(),
        situation: 'Pending For Pay',
        notes: 'تم إضافة الطلب عبر زر إرسال الطلب',
        source: 'myOrdersModal'

    };
    
    try {
        // 1. تحديث العدادات المحلية
        updateLocalCounters(quantity);
        
        // 2. حفظ الطلب في Google Sheets
        const saveSuccess = await saveOrderToGoogleSheets(orderData);
        
        if (saveSuccess) {
           
            // 3. تحديث العدادات في Excel
            await updateUserCountersInSheet(orderData);
            
            // 4. عرض رسالة النجاح
            showNotification(`✅ تم إرسال الطلب وإضافة طلب جديد رقم ${orderData.orderNo}`, 'success');
         
            // 5. تحديث واجهة إدارة الطلبات إذا كانت مفتوحة
            if (document.getElementById('orderManagementModal').style.display === 'flex') {
                await loadOrdersData();
                
            }
        } else {
            showNotification('⚠️ تم إرسال الطلب ولكن لم يتم حفظه في السجلات', 'warning');
        }
        
    } catch (error) {
        console.error('❌ خطأ في إرسال الطلب:', error);
        showNotification('❌ حدث خطأ في إرسال الطلب', 'error');
    }
    
    // إعادة تعيين القيم
    resetOrderForm();
    showLoading(false)
    console.log('✅ تم إكمال عملية إرسال الطلب:', orderData);
    
}


// دالة لتحديث عدادات المستخدم في Excel

// دالة محسنة لتحديث العدادات
async function updateUserCountersInSheet(orderData) {
    return new Promise((resolve, reject) => {
        const UPDATE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTG_11hwYCUPcFiFAA0z49odKHdBOz2J-wIL6PnmTD7CpVynVSTJluka1yjg3vom82/exec';
        
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            reject(new Error('لا يوجد مستخدم مسجل'));
            return;
        }
        
        // الحصول على كمية الطلب من orderData
        const quantity = orderData.quantity || 1;
        
        // جميع القيم نفس الكمية
        let url = UPDATE_SCRIPT_URL + 
                 '?action=updateUser' +
                 '&phone=' + encodeURIComponent(userPhone) +
                 '&TotalQuantity=' + encodeURIComponent(quantity) +
                 '&ActiveNo=0' +
                 '&UnActiveNo=' + encodeURIComponent(quantity) +
                 '&ExpiredNo=0' +
                 '&DeleteNo=0' +
                 '&AddNo=' + encodeURIComponent(quantity) +
                 '&callback=handleUpdateResponse' +
                 '&t=' + new Date().getTime();
        
        console.log('🔗 إرسال طلب JSONP إلى:', url);
        
        // استخدام JSONP فقط
        const script = document.createElement('script');
        script.src = url;
        
        window.handleUpdateResponse = function(response) {
            console.log('📥 استجابة من السيرفر:', response);
            
            // تنظيف
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleUpdateResponse;
            
            if (response && response.success) {
                resolve(response);
            } else {
                reject(new Error(response ? response.message : 'لا توجد استجابة من السيرفر'));
            }
        };
        
        script.onerror = function(error) {
            console.error('💥 خطأ في تحميل السكريبت:', error);
            
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleUpdateResponse;
            
            reject(new Error('فشل في الاتصال'));
        };
        
        document.head.appendChild(script);
        
        // إضافة timeout
        setTimeout(() => {
            if (window.handleUpdateResponse) {
                console.warn('⚠️ انتهت مهلة الطلب');
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window.handleUpdateResponse;
                reject(new Error('انتهت مهلة الطلب'));
            }
        }, 30000);
    });
}

async function getCurrentCounters(userPhone) {
    try {
        const COUNTERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvQFP0-UoTQANtYjgFEVj68ma-rgdrOtUf6F9jp_IpUwfqyg0UVMjvGzVqf8Llusc/exec';
        
        const url = `${COUNTERS_SCRIPT_URL}?action=getUserCounters&phone=${encodeURIComponent(userPhone)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                return data.counters || {
                    TotalQuantity: 0,
                    ActiveNo: 0,
                    UnActiveNo: 0,
                    ExpiredNo: 0,
                    DeleteNo: 0,
                    AddNo: 0
                };
            }
        }
        
        // في حالة الفشل، إرجاع قيم افتراضية
        return {
            TotalQuantity: 0,
            ActiveNo: 0,
            UnActiveNo: 0,
            ExpiredNo: 0,
            DeleteNo: 0,
            AddNo: 0
        };
        
    } catch (error) {
        console.error('خطأ في جلب العدادات:', error);
        return {
            TotalQuantity: 0,
            ActiveNo: 0,
            UnActiveNo: 0,
            ExpiredNo: 0,
            DeleteNo: 0,
            AddNo: 0
        };
    }
}



function updateLocalCounters(quantity) {
    // تحديث العداد الإجمالي
    const totalCounter = document.getElementById('counter-total');
    if (totalCounter) {
        const currentTotal = parseInt(totalCounter.textContent) || 0;
        const newTotal = currentTotal + quantity;
        totalCounter.textContent = newTotal;
        
        totalCounter.style.transform = 'scale(1.2)';
        totalCounter.style.color = '#3498db';
        setTimeout(() => {
            totalCounter.style.transform = 'scale(1)';
            totalCounter.style.color = '#2c3e50';
        }, 500);
    }
    
    // تحديث العداد غير النشط
    const unactiveCounter = document.getElementById('counter-unactive');
    if (unactiveCounter) {
        const currentUnactive = parseInt(unactiveCounter.textContent) || 0;
        const newUnactive = currentUnactive + quantity;
        unactiveCounter.textContent = newUnactive;
        
        unactiveCounter.style.transform = 'scale(1.2)';
        unactiveCounter.style.color = '#f39c12';
        setTimeout(() => {
            unactiveCounter.style.transform = 'scale(1)';
        }, 500);
    }
}

// دالة للحصول على تاريخ الانتهاء
function getExpiryDate(daysToAdd) {
    const date = new Date();
    date.setDate(date.getDate() + daysToAdd);
    return date.toISOString().split('T')[0];
}

// دالة لإضافة الطلب إلى جدول الطلبات
function addOrderToTable(orderData) {
    const tableBody = document.getElementById('ordersTableBody');
    
    if (!tableBody) {
        console.warn('جدول الطلبات غير موجود');
        return;
    }
    
    // إنشاء صف جديد
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td style="font-weight: bold; color: #2c3e50;">${orderData.orderNo}</td>
        <td>${orderData.orderDate}</td>
        <td style="color: #e74c3c; font-weight: bold;">${orderData.quantity}</td>
        <td>${orderData.unitPrice.toFixed(3)}</td>
        <td style="color: #27ae60; font-weight: bold;">${orderData.totalPrice.toFixed(3)}</td>
        <td>${orderData.taxAmount.toFixed(3)}</td>
        <td style="color: #d35400; font-weight: bold;">${orderData.grandTotal.toFixed(3)}</td>
        <td>${orderData.expiryDate}</td>
        <td>
            <span class="status-badge" style="
                background: #f39c12;
                color: white;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 12px;
                display: inline-block;
                font-weight: bold;
                min-width: 70px;
                text-align: center;
            ">
                غير نشط
            </span>
        </td>
        <td>
            <button onclick="sendActivationRequest('${orderData.orderNo}')" 
                    class="btn-activate" 
                    style="
                        background: linear-gradient(135deg, #25D366, #128C7E);
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        display: inline-flex;
                        align-items: center;
                        gap: 5px;
                    ">
                <i class="fab fa-whatsapp"></i> تنشيط
            </button>
        </td>
    `;
    
    // إضافة الصف في البداية
    if (tableBody.firstChild) {
        tableBody.insertBefore(newRow, tableBody.firstChild);
    } else {
        tableBody.appendChild(newRow);
    }
    
    // إضافة تأثير ظهور
    newRow.style.opacity = '0';
    newRow.style.transform = 'translateY(-20px)';
    newRow.style.transition = 'all 0.5s ease';
    
    setTimeout(() => {
        newRow.style.opacity = '1';
        newRow.style.transform = 'translateY(0)';
    }, 10);
    
    console.log(`✅ تم إضافة الطلب ${orderData.orderNo} إلى الجدول`);
}
// دالة تحديث إحصائيات الطلبات
function updateOrdersStatsAfterAddition(quantity) {
    // تحديث الإحصائيات في نافذة إدارة الطلبات
    const totalOrdersElement = document.getElementById('totalOrders');
    const inactiveOrdersElement = document.getElementById('inactiveOrders');
    
    if (totalOrdersElement) {
        const currentTotal = parseInt(totalOrdersElement.textContent) || 0;
        totalOrdersElement.textContent = currentTotal + 1;
        
        // تأثير مرئي
        totalOrdersElement.style.transform = 'scale(1.2)';
        totalOrdersElement.style.color = '#3498db';
        setTimeout(() => {
            totalOrdersElement.style.transform = 'scale(1)';
            totalOrdersElement.style.color = 'inherit';
        }, 500);
    }
    
    if (inactiveOrdersElement) {
        const currentInactive = parseInt(inactiveOrdersElement.textContent) || 0;
        inactiveOrdersElement.textContent = currentInactive + 1;
        
        // تأثير مرئي
        inactiveOrdersElement.style.transform = 'scale(1.2)';
        inactiveOrdersElement.style.color = '#f39c12';
        setTimeout(() => {
            inactiveOrdersElement.style.transform = 'scale(1)';
            inactiveOrdersElement.style.color = 'inherit';
        }, 500);
    }
}
// دالة تحديث عنوان الجدول
function updateTableHeader(isAdmin) {
    const tableHeader = document.querySelector('.orders-table thead');
    if (tableHeader) {
        let headerHTML = `
            <tr>
                <th style="width: 50px;">#</th>
                <th>رقم الطلب ${isAdmin ? '(جميع المستخدمين)' : ''}</th>
                <th>تاريخ الطلب</th>
                <th> الهاتف</th>
                <th>العدد</th>
                <th>سعر الواحد</th>
                <th>سعر الكل</th>
                <th>الضريبة</th>
                <th>الإجمالي</th>
                <th>تاريخ الانتهاء</th>
                <th>الحالة</th>
                <th>طلب التنشيط</th>
            </tr>
        `;
        
        tableHeader.innerHTML = headerHTML;
    }
}
// دالة لاستخراج تاريخ الطلب
function getOrderDate(order) {
    // محاولة الحصول على التاريخ من عدة مصادر
    const possibleDateFields = [
        'timestamp', 'Timestamp', 'date', 'Date',
        'orderDate', 'OrderDate', 'order_date',
        'creationDate', 'creation_date', 'تاريخ الإضافة'
    ];
    
    for (const field of possibleDateFields) {
        if (order[field]) {
            const date = new Date(order[field]);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
    }
    
    // إذا لم يتم العثور، استخدم التاريخ الحالي
    return new Date();
}

// دالة متقدمة لتطبيع بيانات الطلب مع دعم التاريخ
function normalizeOrderData(order) {
    const normalized = { ...order };
    
    // 1. تطبيع حالة الطلب
    const possibleStatusKeys = [
        'orderStatus', 'OrderStatus', 'orderstatus',
        'status', 'Status', 'STATUS',
        'حالة', 'الحالة', 'حالة الطلب',
        'situation', 'Situation', 'SITUATION',
        'state', 'State', 'STATE'
    ];
    
    let orderStatus = 'غير نشط';
    
    for (const key of possibleStatusKeys) {
        if (order[key] !== undefined && order[key] !== null && order[key] !== '') {
            const value = order[key].toString().trim();
            if (value) {
                orderStatus = value;
                break;
            }
        }
    }
    
    normalized.orderStatus = orderStatus;
    normalized.status = orderStatus;
    
    // 2. تطبيع رقم الهاتف
    const possiblePhoneKeys = [
        'signupPhoneUser', 'userPhone', 'phone', 'Phone',
        'رقم الهاتف', 'هاتف', 'الهاتف',
        'userPhoneNumber', 'phoneNumber'
    ];
    
    for (const key of possiblePhoneKeys) {
        if (order[key] !== undefined && order[key] !== null && order[key] !== '') {
            const phone = order[key].toString().trim();
            if (phone) {
                normalized.signupPhoneUser = phone;
                normalized.userPhone = phone;
                break;
            }
        }
    }
    
    // 3. تطبيع اسم المستخدم
    const possibleNameKeys = [
        'userName', 'username', 'fullname', 'FullName',
        'اسم المستخدم', 'الاسم', 'اسم'
    ];
    
    for (const key of possibleNameKeys) {
        if (order[key] !== undefined && order[key] !== null && order[key] !== '') {
            const name = order[key].toString().trim();
            if (name) {
                normalized.userName = name;
                break;
            }
        }
    }
    
    // 4. تطبيع التاريخ
    const possibleDateFields = [
        'timestamp', 'Timestamp', 'date', 'Date',
        'orderDate', 'OrderDate', 'order_date',
        'creationDate', 'creation_date', 'تاريخ الإضافة'
    ];
    
    for (const field of possibleDateFields) {
        if (order[field]) {
            const date = new Date(order[field]);
            if (!isNaN(date.getTime())) {
                normalized.timestamp = date.toISOString();
                normalized.orderDate = date.toISOString().split('T')[0];
                break;
            }
        }
    }
    
    // 5. إذا لم يوجد تاريخ، استخدم الحالي
    if (!normalized.timestamp) {
        const now = new Date();
        normalized.timestamp = now.toISOString();
        normalized.orderDate = now.toISOString().split('T')[0];
    }
    
    // 6. تأكد من وجود جميع الحقول المطلوبة
    if (!normalized.orderNo && normalized.id) {
        normalized.orderNo = `ORD-${normalized.id}`;
    }
    
    if (!normalized.expiryDate && normalized.orderDate) {
        const orderDate = new Date(normalized.orderDate);
        orderDate.setMonth(orderDate.getMonth() + 6);
        normalized.expiryDate = orderDate.toISOString().split('T')[0];
    }
    
    // 7. تحويل القيم الرقمية
    const numericFields = ['quantity', 'unitPrice', 'totalPrice', 'taxAmount', 'grandTotal'];
    numericFields.forEach(field => {
        if (normalized[field]) {
            const numValue = parseFloat(normalized[field]);
            if (!isNaN(numValue)) {
                normalized[field] = numValue;
            }
        }
    });
    
    return normalized;
}

// دالة لتحديث واجهة المسؤول
function updateAdminInterface() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const isAdmin = currentUser.userstate === 'Admin';
    
    // إضافة زر تصدير للمسؤول
    if (isAdmin) {
        addExportButton();
        addFilterControls();
        addOrderStatistics();
    }
}

// دالة إضافة زر تصدير
function addExportButton() {
    const header = document.querySelector('.order-management-header');
    
    if (header && !document.getElementById('exportOrdersBtn')) {
        const exportBtn = document.createElement('button');
        exportBtn.id = 'exportOrdersBtn';
        exportBtn.innerHTML = '<i class="fas fa-download"></i> تصدير Excel';
        exportBtn.className = 'btn btn-secondary';
        exportBtn.style.marginRight = '10px';
        
        exportBtn.addEventListener('click', exportOrdersToExcel);
        
        header.appendChild(exportBtn);
    }
}
// ==================== نظام البحث في الطلبات ====================

// دالة البحث في الطلبات
// دالة البحث في الطلبات
function searchOrders() {
    const searchTerm = document.getElementById('orderSearch').value.trim();
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const searchResultsText = document.getElementById('searchResultsText');
    
    if (!searchTerm) {
        showAllOrders();
        searchResultsInfo.style.display = 'none';
        return;
    }
    
    console.log('🔍 البحث عن:', searchTerm);
    
    // تطبيع مصطلح البحث
    const normalizedSearchTerm = searchTerm.replace(/[^\d]/g, '');
    
    // البحث في الطلبات
    const filteredOrders = ordersData.filter(order => {
        // البحث برقم الطلب
        if (order.orderNo && order.orderNo.toString().toLowerCase().includes(searchTerm.toLowerCase())) {
            return true;
        }
        
        // البحث برقم الهاتف
        if (order.signupPhoneUser && order.signupPhoneUser.toString().includes(normalizedSearchTerm)) {
            return true;
        }
        
        // البحث برقم الهاتف البديل
        if (order.userPhone && order.userPhone.toString().includes(normalizedSearchTerm)) {
            return true;
        }
        
        // البحث برقم الهاتف البديل 2
        if (order.phone && order.phone.toString().includes(normalizedSearchTerm)) {
            return true;
        }
        
        return false;
    });
    
    // عرض النتائج
    displaySearchResults(filteredOrders);
    
    // تحديث معلومات نتائج البحث
    if (filteredOrders.length > 0) {
        searchResultsText.textContent = `تم العثور على ${filteredOrders.length} طلب تطابق "${searchTerm}"`;
        searchResultsInfo.style.display = 'block';
        searchResultsInfo.style.background = '#e3f2fd';
    } else {
        searchResultsText.textContent = `لا توجد نتائج تطابق "${searchTerm}"`;
        searchResultsInfo.style.display = 'block';
        searchResultsInfo.style.background = '#ffebee';
    }
}

// دالة عرض نتائج البحث
function displaySearchResults(filteredOrders) {
    const tableBody = document.getElementById('ordersTableBody');
    
    if (!tableBody) return;
    
    if (filteredOrders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="12" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-search" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <h3 style="margin: 10px 0;">لا توجد نتائج</h3>
                    <p style="color: #999;">لم يتم العثور على طلبات تطابق معايير البحث</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // الحصول على المستخدم الحالي
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const isAdmin = currentUser.userstate === 'Admin';
    
    let rowsHTML = '';
    
    filteredOrders.forEach((order, index) => {
        const orderNumber = index + 1;
        
        // تلوين صف المسؤول
        const rowClass = isAdmin ? 'admin-order-row' : '';
        const rowStyle = isAdmin ? 'background-color: #f8f9fa;' : '';
        
        // تنسيق التواريخ
        const orderDate = formatDisplayDate(order.orderDate || order.timestamp);
        const expiryDate = formatDisplayDate(order.expiryDate);
        
        // حالة الطلب
        const orderStatus = order.orderStatus || order.status || 'غير نشط';
        const isActive = orderStatus.toLowerCase().includes('نشط') || 
                        orderStatus.toLowerCase().includes('active');
        
        // تحديد لون الحالة
        const statusLower = orderStatus.toLowerCase();
        let statusColor = '#e74c3c'; // غير نشط - أحمر
        
        if (statusLower.includes('نشط') || statusLower.includes('active')) {
            statusColor = '#2ecc71'; // نشط - أخضر
        } else if (statusLower.includes('منتهي') || statusLower.includes('expired')) {
            statusColor = '#f39c12'; // منتهي - برتقالي
        } else if (statusLower.includes('ملغي') || statusLower.includes('cancelled')) {
            statusColor = '#95a5a6'; // ملغي - رمادي
        }
        
        const statusText = orderStatus;
        
        // عرض معلومات إضافية للمسؤول
        let adminInfo = '';
        if (isAdmin) {
            adminInfo = `
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    <i class="fas fa-user"></i> ${order.userName || 'غير معروف'}
                    <i class="fas fa-phone" style="margin-right: 10px;"></i> ${order.userPhone || 'غير معروف'}
                </div>
            `;
        }
        
        // تمييز نتيجة البحث
        const searchTerm = document.getElementById('orderSearch').value.trim().toLowerCase();
        let highlightedOrderNo = order.orderNo || `ORD-${order.id}`;
        let highlightedPhone = order.userPhone || order.signupPhoneUser || order.phone || '';
        
        if (searchTerm) {
            // تمييز رقم الطلب
            if (highlightedOrderNo.toLowerCase().includes(searchTerm)) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                highlightedOrderNo = highlightedOrderNo.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
            }
            
            // تمييز رقم الهاتف
            if (highlightedPhone.toLowerCase().includes(searchTerm)) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                highlightedPhone = highlightedPhone.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
            }
        }
        
        rowsHTML += `
            <tr class="${rowClass}" style="${rowStyle}" data-order-id="${order.id}" data-order-no="${order.orderNo}">
                <td style="text-align: center; font-weight: bold; color: #7f8c8d;">
                    ${orderNumber}
                </td>
                <td style="font-weight: bold; color: #2c3e50;">
                    ${highlightedOrderNo}
                    ${adminInfo}
                </td>
                <td>${orderDate}</td>
                <td style="color: #e74c3c; font-weight: bold; text-align: center;">${order.quantity || 0}</td>
                <td style="text-align: center;">${parseFloat(order.unitPrice || 0).toFixed(3)}</td>
                <td style="color: #27ae60; font-weight: bold; text-align: center;">${parseFloat(order.totalPrice || 0).toFixed(3)}</td>
                <td style="text-align: center;">${parseFloat(order.taxAmount || 0).toFixed(3)}</td>
                <td style="color: #d35400; font-weight: bold; text-align: center;">${parseFloat(order.grandTotal || 0).toFixed(3)}</td>
                <td>${expiryDate}</td>
                <td>
                    <span class="status-badge" style="
                        background: ${statusColor};
                        color: white;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        display: inline-block;
                        font-weight: bold;
                        min-width: 70px;
                        text-align: center;
                    ">
                        ${statusText}
                    </span>
                </td>
                <td>
                    ${isActive ? 
                        `<button onclick="quickActivationRequest('${order.id}')" 
        class="fab fa-whatsapp"
        data-order-id="${order.id}"
                                style="
                                    background: linear-gradient(135deg, #25D366, #128C7E);
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 600;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 5px;
                                ">
                            <i class="fab fa-whatsapp"></i> تنشيط
                        </button>` 
                        : 
                        `<span style="color: #999; font-size: 12px; padding: 6px 12px; display: inline-block;">
                            ${statusText}
                        </span>`
                    }
                </td>
                <td>
                    <div class="admin-only" style="display: ${isAdmin ? 'flex' : 'none'}; gap: 5px;">
                        <button class="btn-edit" onclick="editOrderFromTable('${order.orderNo}')" style="
                            background: #3498db;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                        ">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteOrderFromTable('${order.orderNo}')" style="
                            background: #e74c3c;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                        ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = rowsHTML;
    
    // إعادة ربط أحداث زر التنشيط
    attachActivationButtonEvents();
    
    console.log(`✅ عرض ${filteredOrders.length} نتيجة بحث`);
}
// دالة إعادة عرض جميع الطلبات
function showAllOrders() {
    updateOrdersTable(ordersData);
    document.getElementById('searchResultsInfo').style.display = 'none';
}
// دالة ربط أحداث زر التنشيط
function attachActivationButtonEvents() {
    // إزالة أي أحداث سابقة
    document.querySelectorAll('.btn-activate').forEach(btn => {
        btn.onclick = null;
    });
    
    // إضافة أحداث جديدة
    document.querySelectorAll('.btn-activate').forEach(btn => {
        const orderNo = btn.getAttribute('data-order-no');
        if (orderNo) {
            btn.onclick = function(e) {
                e.stopPropagation();
                sendActivationRequest(orderNo);
            };
        }
    });
    
    console.log(`✅ تم ربط أحداث لـ ${document.querySelectorAll('.btn-activate').length} زر تنشيط`);
}
// تهيئة نظام البحث
function initSearchSystem() {
    const searchInput = document.getElementById('orderSearch');
    const filterBtn = document.getElementById('filterOrdersBtn');
    const resetBtn = document.getElementById('resetFilterBtn');
    
    if (searchInput) {
        // البحث عند الضغط على Enter
        searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchOrders();
            }
        });
        
        // البحث عند إدخال نص (مع تأخير)
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchOrders();
            }, 500);
        });
    }
    
    if (filterBtn) {
        filterBtn.addEventListener('click', searchOrders);
    }
    
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            document.getElementById('orderSearch').value = '';
            showAllOrders();
        });
    }
}

// إضافة أنميشن لتسليط الضوء على الصف
if (!document.querySelector('#highlightAnimation')) {
    const style = document.createElement('style');
    style.id = 'highlightAnimation';
    style.textContent = `
        @keyframes highlightRow {
            0% { background-color: #e8f5e9; }
            50% { background-color: #c8e6c9; }
            100% { background-color: inherit; }
        }
    `;
    document.head.appendChild(style);
}
// ==================== تحديث حالة الطلب بعد التنشيط ====================

// دالة تحديث حالة الطلب في الصف مباشرة بعد التنشيط
async function activateOrderAndUpdateRow(orderNo) {
    try {
        console.log(`🎯 تفعيل الطلب: ${orderNo}`);
        
        // البحث عن الطلب في البيانات
        const orderIndex = ordersData.findIndex(o => o.orderNo === orderNo);
        if (orderIndex === -1) {
            showNotification('❌ الطلب غير موجود', 'error');
            return;
        }
        
        const order = ordersData[orderIndex];
        
        // التحقق من صلاحيات المسؤول
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (currentUser.userstate !== 'Admin') {
            showNotification('❌ هذه الميزة متاحة فقط للمسؤولين', 'error');
            return;
        }
        
        // تأكيد العملية
        if (!confirm(`هل تريد تفعيل الطلب ${orderNo}؟`)) {
            return;
        }
        
        // تحديث حالة الطلب في البيانات المحلية
        ordersData[orderIndex].status = 'نشط';
        ordersData[orderIndex].orderStatus = 'نشط';
        
        // تحديث الصف مباشرة في الجدول (بدون إعادة تحميل كامل الجدول)
        updateOrderRowInTable(orderNo, ordersData[orderIndex]);
        
        // تحديث الإحصائيات
        updateOrdersStats(ordersData);
        
        // إرسال إشعار
        showNotification(`✅ تم تفعيل الطلب ${orderNo} بنجاح`, 'success');
        
    } catch (error) {
        console.error('❌ خطأ في تفعيل الطلب:', error);
        showNotification('❌ حدث خطأ أثناء تفعيل الطلب', 'error');
    }
}


/**
 * دالة لجلب بيانات منتج معين من Google Sheets باستخدام رقم المنتج
 */
async function loadProductDataFromExcel(productNo) {
    try {
        console.log(`🔄 جاري تحميل بيانات المنتج رقم: ${productNo}`);
        
        // رابط Google Apps Script لجلب بيانات منتج واحد
        const PRODUCT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmilIObCMaMHo7oAzXo7gG_5TL8Z77LwYEXy7frVyZRzrBC2ETPDw3mxN-Ef883yo3/exec';
        
        const url = `${PRODUCT_SCRIPT_URL}?action=getProductByNo&productNo=${encodeURIComponent(productNo)}&t=${Date.now()}`;
     
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`خطأ في الخادم: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('📦 بيانات المنتج من السيرفر:', data);
        
        if (data.success === true && data.product) {
            // معالجة بيانات المنتج
            const productData = processSingleProductData(data.product);
            console.log('✅ بيانات المنتج المعالجة:', productData);
            return productData;
        } else {
            throw new Error(data.error || 'المنتج غير موجود في قاعدة البيانات');
        }
        
    } catch (error) {
        console.error('❌ خطأ في تحميل بيانات المنتج:', error);
        showNotification(`❌ ${error.message}`, 'error');
        return null;
    } finally {
        showLoading(false);
    }
}

/**
 * دالة معالجة بيانات منتج واحد
 */
function processSingleProductData(productRaw) {
    if (!productRaw) return null;
    
    console.log('🔍 معالجة بيانات المنتج الخام:', productRaw);
    
    // استخراج الصور
    let images = [];
    const imageFields = ['image1', 'image2', 'image3', 'image', 'صورة1', 'صورة2', 'صورة3'];
    
    imageFields.forEach(field => {
        if (productRaw[field] && productRaw[field].trim().startsWith('http')) {
            images.push(productRaw[field].trim());
        }
    });
    
    if (images.length === 0) {
        images = ['https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=200&fit=crop'];
    }
    
    // استخراج الموقع من الخريطة
    let locationLink = '';
    const locationFields = ['locationLink', 'productLocationLink', 'storeLat', 'رابط الموقع'];
    locationFields.forEach(field => {
        if (productRaw[field] && productRaw[field].trim()) {
            locationLink = productRaw[field].trim();
        }
    });
    
    // استخراج إحداثيات الموقع
    let coordinates = null;
    if (locationLink) {
        coordinates = extractCoordinatesFromLink(locationLink);
    }
    
    // بناء كائن المنتج المنظم
    const processedProduct = {
        // الحقول الأساسية
        productNo: productRaw.productNo || '',
        productName: productRaw.productName || '',
        custel: productRaw.custel || '',
        productCategory: productRaw.productCategory || '',
        productPrice: productRaw.productPrice || '',
        productState: productRaw.productState || 'جديد',
        productQuantity: productRaw.productQuantity || '1',
        productDescription: productRaw.productDescription || '',
        productColor: productRaw.productColor || '',
        productWarranty: productRaw.productWarranty || '',
        
        // الموقع
        productLocationState: productRaw.state || productRaw.productLocationState || '',
        productLocationName: productRaw.productLocationName || productRaw.locationName || '',
        productLocationLink: locationLink,
        locationCoordinates: coordinates,
        
        // الحالة والتواريخ
        productSituation: productRaw.situation || 'Active',
        productExpiredDate: productRaw.productExpiredDate || '',
        timestamp: productRaw.timestamp || productRaw.Timestamp || new Date().toISOString(),
        
        // الصور
        images: images.slice(0, 3),
        
        // البيانات الأصلية للرجوع إليها
        rawData: productRaw
    };
    
    return processedProduct;
}

/**
 * دالة تحميل بيانات المنتج في نموذج التعديل
 */
async function loadProductDataForEdit(productNo) {
    try {
        if (!productNo) {
            showNotification('❌ رقم المنتج غير صالح', 'error');
            return;
        }
        
        console.log(`🎯 تحميل منتج للتعديل: ${productNo}`);
        
        // 1. جلب بيانات المنتج من Excel
        const productData = await loadProductDataFromExcel(productNo);
        
        if (!productData) {
            showNotification('❌ تعذر تحميل بيانات المنتج', 'error');
            return;
        }
        
        // 2. 🔥 **تخزين المنتج الحالي في المتغير العالمي**
        currentEditingProduct = productData;
        currentEditingProductNo = productNo;
        
        console.log('💾 تم تخزين المنتج الحالي:', currentEditingProduct);
        
        // 3. فتح نافذة إضافة المنتج في وضع التعديل
        document.getElementById('addProductModal').style.display = 'flex';
        
        // 4. تعبئة الحقول
        fillProductFormWithData(productData);
        
        // 5. تحديث عنوان النافذة
        updateModalTitleForEdit(productNo);
        
        // 6. تهيئة الخريطة بموقع المنتج
        initProductMapWithLocation(productData);
        
        // 7. تحديث زر الحفظ
        updateSubmitButtonForEdit(productNo);
        
        showNotification(`✅ تم تحميل بيانات المنتج ${productNo}`, 'success');
        
    } catch (error) {
        console.error('💥 خطأ في تحميل بيانات التعديل:', error);
        showNotification('❌ حدث خطأ في تحميل بيانات المنتج', 'error');
    }
}
/**
 * دالة تعبئة النموذج ببيانات المنتج
 */
function fillProductFormWithData(productData) {
    console.log('📝 تعبئة النموذج بالبيانات:', productData);
    
    // الحقول الأساسية
    document.getElementById('productNo').value = productData.productNo || '';
    document.getElementById('productName').value = productData.productName || '';
    document.getElementById('custel').value = productData.custel || '';
    document.getElementById('productCategory').value = productData.productCategory || '';
    document.getElementById('productWarranty').value = productData.productWarranty || '';
    document.getElementById('productPrice').value = productData.productPrice || '';
    document.getElementById('productQuantity').value = productData.productQuantity || '1';
    document.getElementById('productState').value = productData.productState || 'جديد';
    document.getElementById('productColor').value = productData.productColor || '';
    document.getElementById('productLocationState').value = productData.productLocationState || '';
    document.getElementById('productLocationName').value = productData.productLocationName || '';
     document.getElementById('productDescription').value = productData.productDescription || '';
    document.getElementById('productSituation').value = productData.productSituation || '';
    
      // 🔥 **تاريخ الإضافة (جديد)**
    if (productData.productAddDate) {
        document.getElementById('productAddDate').value = productData.productAddDate;
        console.log('📅 تاريخ الإضافة:', productData.productAddDate);
    } else if (productData.timestamp) {
        // استخدام timestamp إذا كان موجوداً
        const addDate = new Date(productData.timestamp).toISOString().split('T')[0];
        document.getElementById('productAddDate').value = addDate;
    } else {
        // تاريخ اليوم إذا لم يكن هناك تاريخ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('productAddDate').value = today;
    }
    
    // 🔥 **تاريخ الانتهاء مع التحقق**
    if (productData.productExpiredDate) {
        document.getElementById('productExpiredDate').value = productData.productExpiredDate;
        console.log('📅 تاريخ الانتهاء:', productData.productExpiredDate);
       
        // 🔥 **التحقق من انتهاء الصلاحية وإضافة رسالة**
        checkExpiryAndShowMessage(productData.productExpiredDate);
       
    } else {
        // إذا لم يكن هناك تاريخ انتهاء، حساب تاريخ جديد
        initProductDatesExpired();
    }
    

    if (productData.productLocationLink) {
        document.getElementById('productLocationLink').value = productData.productLocationLink;
    }
    
    // تحميل الصور
    if (productData.images && productData.images.length > 0) {
        productImages = productData.images.map(img => ({
            file: null,
            preview: img
        }));
        updateProductImagesPreview();
        console.log('🖼️ تم تحميل الصور:', productData.images.length);
    }
    
    // تعطيل بعض الحقول لمنع التعديل
    disableReadonlyFields();
}
// 🔥 **نسخة مبسطة لإضافة زر التجديد**
function addSimpleRenewButton() {
    const expiryField = document.getElementById('productExpiredDate');
    if (!expiryField) return;
    
    // التحقق إذا كان الزر موجوداً
    if (document.getElementById('simpleRenewButton')) return;
    
    // إزالة رسالة "انتهت الصلاحية" القديمة إذا كانت موجودة
    const oldMessage = document.getElementById('expiryMessage');
    if (oldMessage) {
        oldMessage.remove();
    }
    
    // إعادة لون البوردر إلى الطبيعي
    expiryField.style.borderColor = '#28a745';
    expiryField.style.borderWidth = '2px';
    expiryField.style.boxShadow = '0 0 5px rgba(40, 167, 69, 0.3)';
    
    // إنشاء زر بسيط
    const button = document.createElement('button');
    button.id = 'simpleRenewButton';
    button.type = 'button';
    button.textContent = 'تجديد لمدة 6 أشهر';
    button.style.cssText = `
        margin-right: 10px;
        padding: 8px 15px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s;
    `;
    
    // تأثير عند المرور على الزر
    button.addEventListener('mouseenter', function() {
        this.style.background = '#218838';
        this.style.transform = 'translateY(-1px)';
    });
    
    button.addEventListener('mouseleave', function() {
        this.style.background = '#28a745';
        this.style.transform = 'translateY(0)';
    });
    
    button.onclick = function() {
        // حساب تاريخ جديد
        const today = new Date();
        const newDate = new Date(today);
        newDate.setMonth(today.getMonth() + 6);
        
        const year = newDate.getFullYear();
        const month = String(newDate.getMonth() + 1).padStart(2, '0');
        const day = String(newDate.getDate()).padStart(2, '0');
        const newDateFormatted = `${year}-${month}-${day}`;
        
        // تحديث الحقل
        expiryField.value = newDateFormatted;
        
        // تغيير لون البوردر إلى اللون الطبيعي (رمادي)
        expiryField.style.borderColor = '#ced4da';
        expiryField.style.borderWidth = '1px';
        expiryField.style.boxShadow = 'none';
        expiryField.style.backgroundColor = '#fff';
        
        // إزالة الزر
        button.remove();
        
        // إضافة رسالة "تم التجديد" بدلاً من alert
        showRenewalSuccessMessage(newDateFormatted);
    };
    
    // إضافة الزر بجانب الحقل
   const expiryMessage = document.querySelector('#expiryMessage'); // اضبط المحدد حسب هيكلك

if (expiryMessage) {
    expiryMessage.insertAdjacentElement('afterend', button);
} else {
    // إذا لم توجد رسالة، أضفها ثم أضف الزر
    addExpiryMessage(); // استدعاء الدالة أولاً
    const expiryMessage = document.querySelector('#expiryMessage'); // افترض أن الدالة تضيف عنصراً بهذا ID
    if (expiryMessage) {
        expiryMessage.insertAdjacentElement('afterend', button);
    }
}
}

// 🔥 **دالة لعرض رسالة نجاح التجديد**
function showRenewalSuccessMessage(newDate) {
    // إزالة أي رسالة نجاح سابقة
    const oldSuccessMessage = document.getElementById('renewalSuccessMessage');
    if (oldSuccessMessage) {
        oldSuccessMessage.remove();
    }
    
    // تحويل التاريخ إلى صيغة مقروءة
    const formattedDate = formatDateToDMY(newDate) || newDate;
    
    // إنشاء رسالة النجاح
    const successDiv = document.createElement('div');
    successDiv.id = 'renewalSuccessMessage';
    successDiv.style.cssText = `
        margin-top: 8px;
        padding: 10px 15px;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-radius: 6px;
        font-size: 13px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: fadeIn 0.5s ease;
    `;
    
    successDiv.innerHTML = `
        <i class="fas fa-check-circle" style="color: #28a745; font-size: 16px;"></i>
        <div>
            <div>✅ تم التجديد إلى 6 أشهر</div>
            <div style="font-size: 12px; color: #0c5460; margin-top: 3px; font-weight: normal;">
                تاريخ الانتهاء الجديد: ${formattedDate}
            </div>
            <div style="font-size: 11px; color: #0c5460; margin-top: 5px; background: #f8d7da; padding: 4px 8px; border-radius: 3px; border: 1px solid #f5c6cb;">
                <i class="fas fa-exclamation-triangle"></i> سيتم الخصم من رصيدك - يرجى حفظ التعديلات لإكمال العملية
            </div>
        </div>
    `;
    
    // إضافة الرسالة بعد حقل التاريخ
    const expiryField = document.getElementById('productExpiredDate');
    if (expiryField) {
        // إزالة رسالة "انتهت الصلاحية" إذا كانت موجودة
        const expiryMessage = document.getElementById('expiryMessage');
        if (expiryMessage) {
            expiryMessage.remove();
        }
        
        // إضافة رسالة النجاح
        expiryField.parentNode.insertBefore(successDiv, expiryField.nextSibling);
    }
    
    // إضافة CSS للأنيميشن إذا لم يكن موجوداً
    if (!document.querySelector('style#renewal-styles')) {
        const style = document.createElement('style');
        style.id = 'renewal-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    }
    
    console.log('✅ عرض رسالة نجاح التجديد');
}
// 🔥 **دالة التحقق من انتهاء الصلاحية وإضافة رسالة**
function checkExpiryAndShowMessage(expiryDateString) {
    try {
        const expiryDate = new Date(expiryDateString);
        const today = new Date();
        
        expiryDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        console.log('🔍 التحقق من الصلاحية:', {
            'تاريخ الانتهاء': expiryDate.toISOString().split('T')[0],
            'تاريخ اليوم': today.toISOString().split('T')[0],
            'هل انتهى؟': expiryDate < today
        });
        
        if (expiryDate < today) {
            // إذا انتهت الصلاحية، نضيف رسالة التحذير والزر
            addExpiryMessage();
            addSimpleRenewButton();
             removeRenewalSuccessMessage();
        } else {
            // إذا لم تنته، نزيل الرسالة والزر
            removeExpiryMessage();
            removeRenewButton();
           
        }
        
    } catch (error) {
        console.error('❌ خطأ في تاريخ الانتهاء:', error);
    }
}
function removeRenewalSuccessMessage() {
    // البحث عن رسالة النجاح وإزالتها
    const successMessage = document.getElementById('renewalSuccessMessage');
    if (successMessage) {
        successMessage.remove();
        console.log('✅ تمت إزالة رسالة نجاح التجديد');
        return true;
    }
    
    console.log('⚠️ لم يتم العثور على رسالة نجاح التجديد');
    return false;
}
// 🔥 **دالة إضافة رسالة انتهاء الصلاحية**
function addExpiryMessage() {
    // إزالة الرسالة القديمة إذا كانت موجودة
  removeExpiryMessage();
    // الحصول على حقل تاريخ الانتهاء
    const expiryDateField = document.getElementById('productExpiredDate');
    if (!expiryDateField) return;
    
    // إنشاء عنصر الرسالة
    const messageDiv = document.createElement('div');
    messageDiv.id = 'expiryMessage';
    messageDiv.style.cssText = `
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 5px;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: fadeIn 0.3s ease;
    `;
    
    messageDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <span>⚠️ انتهت صلاحية المنتج</span>
    `;
    
    // إضافة الرسالة بعد حقل تاريخ الانتهاء
    expiryDateField.parentNode.insertBefore(messageDiv, expiryDateField.nextSibling);
    
    // إضافة تأثير لحقل التاريخ
    expiryDateField.style.borderColor = '#dc3545';
    expiryDateField.style.backgroundColor = '#fff5f5';
    expiryDateField.style.color = '#dc3545';
    
    console.log('✅ تم إضافة رسالة انتهاء الصلاحية');
}
// 🔥 **دالة إزالة زر التجديد**
function removeRenewButton() {
    const button = document.getElementById('simpleRenewButton');
    if (button) {
        button.remove();
    }
}
// 🔥 **دالة إزالة رسالة انتهاء الصلاحية**
function removeExpiryMessage() {
    const existingMessage = document.getElementById('expiryMessage');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // إعادة تنسيق حقل التاريخ
    const expiryDateField = document.getElementById('productExpiredDate');
    if (expiryDateField) {
        expiryDateField.style.borderColor = '';
        expiryDateField.style.backgroundColor = '';
        expiryDateField.style.color = '';
    }
}

// 🔥 **إضافة CSS للأنيميشن**
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    #expiryMessage {
        animation: fadeIn 0.3s ease, pulse 2s infinite;
    }
`;
document.head.appendChild(style);
/**
 * تحديث عنوان النافذة للتعديل
 */
function updateModalTitleForEdit(productNo) {
    const modalTitle = document.querySelector('#addProductModal h2');
    if (modalTitle) {
        modalTitle.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-edit" style="color: #3498db;"></i>
                <span>تعديل المنتج</span>
                <span style="font-size: 14px; color: white; margin-right: 10px;">
                    (رقم: ${productNo})
                </span>
            </div>
        `;
    }
}

/**
 * تهيئة الخريطة بموقع المنتج
 */
function initProductMapWithLocation(productData) {
    setTimeout(() => {
        // إعادة تهيئة الخريطة إذا لم تكن موجودة
        if (!productMap) {
            initProductMap();
        }
        
        // إذا كان هناك رابط موقع، تحميله على الخريطة
        if (productData.productLocationLink) {
            const coords = extractCoordinatesFromLink(productData.productLocationLink);
            if (coords && productMap) {
                productMap.setView([coords.lat, coords.lng], 15);
                if (productLocationMarker) {
                    productLocationMarker.setLatLng([coords.lat, coords.lng]);
                    updateProductLocationFields(coords.lat, coords.lng);
                    reverseProductGeocode(coords.lat, coords.lng);
                }
            }
        }
        
        // إذا كان هناك إحداثيات مباشرة
        if (productData.locationCoordinates) {
            const coords = productData.locationCoordinates;
            if (productMap) {
                productMap.setView([coords.lat, coords.lng], 15);
                if (productLocationMarker) {
                    productLocationMarker.setLatLng([coords.lat, coords.lng]);
                    updateProductLocationFields(coords.lat, coords.lng);
                    reverseProductGeocode(coords.lat, coords.lng);
                }
            }
        }
        
        console.log('🗺️ تم تحميل موقع المنتج على الخريطة');
    }, 500);
}

function updateSubmitButtonForEdit(productNo) {
    const submitBtn = document.querySelector('#addProductForm .btn-submit');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
        submitBtn.dataset.mode = 'edit';
        submitBtn.dataset.productNo = productNo;
        submitBtn.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
    }
}
// تعطيل الحقول غير القابلة للتعديل

function disableReadonlyFields() {
    const readonlyFields = [
        'productNo',
        'productName',
        'custel',
        'productCategory',
        'productWarranty',
        'productAddDate', // 🔥 إضافة تاريخ الإضافة للحقول غير القابلة للتعديل
        'productSituation'

    ];
    
    readonlyFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.readOnly = true;
            if (fieldId === 'productCategory') {
                field.disabled = true;
            }
            field.style.backgroundColor = '#f5f5f5';
            field.style.cursor = 'not-allowed';
        }
               const situationField = document.getElementById('productSituation');
                situationField.disabled = true;
                situationField.hidden = false;
    });
}

/**
 * دالة تحديث بيانات المنتج في Google Sheets
 */

 
/**
 * معالجة تعديل المنتج
 */
async function handleProductEdit(productNo) {
    const submitBtn = document.querySelector('#addProductForm .btn-submit');
    const originalText = submitBtn.textContent;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحديث...';
    submitBtn.disabled = true;
    
    try {
        // جمع البيانات من النموذج
        const updatedData = collectProductFormData();
        
        // 🔥 **إضافة تاريخ الانتهاء**
        const expiredDate = document.getElementById('productExpiredDate').value;
        if (expiredDate) {
            updatedData.productExpiredDate = expiredDate;
        }
        
        // تحديث رقم المنتج
        updatedData.productNo = productNo;
        
        // رفع الصور الجديدة إذا تم إضافتها
        if (productImages.length > 0 && productImages.some(img => img.file)) {
            try {
                const uploadedImages = await uploadProductImages();
                updatedData.image1 = uploadedImages[0] || '';
                updatedData.image2 = uploadedImages[1] || '';
                updatedData.image3 = uploadedImages[2] || '';
            } catch (uploadError) {
                console.warn('⚠️ فشل رفع الصور الجديدة، استخدام الصور القديمة');
            }
        }
        
        console.log('📤 بيانات التحديث المرسلة:', updatedData);
        
        // تحديث البيانات في Google Sheets
        const result = await updateProductInExcel(updatedData);
        
        if (result) {
            showNotification('✅ تم تحديث المنتج بنجاح', 'success');
            
            // إعادة تحميل المنتجات
            setTimeout(async () => {
                await loadUserProductsFromExcel();
                
                // إغلاق النافذة
                closeAddProductModal();
                
                // إعادة تعيين النموذج
                resetProductForm();
            }, 1500);
        }
        
    } catch (error) {
        console.error('💥 خطأ في تحديث المنتج:', error);
        showNotification(`❌ ${error.message}`, 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}
/**
 * جمع البيانات من النموذج
 */
function collectProductFormData() {
  return {
        productName: document.getElementById('productName').value,
        custel: document.getElementById('custel').value,
        productCategory: document.getElementById('productCategory').value,
        productWarranty: document.getElementById('productWarranty').value,
        productPrice: document.getElementById('productPrice').value,
        productQuantity: document.getElementById('productQuantity').value,
        productState: document.getElementById('productState').value,
        productColor: document.getElementById('productColor').value,
        state: document.getElementById('productLocationState').value,
        productLocationName: document.getElementById('productLocationName').value,
        productLocationLink: document.getElementById('productLocationLink').value,
        productDescription: document.getElementById('productDescription').value,
        situation: document.getElementById('productSituation').value,
        // 🔥 **التواريخ**
        productAddDate: document.getElementById('productAddDate').value,
        productExpiredDate: document.getElementById('productExpiredDate').value,
        timestamp: new Date().toISOString(),
        updateDate: new Date().toISOString()
    };
}
/**
 * دالة متطورة لاستخراج الإحداثيات من روابط الخرائط
 */
function extractCoordinatesFromLink(link) {
    if (!link) return null;
    
    try {
        // 1. روابط Google Maps بصيغة ?q=lat,lng
        const qMatch = link.match(/[?&]q=([-\d.]+),([-\d.]+)/);
        if (qMatch) {
            return { lat: parseFloat(qMatch[1]), lng: parseFloat(qMatch[2]) };
        }
        
        // 2. روابط بصيغة /@lat,lng,z
        const atMatch = link.match(/@([-\d.]+),([-\d.]+)/);
        if (atMatch) {
            return { lat: parseFloat(atMatch[1]), lng: parseFloat(atMatch[2]) };
        }
        
        // 3. روابط بصيغة !1dlat!2dlng
        const dMatch = link.match(/!1d([-\d.]+)!2d([-\d.]+)/);
        if (dMatch) {
            return { lat: parseFloat(dMatch[1]), lng: parseFloat(dMatch[2]) };
        }
        
        // 4. روابط بصيغة !3dlat!4dlng
        const d34Match = link.match(/!3d([-\d.]+)!4d([-\d.]+)/);
        if (d34Match) {
            return { lat: parseFloat(d34Match[1]), lng: parseFloat(d34Match[2]) };
        }
        
        // 5. إحداثيات مباشرة في النص
        const coordMatch = link.match(/([-\d.]+)[,\s]+([-\d.]+)/);
        if (coordMatch) {
            return { lat: parseFloat(coordMatch[1]), lng: parseFloat(coordMatch[2]) };
        }
        
        return null;
    } catch (error) {
        console.error('خطأ في استخراج الإحداثيات:', error);
        return null;
    }
}
/**
 * إضافة مؤشر التحميل في زر التعديل
 */
function addLoadingToEditButton(productNo) {
    const editButton = document.querySelector(`[onclick*="${productNo}"]`);
    if (editButton) {
        const originalHTML = editButton.innerHTML;
        editButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        editButton.disabled = true;
        
        // إعادة التمكين بعد 3 ثواني
        setTimeout(() => {
            editButton.innerHTML = originalHTML;
            editButton.disabled = false;
        }, 3000);
    }
}

/**
 * إضافة CSS للتحسينات
 */
function addEditModalStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* تخصيص نافذة التعديل */
        .edit-mode .modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
        }
        
        .edit-mode .btn-submit {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
        }
        
        /* تأثيرات الحقول */
        .form-control:read-only {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
            color: #6c757d !important;
        }
        
        /* تنسيق التواريخ */
        .date-field-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .date-field-group .form-group {
            flex: 1;
        }
        
        #productAddDate {
            background-color: #e8f4fd !important;
            border-color: #b3d7ff !important;
            color: #0d6efd !important;
            font-weight: bold;
        }
        
        #productExpiredDate {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            color: #856404 !important;
            font-weight: bold;
        }
        
        /* علامات التواريخ */
        .date-label {
            position: relative;
            display: inline-block;
            padding-right: 25px;
        }
        
        .date-label::after {
            content: '';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        
        #productAddDate + label::after {
            content: '📅';
        }
        
        #productExpiredDate + label::after {
            content: '⏳';
        }
        
        /* تنبيه تاريخ الانتهاء */
        .expiry-warning {
            display: none;
            margin-top: 5px;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        .expiry-warning.near {
            display: block;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .expiry-warning.expired {
            display: block;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}
// إضافة الأنماط عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', addEditModalStyles);

/**
 * تأكيد تاريخ انتهاء المنتج
 */
function confirmExpiryDate() {
    const expiryDateInput = document.getElementById('productExpiredDate');
    const expiryDate = expiryDateInput.value;
    if (!expiryDate) return;
    
    const expiry = new Date(expiryDate);
    const today = new Date();
    const daysDiff = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    
    // إزالة أي تنبيهات سابقة
    const existingWarning = expiryDateInput.parentElement.querySelector('.expiry-warning');
    if (existingWarning) {
        existingWarning.remove();
    }
    
    // إضافة تنبيه جديد
    const warningDiv = document.createElement('div');
    
    if (daysDiff < 0) {
        // انتهى الصلاحية
        warningDiv.className = 'expiry-warning expired';
        warningDiv.innerHTML = '⚠️ انتهى الصلاحية';
        expiryDateInput.style.borderColor = '#dc3545';
        expiryDateInput.style.color = '#dc3545';
    } else if (daysDiff <= 30) {
        // قريب من الانتهاء
        warningDiv.className = 'expiry-warning near';
        warningDiv.innerHTML = `⚠️ تاريخ انتهاء المنتج قريب (${daysDiff} يوم)`;
        expiryDateInput.style.borderColor = '#ffc107';
        expiryDateInput.style.color = '#856404';
    } else {
        // جيد
        expiryDateInput.style.borderColor = '#28a745';
        expiryDateInput.style.color = '#155724';
    }
    
    expiryDateInput.parentElement.appendChild(warningDiv);
}

// إضافة مستمع للتاريخ عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    const expiryDateInput = document.getElementById('productExpiredDate');
    if (expiryDateInput) {
        expiryDateInput.addEventListener('change', confirmExpiryDate);
        // التحقق فوراً إذا كان هناك قيمة
        if (expiryDateInput.value) {
            confirmExpiryDate();
        }
    }
});

// تهيئة أحداث شروط التسجيل
function initTermsEvents() {
    const showTermsLink = document.getElementById('showTermsLink');
    const closeTermsBtn = document.getElementById('closeTermsBtn');
    const termsContent = document.getElementById('termsContent');
    const agreeTermsCheckbox = document.getElementById('agreeTerms');
    
    // إظهار الشروط عند النقر على الرابط
    if (showTermsLink) {
        showTermsLink.addEventListener('click', function(e) {
            e.preventDefault();
            termsContent.style.display = 'block';
            
            // تمركز الشروط إذا لزم الأمر
            setTimeout(() => {
                termsContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        });
    }
    
    // إخفاء الشروط عند النقر على زر موافق
    if (closeTermsBtn) {
        closeTermsBtn.addEventListener('click', function() {
            termsContent.style.display = 'none';
        });
    }
    
    // إخفاء الشروط عند النقر على المربع (اختياري)
    if (agreeTermsCheckbox) {
        agreeTermsCheckbox.addEventListener('click', function() {
            // إذا كان المستخدم يوافق على الشروط، نخفيها بعد ثانيتين
            if (this.checked && termsContent.style.display === 'block') {
                setTimeout(() => {
                    termsContent.style.display = 'none';
                }, 2000);
            }
        });
    }
    
    // إخفاء الشروط عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (termsContent && termsContent.style.display === 'block') {
            const isClickInsideTerms = termsContent.contains(e.target);
            const isClickOnTermsLink = showTermsLink && showTermsLink.contains(e.target);
            const isClickOnCheckbox = agreeTermsCheckbox && agreeTermsCheckbox.contains(e.target);
            
            if (!isClickInsideTerms && !isClickOnTermsLink && !isClickOnCheckbox) {
                termsContent.style.display = 'none';
            }
        }
    });
}

// دالة لإخفاء الشروط (تستخدم في وضع التعديل)
function hideTermsSection() {
    const termsContainer = document.querySelector('.terms-checkbox')?.parentElement;
    if (termsContainer) {
        termsContainer.style.display = 'none';
    }
}

// دالة لإظهار الشروط (تستخدم في وضع التسجيل الجديد)
function showTermsSection() {
    const termsContainer = document.querySelector('.terms-checkbox')?.parentElement;
    if (termsContainer) {
        termsContainer.style.display = 'block';
        
        // إعادة تعيين حالة المربع
        const agreeTermsCheckbox = document.getElementById('agreeTerms');
        if (agreeTermsCheckbox) {
            agreeTermsCheckbox.checked = false;
            agreeTermsCheckbox.required = true;
        }
        
        // إخفاء محتوى الشروط
        const termsContent = document.getElementById('termsContent');
        if (termsContent) {
            termsContent.style.display = 'none';
        }
    }
}


//نافذة التعديل السمتقلة
/**
 * دالة فتح نافذة التعديل المستقلة مع جميع البيانات
 */

 
async function openStandaloneEditModal(productNo) {
    console.log('🚀 فتح نافذة التعديل:', productNo);
    
    try {
        // 1. التحقق من وجود النافذة أو إنشاؤها
        let modal = document.getElementById('standaloneEditModal');
        
        if (!modal) {
            // إنشاء النافذة ببساطة
            modal = document.createElement('div');
            modal.id = 'standaloneEditModal';
        modal.style.cssText = 'display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.7); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; animation: fadeIn 0.3s ease;';
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    border-radius: 10px;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="
                        background: #3498db;
                        color: white;
                        padding: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-edit"></i>
                            <span>تعديل المنتج</span>
                            <span id="editProductNo" style="font-size: 14px;"></span>
                        </h3>
                        <button onclick="closeStandaloneEditModal()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            width: 35px;
                            height: 35px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                        ">×</button>
                    </div>
                    
                    <div id="standaloneEditFormContainer" style="
                        padding: 20px;
                        flex: 1;
                        overflow-y: auto;
                    ">
                        <div id="editFormLoading" style="text-align: center; padding: 50px;">
                            <div style="
                                width: 50px;
                                height: 50px;
                                border: 4px solid #f3f3f3;
                                border-top: 4px solid #3498db;
                                border-radius: 50%;
                                margin: 0 auto 20px;
                                animation: spin 1s linear infinite;
                            "></div>
                            <div style="color: #3498db; font-weight: 600;">
                                جاري تحميل بيانات المنتج...
                            </div>
                        </div>
                    </div>
                    
                    <div style="
                        padding: 15px;
                        background: #f8f9fa;
                        border-top: 1px solid #dee2e6;
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                    ">
                        <button onclick="saveStandaloneEdit()" style="
                            padding: 10px 25px;
                            background: #28a745;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-save"></i> حفظ
                        </button>
                        <button onclick="closeStandaloneEditModal()" style="
                            padding: 10px 25px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // إضافة CSS للأنيميشن
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // إغلاق عند النقر خارج النافذة
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeStandaloneEditModal();
                }
            });
        }
        
        // 2. تحديث رقم المنتج في العنوان
        document.getElementById('editProductNo').textContent = `(رقم: ${productNo})`;
        
        // 3. إظهار مؤشر التحميل
        const formContainer = document.getElementById('standaloneEditFormContainer');
        formContainer.innerHTML = `
            <div id="editFormLoading" style="text-align: center; padding: 50px;">
                <div style="
                    width: 50px;
                    height: 50px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #3498db;
                    border-radius: 50%;
                    margin: 0 auto 20px;
                    animation: spin 1s linear infinite;
                "></div>
                <div style="color: #3498db; font-weight: 600;">
                    جاري تحميل بيانات المنتج ${productNo}...
                </div>
            </div>
        `;
        
        // 4. إظهار النافذة (هذا هو الجزء المهم)
        modal.style.display = 'flex';
modal.style.justifyContent = 'center';
modal.style.alignItems = 'center';
        modal.style.animation = 'fadeIn 0.3s ease';
        
        // 5. إحضار النافذة إلى الأمام
        modal.style.zIndex = '9999';
        
        // 6. منع التمرير خلف النافذة
        document.body.style.overflow = 'hidden';
        
        // 7. جلب البيانات
        setTimeout(async () => {
            try {
                // استدعاء دالة جلب البيانات الخاصة بك
                if (typeof loadProductDataForStandaloneEdit === 'function') {
                    const productData = await loadProductDataForStandaloneEdit(productNo);
                    if (productData) {
                        // عرض النموذج مع البيانات
                        renderStandaloneEditForm(productData, productNo);
                    }
                } else {
                    throw new Error('دالة جلب البيانات غير متوفرة');
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                formContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #dc3545;">
                        <div style="font-size: 40px; margin-bottom: 15px;">⚠️</div>
                        <h4 style="margin-bottom: 10px;">فشل تحميل البيانات</h4>
                        <p>${error.message}</p>
                        <button onclick="openStandaloneEditModal('${productNo}')" 
                                style="margin-top: 20px; padding: 8px 20px; 
                                       background: #3498db; color: white; 
                                       border: none; border-radius: 5px; 
                                       cursor: pointer;">
                            إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }, 300);
        
    } catch (error) {
        console.error('❌ خطأ في فتح النافذة:', error);
        alert('حدث خطأ: ' + error.message);
    }
}

/**
 * إنشاء HTML لمؤشر التحميل
 */
function createLoadingHTML() {
    return `
        <div id="editFormLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">جاري تحميل بيانات المنتج...</div>
            <p style="color: #7f8c8d; margin-top: 15px; font-size: 14px;">
                الرجاء الانتظار قليلاً
            </p>
        </div>
    `;
}

/**
 * إنشاء HTML لرسالة الخطأ
 */
function createErrorHTML(error) {
    return `
        <div style="text-align: center; padding: 60px 30px; color: #dc3545;">
            <div style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
            <h3 style="margin-bottom: 15px; font-weight: 700;">فشل في تحميل بيانات المنتج</h3>
            <p style="color: #666; margin-bottom: 25px; font-size: 16px;">
                ${error.message || 'حدث خطأ غير متوقع'}
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="closeStandaloneEditModal()" 
                        style="padding: 12px 25px; background: #dc3545; color: white; 
                               border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-times"></i> إغلاق
                </button>
                <button onclick="location.reload()" 
                        style="padding: 12px 25px; background: #3498db; color: white; 
                               border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-redo"></i> إعادة تحميل
                </button>
            </div>
        </div>
    `;
}

/**
 * جلب بيانات المنتج للنافذة المستقلة
 */
async function loadProductDataForStandaloneEdit(productNo) {
    console.log(`🔄 جاري تحميل بيانات المنتج ${productNo} مع جميع الحقول`);
    
    try {
        // استخدام دالة جلب البيانات الخاصة بك
        if (typeof loadProductDataFromExcel === 'function') {
            const productData = await loadProductDataFromExcel(productNo);
            
            if (!productData) {
                throw new Error('لا توجد بيانات للمنتج');
            }
            
            // تنسيق التواريخ لصيغة يوم-شهر-سنة
            formatAllDates(productData);
            
            return productData;
        } else {
            throw new Error('دالة جلب البيانات غير متوفرة');
        }
    } catch (error) {
        console.error('❌ خطأ في تحميل البيانات:', error);
        throw error;
    }
}

/**
 * تنسيق جميع التواريخ إلى صيغة يوم-شهر-سنة
 */
function formatAllDates(productData) {
      const dateFields = [
        'productAddDate', 'productExpiredDate', 'timestamp', 'updateDate',
        'creationDate', 'التاريخ', 'date', 'originalTimestamp'
    ];
    
    dateFields.forEach(field => {
        if (productData[field]) {
            productData[field] = formatDateToDMY(productData[field]);
        }
    });
    
    // إذا لم يكن هناك timestamp، استخدم تاريخ اليوم
    if (!productData.timestamp) {
        productData.timestamp = formatDateToDMY(new Date());
    }
    
    // للتوافق: إذا لم يكن هناك productAddDate، استخدم timestamp
    if (!productData.productAddDate) {
        productData.productAddDate = productData.timestamp;
    }
    
    // إذا لم يكن هناك تاريخ انتهاء، حساب 6 أشهر من الآن
    if (!productData.productExpiredDate) {
        const sixMonthsLater = new Date();
        sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
        productData.productExpiredDate = formatDateToDMY(sixMonthsLater);
    }
    
    // الاحتفاظ بتاريخ Timestamp الأصلي إذا كان موجوداً
    if (productData.timestamp && !productData.originalTimestamp) {
        productData.originalTimestamp = productData.timestamp;
    }
}
/**
 * تنسيق التاريخ إلى يوم-شهر-سنة
 */
function formatDateToDMY(dateInput) {
    try {
        let date;
        
        if (typeof dateInput === 'string') {
            // تحليل التاريخ من النص
            date = new Date(dateInput);
            
            // إذا فشل التحليل، حاول تحليل صيغة DD/MM/YYYY
            if (isNaN(date.getTime())) {
                const parts = dateInput.split(/[/\-]/);
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
        } else if (dateInput instanceof Date) {
            date = dateInput;
        } else {
            date = new Date();
        }
        
        // التحقق من صحة التاريخ
        if (isNaN(date.getTime())) {
            console.warn('⚠️ تاريخ غير صالح، استخدام تاريخ اليوم:', dateInput);
            date = new Date();
        }
        
        // تنسيق إلى DD/MM/YYYY
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
        
    } catch (error) {
        console.error('❌ خطأ في تنسيق التاريخ:', error);
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        return `${day}/${month}/${year}`;
    }
}

/**
 * تحويل تاريخ DD/MM/YYYY إلى YYYY-MM-DD لحقول input type="date"
 */
function formatDateForInput(dateDMY) {
    if (!dateDMY) return '';
    
    try {
        const parts = dateDMY.split('/');
        if (parts.length === 3) {
            const [day, month, year] = parts;
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        return dateDMY;
    } catch (error) {
        console.error('❌ خطأ في تحويل التاريخ:', error);
        return '';
    }
}

/**
 * عرض النموذج في النافذة المستقلة مع جميع البيانات
 */
/**
 * عرض النموذج في النافذة المستقلة مع جميع البيانات
 */
function renderStandaloneEditForm(productData, productNo) {
    console.log('🎨 عرض النموذج مع جميع البيانات:', productData);
    
    const formContainer = document.getElementById('standaloneEditFormContainer');
    
    // تنسيق التواريخ للتأكد من صيغة صحيحة
    const formattedAddDate = formatDateToDMY(productData.timestamp || productData.productAddDate);
    const formattedExpiryDate = formatDateToDMY(productData.productExpiredDate);
    
    // تحويل التواريخ إلى كائنات Date للمقارنة
    const today = new Date();
    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    
    let expiryDateObj = null;
    let isExpired = false;
    let isDateParsed = false;
    
    // محاولة تحليل تاريخ الانتهاء بطرق مختلفة
    const expiryDateStr = productData.productExpiredDate || formattedExpiryDate;
    
    if (expiryDateStr && expiryDateStr !== 'غير محدد') {
        try {
            // الطريقة 1: إذا كان التاريخ بتنسيق DD/MM/YYYY
            if (typeof expiryDateStr === 'string' && expiryDateStr.includes('/')) {
                const parts = expiryDateStr.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // الأشهر من 0-11
                    const year = parseInt(parts[2], 10);
                    
                    // التأكد من أن السنة كاملة (4 أرقام)
                    const fullYear = (year < 100) ? 2000 + year : year;
                    
                    expiryDateObj = new Date(fullYear, month, day);
                    isDateParsed = true;
                }
            }
            // الطريقة 2: إذا كان التاريخ كائن Date
            else if (expiryDateStr instanceof Date) {
                expiryDateObj = new Date(expiryDateStr);
                isDateParsed = true;
            }
            // الطريقة 3: تحليل أي تنسيق تاريخي آخر
            else {
                expiryDateObj = new Date(expiryDateStr);
                isDateParsed = !isNaN(expiryDateObj.getTime());
            }
            
            if (isDateParsed && !isNaN(expiryDateObj.getTime())) {
                // مقارنة التواريخ بدون الوقت
                const expiryDateOnly = new Date(
                    expiryDateObj.getFullYear(), 
                    expiryDateObj.getMonth(), 
                    expiryDateObj.getDate()
                );
                
                console.log('📅 مقارنة التواريخ:');
                console.log('  اليوم:', todayDateOnly.toLocaleDateString('ar-SA'));
                console.log('  تاريخ الانتهاء:', expiryDateOnly.toLocaleDateString('ar-SA'));
                console.log('  الفرق بالأيام:', Math.floor((expiryDateOnly - todayDateOnly) / (1000 * 60 * 60 * 24)));
                
                isExpired = expiryDateOnly < todayDateOnly;
                
                console.log('  هل انتهى؟:', isExpired);
            } else {
                console.warn('⚠️ لم يتمكن من تحليل تاريخ الانتهاء:', expiryDateStr);
            }
        } catch (error) {
            console.error('❌ خطأ في تحليل تاريخ الانتهاء:', error, 'القيمة:', expiryDateStr);
        }
    } else {
        console.log('ℹ️ تاريخ الانتهاء غير محدد أو فارغ');
    }
    
    // التحقق من حالة المنتج إذا كانت "منتهي" أو "انتهى" أو "UnActive"
    const situation = productData.situation || '';
    const situationLower = situation.toLowerCase().trim();
    
    // قائمة الحالات التي تعتبر منتهية
    const expiredSituations = [
        'منتهي',
        'انتهى',
        'unactive',
        'منتهية',
        'انتهت',
        'انتهاء',
        'منته',
        'expired',
        'inactive',
        'غير فعال',
        'غير نشط',
        'deleting'
    ];
    
    let isSituationExpired = false;
    
    // التحقق إذا كانت الحالة تحتوي على أي من القيم المطلوبة
    for (const expiredSit of expiredSituations) {
        if (situationLower.includes(expiredSit.toLowerCase())) {
            isSituationExpired = true;
            console.log(`📌 الحالة "${situation}" تعتبر منتهية (مطابقة لـ: "${expiredSit}")`);
            break;
        }
    }
    
    // تحديد إذا كان يجب عرض زر التجديد
    const shouldShowRenewButton = isExpired || isSituationExpired;
    
    console.log('📊 حالة المنتج النهائية:');
    console.log('  - رقم المنتج:', productNo);
    console.log('  - تاريخ الانتهاء:', formattedExpiryDate);
    console.log('  - هل انتهى التاريخ؟:', isExpired);
    console.log('  - الحالة:', situation);
    console.log('  - هل الحالة منتهية؟:', isSituationExpired);
    console.log('  - هل يجب عرض زر التجديد؟:', shouldShowRenewButton);
    
    // إنشاء النموذج الكامل
    const formHTML = `
        <div class="standalone-form-container">
            <!-- معلومات المنتج الأساسية -->
            <div class="standalone-form-section">
                <div class="section-header">
                    <i class="fas fa-info-circle"></i>
                    <h4>المعلومات الأساسية (لا يمكن التعديل)</h4>
                </div>
                
                <div class="standalone-form-row">
                    ${createFormField('هاتف المستخدم', 'standaloneCustel', productData.custel, 'tel', true)}
                    ${createFormField('اسم المنتج', 'standaloneProductName', productData.productName, 'text', true)}
                </div>
                
                <div class="standalone-form-row">
                    ${createFormField('الفسم', 'standaloneProductCategory', productData.productCategory, 'select', true, [
                        {value: '', label: 'اختر القسم'},
                        {value: 'إلكترونيات', label: 'إلكترونيات'},
                        {value: 'ملابس', label: 'ملابس'},
                        {value: 'أثاث', label: 'أثاث'},
                        {value: 'سيارات', label: 'سيارات'},
                        {value: 'عقارات', label: 'عقارات'},
                        {value: 'خدمات', label: 'خدمات'},
                        {value: 'أخرى', label: 'أخرى'}
                    ])}
                    ${createFormField('الفئة', 'standaloneProductWarranty', productData.productWarranty, 'text', true)}
                </div>
            </div>
            
            <!-- معلومات السعر والكمية -->
            <div class="standalone-form-section">
                <div class="section-header">
                    <i class="fas fa-tag"></i>
                    <h4>معلومات السعر والكمية</h4>
                </div>
                
                <div class="standalone-form-row">
                    ${createFormField('السعر (ر.س)', 'standaloneProductPrice', productData.productPrice, 'number', false, true, null, {step: '0.01', min: '0'})}
                    ${createFormField('الكمية', 'standaloneProductQuantity', productData.productQuantity || '1', 'number', false, true, null, {min: '1'})}
                </div>
                
                <div class="standalone-form-row">
                    ${createFormField('الحالة', 'standaloneProductState', productData.productState, 'select', false, true, [
                        {value: '', label: 'اختر الحالة'},
                        {value: 'جديد', label: 'جديد'},
                        {value: 'مستعمل', label: 'مستعمل'},
                        {value: 'غرده', label: 'خرده'}
                    ])}
                    
                    ${createFormField('اللون', 'standaloneProductColor', productData.productColor, 'select', false, true, [
                        {value: '', label: 'اختر اللون'},
                        {value: 'أسود', label: 'أسود'},
                        {value: 'أبيض', label: 'أبيض'},
                        {value: 'رمادي', label: 'رمادي'},
                        {value: 'فضي', label: 'فضي'},
                        {value: 'ذهبي', label: 'ذهبي'},
                        {value: 'أزرق', label: 'أزرق'},
                        {value: 'أحمر', label: 'أحمر'},
                        {value: 'أخضر', label: 'أخضر'},
                        {value: 'أصفر', label: 'أصفر'},
                        {value: 'برتقالي', label: 'برتقالي'},
                        {value: 'بنفسجي', label: 'بنفسجي'},
                        {value: 'وردي', label: 'وردي'},
                        {value: 'بني', label: 'بني'},
                        {value: 'كريمي', label: 'كريمي'},
                        {value: 'أخرى', label: 'أخرى'}
                    ])}
                </div>
            </div>

           <!-- الموقع -->
<div class="standalone-form-section">
    <div class="section-header">
        <i class="fas fa-map-marker-alt"></i>
        <h4>معلومات الموقع</h4>
    </div>
    
    <div class="standalone-form-row">
${createFormField('المنطقة', 'standaloneProductLocationState', productData.productLocationState || productData.state, 'select', false, true, [
    {value: '', label: 'اختر المنطقة'},
    {value: 'مسقط', label: 'مسقط'},
    {value: 'الداخلية', label: 'الداخلية'},
    {value: 'جنوب الباطنة', label: 'جنوب الباطنة'},
    {value: 'شمال الباطنة', label: 'شمال الباطنة'},
    {value: 'الظاهرة', label: 'الظاهرة'},
    {value: 'البريمي', label: 'البريمي'},
    {value: 'شمال الشرقية', label: 'شمال الشرقية'},
    {value: 'جنوب الشرقية', label: 'جنوب الشرقية'},
    {value: 'الوسطى', label: 'الوسطى'},
    {value: 'ظفار', label: 'ظفار'}
])}
        
        ${createFormField('اسم الموقع', 'standaloneProductLocationName', productData.productLocationName, 'text', false, true)}
    </div>
    
    <!-- خريطة مصغرة -->
    <div class="standalone-form-group">
        <label for="mapSearch">
            <i class="fas fa-search-location"></i> البحث عن الموقع
        </label>
        <div class="map-search-container">
            <input type="text" 
                   id="mapSearch" 
                   class="standalone-form-control"
                   placeholder="اكتب اسم الموقع أو المنطقة للبحث..."
                   value="${productData.productLocationName || ''}">
            <button type="button" id="searchLocationBtn" class="map-search-btn">
                <i class="fas fa-search"></i>
            </button>
            <button type="button" id="useCurrentLocationBtn" class="map-current-btn">
                <i class="fas fa-location-arrow"></i> الموقع الحالي
            </button>
        </div>
    </div>
    
    <div class="standalone-form-row">
        <div class="mini-map-container" id="miniMapContainer">
            <div id="miniMap" style="height: 250px; border-radius: 8px; margin-bottom: 10px;"></div>
            <div class="map-coordinates">
                <span id="selectedCoordinates">لم يتم تحديد موقع بعد</span>
                <button type="button" id="clearMarkerBtn" class="clear-marker-btn" style="display: none;">
                    <i class="fas fa-times"></i> إزالة العلامة
                </button>
            </div>
        </div>
    </div>
    
    <div class="standalone-form-row">
        ${createFormField('رابط الموقع', 'standaloneProductLocationLink', productData.productLocationLink, 'url')}
    </div>
    
    <div class="map-instructions">
        <i class="fas fa-info-circle"></i>
        <small>تعليمات: اكتب اسم الموقع في مربع البحث، أو استخدم "الموقع الحالي"، ثم انقر على الخريطة لتحديد الموقع الدقيق</small>
    </div>
</div>
            
            <!-- وصف المنتج -->
            <div class="standalone-form-section">
                <div class="section-header">
                    <i class="fas fa-align-left"></i>
                    <h4>وصف المنتج</h4>
                </div>
                
                <div class="standalone-form-group">
                    <label for="standaloneProductDescription">
                        <i class="fas fa-edit"></i> الوصف التفصيلي
                    </label>
                    <textarea id="standaloneProductDescription" 
                              class="standalone-form-control standalone-textarea"
                              rows="5">${productData.productDescription || ''}</textarea>
                </div>
            </div>
            
          <!-- صور المنتج -->
<div class="standalone-form-section">
    <div class="section-header">
        <i class="fas fa-images"></i>
        <h4>صور المنتج (حد أقصى 3 صور)</h4>
    </div>
    
    <div class="standalone-images-section" id="imagesSection">
        ${createImagesPreview(productData.images || productData.image1 || productData.image2 || productData.image3)}
        
        <div style="margin-top: 20px;">
            <input type="file" id="standaloneImageUploadInput" 
                   multiple accept="image/*" 
                   style="display: none;"
                   onchange="handleStandaloneImageUpload(event)">
            
            <button type="button" class="upload-images-btn" onclick="handleImageUploadClick()">
                <i class="fas fa-upload"></i> إضافة صور
            </button>
            
            <div id="imageUploadStatus" style="margin-top: 10px; font-size: 14px; color: #7f8c8d;"></div>
        </div>
    </div>
</div>
            
            <!-- التواريخ -->
            <div class="standalone-form-section">
                <div class="section-header">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>التواريخ</h4>
                </div>
                
                <div class="standalone-form-row">
                    <div class="date-input-group">
                        ${createFormField('تاريخ الطلب (Timestamp)', 'standaloneTimestamp', 
                            formatDateForInput(productData.timestamp || productData.productAddDate), 'date', true)}
                        <div class="date-display">${formattedAddDate || 'غير محدد'}</div>
                    </div>
                    
                    <div class="date-input-group">
                        ${createFormField('تاريخ الانتهاء', 'standaloneProductExpiredDate', 
                            formatDateForInput(productData.productExpiredDate), 'date', true)}
                        <div class="date-display ${isExpired || isSituationExpired ? 'expired' : ''}">
                            ${formattedExpiryDate || 'غير محدد'}
                            ${isExpired ? ' ⚠️ منتهي' : ''}
                            ${isSituationExpired && !isExpired ? ' ⚠️ (حالة منتهية)' : ''}
                        </div>
                    </div>
                </div>
                
                <!-- زر التجديد - يظهر فقط إذا كان تاريخ الانتهاء أقل من تاريخ اليوم أو حالة المنتج منتهية -->
                ${shouldShowRenewButton ? `
                <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                    <button type="button" class="renew-button" onclick="renewProductSixMonths()" style="
                        background: #e74c3c;
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        transition: all 0.3s;
                        font-size: 14px;
                    ">
                        <i class="fas fa-sync-alt"></i> تجديد المنتج 6 أشهر
                    </button>
                   
                ` : ''}
                
                ${!shouldShowRenewButton && formattedExpiryDate && situation ? `
                <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 5px; color: #155724; font-size: 14px;">
                    <i class="fas fa-info-circle" style="margin-left: 5px;"></i>
                </div>
                ` : ''}
                
                ${!formattedExpiryDate || formattedExpiryDate === 'غير محدد' ? `
                <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2; font-size: 14px;">
                    <i class="fas fa-info-circle" style="margin-left: 5px;"></i>
                    <strong>ملاحظة:</strong> لم يتم تحديد تاريخ انتهاء للمنتج
                </div>
                ` : ''}
            </div>
            
            <!-- رسائل التنبيه -->
            <div id="standaloneFormMessages" style="margin-top: 20px;"></div>
            
            <!-- معلومات إضافية -->
            <div class="standalone-form-section" style="background: #f8f9fa;">
                <div class="section-header">
                    <i class="fas fa-database"></i>
                    <h4>معلومات إضافية</h4>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <span class="product-info-badge">
                        <i class="fas fa-hashtag"></i> رقم المنتج: ${productNo}
                    </span>
                    ${situation ? `<span class="product-info-badge ${shouldShowRenewButton ? 'expired-badge' : ''}" 
                        style="${shouldShowRenewButton ? 'background: #f8d7da; border-color: #f5c6cb; color: #721c24;' : 'background: #d4edda; border-color: #c3e6cb; color: #155724;'}">
                        <i class="fas fa-circle"></i> الحالة: ${situation}
                    </span>` : ''}
                    ${formattedAddDate ? `<span class="product-info-badge">
                        <i class="fas fa-clock"></i> الإضافة: ${formattedAddDate}
                    </span>` : ''}
                    ${productData.updateDate ? `<span class="product-info-badge">
                        <i class="fas fa-sync"></i> آخر تعديل: ${productData.updateDate}
                    </span>` : ''}
                </div>
            </div>
            
            <!-- تخزين التاريخ الأصلي -->
            <input type="hidden" id="originalAddDate" value="${formattedAddDate || ''}">
            <input type="hidden" id="originalExpiryDate" value="${formattedExpiryDate || ''}">
        </div>
    `;
    
    formContainer.innerHTML = formHTML;
    
    // تخزين البيانات
    window.currentStandaloneEditProductNo = productNo;
    window.currentStandaloneEditProductData = productData;
    window.standaloneProductImages = [];
    
    // إضافة الأنماط إذا لم تكن موجودة
    addDateStyles();
    addMapStyles();
    addImageStyles();
    addRenewalStyles();
    // تهيئة الخريطة بعد تحميل DOM
    setTimeout(() => {
        initMiniMap(productData);
        initImageManagement();
    }, 100);
}


/**
 * استخراج اسم الملف من الرابط
 */
function getFileNameFromUrl(url) {
    if (!url) return '';
    
    try {
        if (url.startsWith('data:')) {
            return 'صورة جديدة';
        }
        
        const urlObj = new URL(url);
        const pathname = urlObj.pathname;
        const filename = pathname.split('/').pop();
        return filename || 'صورة';
    } catch {
        // إذا فشل تحليل الرابط، محاولة استخراج الاسم يدوياً
        const parts = url.split('/');
        const lastPart = parts[parts.length - 1];
        return lastPart.split('?')[0] || 'صورة';
    }
}
/**
 * إنشاء HTML للصورة الفردية
 */
function createImageItemHTML(imgSrc, index) {
    const fileName = getFileNameFromUrl(imgSrc) || `صورة ${index + 1}`;
    
    return `
        <div class="image-preview-item" data-image-index="${index}" data-image-type="existing" data-image-src="${imgSrc}">
            <span class="image-number">${index + 1}</span>
            <img src="${imgSrc}" 
                 alt="${fileName}"
                 onerror="handleImageError(this)"
                 data-original-src="${imgSrc}">
            <div class="image-replace-overlay">
                <button type="button" class="replace-image-btn" onclick="replaceSingleImage(${index})">
                    <i class="fas fa-exchange-alt"></i> استبدال
                </button>
                <button type="button" class="replace-image-btn delete-btn" onclick="deleteImageFromPreview(${index})">
                    <i class="fas fa-trash"></i> حذف
                </button>
            </div>
            <div class="image-actions">
                <span class="image-size-info">${fileName}</span>
            </div>
        </div>
    `;
}

/**
 * إنشاء HTML للمكان الفارغ
 */
function createEmptySlotHTML(index) {
    return `
        <div class="image-preview-item empty-slot" data-image-index="${index}" data-image-type="empty">
            <div class="empty-slot-content">
                <i class="fas fa-plus" style="font-size: 30px; color: #adb5bd; margin-bottom: 10px;"></i>
                <p style="color: #6c757d; font-size: 14px;">إضافة صورة</p>
                <button type="button" class="add-image-btn" onclick="addImageToSlot(${index})">
                    <i class="fas fa-upload"></i> اختيار صورة
                </button>
            </div>
        </div>
    `;
}

/**
 * إضافة أنماط التواريخ
 */
function addDateStyles() {
    if (!document.getElementById('date-styles')) {
        const style = document.createElement('style');
        style.id = 'date-styles';
        style.textContent = `
            .date-input-group {
                position: relative;
                flex: 1;
            }
            
            .date-display {
                margin-top: 5px;
                padding: 8px 12px;
                background: #f8f9fa;
                border-radius: 5px;
                font-size: 14px;
                color: #495057;
                border: 1px solid #dee2e6;
                min-height: 20px;
            }
            
            .date-display.expired {
                background: #f8d7da;
                border-color: #f5c6cb;
                color: #721c24;
                font-weight: bold;
            }
            
            .date-display.renewed {
                background: #d4edda;
                border-color: #c3e6cb;
                color: #155724;
                font-weight: bold;
            }
            
            .renew-button {
                background: #e74c3c !important;
                color: white !important;
                border: none !important;
                padding: 12px 20px !important;
                border-radius: 5px !important;
                cursor: pointer !important;
                font-weight: bold !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                transition: all 0.3s !important;
                font-size: 14px !important;
            }
            
            .renew-button:hover {
                background: #c0392b !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
            }
            
            .renew-button:active {
                transform: translateY(0) !important;
            }
            
            .product-info-badge {
                background: white;
                padding: 8px 12px;
                border-radius: 5px;
                border: 1px solid #dee2e6;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 5px;
            }
        `;
        document.head.appendChild(style);
    }
}

/**
 * إنشاء حقل نموذج
 */
function createFormField(label, id, value, type = 'text', readonly = false, required = false, options = null, attributes = {}) {
    let inputHTML = '';
    
    if (type === 'select' && options) {
        inputHTML = `<select id="${id}" class="standalone-form-control" ${readonly ? 'disabled' : ''} ${required ? 'required' : ''}>`;
        options.forEach(option => {
            const selected = option.value === value ? 'selected' : '';
            inputHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
        });
        inputHTML += '</select>';
    } else {
        const attrString = Object.entries(attributes)
            .map(([key, val]) => `${key}="${val}"`)
            .join(' ');
            
        inputHTML = `
            <input type="${type}" 
                   id="${id}" 
                   class="standalone-form-control" 
                   value="${value || ''}"
                   ${readonly ? 'readonly' : ''}
                   ${required ? 'required' : ''}
                   ${attrString}>
        `;
    }
    
    return `
        <div class="standalone-form-group">
            <label for="${id}">
                <i class="fas fa-${getFieldIcon(label)}"></i> ${label}
            </label>
            ${inputHTML}
        </div>
    `;
}

/**
 * الحصول على أيقونة للحقل
 */
function getFieldIcon(fieldLabel) {
    const icons = {
        'رقم المنتج': 'hashtag',
        'اسم المنتج': 'tag',
        'هاتف المستخدم': 'phone',
        'الفئة': 'folder',
        'السعر': 'dollar-sign',
        'الكمية': 'box',
        'الضمان': 'shield-alt',
        'الحالة': 'star',
        'اللون': 'palette',
        'تاريخ الإضافة': 'calendar-plus',
        'تاريخ الانتهاء': 'calendar-times',
        'المنطقة': 'map-marker-alt',
        'اسم الموقع': 'location-arrow',
        'رابط الموقع': 'link'
    };
    
    return icons[fieldLabel] || 'edit';
}

/**
 * إنشاء معاينة للصور
 */
function createImagesPreview(images) {
    // تحويل الصور إلى مصفوفة
    const imagesArray = convertToImagesArray(images);
    
    if (imagesArray.length === 0) {
        return createEmptyImagesTemplate();
    }
    
    let imagesHTML = '<div class="images-preview-grid">';
    
    // أولاً: عرض الصور الحالية
    imagesArray.forEach((imgSrc, index) => {
        if (!imgSrc || imgSrc.trim() === '') {
            // إذا كانت الصورة فارغة، عرض مكان فارغ
            imagesHTML += createEmptySlotHTML(index);
        } else {
            // عرض الصورة الحالية مع خيارات الحذف والاستبدال
            imagesHTML += createImageItemHTML(imgSrc, index);
        }
    });
    
    // ثانياً: إضافة أماكن فارغة للصور المتبقية
    const totalSlots = 3;
    const currentCount = imagesArray.length;
    const emptySlotsCount = totalSlots - currentCount;
    
    for (let i = currentCount; i < totalSlots; i++) {
        imagesHTML += createEmptySlotHTML(i);
    }
    
    imagesHTML += '</div>';
    return imagesHTML;
}
/**
 * إنشاء قالب الصفحة عند عدم وجود صور
 */
function createEmptyImagesTemplate() {
    return `
        <div class="no-images-message">
            <i class="fas fa-image" style="font-size: 48px; color: #dee2e6; margin-bottom: 15px;"></i>
            <p style="color: #6c757d; font-size: 16px; margin-bottom: 10px;">لا توجد صور للمنتج</p>
            <p style="color: #adb5bd; font-size: 14px;">يمكنك إضافة حتى 3 صور</p>
            <div style="margin-top: 20px;">
                <button type="button" class="upload-images-btn" onclick="handleImageUploadClick()">
                    <i class="fas fa-upload"></i> إضافة صور
                </button>
            </div>
        </div>
    `;
}

/**
 * معالجة خطأ تحميل الصورة
 */
function handleImageError(imgElement) {
    imgElement.src = 'https://via.placeholder.com/150x150/e9ecef/6c757d?text=خطأ+في+الصورة';
    imgElement.style.border = '2px dashed #dc3545';
    imgElement.parentElement.querySelector('.image-replace-overlay').style.display = 'flex';
}
/**
 * تهيئة خاصية استبدال الصور
 */
function initImageReplaceFeature() {
    // تخزين الصور الأصلية
    if (!window.originalImages) {
        window.originalImages = [];
        const images = document.querySelectorAll('.image-preview-item img');
        images.forEach((img, index) => {
            window.originalImages[index] = img.src;
        });
    }
}

/**
 * تحويل بيانات الصور إلى مصفوفة
 */
function convertToImagesArray(images) {
    let imagesArray = [];
    
    if (!images) {
        return imagesArray;
    }
    
    if (Array.isArray(images)) {
        // إذا كانت مصفوفة
        imagesArray = images.filter(img => img && img.trim() !== '').slice(0, 3);
    } else if (typeof images === 'string' && images.startsWith('http')) {
        // إذا كانت رابط واحد
        imagesArray = [images];
    } else if (typeof images === 'object') {
        // إذا كانت صور متعددة في كائن
        if (images.image1 && images.image1.trim() !== '') imagesArray.push(images.image1);
        if (images.image2 && images.image2.trim() !== '') imagesArray.push(images.image2);
        if (images.image3 && images.image3.trim() !== '') imagesArray.push(images.image3);
    }
    
    return imagesArray.slice(0, 3); // التأكد من عدم تجاوز 3 صور
}

/**
 * استبدال صورة محددة
 */
function replaceSingleImage(imageIndex) {
    const slotElement = document.querySelector(`.image-preview-item[data-image-index="${imageIndex}"]`);
    if (!slotElement) {
        console.error('❌ العنصر غير موجود:', imageIndex);
        showImageUploadStatus('❌ العنصر غير موجود', 'error');
        return;
    }
    
    const slotType = slotElement.getAttribute('data-image-type');
    
    if (slotType === 'empty') {
        // إذا كان المكان فارغاً، استدعاء addImageToSlot بدلاً من replace
        addImageToSlot(imageIndex);
        return;
    }
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            showImageUploadStatus('❌ الملف المحدد ليس صورة', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            // الحصول على الرابط الأصلي
            const imgElement = slotElement.querySelector('img');
            const originalSrc = imgElement ? imgElement.getAttribute('data-original-src') : null;
            
            // إذا كان هناك رابط أصلي (ليس بيانات base64)، حفظه للمسح
            if (originalSrc && originalSrc.startsWith('http')) {
                if (!window.deletedImages) window.deletedImages = [];
                window.deletedImages[imageIndex] = originalSrc;
            }
            
            // تحديث الصورة
            if (imgElement) {
                imgElement.src = event.target.result;
                imgElement.setAttribute('data-original-src', event.target.result);
            }
            
            // تحديث اسم الملف
            const fileNameDisplay = slotElement.querySelector('.image-size-info');
            if (fileNameDisplay) {
                fileNameDisplay.textContent = file.name.length > 15 ? 
                    file.name.substring(0, 12) + '...' : file.name;
            }
            
            // تحديث السمة
            slotElement.setAttribute('data-image-src', event.target.result);
            
            // تخزين الصورة الجديدة
            if (!window.uploadedImages) window.uploadedImages = [];
            
            // إزالة أي صورة مرفوعة سابقة لنفس المكان
            window.uploadedImages = window.uploadedImages.filter(img => 
                !img.slotIndex || img.slotIndex !== imageIndex
            );
            
            // إضافة الصورة الجديدة
            window.uploadedImages.push({
                file: file,
                preview: event.target.result,
                slotIndex: imageIndex,
                isReplacement: true
            });
            
            // تحديث الصور الحالية
            window.currentProductImages[imageIndex] = event.target.result;
            
            showImageUploadStatus(`✅ تم استبدال الصورة ${imageIndex + 1}`, 'success');
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

/**
 * حذف صورة محددة
 */
function removeImage(imageIndex) {
    const confirmDelete = confirm('هل تريد حذف هذه الصورة؟');
    if (!confirmDelete) return;
    
    const imgElement = document.querySelector(`.image-preview-item[data-image-index="${imageIndex}"] img`);
    if (imgElement) {
        imgElement.src = 'https://via.placeholder.com/150x150?text=No+Image';
        imgElement.style.opacity = '0.5';
        
        // إخفاء الصورة عند الحفظ
        if (!window.removedImages) window.removedImages = [];
        window.removedImages[imageIndex] = true;
    }
    
    showStandaloneMessage('تم حذف الصورة', 'info');
}

/**
 * تجديد تاريخ الانتهاء
 */
function extendExpiryDate(days) {
    const expiryField = document.getElementById('standaloneProductExpiredDate');
    if (!expiryField) return;
    
    const currentDate = new Date();
    currentDate.setDate(currentDate.getDate() + days);
    
    const formattedDate = formatDateForInput(formatDateToDMY(currentDate));
    expiryField.value = formattedDate;
    
    // تحديث العرض
    const displayDiv = expiryField.parentElement.querySelector('.date-display');
    if (displayDiv) {
        displayDiv.textContent = formatDateToDMY(currentDate);
        displayDiv.style.color = '#27ae60';
        displayDiv.innerHTML += ' <i class="fas fa-check-circle"></i>';
    }
    
    showStandaloneMessage(`تم تجديد التاريخ لمدة ${days} يوم`, 'success');
}

/**
 * رفع الصور في النافذة المستقلة
 */
function handleStandaloneImageUpload(event) {
    const files = Array.from(event.target.files);
    const currentCount = getCurrentImagesCount();
    
    if (currentCount >= 3) {
        showImageUploadStatus('❌ وصلت للحد الأقصى من الصور', 'error');
        return;
    }
    
    // تصفية الملفات لتحقق أنها صور
    const imageFiles = files.filter(file => file.type.startsWith('image/'));
    
    if (imageFiles.length === 0) {
        showImageUploadStatus('❌ لم يتم تحديد أي صور صالحة', 'error');
        return;
    }
    
    // تحديد عدد الصور التي يمكن إضافتها
    const availableSlots = 3 - currentCount;
    const filesToAdd = imageFiles.slice(0, Math.min(availableSlots, imageFiles.length));
    
    if (filesToAdd.length === 0) {
        showImageUploadStatus('❌ لا يوجد مكان لإضافة المزيد من الصور', 'error');
        return;
    }
    
    showImageUploadStatus(`📤 جاري إضافة ${filesToAdd.length} صور...`, 'info');
    
    // العثور على الأماكن الفارغة
    const emptySlots = Array.from(document.querySelectorAll('.image-preview-item.empty-slot'))
        .map(slot => parseInt(slot.getAttribute('data-image-index')))
        .sort((a, b) => a - b);
    
    // قراءة وعرض الصور في الأماكن الفارغة
    filesToAdd.forEach((file, index) => {
        if (index >= emptySlots.length) {
            showImageUploadStatus('❌ لا يوجد أماكن فارغة كافية', 'error');
            return;
        }
        
        const slotIndex = emptySlots[index];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // إضافة الصورة إلى المكان الفارغ
            updateImageSlot(slotIndex, e.target.result, file.name);
            
            // تخزين الصورة للرفع لاحقاً
            if (!window.uploadedImages) window.uploadedImages = [];
            window.uploadedImages.push({
                file: file,
                preview: e.target.result,
                slotIndex: slotIndex
            });
            
            // تحديث العداد
            if (index === filesToAdd.length - 1) {
                setTimeout(() => {
                    const newCount = getCurrentImagesCount();
                    showImageUploadStatus(`✅ تم إضافة ${filesToAdd.length} صور - ${newCount}/3`, 'success');
                    updateUploadButtonStatus();
                }, 500);
            }
        };
        reader.readAsDataURL(file);
    });
    
    // إعادة تعيين حقل الرفع
    event.target.value = '';
}


/**
 * إنشاء معاينة للصور المرفوعة
 */
function createImageUploadPreview(files) {
    let previewHTML = '';
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgElement = document.querySelector(`.image-preview-item:nth-child(${index + 1}) img`);
            if (imgElement) {
                imgElement.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
        
        previewHTML += `
            <div class="image-preview-item">
                <span class="image-number">${index + 1}</span>
                <img src="" alt="صورة ${file.name}" style="background: #f8f9fa;">
                <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; 
                            background: rgba(0,0,0,0.7); color: white; padding: 3px 6px; 
                            border-radius: 3px; font-size: 11px; text-align: center;">
                    ${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}
                </div>
            </div>
        `;
    });
    
    return previewHTML;
}

/**
 * تهيئة أحداث النموذج
 */
function initStandaloneFormEvents() {
    // أحداث التواريخ
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        field.addEventListener('change', function() {
            const displayDiv = this.parentElement.querySelector('.date-display');
            if (displayDiv && this.value) {
                const formattedDate = formatDateToDMY(this.value);
                displayDiv.textContent = formattedDate;
                
                // تلوين تاريخ الانتهاء إذا كان قريباً
                if (this.id === 'standaloneProductExpiredDate') {
                    checkExpiryDateWarning(this.value, displayDiv);
                }
            }
        });
    });
    
    // أحداث الحقول الإلزامية
    const requiredFields = document.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('invalid', function(e) {
            e.preventDefault();
            showStandaloneMessage('يرجى ملء جميع الحقول الإلزامية', 'error');
            this.style.borderColor = '#dc3545';
        });
        
        field.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#2ecc71';
            }
        });
    });
    
    // حدث حساب السعر الإجمالي
    const priceField = document.getElementById('standaloneProductPrice');
    const quantityField = document.getElementById('standaloneProductQuantity');
    
    if (priceField && quantityField) {
        const calculateTotal = () => {
            const price = parseFloat(priceField.value) || 0;
            const quantity = parseInt(quantityField.value) || 1;
            const total = price * quantity;
            
            // عرض النتيجة في رسالة
            if (price > 0 && quantity > 0) {
                showStandaloneMessage(`السعر الإجمالي: ${total.toFixed(2)} ر.س`, 'info', 3000);
            }
        };
        
        priceField.addEventListener('input', calculateTotal);
        quantityField.addEventListener('input', calculateTotal);
    }
}

/**
 * التحقق من تاريخ الانتهاء وإظهار تحذير
 */
function checkExpiryDateWarning(dateValue, displayElement) {
    if (!dateValue) return;
    
    const expiryDate = new Date(dateValue);
    const today = new Date();
    const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
    
    if (daysDiff < 0) {
        displayElement.style.color = '#dc3545';
        displayElement.innerHTML += ' ⚠️ منتهي';
        showStandaloneMessage('تاريخ الانتهاء قد انتهى!', 'error');
    } else if (daysDiff <= 30) {
        displayElement.style.color = '#f39c12';
        displayElement.innerHTML += ` ⚠️ (${daysDiff} يوم)`;
        showStandaloneMessage(`تاريخ الانتهاء قريب: ${daysDiff} يوم`, 'warning');
    } else {
        displayElement.style.color = '#27ae60';
        displayElement.innerHTML += ' ✓';
    }
}

/**
 * إظهار رسالة في النافذة المستقلة
 */
function showStandaloneMessage(message, type = 'info', duration = 5000) {
    const messagesDiv = document.getElementById('standaloneFormMessages');
    if (!messagesDiv) return;
    
    // إزالة الرسائل القديمة
    const oldMessages = messagesDiv.querySelectorAll('.standalone-message');
    oldMessages.forEach(msg => {
        if (!msg.classList.contains('permanent')) {
            setTimeout(() => msg.remove(), 300);
        }
    });
    
    const colors = {
        success: '#2ecc71',
        error: '#dc3545',
        warning: '#f39c12',
        info: '#3498db'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    // التحقق إذا كانت الرسالة تحتوي على HTML
    const isHTML = /<\/?[a-z][\s\S]*>/i.test(message);
    
    const messageHTML = `
        <div class="standalone-message" 
             style="background: ${colors[type]}15; 
                    border: 1px solid ${colors[type]};
                    border-radius: 8px; 
                    padding: 12px 15px; 
                    margin-bottom: 10px;
                    color: ${type === 'warning' ? '#856404' : '#155724'};
                    animation: slideIn 0.3s ease;">
            ${isHTML ? message : `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 18px;"></i>
                    <span style="flex: 1; font-weight: 600;">${message}</span>
                </div>
            `}
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('afterbegin', messageHTML);
    
    // إذا كان الرسالة مؤقتة، احذفها بعد المدة
    if (duration > 0) {
        setTimeout(() => {
            const messageElement = messagesDiv.querySelector('.standalone-message:first-child');
            if (messageElement) {
                messageElement.style.opacity = '0';
                messageElement.style.transform = 'translateY(-10px)';
                setTimeout(() => messageElement.remove(), 300);
            }
        }, duration);
    }
}

/**
 * تعديل دالة الحفظ للتعامل مع التواريخ المجددة
 */
async function saveStandaloneEditWithRenewalCheck() {
    try {
        // التحقق من صحة التواريخ
        if (!validateDatesBeforeSave()) {
            showStandaloneMessage('❌ التواريخ غير صالحة، يرجى التحقق', 'error');
            return;
        }
        
        // إذا كان هناك تجديد، تحديث حالة المنتج إلى Active
        const renewButton = document.querySelector('.renew-button');
        if (renewButton && renewButton.disabled && renewButton.textContent.includes('تم التجديد')) {
            // المنتج تم تجديده، تأكد من تحديث الحالة
            const situationField = document.getElementById('standaloneProductSituation');
            if (situationField) {
                situationField.value = 'Active';
            } else {
                // إذا لم يكن هناك حقل، أضفه كبيانات مخفية
                if (!document.getElementById('hiddenSituationField')) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.id = 'hiddenSituationField';
                    hiddenField.name = 'situation';
                    hiddenField.value = 'Active';
                    document.querySelector('.standalone-form-container').appendChild(hiddenField);
                }
            }
        }
        
        // استدعاء دالة الحفظ الأصلية
        await saveStandaloneEdit();
        
    } catch (error) {
        console.error('❌ خطأ في حفظ التعديلات:', error);
        showStandaloneMessage('❌ ' + error.message, 'error');
    }
}
/**
 * حفظ التعديلات من النافذة المستقلة
 */
async function saveStandaloneEdit() {
    const productNo = window.currentStandaloneEditProductNo;
    if (!productNo) {
        showNotification('❌ رقم المنتج غير موجود', 'error');
        return;
    }

    // التحقق من تاريخ الانتهاء
    const expiryDateField = document.getElementById('standaloneProductExpiredDate');
    if (expiryDateField && expiryDateField.value) {
        const expiryDate = new Date(expiryDateField.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (expiryDate < today) {
            const messagesDiv = document.getElementById('standaloneFormMessages');
            if (messagesDiv) {
                messagesDiv.innerHTML = `
                    <div style="
                        background: #f8d7da;
                        border: 1px solid #f5c6cb;
                        border-radius: 8px;
                        padding: 12px 15px;
                        color: #721c24;
                        font-weight: bold;
                        font-size: 16px;
                        text-align: center;
                        margin-bottom: 10px;
                        animation: fadeIn 0.3s ease;
                    ">
                        <i class="fas fa-exclamation-triangle" style="margin-left: 8px;"></i>
                        ❌ يجب التجديد - تاريخ الانتهاء أقل من تاريخ اليوم
                    </div>
                `;
            }
            
            expiryDateField.style.borderColor = '#dc3545';
            expiryDateField.style.boxShadow = '0 0 0 0.2rem rgba(220,53,69,.25)';
            expiryDateField.focus();
            expiryDateField.select();
            
            console.log('❌ منع الحفظ: تاريخ الانتهاء منتهي');
            return;
        }
    }
    
    // التحقق من التجديد
    let shouldDeductBalance = false;
    let renewalInfo = null;
    
    if (window.productRenewed) {
        const counterActiveElement = document.getElementById('counter-active');
        const counterActiveText = counterActiveElement ? counterActiveElement.textContent.trim() : '0';
        const activeBalance = parseInt(counterActiveText) || 0;
        
        if (activeBalance < 1) {
            showInsufficientBalanceModal();
            return;
        }
        
        shouldDeductBalance = true;
        renewalInfo = {
            productNo: productNo,
            renewalDate: window.renewalDate,
            deductionAmount: 1
        };
    }
    
    try {
        const saveBtn = document.querySelector('.edit-modal-btn-save');
        const originalBtn = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
        saveBtn.disabled = true;
        
        const updatedData = collectAllFormData();
        updatedData.productNo = productNo;
        
        if (window.productRenewed) {
            updatedData.situation = "Active";
            updatedData.productSituation = "Active";
        }
        
        await handleImagesBeforeSave(updatedData);
        
        // 1. خصم الرصيد أولاً إذا كان هناك تجديد
        let deductionSuccess = true;
        let newBalance = 0;
        
        if (shouldDeductBalance && renewalInfo) {
            const deductionResult = await deductActiveNoBalance(renewalInfo);
            
            if (deductionResult.success) {
                deductionSuccess = true;
                newBalance = deductionResult.newBalance;
            } else {
                // فشل خصم الرصيد - إلغاء العملية
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtn;
                showNotification(`❌ فشل خصم الرصيد: ${deductionResult.error}`, 'error');
                return;
            }
        }
        
        // 2. تحديث المنتج فقط إذا نجح خصم الرصيد أو لا يوجد تجديد
        if (deductionSuccess && typeof updateProductInExcel === 'function') {
            const result = await updateProductInExcel(updatedData);
            
            if (result) {
                if (shouldDeductBalance && deductionSuccess) {
                    updateLocalBalanceCounter(newBalance);
                    showNotification('✅ تم تجديد الاشتراك وخصم الرصيد بنجاح', 'success');
                } else {
                    showNotification('✅ تم تحديث المنتج بنجاح', 'success');
                }
                
                // تنظيف البيانات
                delete window.productRenewed;
                delete window.renewalDate;
                delete window.productNo;
                
                // إعادة تعيين زر التجديد
                const renewButton = document.querySelector('.renew-button');
                if (renewButton) {
                    renewButton.disabled = false;
                    renewButton.innerHTML = '<i class="fas fa-sync-alt"></i> تجديد المنتج 6 أشهر';
                    renewButton.style.background = '#e74c3c';
                }
                
                // إعادة تعيين زر الحفظ
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtn;
                
                // إغلاق النافذة
                setTimeout(() => {
                    closeStandaloneEditModal();
                    if (typeof loadUserProductsFromExcel === 'function') {
                        setTimeout(() => loadUserProductsFromExcel(), 1000);
                    }
                }, 1500);
            }
        }
        
    } catch (error) {
        console.error('❌ خطأ:', error);
        showNotification(`❌ ${error.message}`, 'error');
        
        const saveBtn = document.querySelector('.edit-modal-btn-save');
        if (saveBtn) {
            saveBtn.innerHTML = originalBtn;
            saveBtn.disabled = false;
        }
    }
}



function parseDateFromDMY(dateString) {
    if (!dateString) return null;
    
    try {
        // تنسيق التاريخ أولاً إذا كان يحتاج
        const formattedDate = formatDateToDMY(dateString);
        const parts = formattedDate.split('/');
        
        if (parts.length !== 3) return null;
        
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // الأشهر من 0-11
        const year = parseInt(parts[2], 10);
        
        return new Date(year, month, day);
    } catch (error) {
        console.error('❌ خطأ في تحليل التاريخ:', error);
        return null;
    }
}
/**
 * جمع جميع البيانات من النموذج
 */
function collectAllFormData() {
    const data = {
        // المعلومات الأساسية
        productName: document.getElementById('standaloneProductName')?.value || '',
        custel: document.getElementById('standaloneCustel')?.value || '',
        productCategory: document.getElementById('standaloneProductCategory')?.value || '',
        
        // السعر والكمية
        productPrice: document.getElementById('standaloneProductPrice')?.value || '',
        productQuantity: document.getElementById('standaloneProductQuantity')?.value || '1',
        productWarranty: document.getElementById('standaloneProductWarranty')?.value || '',
        
        // الحالة واللون
        productState: document.getElementById('standaloneProductState')?.value || '',
        productColor: document.getElementById('standaloneProductColor')?.value || '',
        
        // 🔥 **جميع حقول التاريخ - التأكد من إرسالها جميعاً**
        timestamp: document.getElementById('standaloneTimestamp')?.value || 
                   new Date().toISOString().split('T')[0],
        
        productAddDate: document.getElementById('standaloneProductAddDate')?.value || 
                       document.getElementById('hiddenProductAddDate')?.value ||
                       document.getElementById('standaloneTimestamp')?.value ||
                       new Date().toISOString().split('T')[0],
        
        productExpiredDate: document.getElementById('standaloneProductExpiredDate')?.value || 
                          window.currentStandaloneEditProductData?.productExpiredDate || 
                          new Date().toISOString().split('T')[0],
        
        // الموقع
        productLocationState: document.getElementById('standaloneProductLocationState')?.value || '',
        state: document.getElementById('standaloneProductLocationState')?.value || '',
        productLocationName: document.getElementById('standaloneProductLocationName')?.value || '',
        productLocationLink: document.getElementById('standaloneProductLocationLink')?.value || '',
        
        // الوصف
        productDescription: document.getElementById('standaloneProductDescription')?.value || '',
        
        // بيانات إضافية
        situation: "Active", // 🔥 **تغيير الحالة إلى Active بعد التجديد**
        updateDate: new Date().toISOString(),
        
        // 🔥 **الحقول الإضافية للتأكد من التحديث في Excel**
        // قد تحتاج Excel Sheet إلى أسماء حقول محددة
        'تاريخ الإضافة': document.getElementById('standaloneProductAddDate')?.value || 
                        document.getElementById('standaloneTimestamp')?.value,
        
        'تاريخ الانتهاء': document.getElementById('standaloneProductExpiredDate')?.value,
        
        'التاريخ': document.getElementById('standaloneTimestamp')?.value,
        
        'Timestamp': document.getElementById('standaloneTimestamp')?.value,
        
        // الاحتفاظ بتاريخ الطلب الأصلي
        originalTimestamp: window.currentStandaloneEditProductData?.originalTimestamp || 
                          window.currentStandaloneEditProductData?.timestamp
    };
    
    console.log('📋 جميع بيانات التاريخ المرسلة:', {
        timestamp: data.timestamp,
        productAddDate: data.productAddDate,
        productExpiredDate: data.productExpiredDate,
        situation: data.situation
    });
    
    return data;
}



/**
 * إنشاء نافذة التعديل ديناميكياً
 */
function createStandaloneEditModal() {
    console.log('🏗️ إنشاء نافذة التعديل ديناميكياً');
    
    // إزالة أي نافذة سابقة
    const existingModal = document.getElementById('standaloneEditModal');
    if (existingModal) existingModal.remove();
    
    // إنشاء HTML للنافذة
    const modalHTML = `
        <div id="standaloneEditModal" class="edit-product-modal">
            <div class="edit-product-modal-content">
                <div class="edit-product-modal-header">
                    <h3>
                        <i class="fas fa-edit"></i>
                        <span id="editModalTitle">تعديل المنتج</span>
                        <span id="editProductNo" style="font-size: 14px; margin-right: 10px;"></span>
                    </h3>
                    <button class="edit-product-modal-close" onclick="closeStandaloneEditModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="edit-product-modal-body" id="standaloneEditFormContainer">
                    <div id="editFormLoading" style="text-align: center; padding: 50px;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #3498db;"></i>
                        <p style="margin-top: 20px; font-size: 16px;">جاري تحميل بيانات المنتج...</p>
                    </div>
                </div>
                
                <div class="edit-product-modal-footer">
                    <button class="edit-modal-btn edit-modal-btn-save" onclick="saveStandaloneEdit()">
                        <i class="fas fa-save"></i>
                        حفظ التعديلات
                    </button>
                    <button class="edit-modal-btn edit-modal-btn-close" onclick="closeStandaloneEditModal()">
                        <i class="fas fa-times"></i>
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // إضافة النافذة إلى body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    console.log('✅ تم إنشاء نافذة التعديل ديناميكياً');
}

// دالة إغلاق النافذة
function closeStandaloneEditModal() {
    console.log('🚪 إغلاق نافذة التعديل المستقلة');
    
    const modal = document.getElementById('standaloneEditModal');
    if (modal) {
        modal.classList.remove('show');
        
        // إخفاء النافذة بعد الأنيميشن
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    
    // إعادة التمرير
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    // تنظيف البيانات المؤقتة
    delete window.currentStandaloneEditProductNo;
    delete window.currentStandaloneEditProductData;
    
    console.log('✅ تم إغلاق النافذة');
}


// تشغيل عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 الصفحة محملة، جاهز لنافذة التعديل المستقلة');
    
    // إضافة CSS
    addStandaloneModalStyles();
    
    // تأكد من وجود النافذة
    if (!document.getElementById('standaloneEditModal')) {
        createStandaloneEditModal();
    }
    
    // تعديل جميع أزرار التعديل في الصفحة
    setTimeout(() => {
        modifyAllEditButtons();
    }, 2000);
});

// تعديل جميع أزرار التعديل لاستخدام النافذة الجديدة
function modifyAllEditButtons() {
    const editButtons = document.querySelectorAll('[onclick*="loadProductDataForEdit"], [onclick*="editProduct"]');
    
    editButtons.forEach(button => {
        const onclick = button.getAttribute('onclick') || '';
        if (onclick.includes('loadProductDataForEdit') && !onclick.includes('openStandaloneEditModal')) {
            const match = onclick.match(/['"]([^'"]+)['"]/);
            if (match && match[1]) {
                const productNo = match[1];
                button.setAttribute('onclick', `openStandaloneEditModal('${productNo}')`);
                button.setAttribute('title', 'فتح في نافذة مستقلة');
                button.innerHTML = '<i class="fas fa-external-link-alt"></i> تعديل في نافذة جديدة';
            }
        }
    });
}

// دالة تجديد المنتج بستة أشهر
function renewProductSixMonths() {
    try {
        // التحقق من رصيد المستخدم (counter-active)
        const counterActiveElement = document.getElementById('counter-active');
        const counterActiveText = counterActiveElement ? counterActiveElement.textContent.trim() : '0';
        const activeBalance = parseInt(counterActiveText) || 0;
        
        console.log(`💰 الرصيد النشط الحالي: ${activeBalance}`);
        
        // إذا كان الرصيد أقل من 1، عرض نافذة تنبيه
        if (activeBalance < 1) {
            showInsufficientBalanceModal();
            return; // إيقاف عملية التجديد
        }
        
        // إذا كان الرصيد كافياً، متابعة عملية التجديد
        console.log('🔄 تجديد المنتج لمدة 6 أشهر...');
        
        // 1. الحصول على تاريخ اليوم بدون أي تعديلات
        const today = new Date();
        
        // ضبط الوقت لمنتصف النهار لتجنب مشاكل المنطقة الزمنية
        today.setHours(12, 0, 0, 0);
        
        // 2. حساب تاريخ اليوم + 6 أشهر بدون أي نقص
        const sixMonthsLater = new Date(today);
        sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
        
        // 3. استخدام دالة مخصصة لتنسيق التاريخ لتجنب مشكلة UTC
        const formatDateToYMD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // 4. تنسيق التواريخ
        const todayFormatted = formatDateToYMD(today);
        const sixMonthsLaterFormatted = formatDateToYMD(sixMonthsLater);
        
        // 5. تنسيق للعرض (تأكد أن formatDateToDMY لا تخصم يومًا أيضًا)
        const todayDisplay = formatDateToDMY ? formatDateToDMY(today) : todayFormatted;
        const sixMonthsLaterDisplay = formatDateToDMY ? formatDateToDMY(sixMonthsLater) : sixMonthsLaterFormatted;
        
        console.log(`📅 التواريخ الجديدة:
          تاريخ الإضافة الجديد: ${todayFormatted} (${todayDisplay})
          تاريخ الانتهاء الجديد: ${sixMonthsLaterFormatted} (${sixMonthsLaterDisplay})`);
        
        // 6. تحديث جميع حقول التاريخ في النموذج
        updateAllDateFields(todayFormatted, sixMonthsLaterFormatted, todayDisplay, sixMonthsLaterDisplay);
        
        // 7. تحديث البيانات المخزنة
        updateStoredProductDates(today, sixMonthsLater);
        
        // 8. إخفاء رسالة التنبيه الحمراء
        const messagesDiv = document.getElementById('standaloneFormMessages');
        if (messagesDiv) {
            messagesDiv.innerHTML = ''; // إزالة رسالة التنبيه
        }
        
        // 9. تلوين بوردر تاريخ الانتهاء باللون الأخضر
        const expiryDateField = document.getElementById('standaloneProductExpiredDate');
        if (expiryDateField) {
            expiryDateField.style.borderColor = '#28a745'; // أخضر
            expiryDateField.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
            expiryDateField.style.backgroundColor = '#f0fff4';
            
            // إزالة التأثيرات السابقة بعد 3 ثواني
            setTimeout(() => {
                expiryDateField.style.boxShadow = '';
                expiryDateField.style.backgroundColor = '';
            }, 3000);
        }
        
        // 10. تحديث زر التجديد
        updateRenewButton();
        
        // 11. تمكين زر الحفظ
        enableSaveButton();
        
        // 12. تخزين علامة التجديد
        window.productRenewed = true;
        window.renewalDate = sixMonthsLaterFormatted;
        window.productNo = window.currentStandaloneEditProductNo;
        
        // 13. عرض رسالة نجاح
        showStandaloneMessage(`
            <div style="
                background: #d4edda;
                border: 1px solid #c3e6cb;
                border-radius: 8px;
                padding: 12px 15px;
                color: #155724;
                font-weight: bold;
                font-size: 16px;
                text-align: center;
                animation: fadeIn 0.3s ease;
            ">
                <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
                ✅ تم تجديد المنتج لمدة 6 أشهر
                <div style="font-size: 14px; margin-top: 8px; color: #0c5460;">
                    <i class="fas fa-coins"></i> سيتم خصم <strong>1 رصيد</strong> من حسابك عند حفظ التعديلات
                </div>
            </div>
        `, 'success', 300000);
        
        console.log('✅ تم تحديث جميع التواريخ بنجاح، المنتج يحتاج إلى خصم رصيد عند الحفظ');
        
    } catch (error) {
        console.error('❌ خطأ في تجديد المنتج:', error);
        showStandaloneMessage('❌ حدث خطأ أثناء تجديد المنتج: ' + error.message, 'error');
    }
}

// دالة تحديث جميع حقول التاريخ
function updateAllDateFields(todayISO, expiryISO, todayDisplay, expiryDisplay) {
    // 1. تحديث حقل Timestamp (تاريخ الإضافة)
    const timestampField = document.getElementById('standaloneTimestamp');
    if (timestampField) {
        timestampField.value = todayISO;
        console.log('✅ تم تحديث standaloneTimestamp:', todayISO);
    }
    
    // 2. تحديث حقل تاريخ الانتهاء
    const expiryDateField = document.getElementById('standaloneProductExpiredDate');
    if (expiryDateField) {
        expiryDateField.value = expiryISO;
        console.log('✅ تم تحديث standaloneProductExpiredDate:', expiryISO);
    }
    
    // 3. تحديث حقل تاريخ الإضافة المخصص (إذا كان موجوداً)
    const addDateField = document.getElementById('standaloneProductAddDate');
    if (addDateField) {
        addDateField.value = todayISO;
        console.log('✅ تم تحديث standaloneProductAddDate:', todayISO);
    } else {
        // إذا لم يكن الحقل موجوداً، أنشئه كحقل مخفي
        createHiddenAddDateField(todayISO);
    }
    
    // 4. تحديث العرض
    updateDateDisplays(todayDisplay, expiryDisplay);
}

// إنشاء حقل تاريخ الإضافة المخفي إذا لم يكن موجوداً
function createHiddenAddDateField(dateValue) {
    // تحقق إذا كان الحقل موجوداً بالفعل
    let hiddenField = document.getElementById('hiddenProductAddDate');
    
    if (!hiddenField) {
        hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.id = 'hiddenProductAddDate';
        hiddenField.name = 'productAddDate';
        
        // أضفه إلى النموذج
        const formContainer = document.querySelector('.standalone-form-container');
        if (formContainer) {
            formContainer.appendChild(hiddenField);
        }
    }
    
    hiddenField.value = dateValue;
    console.log('✅ تم إنشاء/تحديث hiddenProductAddDate:', dateValue);
}

// تحديث عرض التواريخ
function updateDateDisplays(todayDisplay, expiryDisplay) {
    // تحديث عرض تاريخ الإضافة
    const timestampDisplay = document.querySelector('#standaloneTimestamp').parentElement.querySelector('.date-display');
    if (timestampDisplay) {
        timestampDisplay.innerHTML = `
            ${todayDisplay} 
            <span style="color: #28a745; font-weight: bold; font-size: 12px;">
                <i class="fas fa-sync-alt"></i> تم التجديد
            </span>
        `;
        timestampDisplay.className = 'date-display renewed';
    }
    
    // تحديث عرض تاريخ الانتهاء
    const expiryDisplayDiv = document.querySelector('#standaloneProductExpiredDate').parentElement.querySelector('.date-display');
    if (expiryDisplayDiv) {
        expiryDisplayDiv.innerHTML = `
            ${expiryDisplay} 
            <span style="color: #28a745; font-weight: bold; font-size: 12px;">
                <i class="fas fa-plus-circle"></i> +6 أشهر
            </span>
        `;
        expiryDisplayDiv.className = 'date-display renewed';
    }
}

// تحديث البيانات المخزنة
function updateStoredProductDates(today, sixMonthsLater) {
    if (window.currentStandaloneEditProductData) {
        // تحديث جميع حقول التاريخ في البيانات المخزنة
        window.currentStandaloneEditProductData.timestamp = today.toISOString();
        window.currentStandaloneEditProductData.productAddDate = today.toISOString().split('T')[0];
        window.currentStandaloneEditProductData.productExpiredDate = sixMonthsLater.toISOString().split('T')[0];
        window.currentStandaloneEditProductData.situation = "Active";
        
        // تخزين التاريخ القديم للاحتفاظ بالسجل
        if (!window.currentStandaloneEditProductData.originalAddDate) {
            window.currentStandaloneEditProductData.originalAddDate = 
                window.currentStandaloneEditProductData.timestamp;
        }
        
        console.log('💾 تم تحديث البيانات المخزنة:', {
            timestamp: window.currentStandaloneEditProductData.timestamp,
            productAddDate: window.currentStandaloneEditProductData.productAddDate,
            productExpiredDate: window.currentStandaloneEditProductData.productExpiredDate,
            situation: window.currentStandaloneEditProductData.situation
        });
    }
}

// تحديث زر التجديد
function updateRenewButton() {
    const renewButton = document.querySelector('.renew-button');
    if (renewButton) {
        renewButton.innerHTML = '<i class="fas fa-check-circle"></i> تم التجديد - جاهز للحفظ';
        renewButton.style.background = '#28a745';
        renewButton.disabled = true;
        renewButton.title = 'تم تجديد المنتج، احفظ التعديلات لخصم الرصيد';
        
        // إضافة وصف تحت الزر
        const buttonContainer = renewButton.parentElement;
        if (buttonContainer && !buttonContainer.querySelector('.renew-details')) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'renew-details';
 
        }
    }
}

// تمكين زر الحفظ
function enableSaveButton() {
    const saveButton = document.querySelector('.edit-modal-btn-save');
    if (saveButton && saveButton.disabled) {
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.cursor = 'pointer';
        
        // إضافة تأثير
        saveButton.style.animation = 'pulse 2s infinite';
        setTimeout(() => {
            saveButton.style.animation = '';
        }, 2000);
    }
}

// دالة التحقق من تاريخ الانتهاء
function checkExpiryForRenewal(expiryDate) {
    if (!expiryDate) return false;
    
    try {
        const today = new Date();
        const expiry = new Date(expiryDate);
        
        // تنسيق التواريخ لمقارنة فقط التاريخ (بدون الوقت)
        const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const expiryDateOnly = new Date(expiry.getFullYear(), expiry.getMonth(), expiry.getDate());
        
        return expiryDateOnly < todayDate;
    } catch (error) {
        console.error('❌ خطأ في التحقق من تاريخ الانتهاء:', error);
        return false;
    }
}
/**
 * إضافة أنماط الخريطة
 */
function addMapStyles() {
    if (!document.getElementById('map-styles')) {
        const style = document.createElement('style');
        style.id = 'map-styles';
        style.textContent = `
            .map-search-container {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .map-search-container input {
                flex: 1;
            }
            
            .map-search-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 0 15px;
                border-radius: 5px;
                cursor: pointer;
            }
            
            .map-current-btn {
                background: #2ecc71;
                color: white;
                border: none;
                padding: 0 15px;
                border-radius: 5px;
                cursor: pointer;
                white-space: nowrap;
                font-size: 14px;
            }
            
            .mini-map-container {
                margin: 15px 0;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
                border: 1px solid #dee2e6;
            }
            
            .map-coordinates {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background: white;
                border-radius: 5px;
                border: 1px solid #dee2e6;
                font-size: 14px;
                color: #495057;
            }
            
            .clear-marker-btn {
                background: #e74c3c;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .clear-marker-btn:hover {
                background: #c0392b;
            }
            
            .map-instructions {
                background: #e3f2fd;
                border: 1px solid #bbdefb;
                border-radius: 5px;
                padding: 10px;
                margin-top: 10px;
                color: #1976d2;
                font-size: 13px;
                display: flex;
                align-items: flex-start;
                gap: 8px;
            }
            
            .map-instructions i {
                margin-top: 2px;
            }
            
            /* أنماط استبدال الصور */
            .image-preview-item {
                position: relative;
                cursor: pointer;
                transition: transform 0.3s;
            }
            
            .image-preview-item:hover {
                transform: scale(1.05);
            }
            
            .image-replace-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
                border-radius: 8px;
                color: white;
            }
            
            .image-preview-item:hover .image-replace-overlay {
                opacity: 1;
            }
            
            .replace-image-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            
            .replace-image-btn:hover {
                background: #2980b9;
            }
            
            .image-number {
                position: absolute;
                top: 5px;
                left: 5px;
                background: #3498db;
                color: white;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                z-index: 2;
            }
            
            .images-preview-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .image-preview-item img {
                width: 100%;
                height: 150px;
                object-fit: cover;
                border-radius: 8px;
                border: 2px solid #dee2e6;
            }
        `;
        document.head.appendChild(style);
    }
}

/**
 * تهيئة الخريطة المصغرة
 */

let currentLocation = null;

function initMiniMap(productData) {
    try {
        // إنشاء الخريطة
        const mapElement = document.getElementById('miniMap');
        if (!mapElement) return;
        
        // تنسيقات أولية للخريطة (العراق)
       const defaultLocation = [23.5880, 58.3829]; // وسط العراق
        const zoomLevel = 6;
        
        // إنشاء الخريطة باستخدام Leaflet
        map = L.map('miniMap').setView(defaultLocation, zoomLevel);
        
        // إضافة طبقة الخريطة (استخدام OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
        }).addTo(map);
        
        // ربط مربع البحث مع حقل اسم الموقع
        const locationNameInput = document.getElementById('standaloneProductLocationName');
        const searchInput = document.getElementById('mapSearch');
        
        if (locationNameInput && searchInput) {
            // جلب الاسم الحالي إلى مربع البحث
            searchInput.value = locationNameInput.value;
            
            // عند تغيير اسم الموقع، تحديث مربع البحث
            locationNameInput.addEventListener('input', function() {
                searchInput.value = this.value;
            });
            
            // عند تغيير مربع البحث، تحديث اسم الموقع
            searchInput.addEventListener('input', function() {
                locationNameInput.value = this.value;
            });
        }
        
        // محاولة الحصول على الموقع من بيانات المنتج
        if (productData.productLocationLink) {
            try {
                // محاولة استخراج إحداثيات من رابط خرائط جوجل
                const coords = extractCoordinatesFromGoogleMaps(productData.productLocationLink);
                if (coords) {
                    marker = L.marker(coords).addTo(map);
                    map.setView(coords, 13);
                    updateCoordinatesDisplay(coords);
                    showClearMarkerButton(true);
                    
                    // جلب اسم الموقع من الإحداثيات
                    reverseGeocode(coords, true);
                }
            } catch (e) {
                console.log('لا يمكن استخراج إحداثيات من الرابط');
            }
        }
        
        // أحداث البحث
        const searchBtn = document.getElementById('searchLocationBtn');
        const currentLocationBtn = document.getElementById('useCurrentLocationBtn');
        const clearMarkerBtn = document.getElementById('clearMarkerBtn');
        
        // حدث البحث
        if (searchBtn && searchInput) {
            searchBtn.addEventListener('click', () => searchLocation(searchInput.value));
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchLocation(searchInput.value);
                }
            });
        }
        
        // حدث الموقع الحالي
        if (currentLocationBtn) {
            currentLocationBtn.addEventListener('click', getCurrentLocation);
        }
        
        // حدث إزالة العلامة
        if (clearMarkerBtn) {
            clearMarkerBtn.addEventListener('click', clearMarker);
        }
        
        // حدث النقر على الخريطة
        map.on('click', function(e) {
            addMarker(e.latlng);
            updateCoordinatesDisplay(e.latlng);
            updateLocationLink(e.latlng);
            
            // جلب اسم الموقع عند النقر
            getLocationNameFromCoordinates(e.latlng);
        });
        
    } catch (error) {
        console.error('❌ خطأ في تهيئة الخريطة:', error);
        document.getElementById('miniMapContainer').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>لا يمكن تحميل الخريطة. تأكد من اتصال الإنترنت.</p>
            </div>
        `;
    }
}

/**
 * البحث عن موقع
 */
function searchLocation(query) {
    if (!query.trim()) return;
    
    showStandaloneMessage('جاري البحث عن الموقع...', 'info');
    
    // تحديث حقل اسم الموقع مع قيمة البحث
    const locationNameInput = document.getElementById('standaloneProductLocationName');
    const searchInput = document.getElementById('mapSearch');
    
    if (locationNameInput && searchInput.value !== query) {
        locationNameInput.value = query;
    }
    
    // استخدام Nominatim للبحث (OpenStreetMap)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=ar`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                const location = [lat, lon];
                
                // تحديث عرض الخريطة
                map.setView(location, 14);
                
                // إضافة علامة
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker(location).addTo(map);
                
                // تحديث العرض
                updateCoordinatesDisplay(location);
                showClearMarkerButton(true);
                
                // تحديث اسم الموقع بالكامل من النتيجة
                updateLocationName(result.display_name);
                
                // تحديث رابط الموقع
                updateLocationLink({lat: lat, lng: lon});
                
                showStandaloneMessage(`تم العثور على: ${result.display_name}`, 'success');
            } else {
                showStandaloneMessage('لم يتم العثور على الموقع المطلوب', 'warning');
            }
        })
        .catch(error => {
            console.error('❌ خطأ في البحث:', error);
            showStandaloneMessage('خطأ في البحث عن الموقع', 'error');
        });
}

/**
 * الحصول على الموقع الحالي
 */
function getCurrentLocation() {
    if (!navigator.geolocation) {
        showStandaloneMessage('المتصفح لا يدعم تحديد الموقع', 'error');
        return;
    }
    
    showStandaloneMessage('جاري الحصول على موقعك الحالي...', 'info');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const location = [position.coords.latitude, position.coords.longitude];
            currentLocation = location;
            
            // تحديث عرض الخريطة
            map.setView(location, 15);
            
            // إضافة علامة
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(location).addTo(map);
            
            // تحديث العرض
            updateCoordinatesDisplay({lat: location[0], lng: location[1]});
            showClearMarkerButton(true);
            
            // البحث عن اسم الموقع وجلب الاسم والرابط
            getLocationInfoFromCoordinates(location[0], location[1]);
            
            showStandaloneMessage('تم الحصول على موقعك الحالي', 'success');
        },
        (error) => {
            console.error('❌ خطأ في الحصول على الموقع:', error);
            showStandaloneMessage('فشل الحصول على الموقع الحالي', 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}
/**
 * جلب معلومات الموقع من الإحداثيات (الاسم والرابط)
 */
function getLocationInfoFromCoordinates(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data) {
                // تحديث اسم الموقع
                updateLocationName(data.display_name || 'موقع غير معروف');
                
                // تحديث رابط الموقع
                updateLocationLink({lat: lat, lng: lng});
                
                // تحديث مربع البحث
                const searchInput = document.getElementById('mapSearch');
                if (searchInput && data.display_name) {
                    // استخراج اسم المنطقة الأساسية من العنوان الكامل
                    const locationParts = data.display_name.split(',');
                    const mainLocation = locationParts[0] || locationParts[1] || data.display_name;
                    searchInput.value = mainLocation.trim();
                }
            }
        })
        .catch(error => {
            console.error('❌ خطأ في جلب معلومات الموقع:', error);
            
            // استخدام اسم افتراضي إذا فشل الاتصال
            updateLocationName('موقع المستخدم الحالي');
            updateLocationLink({lat: lat, lng: lng});
        });
}
/**
 * جلب اسم الموقع عند النقر على الخريطة
 */
function getLocationNameFromCoordinates(latlng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&accept-language=ar`;
    
    showStandaloneMessage('جاري تحديد اسم الموقع...', 'info');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.display_name) {
                // تحديث اسم الموقع
                updateLocationName(data.display_name);
                
                // تحديث مربع البحث بالاسم الأساسي
                const searchInput = document.getElementById('mapSearch');
                if (searchInput) {
                    const locationParts = data.display_name.split(',');
                    const mainLocation = locationParts[0] || data.display_name;
                    searchInput.value = mainLocation.trim();
                }
                
                showStandaloneMessage('تم تحديد الموقع: ' + data.display_name, 'success');
            } else {
                updateLocationName('موقع غير معروف');
                showStandaloneMessage('لم يتم العثور على اسم للموقع', 'warning');
            }
        })
        .catch(error => {
            console.error('❌ خطأ في جلب اسم الموقع:', error);
            updateLocationName('موقع محدد');
            showStandaloneMessage('موقع محدد (لم يتم تحديد الاسم)', 'info');
        });
}
/**
 * إضافة علامة على الخريطة
 */
function addMarker(latlng) {
    if (marker) {
        map.removeLayer(marker);
    }
    marker = L.marker(latlng).addTo(map);
    showClearMarkerButton(true);
}

/**
 * تحديث عرض الإحداثيات
 */
function updateCoordinatesDisplay(latlng) {
    const coordinatesDisplay = document.getElementById('selectedCoordinates');
    if (coordinatesDisplay) {
        coordinatesDisplay.textContent = `الإحداثيات: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
    
    // تحديث رابط الموقع
    updateLocationLink(latlng);
}

/**
 * تحديث اسم الموقع في الحقل المخصص
 */
function updateLocationName(name) {
    const locationNameInput = document.getElementById('standaloneProductLocationName');
    if (locationNameInput) {
        locationNameInput.value = name;
    }
}

/**
 * تحديث رابط الموقع في الحقل المخصص
 */
function updateLocationLink(latlng) {
    const locationLinkField = document.getElementById('standaloneProductLocationLink');
    if (locationLinkField) {
        // إنشاء رابط خرائط جوجل
        const googleMapsLink = `https://www.google.com/maps?q=${latlng.lat},${latlng.lng}&z=15`;
        locationLinkField.value = googleMapsLink;
    }
}

/**
 * تحديث عرض الإحداثيات
 */
function updateCoordinatesDisplay(latlng) {
    const coordinatesDisplay = document.getElementById('selectedCoordinates');
    if (coordinatesDisplay) {
        coordinatesDisplay.textContent = `الإحداثيات: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
}

/**
 * عرض/إخفاء زر إزالة العلامة
 */
function showClearMarkerButton(show) {
    const clearMarkerBtn = document.getElementById('clearMarkerBtn');
    if (clearMarkerBtn) {
        clearMarkerBtn.style.display = show ? 'inline-block' : 'none';
    }
}

/**
 * إزالة العلامة
 */
function clearMarker() {
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    showClearMarkerButton(false);
    
    // تحديث العرض
    document.getElementById('selectedCoordinates').textContent = 'لم يتم تحديد موقع بعد';
    
    // إزالة القيم من الحقول
    document.getElementById('standaloneProductLocationName').value = '';
    document.getElementById('standaloneProductLocationLink').value = '';
    document.getElementById('mapSearch').value = '';
    
    showStandaloneMessage('تم إزالة الموقع المحدد', 'info');
}

/**
 * تحويل الإحداثيات إلى اسم موقع
 */
function reverseGeocode(latlng, updateSearch = false) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng[0]}&lon=${latlng[1]}&accept-language=ar`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.display_name) {
                // تحديث اسم الموقع
                updateLocationName(data.display_name);
                
                // تحديث مربع البحث إذا طلب
                if (updateSearch) {
                    const searchInput = document.getElementById('mapSearch');
                    if (searchInput) {
                        const locationParts = data.display_name.split(',');
                        const mainLocation = locationParts[0] || data.display_name;
                        searchInput.value = mainLocation.trim();
                    }
                }
                
                // تحديث رابط الموقع
                updateLocationLink({lat: latlng[0], lng: latlng[1]});
            }
        })
        .catch(error => {
            console.error('❌ خطأ في تحويل الإحداثيات:', error);
        });
}

/**
 * استخراج إحداثيات من رابط خرائط جوجل
 */
function extractCoordinatesFromGoogleMaps(url) {
    try {
        // نمط 1: https://www.google.com/maps?q=33.3123,44.3611
        const pattern1 = /q=([-\d.]+),([-\d.]+)/;
        const match1 = url.match(pattern1);
        if (match1) {
            return [parseFloat(match1[1]), parseFloat(match1[2])];
        }
        
        // نمط 2: https://maps.google.com/?ll=33.3123,44.3611
        const pattern2 = /ll=([-\d.]+),([-\d.]+)/;
        const match2 = url.match(pattern2);
        if (match2) {
            return [parseFloat(match2[1]), parseFloat(match2[2])];
        }
        
        return null;
    } catch (error) {
        console.error('❌ خطأ في استخراج الإحداثيات:', error);
        return null;
    }
}

/**
 * إضافة أنماط الصور
 */
function addImageStyles() {
    if (!document.getElementById('image-styles')) {
        const style = document.createElement('style');
        style.id = 'image-styles';
        style.textContent = `
            /* أنماط استبدال الصور */
            .image-preview-item {
                position: relative;
                cursor: pointer;
                transition: transform 0.3s, box-shadow 0.3s;
                border-radius: 10px;
                overflow: hidden;
                background: #f8f9fa;
                border: 2px solid #dee2e6;
            }
            
            .image-preview-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                border-color: #3498db;
            }
            
            .image-replace-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
                border-radius: 8px;
                color: white;
                padding: 15px;
            }
            
            .image-preview-item:hover .image-replace-overlay {
                opacity: 1;
            }
            
            .replace-image-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                width: 120px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 14px;
                transition: background 0.3s;
            }
            
            .replace-image-btn:hover {
                background: #2980b9;
            }
            
            .replace-image-btn.delete-btn {
                background: #e74c3c;
            }
            
            .replace-image-btn.delete-btn:hover {
                background: #c0392b;
            }
            
            .image-number {
                position: absolute;
                top: 10px;
                left: 10px;
                background: #3498db;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                z-index: 2;
                font-size: 14px;
            }
            
            .images-preview-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .image-preview-item img {
                width: 100%;
                height: 180px;
                object-fit: cover;
                display: block;
            }
            
            .image-actions {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0,0,0,0.7);
                padding: 8px;
                color: white;
                font-size: 12px;
                text-align: center;
            }
            
            /* الأنماط للأماكن الفارغة */
            .image-preview-item.empty-slot {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 180px;
                border: 2px dashed #dee2e6;
                background: #f8f9fa;
                cursor: pointer;
            }
            
            .image-preview-item.empty-slot:hover {
                border-color: #3498db;
                background: #e3f2fd;
            }
            
            .empty-slot-content {
                text-align: center;
                padding: 20px;
            }
            
            .add-image-btn {
                background: #2ecc71;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                font-size: 14px;
            }
            
            .add-image-btn:hover {
                background: #27ae60;
            }
            
            /* رسالة عدم وجود صور */
            .no-images-message {
                text-align: center;
                padding: 40px 20px;
                background: #f8f9fa;
                border-radius: 10px;
                border: 2px dashed #dee2e6;
                margin-bottom: 20px;
            }
            
            .upload-images-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                display: inline-flex;
                align-items: center;
                gap: 10px;
                transition: all 0.3s;
                font-size: 16px;
            }
            
            .upload-images-btn:hover {
                background: #2980b9;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            }
            
            .upload-images-btn:disabled {
                background: #95a5a6;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            /* رسالة حالة التحميل */
            #imageUploadStatus {
                padding: 10px;
                border-radius: 5px;
                background: #f8f9fa;
                border: 1px solid #dee2e6;
            }
            
            #imageUploadStatus.success {
                background: #d4edda;
                border-color: #c3e6cb;
                color: #155724;
            }
            
            #imageUploadStatus.error {
                background: #f8d7da;
                border-color: #f5c6cb;
                color: #721c24;
            }
            
            #imageUploadStatus.warning {
                background: #fff3cd;
                border-color: #ffeaa7;
                color: #856404;
            }
        `;
        document.head.appendChild(style);
    }
}

/**
 * تهيئة خاصية إدارة الصور
 */
function initImageManagement() {
    // إعادة تهيئة المصفوفات
    window.currentProductImages = [];
    window.uploadedImages = [];
    window.deletedImages = [];
    window.imageSlotsStatus = {};
    
    // تحميل الصور الحالية من العرض
    const imageItems = document.querySelectorAll('.image-preview-item');
    
    imageItems.forEach(item => {
        const index = parseInt(item.getAttribute('data-image-index'));
        const type = item.getAttribute('data-image-type');
        
        if (type === 'existing') {
            const imgSrc = item.getAttribute('data-image-src');
            if (imgSrc && imgSrc.trim() !== '') {
                window.currentProductImages[index] = imgSrc;
                window.imageSlotsStatus[index] = 'filled';
            }
        } else {
            window.imageSlotsStatus[index] = 'empty';
        }
    });
    
    // تحديث حالة زر الإضافة
    updateUploadButtonStatus();
    
    console.log('📸 حالة الصور:', window.imageSlotsStatus);
    console.log('🖼️ الصور الحالية:', window.currentProductImages);
}

/**
 * تحديث حالة زر إضافة الصور
 */
function updateUploadButtonStatus() {
    const uploadBtn = document.querySelector('.upload-images-btn');
    const currentCount = getCurrentImagesCount();
    
    if (!uploadBtn) return;
    
    if (currentCount >= 3) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-ban"></i> الحد الأقصى للصور (3)';
        uploadBtn.style.opacity = '0.7';
        uploadBtn.style.cursor = 'not-allowed';
        showImageUploadStatus('❌ وصلت للحد الأقصى من الصور (3 صور)', 'error');
    } else {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> إضافة صور';
        uploadBtn.style.opacity = '1';
        uploadBtn.style.cursor = 'pointer';
        showImageUploadStatus(`يمكنك إضافة ${3 - currentCount} صور أخرى`, 'info');
    }
}

/**
 * الحصول على عدد الصور الحالي
 */
function getCurrentImagesCount() {
    const filledSlots = document.querySelectorAll('.image-preview-item[data-image-type="existing"]');
    return filledSlots.length;
}

/**
 * عرض حالة تحميل الصور
 */
function showImageUploadStatus(message, type = 'info') {
    const statusDiv = document.getElementById('imageUploadStatus');
    if (!statusDiv) return;
    
    statusDiv.textContent = message;
    statusDiv.className = type;
}

/**
 * النقر على زر إضافة الصور
 */
function handleImageUploadClick() {
    const currentCount = getCurrentImagesCount();
    const maxNewImages = 3 - currentCount;
    
    if (maxNewImages <= 0) {
        showImageUploadStatus('❌ وصلت للحد الأقصى من الصور (3 صور)', 'error');
        return;
    }
    
    const input = document.getElementById('standaloneImageUploadInput');
    input.setAttribute('data-max-count', maxNewImages.toString());
    input.click();
}
/**
 * إضافة صورة إلى العرض
 */
function addImageToDisplay(imageData, fileName = 'صورة جديدة') {
    // العثور على أول مكان فارغ
    const emptySlot = document.querySelector('.image-preview-item.empty-slot:first-child');
    
    if (!emptySlot) {
        showImageUploadStatus('❌ لا يوجد مكان لإضافة المزيد من الصور', 'error');
        return;
    }
    
    const slotIndex = parseInt(emptySlot.getAttribute('data-image-index'));
    
    // تحديث العنصر ليكون صورة
    emptySlot.className = 'image-preview-item';
    emptySlot.innerHTML = `
        <span class="image-number">${slotIndex + 1}</span>
        <img src="${imageData}" 
             alt="${fileName}"
             onerror="handleImageError(this)"
             data-original-src="${imageData}">
        <div class="image-replace-overlay">
            <button type="button" class="replace-image-btn" onclick="replaceSingleImage(${slotIndex})">
                <i class="fas fa-exchange-alt"></i> استبدال
            </button>
            <button type="button" class="replace-image-btn delete-btn" onclick="deleteImageFromPreview(${slotIndex})">
                <i class="fas fa-trash"></i> حذف
            </button>
        </div>
        <div class="image-actions">
            <span class="image-size-info">${fileName.length > 15 ? fileName.substring(0, 12) + '...' : fileName}</span>
        </div>
    `;
    
    // تحديث الصور الحالية
    if (!window.currentProductImages) window.currentProductImages = [];
    window.currentProductImages[slotIndex] = imageData;
}
/**
 * إضافة صورة إلى مكان محدد
 */
function addImageToSlot(slotIndex) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            showImageUploadStatus('❌ الملف المحدد ليس صورة', 'error');
            return;
        }
        
        // التحقق من وجود مكان
        if (getCurrentImagesCount() >= 3) {
            showImageUploadStatus('❌ وصلت للحد الأقصى من الصور', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            updateImageSlot(slotIndex, event.target.result, file.name);
            
            // تخزين الصورة
            if (!window.uploadedImages) window.uploadedImages = [];
            window.uploadedImages.push({
                file: file,
                preview: event.target.result,
                slotIndex: slotIndex
            });
            
            showImageUploadStatus(`✅ تم إضافة الصورة ${slotIndex + 1}`, 'success');
            updateUploadButtonStatus();
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}
/**
 * حذف صورة من المعاينة
 */
function deleteImageFromPreview(imageIndex) {
    const slotElement = document.querySelector(`.image-preview-item[data-image-index="${imageIndex}"]`);
    if (!slotElement) return;
    
    const slotType = slotElement.getAttribute('data-image-type');
    
    if (slotType === 'empty') {
        showImageUploadStatus('❌ هذا المكان فارغ بالفعل', 'warning');
        return;
    }
    
    const confirmDelete = confirm('هل أنت متأكد من حذف هذه الصورة؟');
    if (!confirmDelete) return;
    
    // الحصول على الرابط الأصلي للصورة
    const originalSrc = slotElement.getAttribute('data-image-src') || 
                       slotElement.querySelector('img')?.getAttribute('data-original-src');
    
    // إذا كان الرابط يشير إلى صورة مخزنة (ليس بيانات base64)
    if (originalSrc && originalSrc.startsWith('http')) {
        // تخزين الصور المحذوفة التي لها روابط حقيقية
        if (!window.deletedImages) window.deletedImages = [];
        window.deletedImages[imageIndex] = originalSrc;
    }
    
    // إزالة الصورة من العرض وتحويلها لمكان فارغ
    slotElement.className = 'image-preview-item empty-slot';
    slotElement.setAttribute('data-image-type', 'empty');
    slotElement.removeAttribute('data-image-src');
    
    slotElement.innerHTML = `
        <div class="empty-slot-content">
            <i class="fas fa-plus" style="font-size: 30px; color: #adb5bd; margin-bottom: 10px;"></i>
            <p style="color: #6c757d; font-size: 14px;">إضافة صورة</p>
            <button type="button" class="add-image-btn" onclick="addImageToSlot(${imageIndex})">
                <i class="fas fa-upload"></i> اختيار صورة
            </button>
        </div>
    `;
    
    // تحديث الصور الحالية
    if (window.currentProductImages && window.currentProductImages[imageIndex]) {
        delete window.currentProductImages[imageIndex];
    }
    
    // تحديث الحالة
    window.imageSlotsStatus[imageIndex] = 'empty';
    
    // إزالة من الصور المرفوعة مؤقتاً
    if (window.uploadedImages) {
        window.uploadedImages = window.uploadedImages.filter(img => 
            !img.slotIndex || img.slotIndex !== imageIndex
        );
    }
    
    showImageUploadStatus('✅ تم حذف الصورة', 'success');
    updateUploadButtonStatus();
}

/**
 * التعامل مع الصور قبل الحفظ
 */
async function handleImagesBeforeSave(updatedData) {
    try {
        // تهيئة بيانات الصور
        updatedData.image1 = '';
        updatedData.image2 = '';
        updatedData.image3 = '';
        
        // 1. الحصول على جميع العناصر
        const imageItems = document.querySelectorAll('.image-preview-item');
        
        for (const item of imageItems) {
            const index = parseInt(item.getAttribute('data-image-index'));
            const type = item.getAttribute('data-image-type');
            
            if (type === 'existing') {
                const imgSrc = item.getAttribute('data-image-src');
                if (imgSrc && imgSrc.trim() !== '') {
                    updatedData[`image${index + 1}`] = imgSrc;
                }
            }
        }
        
        // 2. رفع الصور الجديدة
        if (window.uploadedImages && window.uploadedImages.length > 0) {
            showStandaloneMessage('جاري رفع الصور الجديدة...', 'info');
            
            for (let i = 0; i < window.uploadedImages.length; i++) {
                const imageData = window.uploadedImages[i];
                try {
                    const uploadedUrl = await uploadToImgBB(imageData.file);
                    if (uploadedUrl && imageData.slotIndex !== undefined) {
                        updatedData[`image${imageData.slotIndex + 1}`] = uploadedUrl;
                    }
                } catch (uploadError) {
                    console.warn(`⚠️ فشل رفع الصورة ${i + 1}:`, uploadError);
                }
            }
        }
        
        // 3. تنظيف الصور المحذوفة
        if (window.deletedImages) {
            for (const index in window.deletedImages) {
                updatedData[`image${parseInt(index) + 1}`] = '';
            }
        }
        
        console.log('📸 بيانات الصور المحفوظة:', {
            image1: updatedData.image1,
            image2: updatedData.image2,
            image3: updatedData.image3
        });
        
    } catch (error) {
        console.error('❌ خطأ في معالجة الصور:', error);
        throw new Error('فشل في معالجة الصور');
    }
}
/**
 * الحصول على الصور الحالية من العرض
 */
function getCurrentImagesFromDisplay() {
    const images = [];
    const imageElements = document.querySelectorAll('.image-preview-item:not(.empty-slot) img');
    
    imageElements.forEach((img, index) => {
        if (img.src && !img.src.includes('placeholder')) {
            images[index] = img.src;
        }
    });
    
    return images;
}


// ==================== دالة عرض نافذة الرصيد غير الكافي ====================
function showInsufficientBalanceModal() {
    console.log('⚠️ الرصيد غير كافي، عرض نافذة التنبيه...');
    
    // إنشاء نافذة التنبيه
    const modalHTML = `
        <div id="insufficientBalanceModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        ">
            <div style="
                background: white;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease;
            ">
                <!-- رأس النافذة -->
                <div style="
                    background: #e74c3c;
                    color: white;
                    padding: 20px;
                    text-align: center;
                    position: relative;
                ">
                    <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <h3 style="margin: 0; font-size: 20px;">رصيد غير كافي</h3>
                    <p style="margin: 5px 0 0; opacity: 0.9; font-size: 14px;">
                        رصيدك النشط غير كافي لإتمام عملية التجديد
                    </p>
                </div>
                
                <!-- محتوى النافذة -->
                <div style="padding: 25px; text-align: center;">
                    <div style="
                        background: #f8f9fa;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 20px;
                        border: 2px dashed #dee2e6;
                    ">
                        <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 8px;">
                            <i class="fas fa-coins"></i> الرصيد النشط الحالي
                        </div>
                        <div style="font-size: 32px; font-weight: 700; color: #e74c3c;">
                            <span id="currentBalanceDisplay">0</span>
                        </div>
                        <div style="font-size: 13px; color: #95a5a6; margin-top: 5px;">
                            المطلوب: <span style="color: #2ecc71; font-weight: bold;">1</span> رصيد
                        </div>
                    </div>
                    
                    <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                        يرجى شحن رصيدك أو تنشيط الرصيد الحالي لمتابعة عملية تجديد المنتج.
                        <br><br>
                        <strong>ملاحظة:</strong> سيتم خصم رصيد واحد عند حفظ التعديلات بعد التجديد.
                    </p>
                    
                    <!-- أزرار الإجراء -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="openMyOrdersModalForRecharge()" style="
                            background: linear-gradient(135deg, #3498db, #2980b9);
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            transition: all 0.3s;
                        ">
                            <i class="fas fa-bolt"></i>
                            شحن الرصيد
                        </button>
                        <button onclick="closeInsufficientBalanceModal()" style="
                            background: #95a5a6;
                            color: white;
                            border: none;
                            padding: 12px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.3s;
                            margin-top: 10px;
                        ">
                            <i class="fas fa-times"></i>
                            إغلاق
                        </button>
                    </div>
                </div>
                
                <!-- تذييل النافذة -->
                <div style="
                    background: #f8f9fa;
                    padding: 15px;
                    text-align: center;
                    border-top: 1px solid #eee;
                    font-size: 12px;
                    color: #7f8c8d;
                ">
                    <i class="fas fa-info-circle"></i>
                    يمكنك التواصل مع الدعم الفني للحصول على المساعدة
                </div>
            </div>
        </div>
    `;
    
    // إضافة النافذة إلى body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // تحديث عرض الرصيد الحالي
    const counterActiveElement = document.getElementById('counter-active');
    const counterActiveText = counterActiveElement ? counterActiveElement.textContent.trim() : '0';
    const activeBalance = parseInt(counterActiveText) || 0;
    
    document.getElementById('currentBalanceDisplay').textContent = activeBalance;
    
    // إضافة CSS للأنيميشن إذا لم يكن موجوداً
    addInsufficientBalanceModalStyles();
}

// ==================== دالة فتح نافذة طلباتي للشحن ====================

// ==================== دالة إغلاق نافذة الرصيد غير الكافي ====================
function closeInsufficientBalanceModal() {
    const modal = document.getElementById('insufficientBalanceModal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        modal.style.transition = 'opacity 0.3s, transform 0.3s';
        
        setTimeout(() => {
            if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }, 300);
    }
}

// ==================== إضافة أنماط CSS للنافذة ====================
function addInsufficientBalanceModalStyles() {
    if (!document.getElementById('insufficient-balance-styles')) {
        const style = document.createElement('style');
        style.id = 'insufficient-balance-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideUp {
                from { 
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            
            #insufficientBalanceModal button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            
            #insufficientBalanceModal button:active {
                transform: translateY(0);
            }
            
            /* تأثيرات خاصة لأزرار الشحن والتنشيط */
            #insufficientBalanceModal button:first-of-type:hover {
                box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            }
            
            #insufficientBalanceModal button:nth-of-type(2):hover {
                box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
            }
        `;
        document.head.appendChild(style);
    }
}


// ==================== دالة تحديث عرض الرصيد ====================
function updateBalanceDisplay() {
    const counterActiveElement = document.getElementById('counter-active');
    const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
    
    if (counterActiveElement && currentBalanceDisplay) {
        const counterActiveText = counterActiveElement.textContent.trim();
        const activeBalance = parseInt(counterActiveText) || 0;
        currentBalanceDisplay.textContent = activeBalance;
    }
}

// ==================== تهيئة الأحداث عند تحميل الصفحة ====================
document.addEventListener('DOMContentLoaded', function() {
    // إضافة مستمع حدث لتحديث عرض الرصيد عند تغييره
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'counter-active') {
                updateBalanceDisplay();
            }
        });
    });
    
    const counterActiveElement = document.getElementById('counter-active');
    if (counterActiveElement) {
        observer.observe(counterActiveElement, {
            characterData: true,
            childList: true,
            subtree: true
        });
    }
    
    console.log('✅ تم تحميل نظام التحقق من الرصيد للتجديد');
});

// ==================== دالة مساعدة للتحقق من الرصيد ====================
function checkBalanceBeforeRenewal() {
    const counterActiveElement = document.getElementById('counter-active');
    const counterActiveText = counterActiveElement ? counterActiveElement.textContent.trim() : '0';
    const activeBalance = parseInt(counterActiveText) || 0;
    
    return activeBalance >= 1;
}

// ==================== تعديل دالة saveStandaloneEdit للتحقق من الرصيد ====================
async function saveStandaloneEditWithBalanceCheck() {
    try {
        // التحقق من الرصيد قبل الحفظ
        if (!checkBalanceBeforeRenewal()) {
            showInsufficientBalanceModal();
            return;
        }
        
        // إذا كان الرصيد كافياً، متابعة عملية الحفظ
        await saveStandaloneEdit();
        
    } catch (error) {
        console.error('❌ خطأ في حفظ التعديلات:', error);
        showStandaloneMessage('❌ ' + error.message, 'error');
    }
}

// ==================== دالة خصم الرصيد من Excel Sheet ====================
async function deductActiveNoBalance(renewalInfo) {
    try {
        console.log('💰 بدء خصم الرصيد من ActiveNo:', renewalInfo);
        
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userPhone = currentUser.signupPhone || currentUser.phone;
        
        if (!userPhone) {
            throw new Error('لا يوجد مستخدم مسجل');
        }
        
        // رابط Google Apps Script لتحديث الرصيد (نفس رابط العدادات)
        const BALANCE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxU2EMbS0-Sqt7q-DBPeIjojKl9VCgqbgu3U5WyCQMHnCLTBjHzWm0aw43D2IvZIMEJ/exec';
        
        // الحصول على الرصيد الحالي أولاً
        const currentBalance = await getCurrentActiveNo(userPhone);
        
        if (currentBalance < 1) {
            throw new Error('الرصيد غير كافي');
        }
        
        // حساب الرصيد الجديد
        const newBalance = currentBalance - 1;
        
        // تحديث حقل ActiveNo في بيانات المستخدم
        const updateResult = await updateUserActiveNo(userPhone, newBalance);
        
        if (updateResult.success) {
            // تسجيل عملية الخصم
            await logBalanceDeduction(userPhone, renewalInfo, currentBalance, newBalance);
            
            return {
                success: true,
                newBalance: newBalance,
                message: 'تم خصم الرصيد بنجاح'
            };
        } else {
            throw new Error(updateResult.error || 'فشل في تحديث الرصيد');
        }
        
    } catch (error) {
        console.error('❌ خطأ في خصم الرصيد:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// ==================== دالة تحديث عداد الرصيد المحلي ====================
function updateLocalBalanceCounter() {
    const counterActiveElement = document.getElementById('counter-active');
    if (!counterActiveElement) return;
    
    const currentBalance = parseInt(counterActiveElement.textContent.trim()) || 0;
    const newBalance = Math.max(0, currentBalance - 1); // لا يقل عن الصفر
    
    // تحديث العداد
    counterActiveElement.textContent = newBalance;
    
    // إضافة تأثير مرئي
    counterActiveElement.style.transform = 'scale(1.3)';
    counterActiveElement.style.color = '#e74c3c';
    counterActiveElement.style.fontWeight = 'bold';
    counterActiveElement.style.transition = 'all 0.5s ease';
    
    setTimeout(() => {
        counterActiveElement.style.transform = 'scale(1)';
        counterActiveElement.style.color = '';
        counterActiveElement.style.fontWeight = '';
    }, 500);
    
    // تحديث العداد في نافذة طلباتي إذا كانت مفتوحة
    const myOrdersCounter = document.getElementById('counter-active');
    if (myOrdersCounter && myOrdersCounter !== counterActiveElement) {
        myOrdersCounter.textContent = newBalance;
    }
    
    console.log(`✅ تم تحديث الرصيد المحلي: ${currentBalance} → ${newBalance}`);
}

// ==================== دالة فتح نافذة طلباتي للشحن ====================
function openMyOrdersModalForRecharge() {
    console.log('🔋 فتح نافذة طلباتي للشحن...');
    
    // إغلاق النوافذ المفتوحة أولاً
    closeInsufficientBalanceModal();
    closeStandaloneEditModal();
    
    // فتح نافذة إدخال الكمية مباشرة
    openQuantityInputModal();
    
    // تركيز مباشر على حقل الإدخال
    setTimeout(() => {
        const quantityInput = document.getElementById('quantityInput');
        if (quantityInput) {
            quantityInput.focus();
            quantityInput.select();
            console.log('✅ تم التركيز على حقل إدخال الكمية');
        }
    }, 100); // تأخير بسيط لضمان تحميل العنصر
}
// ==================== دالة الحصول على الرصيد الحالي من ActiveNo ====================
async function getCurrentActiveNo(userPhone) {
    try {
        const COUNTERS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRjaWQJaJpahlG8Z9MIF3Plg6XsHQDM0MpNu3CpSG0TfcEdyZjmRIDEx_qkWC_BoSc/exec';
        
        const url = `${COUNTERS_SCRIPT_URL}?action=getUserCounters&phone=${encodeURIComponent(userPhone)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.counters) {
                return parseInt(data.counters.ActiveNo) || 0;
            }
        }
        
        return 0;
        
    } catch (error) {
        console.error('❌ خطأ في جلب الرصيد الحالي:', error);
        return 0;
    }
}

// ==================== دالة تحديث حقل ActiveNo للمستخدم ====================
async function updateUserActiveNo(userPhone, newBalance) {
    try {
        // رابط السكريبت لتحديث بيانات المستخدم
        const UPDATE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRjaWQJaJpahlG8Z9MIF3Plg6XsHQDM0MpNu3CpSG0TfcEdyZjmRIDEx_qkWC_BoSc/exec';
        
        // تحديث فقط حقل ActiveNo
        const url = UPDATE_SCRIPT_URL + 
                   '?action=updateUserActiveNo' +
                   '&phone=' + encodeURIComponent(userPhone) +
                   '&ActiveNo=' + encodeURIComponent(newBalance) +
                   '&updateDate=' + encodeURIComponent(new Date().toISOString()) +
                   '&t=' + new Date().getTime();
        
        console.log('🔗 تحديث ActiveNo:', url);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });
        
        if (!response.ok) {
            throw new Error(`خطأ في الخادم: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('📥 استجابة تحديث ActiveNo:', result);
        
        return result;
        
    } catch (error) {
        console.error('❌ خطأ في تحديث ActiveNo:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// ==================== دالة تسجيل عملية الخصم ====================
async function logBalanceDeduction(userPhone, renewalInfo, oldBalance, newBalance) {
    try {
        const LOG_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRjaWQJaJpahlG8Z9MIF3Plg6XsHQDM0MpNu3CpSG0TfcEdyZjmRIDEx_qkWC_BoSc/exec';
        
        const logData = {
            timestamp: new Date().toISOString(),
            phone: userPhone,
            action: 'deduct_balance',
            productNo: renewalInfo.productNo,
            amount: renewalInfo.deductionAmount,
            reason: 'تجديد منتج',
            renewalDate: renewalInfo.renewalDate,
            oldBalance: oldBalance,
            newBalance: newBalance
        };
        
        const url = LOG_SCRIPT_URL + '?action=logTransaction&data=' + encodeURIComponent(JSON.stringify(logData));
        
        fetch(url).catch(err => console.warn('⚠️ فشل تسجيل السجل:', err));
        
    } catch (error) {
        console.warn('⚠️ خطأ في تسجيل العملية:', error);
    }
}

// ==================== دالة تحديث عداد الرصيد المحلي ====================
function updateLocalBalanceCounter(newBalance) {
    const counterActiveElement = document.getElementById('counter-active');
    if (!counterActiveElement) return;
    
    // تحديث العداد
    counterActiveElement.textContent = newBalance;
    
    // إضافة تأثير مرئي
    counterActiveElement.style.transform = 'scale(1.3)';
    counterActiveElement.style.color = '#e74c3c';
    counterActiveElement.style.fontWeight = 'bold';
    counterActiveElement.style.transition = 'all 0.5s ease';
    
    setTimeout(() => {
        counterActiveElement.style.transform = 'scale(1)';
        counterActiveElement.style.color = '';
        counterActiveElement.style.fontWeight = '';
    }, 500);
    
    // تحديث العداد في نافذة طلباتي إذا كانت مفتوحة
    const myOrdersCounter = document.querySelector('#myOrdersModal #counter-active');
    if (myOrdersCounter && myOrdersCounter !== counterActiveElement) {
        myOrdersCounter.textContent = newBalance;
    }
    
    console.log(`✅ تم تحديث الرصيد المحلي إلى: ${newBalance}`);
}
// ==================== دالة للتمرير إلى قسم محدد في النافذة ====================
function scrollToTopMyOrdersModal() {
    console.log('🔼 محاولة التمرير إلى أعلى myOrdersModal...');
    
    const modal = document.getElementById('myOrdersModal');
    if (!modal) {
        console.error('❌ myOrdersModal غير موجود');
        return;
    }
    
    // التحقق إذا كانت النافذة مفتوحة
    const isModalOpen = modal.style.display === 'flex' || 
                       modal.style.display === '' ||
                       window.getComputedStyle(modal).display === 'flex';
    
    console.log('🔍 حالة النافذة:', isModalOpen, 'display:', modal.style.display);
    
    if (isModalOpen) {
        // تجربة جميع الطرق الممكنة للتمرير
        
        // الطريقة 1: التمرير داخل محتوى النافذة الرئيسي
        const modalContent = modal.querySelector('.modal-content, .modal-body, .orders-content, .content');
        
        if (modalContent) {
            console.log('✅ تم العثور على محتوى النافذة:', modalContent.className);
            
            // طريقة مباشرة وسريعة
            modalContent.scrollTop = 0;
            
            // طريقة مع تأثير سلس
            setTimeout(() => {
                modalContent.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 10);
            
            console.log('✅ تم التمرير داخل محتوى النافذة');
        } else {
            console.log('⚠️ لم يتم العثور على محتوى محدد، المحاولة على النافذة نفسها');
            // التمرير على النافذة نفسها
            modal.scrollTop = 0;
        }
        
        // الطريقة 2: التمرير على body إذا كان التمرير كامل الصفحة
        setTimeout(() => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }, 50);
        
        // الطريقة 3: استخدام focus على العنصر الأول
        setTimeout(() => {
            const firstElement = modal.querySelector('button, input, .card, .product-card');
            if (firstElement) {
                firstElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }, 100);
        
        console.log('✅ تم التمرير إلى أعلى النافذة');

        
    } else {
        console.log('⚠️ النافذة غير مفتوحة، التمرير في الصفحة الرئيسية');
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
}


function addScrollToTopButtonToModal() {
    const modal = document.getElementById('myOrdersModal');
    if (!modal) return;
    
    // التحقق إذا كان الزر موجود بالفعل
    if (document.getElementById('scrollToTopMyOrdersBtn')) return;
    
    // إنشاء زر التمرير للأعلى
    const scrollButton = document.createElement('button');
    scrollButton.id = 'scrollToTopMyOrdersBtn';
    scrollButton.innerHTML = '▲';
    scrollButton.title = 'التمرير إلى الأعلى';
    scrollButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 0.8;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // إضافة حدث النقر
    scrollButton.addEventListener('click', () => {
        scrollToTopMyOrdersModal();
    });
    
    // إضافة الزر إلى النافذة
    modal.appendChild(scrollButton);
    
    // إظهار/إخفاء الزر بناءً على موقع التمرير
    modal.addEventListener('scroll', function() {
        const button = document.getElementById('scrollToTopMyOrdersBtn');
        if (button) {
            if (this.scrollTop > 100) {
                button.style.opacity = '1';
                button.style.transform = 'translateY(0)';
            } else {
                button.style.opacity = '0';
                button.style.transform = 'translateY(20px)';
                button.style.pointerEvents = 'none';
            }
        }
    }, true);
    
    console.log('✅ تم إضافة زر التمرير للأعلى إلى myOrdersModal');
}
function addScrollToTopStyles() {
    if (!document.getElementById('scroll-to-top-styles')) {
        const style = document.createElement('style');
        style.id = 'scroll-to-top-styles';
        style.textContent = `
            /* أنيميشن التمرير لأعلى */
            @keyframes scrollToTop {
                from {
                    transform: translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            /* تأثير عند التمرير لأعلى */
            .scroll-to-top-effect {
                animation: scrollToTop 0.5s ease;
            }
            
            /* زر التمرير لأعلى في النافذة */
            #scrollToTopMyOrdersBtn {
                animation: fadeInUp 0.5s ease;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* تحسين التمرير للنافذة */
            #myOrdersModal .modal-content {
                scroll-behavior: smooth;
                overflow-y: auto;
                max-height: 90vh;
            }
            
            /* زر التمرير يظهر فقط عند الحاجة */
            #scrollToTopMyOrdersBtn.hidden {
                opacity: 0 !important;
                pointer-events: none !important;
                transform: translateY(20px) !important;
            }
            
            /* تأثير عند وصول التمرير للأعلى */
            .scroll-top-reached {
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);
    }
}


// متغيرات الفلترة
// دالة فتح نافذة الفلترة
// دالة فتح نافذة الفلترة
// دالة فتح نافذة الفلترة
function openFilterModal() {
    console.log('🔓 فتح نافذة الفلترة...');
    
    const modal = document.getElementById('filterModal');
    if (!modal) {
        console.error('❌ عنصر filterModal غير موجود');
        return;
    }
    
    // طريقة آمنة للفتح
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    
    // إضافة كلاس active
    modal.classList.add('active', 'show');
    
    // منع تمرير الصفحة
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    
    // تحديث القيم الحالية في النموذج
    updateFilterFormFromParams();
    
    console.log('✅ تم فتح نافذة الفلترة');
}
// دالة تحديث نموذج الفلترة من المعاملات الحالية
function updateFilterFormFromParams() {
    if (Object.keys(currentFilterParams).length === 0) {
        document.getElementById('filterForm').reset();
        return;
    }
    
    Object.keys(currentFilterParams).forEach(key => {
        // التعامل مع الحقول الخاصة
        if (key === 'productWarranty' || key === 'warranty') {
            const warrantyElement = document.getElementById('filterProductWarranty');
            if (warrantyElement && currentFilterParams[key]) {
                warrantyElement.value = currentFilterParams[key];
            }
        } else {
            // الحقول العادية
            const element = document.getElementById(`filter${capitalizeFirstLetter(key)}`);
            if (element && currentFilterParams[key] !== undefined && currentFilterParams[key] !== '') {
                element.value = currentFilterParams[key];
            }
        }
    });
}

// دالة مساعدة للبحث في بيانات المنتج
function searchInProductFields(product, searchTerm, fields) {
    const term = searchTerm.toLowerCase().trim();
    
    return fields.some(fieldName => {
        const fieldValue = product[fieldName];
        
        if (fieldValue && typeof fieldValue === 'string') {
            return fieldValue.toLowerCase().includes(term);
        }
        
        return false;
    });
}

// ثم استخدامها في الفلترة:
if (showProduct && filterData.productWarranty) {
    const warrantyFields = ['productWarranty', 'warranty', 'type', 'category', 'name'];
    if (!searchInProductFields(product, filterData.productWarranty, warrantyFields)) {
        showProduct = false;
    }
}
// دالة مساعدة لحرف كبير أولي
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}
// دالة إغلاق نافذة الفلترة
function closeFilterModal() {
    console.log('🔒 إغلاق نافذة الفلترة...');
    
    const modal = document.getElementById('filterModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active', 'show');
    }
    
    // إعادة تمكين تمرير الصفحة
    document.body.style.overflow = 'auto';
    document.body.style.position = 'static';
    
    console.log('✅ تم إغلاق نافذة الفلترة');
}


// دالة إعادة تعيين الفلترة
function resetFilter() {
    console.log('🔄 إعادة تعيين الفلترة...');
    
    // 1. إعادة تعيين النموذج
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.reset();
    }
    
    // 2. إعادة تعيين المعاملات
    currentFilterParams = {};
    isFilterApplied = false;
    
    // 3. استعادة المحتوى الأصلي
    const productsGrid = document.getElementById('productsGrid');
    if (productsGrid) {
        const originalContent = productsGrid.getAttribute('data-original-content');
        if (originalContent) {
            productsGrid.innerHTML = originalContent;
            productsGrid.removeAttribute('data-original-content');
        }
        
        // إظهار جميع البطاقات
        const productCards = productsGrid.querySelectorAll('.product-card');
        productCards.forEach(card => {
            showProductCard(card);
        });
    }
    
    // 4. تحديث واجهة الفلترة
    updateFilterUI(false);
    
    // 5. إغلاق النافذة إذا كانت مفتوحة
    closeFilterModal();
    
    // 6. إظهار الإشعار
    showNotification('✅ تم إعادة تعيين الفلترة', 'success');
    
    // 7. تحديث العدادات
    updateProductCounts();
}

function updateFilterUI(isActive) {
    const filterTab = document.querySelector('.filter-tab.filter');
    const filterIcon = filterTab?.querySelector('i');
    
    if (isActive) {
        // تم تطبيق الفلترة
        filterTab?.classList.add('active', 'filter-active');
        filterTab.innerHTML = '<i class="fas fa-filter"></i> فلترة مفعلة';
        if (filterIcon) {
            filterIcon.style.color = '#2ecc71';
        }
        filterTab?.setAttribute('title', 'فلترة مفعلة - انقر لإعادة تعيين');
        
        // إضافة تأثير مميز
        filterTab.style.animation = 'pulse 2s infinite';
    } else {
        // الفلترة معطلة
        filterTab?.classList.remove('active', 'filter-active');
        filterTab.innerHTML = '<i class="fas fa-filter"></i> فلترة';
        filterTab.style.animation = '';
        if (filterIcon) {
            filterIcon.style.color = '';
        }
        filterTab?.removeAttribute('title');
    }
}


// دالة تطبيق الفلترة
function applyFilter(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    console.log('🎯 تطبيق الفلترة...');
    
    try {
        // جمع بيانات الفلترة
        const filterData = collectFilterData();
        console.log('📋 بيانات الفلترة المجمعة:', filterData);
        
        // حفظ المعاملات
        currentFilterParams = filterData;
        isFilterApplied = true;
        
        // تطبيق الفلترة على المنتجات
        const result = applyFilterToProducts(filterData);
        console.log('📊 نتيجة الفلترة:', result);
        
        // إغلاق النافذة
        closeFilterModal();
        
        // تحديث واجهة الفلترة
        updateFilterUI(true);
        
        // إظهار الإشعار
        if (result.visibleCount === 0) {
            showNotification('⚠️ لا توجد منتجات تطابق معايير البحث', 'warning');
        } else {
            showNotification(`✅ تم العثور على ${result.visibleCount} منتج`, 'success');
        }
        
    } catch (error) {
        console.error('❌ خطأ في تطبيق الفلترة:', error);
        showNotification('❌ حدث خطأ في تطبيق الفلترة', 'error');
    }
}
// دالة جمع بيانات الفلترة
function collectFilterData() {
    // أولاً، نجمع القيم من الحقول
    const formData = {
        productName: getFilterValue('filterProductName'),
        productNumber: getFilterValue('filterProductNumber'),
        userPhone: getFilterValue('filterUserPhone'),
        region: getFilterValue('filterRegion'),
        location: getFilterValue('filterLocation'),
        category: getFilterValue('filterCategory'),
        productWarranty: getFilterValue('filterProductWarranty'), // الاسم في HTML
        priceFrom: parseFloat(getFilterValue('filterPriceFrom')) || 0,
        priceTo: parseFloat(getFilterValue('filterPriceTo')) || Infinity,
        color: getFilterValue('filterColor'),
        condition: getFilterValue('filterCondition')
    };
    
    // نرجع البيانات مع اسمين للحقل لضمان المرونة
    return {
        ...formData,
        warranty: formData.productWarranty // نسخة احتياطية
    };
}
// دالة مساعدة للحصول على قيمة الحقل
function getFilterValue(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return '';
    
    const value = element.value;
    return typeof value === 'string' ? value.trim() : '';
}
// دالة تطبيق الفلترة على المنتجات
function applyFilterToProducts(filterData) {
    console.log('🔍 تطبيق الفلترة على المنتجات...');
    
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) {
        console.error('❌ productsGrid غير موجود');
        return { visibleCount: 0, hiddenCount: 0, total: 0 };
    }
    
    const productCards = productsGrid.querySelectorAll('.product-card');
    let visibleCount = 0;
    let hiddenCount = 0;
    
    productCards.forEach(card => {
        const productId = card.getAttribute('data-index');
        const product = productDetails[productId];
        
        if (!product) {
            card.style.display = 'none';
            hiddenCount++;
            return;
        }
        
        let showProduct = true;
        
        // 1. فلترة حسب اسم المنتج
        if (showProduct && filterData.productName) {
            const searchName = filterData.productName.toLowerCase();
            if (product.name && typeof product.name === 'string') {
                if (!product.name.toLowerCase().includes(searchName)) {
                    showProduct = false;
                }
            } else {
                // إذا المنتج ليس له اسم، لا يظهر عند البحث بالاسم
                showProduct = false;
            }
        }
        
        // 2. فلترة حسب رقم المنتج
        if (showProduct && filterData.productNumber) {
            const searchNumber = filterData.productNumber.toLowerCase();
            if (product.productNo && typeof product.productNo === 'string') {
                if (!product.productNo.toLowerCase().includes(searchNumber)) {
                    showProduct = false;
                }
            } else {
                showProduct = false;
            }
        }
        
        // 3. فلترة حسب هاتف المستخدم - إصلاح الخطأ هنا
        if (showProduct && filterData.userPhone) {
            const searchPhone = filterData.userPhone;
            
            // تحويل الهاتف إلى نص إذا لم يكن نصًا
            let phoneValue = '';
            if (product.phone !== undefined && product.phone !== null) {
                phoneValue = String(product.phone); // تحويل أي نوع إلى نص
            }
            
            // إزالة المسافات والإشارات للحصول على أرقام فقط
            const cleanSearchPhone = searchPhone.replace(/\D/g, '');
            const cleanProductPhone = phoneValue.replace(/\D/g, '');
            
            if (cleanProductPhone === '' || !cleanProductPhone.includes(cleanSearchPhone)) {
                showProduct = false;
            }
        }
        
        // 4. فلترة حسب المنطقة
        if (showProduct && filterData.region && product.location) {
            if (product.location !== filterData.region) {
                showProduct = false;
            }
        }
        
        // 5. فلترة حسب الموقع
        if (showProduct && filterData.location && product.locationstate) {
            const searchLocation = filterData.location.toLowerCase();
            const productLocation = product.locationstate ? product.locationstate.toLowerCase() : '';
            
            if (productLocation === '' || !productLocation.includes(searchLocation)) {
                showProduct = false;
            }
        }
        
        // 6. فلترة حسب القسم
        if (showProduct && filterData.category && product.type) {
            if (product.type !== filterData.category) {
                showProduct = false;
            }
        }
        
        // 7. فلترة حسب النوع (الحالة)
if (showProduct && filterData.productWarranty) {
    const searchWarranty = filterData.productWarranty.toLowerCase().trim();
    
    if (searchWarranty) {
        // البحث في جميع الحقول المحتملة
        const warrantyFields = [
            product.productWarranty,  // إذا كان الاسم productWarranty
            product.warranty,         // إذا كان الاسم warranty
            product.type,             // أو قد يكون في النوع
            product.category          // أو في الفئة
        ];
        
        // تحويل جميع الحقول إلى نصوص صغيرة
        const productWarrantyText = warrantyFields
            .filter(field => field && typeof field === 'string')
            .map(field => field.toLowerCase())
            .join(' ');
        
        console.log(`🔍 فلترة حسب نوع المنتج: البحث عن "${searchWarranty}" في "${productWarrantyText}"`);
        
        // إذا لم يتم العثور على الكلمة المطلوبة
        if (!productWarrantyText.includes(searchWarranty)) {
            showProduct = false;
        }
    }
}    
        // 8. فلترة حسب السعر
        if (showProduct && (filterData.priceFrom !== null || filterData.priceTo !== null)) {
            const productPrice = extractPriceFromString(product.price || '0');
            
            console.log(`💰 سعر المنتج ${product.name || productId}: ${productPrice} (بحث من ${filterData.priceFrom} إلى ${filterData.priceTo})`);
            
            // إذا كان هناك حد أدنى والسعر أقل منه
            if (filterData.priceFrom !== null && productPrice < filterData.priceFrom) {
                showProduct = false;
            }
            
            // إذا كان هناك حد أقصى والسعر أكبر منه
            if (filterData.priceTo !== null && productPrice > filterData.priceTo) {
                showProduct = false;
            }
        }
        
        // 9. فلترة حسب اللون
        if (showProduct && filterData.color && product.color) {
            if (product.color !== filterData.color) {
                showProduct = false;
            }
        }
        
        // 10. فلترة حسب الحالة
        if (showProduct && filterData.condition && product.condition) {
            if (product.condition !== filterData.condition) {
                showProduct = false;
            }
        }
        
        // عرض أو إخفاء المنتج
        if (showProduct) {
            card.style.display = 'flex';
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
            visibleCount++;
        } else {
            card.style.display = 'none';
            card.style.opacity = '0';
            card.style.transform = 'scale(0.9)';
            hiddenCount++;
        }
    });
    
    console.log(`✅ الفلترة: ${visibleCount} ظاهر، ${hiddenCount} مخفي`);
        return { visibleCount: visibleCount };

    // عرض رسالة إذا لم توجد منتجات مطابقة
    if (visibleCount === 0 && productCards.length > 0) {
        showNoResultsMessage();
    }
    
    // تحديث عدد المنتجات
    updateProductCounts();
    
    return { visibleCount, hiddenCount, total: productCards.length };
}


function checkProductWarranty(product, filter) {
    if (!filter.productWarranty) return true;
    
    const searchWarranty = filter.productWarranty.toLowerCase().trim();
    
    // البحث في جميع الحقول المحتملة
    const warrantyFields = [
        product.productWarranty,
        product.warranty,
        product.type,
        product.category
    ];
    
    // التحقق مما إذا كان أي حقل يحتوي على الكلمة المطلوبة
    const hasMatch = warrantyFields.some(field => {
        if (field && typeof field === 'string') {
            return field.toLowerCase().includes(searchWarranty);
        }
        return false;
    });
    
    return hasMatch;
}

// ثم تحديث دالة checkFilterCriteria:
function checkFilterCriteria(product, filterData) {
    if (isEmptyFilter(filterData)) return true;
    
    const checks = [
        checkProductName(product, filterData),
        checkProductNumber(product, filterData),
        checkUserPhone(product, filterData),
        checkRegion(product, filterData),
        checkLocation(product, filterData),
        checkCategory(product, filterData),
        checkProductWarranty(product, filterData), // استخدم الدالة الجديدة
        checkPrice(product, filterData),
        checkColor(product, filterData),
        checkCondition(product, filterData)
    ];
    
    return checks.every(check => check === true);
}

// دالة التحقق إذا كانت الفلترة فارغة
function isEmptyFilter(filterData) {
    return Object.values(filterData).every(value => 
        value === '' || value === 0 || value === Infinity
    );
}

// دوال التحقق لكل معيار
function checkProductName(product, filter) {
    if (!filter.productName) return true;
    return product.name && product.name.toLowerCase().includes(filter.productName);
}

function checkProductNumber(product, filter) {
    if (!filter.productNumber) return true;
    return product.productNo && product.productNo.toLowerCase().includes(filter.productNumber);
}

function checkUserPhone(product, filter) {
    if (!filter.userPhone) return true;
    return product.phone && product.phone.includes(filter.userPhone);
}

function checkRegion(product, filter) {
    if (!filter.region) return true;
    return product.location && product.location === filter.region;
}

function checkLocation(product, filter) {
    if (!filter.location) return true;
    return product.locationstate && product.locationstate.toLowerCase().includes(filter.location);
}

function checkCategory(product, filter) {
    if (!filter.category) return true;
    return product.type && product.type === filter.category;
}

function checkProductType(product, filter) {
    if (!filter.productType) return true;
    return product.condition && product.condition === filter.productType;
}

function checkPrice(product, filter) {
    if (filter.priceFrom === 0 && filter.priceTo === Infinity) return true;
    
    const productPrice = extractPrice(product.price);
    return productPrice >= filter.priceFrom && productPrice <= filter.priceTo;
}

function checkColor(product, filter) {
    if (!filter.color) return true;
    return product.color && product.color === filter.color;
}

function checkCondition(product, filter) {
    if (!filter.condition) return true;
    return product.condition && product.condition === filter.condition;
}

// دالة استخراج السعر من النص
function extractPriceFromString(priceText) {
    if (!priceText) return 0;
    
    try {
        const match = priceText.match(/[\d,\.]+/);
        if (match) {
            return parseFloat(match[0].replace(/,/g, ''));
        }
        return 0;
    } catch (error) {
        console.warn('⚠️ خطأ في استخراج السعر:', error);
        return 0;
    }
}

// دوال التحكم في عرض البطاقات
function showProductCard(card) {
    card.style.display = 'flex';
    card.style.opacity = '1';
    card.style.transform = 'scale(1)';
    card.classList.remove('hidden');
    card.classList.add('visible');
}

function hideProductCard(card) {
    card.style.display = 'none';
    card.style.opacity = '0';
    card.style.transform = 'scale(0.9)';
    card.classList.add('hidden');
    card.classList.remove('visible');
}

// دالة عرض رسالة عدم وجود نتائج
function showNoResultsMessage() {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    productsGrid.innerHTML = `
        <div class="no-results-message" style="
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
            margin: 20px;
        ">
            <i class="fas fa-search" style="
                font-size: 70px;
                color: #adb5bd;
                margin-bottom: 25px;
                display: block;
                opacity: 0.7;
            "></i>
            <h3 style="
                color: #495057;
                margin-bottom: 15px;
                font-size: 24px;
            ">لا توجد منتجات تطابق معايير البحث</h3>
            <p style="
                color: #6c757d;
                margin-bottom: 25px;
                font-size: 16px;
                line-height: 1.6;
            ">جرب تغيير معايير الفلترة أو استخدام مصطلحات بحث مختلفة</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="resetFilter()" class="btn btn-secondary" style="
                    padding: 12px 24px;
                    font-size: 16px;
                    border-radius: 8px;
                ">
                    <i class="fas fa-redo"></i> إعادة تعيين الفلترة
                </button>
                <button onclick="closeFilterModal()" class="btn btn-primary" style="
                    padding: 12px 24px;
                    font-size: 16px;
                    border-radius: 8px;
                ">
                    <i class="fas fa-filter"></i> تعديل الفلترة
                </button>
            </div>
        </div>
    `;
}

// دالة تطبيق الفلترة حسب المعايير
function filterProductsByCriteria(filterData) {
    console.log('🔍 بدء فلترة المنتجات...');
    
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) {
        console.error('❌ productsGrid غير موجود');
        return { visibleCount: 0 };
    }
    
    // جلب جميع بطاقات المنتجات
    const productCards = productsGrid.querySelectorAll('.product-card');
    console.log(`📦 عدد بطاقات المنتجات: ${productCards.length}`);
    
    if (productCards.length === 0) {
        console.warn('⚠️ لا توجد بطاقات منتجات');
        return { visibleCount: 0 };
    }
    
    let visibleCount = 0;
    let hiddenCount = 0;
    
    productCards.forEach(card => {
        const productId = card.getAttribute('data-index');
        const product = productDetails[productId];
        
        if (!product) {
            console.warn(`⚠️ المنتج ${productId} غير موجود في productDetails`);
            card.style.display = 'none';
            hiddenCount++;
            return;
        }
        
        // التحقق من كل معيار
        let showProduct = true;
        
        // 1. فلترة حسب اسم المنتج
        if (filterData.productName && product.name) {
            const productName = product.name.toLowerCase();
            if (!productName.includes(filterData.productName)) {
                showProduct = false;
            }
        }
        
        // 2. فلترة حسب رقم المنتج
        if (showProduct && filterData.productNumber && product.productNo) {
            const productNo = product.productNo.toLowerCase();
            if (!productNo.includes(filterData.productNumber)) {
                showProduct = false;
            }
        }
        
        // 3. فلترة حسب هاتف المستخدم
        if (showProduct && filterData.userPhone && product.phone) {
            if (!product.phone.includes(filterData.userPhone)) {
                showProduct = false;
            }
        }
        
        // 4. فلترة حسب المنطقة
        if (showProduct && filterData.region && product.location) {
            if (product.location !== filterData.region) {
                showProduct = false;
            }
        }
        
        // 5. فلترة حسب الموقع
        if (showProduct && filterData.location && product.locationstate) {
            const locationState = product.locationstate.toLowerCase();
            if (!locationState.includes(filterData.location)) {
                showProduct = false;
            }
        }
        
        // 6. فلترة حسب القسم
        if (showProduct && filterData.category && product.type) {
            if (product.type !== filterData.category) {
                showProduct = false;
            }
        }
        
        // 7. فلترة حسب النوع (الحالة)
        if (showProduct && filterData.productType && product.condition) {
            if (product.condition !== filterData.productType) {
                showProduct = false;
            }
        }
        
        // 8. فلترة حسب السعر
        if (showProduct && (filterData.priceFrom > 0 || filterData.priceTo < Infinity)) {
            // استخراج السعر من النص
            let productPrice = 0;
            if (product.price) {
                // إزالة كل ما ليس رقم أو نقطة
                const priceStr = product.price.replace(/[^\d.]/g, '');
                productPrice = parseFloat(priceStr) || 0;
                console.log(`💰 سعر المنتج ${product.name}: ${productPrice} (من: ${product.price})`);
            }
            
            if (productPrice < filterData.priceFrom || productPrice > filterData.priceTo) {
                showProduct = false;
            }
        }
        
        // 9. فلترة حسب اللون
        if (showProduct && filterData.color && product.color) {
            if (product.color !== filterData.color) {
                showProduct = false;
            }
        }
        
        // 10. فلترة حسب الحالة
        if (showProduct && filterData.condition && product.condition) {
            if (product.condition !== filterData.condition) {
                showProduct = false;
            }
        }
        
        // عرض أو إخفاء المنتج
        if (showProduct) {
            card.style.display = 'flex';
            card.style.opacity = '1';
            visibleCount++;
        } else {
            card.style.display = 'none';
            card.style.opacity = '0';
            hiddenCount++;
        }
    });
    
    console.log(`✅ الفلترة: ${visibleCount} ظاهر، ${hiddenCount} مخفي`);
    
    // عرض رسالة إذا لم توجد منتجات مطابقة
    if (visibleCount === 0) {
        const originalContent = productsGrid.innerHTML;
        productsGrid.setAttribute('data-original-content', originalContent);
        
        productsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                <h3>لا توجد منتجات تطابق معايير البحث</h3>
                <p>جرب تغيير معايير الفلترة للحصول على نتائج</p>
                <button onclick="resetFilter()" class="btn btn-secondary" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> إعادة تعيين الفلترة
                </button>
            </div>
        `;
    } else {
        // استعادة المحتوى الأصلي إذا تم حفظه
        const originalContent = productsGrid.getAttribute('data-original-content');
        if (originalContent && productsGrid.children.length === 1) {
            productsGrid.innerHTML = originalContent;
            productsGrid.removeAttribute('data-original-content');
            
            // إعادة تطبيق الفلترة على المحتوى المستعاد
            setTimeout(() => filterProductsByCriteria(filterData), 100);
        }
    }
    
    return { visibleCount, hiddenCount };
}

// تهيئة أحداث الفلترة
function initFilterEvents() {
    console.log('🎯 تهيئة أحداث الفلترة...');
    
    // 1. زر الفلترة في الشريط العلوي
    const filterTab = document.querySelector('.filter-tab.filter');
    if (filterTab) {
        console.log('✅ زر الفلترة موجود');
        
        // إزالة أي أحداث سابقة
        filterTab.replaceWith(filterTab.cloneNode(true));
        const newFilterTab = document.querySelector('.filter-tab.filter');
        
       newFilterTab.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('🖱️ تم النقر على زر الفلترة');
    
  
        // فتح نافذة الفلترة
        openFilterModal();
    
});

// وأيضاً تحديث تأثير hover ليظهر الرسالة المناسبة
newFilterTab.addEventListener('mouseenter', function() {
    if (isFilterApplied) {
        this.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
        this.innerHTML = '<i class="fas fa-redo"></i> إعادة تعيين الفلترة';
        this.style.transform = 'scale(1.05)';
        this.style.transition = 'all 0.3s';
    }
});

newFilterTab.addEventListener('mouseleave', function() {
    if (isFilterApplied) {
        this.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        this.innerHTML = '<i class="fas fa-filter"></i> فلترة مفعلة';
        this.style.transform = 'scale(1)';
    }
});
    }
    
    // 2. زر تطبيق الفلترة في النافذة
    const applyBtn = document.getElementById('modalApplyFilterBtn');
    if (applyBtn) {
        console.log('✅ زر التطبيق موجود');
        applyBtn.addEventListener('click', applyFilter);
    } else {
        console.error('❌ زر التطبيق غير موجود');
        // البحث مرة أخرى
        setTimeout(() => {
            const retryBtn = document.getElementById('modalApplyFilterBtn');
            if (retryBtn) {
                retryBtn.addEventListener('click', applyFilter);
                console.log('✅ تم إصلاح زر التطبيق');
            }
        }, 500);
    }
    
    // 3. زر إعادة التعيين في النافذة
    const resetBtn = document.getElementById('modalResetFilterBtn');
    if (resetBtn) {
        console.log('✅ زر إعادة التعيين موجود');
        resetBtn.addEventListener('click', resetFilter);
    }
    
    // 4. زر إغلاق النافذة
    const closeBtn = document.getElementById('closeFilterModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeFilterModal);
    }
    

    
    // 6. البحث بالضغط على Enter
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('filterModal');
        if (modal && modal.style.display === 'flex') {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyFilter(e);
            } else if (e.key === 'Escape') {
                closeFilterModal();
            }
        }
    });
    
    console.log('✅ تم تهيئة جميع أحداث الفلترة');
}

// تحديث دالة filterProducts لتشمل الفلترة المخصصة
function filterProducts(filterType) {
    console.log(`🔍 فلترة المنتجات حسب: ${filterType}`);
    
    if (filterType === 'filter') {
        openFilterModal();
        return;
    }
    
    const productsGrid = document.getElementById('productsGrid');
    const productCards = productsGrid.querySelectorAll('.product-card');
    
    if (productCards.length === 0) {
        console.warn('⚠️ لا توجد بطاقات منتجات للفلترة');
        return;
    }
    
    if (filterType === 'all') {
        productCards.forEach(card => {
            card.style.display = 'flex';
        });
        showNotification('تم عرض جميع المنتجات');
    } 
    else if (filterType === 'favorite') {
        let favoriteCount = 0;
        productCards.forEach(card => {
            const productId = card.getAttribute('data-index');
            if (favoriteProducts.includes(productId.toString())) {
                card.style.display = 'flex';
                favoriteCount++;
            } else {
                card.style.display = 'none';
            }
        });
        showNotification(`تم عرض ${favoriteCount} منتج مفضل`);
    } 
    else {
        let count = 0;
        productCards.forEach(card => {
            const category = card.getAttribute('data-category');
            if (category === filterType) {
                card.style.display = 'flex';
                count++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // تحديد اسم الفئة للعرض
        let categoryName = '';
        switch(filterType) {
            case 'new': categoryName = 'جديد'; break;
            case 'sale': categoryName = 'مستعمل'; break;
            case 'popular': categoryName = 'خردة'; break;
            default: categoryName = filterType;
        }
        
        showNotification(`تم عرض ${count} منتج ${categoryName}`);
    }
}

// تهيئة أحداث الفلترة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
     setTimeout(function() {
        initFilterEvents();
    }, 500);
});
// ========== دوال التحكم بالنافذة المنبثقة ==========

// فتح نافذة تأكيد إعادة التعيين
function openConfirmResetModal() {
    console.log('📢 فتح نافذة تأكيد إعادة التعيين...');
    
    const modal = document.getElementById('confirmResetModal');
    if (!modal) {
        console.error('❌ نافذة التأكيد غير موجودة');
        // استخدام confirm كبديل احتياطي
        if (confirm('هل تريد إعادة تعيين الفلترة؟')) {
            resetFilter();
        }
        return;
    }
    
    // عرض النافذة
    modal.style.display = 'block';
    
    // منع التمرير
    document.body.style.overflow = 'hidden';
    
    // إضافة أنميشن
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.style.animation = 'modalSlideIn 0.3s ease-out';
    }
    
    console.log('✅ تم فتح نافذة التأكيد');
}

</script>
</body>
</html>